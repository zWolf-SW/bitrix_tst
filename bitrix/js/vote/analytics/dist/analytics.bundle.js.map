{"version":3,"file":"analytics.bundle.js","sources":["../src/const.js","../src/analytics.js"],"sourcesContent":["export const AnalyticsEvents = Object.freeze({\n\tpublishPoll: 'publish_poll',\n\tfinishPoll: 'finish_poll',\n\tvote: 'vote',\n\tcancelVote: 'cancel_vote',\n\tcopyPollLink: 'copy_poll_link',\n\tsetOptions: 'set_options',\n\tisMultipleChoice: 'is_multiple_choice',\n\tsetCancelVote: 'set_cancel_vote',\n\tsetTimeLimit: 'set_time_limit',\n\tdownloadResult: 'download_result',\n});\n\nexport const AnalyticsCategories = Object.freeze({\n\tpollSettings: 'poll_settings',\n\tpolls: 'polls',\n});\n","import { Runtime } from 'main.core';\nimport { sendData, type AnalyticsOptions } from 'ui.analytics';\nimport { AnalyticsCategories, AnalyticsEvents } from './const';\n\nconst getAnalyticsOptions = async (dialogId: string, messageId: number): Promise<Partial<AnalyticsOptions> | null> => {\n\ttry\n\t{\n\t\tconst { Analytics: ImAnalytics } = await Runtime.loadExtension('im.v2.lib.analytics');\n\t\tconst analyticsInstance = ImAnalytics.getInstance();\n\t\tconst options = analyticsInstance.vote.getAnalyticsOptions(dialogId);\n\t\toptions.p3 = `pollId_${messageId}`;\n\n\t\treturn options;\n\t}\n\tcatch (ex)\n\t{\n\t\tconsole.error(ex);\n\n\t\treturn null;\n\t}\n};\n\nconst publishVote = (anonymousVote: boolean, messageId: number): void => {\n\tconst { searchParams } = new URL(document.location.href);\n\tconst options = {\n\t\ttool: searchParams.get('st[tool]'),\n\t\tevent: AnalyticsEvents.publishPoll,\n\t\ttype: anonymousVote ? 'anonymous' : 'public',\n\t\tcategory: searchParams.get('st[category]'),\n\t\tp1: searchParams.get('st[p1]'),\n\t\tp2: searchParams.get('st[p2]'),\n\t\tp3: `pollId_${messageId}`,\n\t\tp5: searchParams.get('st[p5]'),\n\t};\n\tif (searchParams.has('st[p4]'))\n\t{\n\t\toptions.p4 = searchParams.get('st[p4]');\n\t}\n\n\tsendData(options);\n};\n\nconst sendDataByImOptions = async (\n\tdialogId: string,\n\tmessageId: number,\n\tevent: string,\n\ttype: ?string,\n): Promise<void> => {\n\tconst analyticsOptions = await getAnalyticsOptions(dialogId, messageId);\n\tif (!analyticsOptions)\n\t{\n\t\treturn;\n\t}\n\n\tanalyticsOptions.event = event;\n\tif (event === AnalyticsEvents.finishPoll)\n\t{\n\t\tsendData({ ...analyticsOptions, type });\n\n\t\treturn;\n\t}\n\n\tconst { p4, p5, ...rest } = analyticsOptions;\n\tif (type)\n\t{\n\t\trest.type = type;\n\t}\n\n\tsendData(rest);\n};\n\nconst downloadResult = (messageId: number): void => {\n\tconst options = {\n\t\ttool: 'im',\n\t\tevent: AnalyticsEvents.downloadResult,\n\t\tcategory: AnalyticsCategories.polls,\n\t\tp3: `pollId_${messageId}`,\n\t};\n\tsendData(options);\n};\n\nconst setupVote = (optionValue: boolean | number, event: string, messageId: string): void => {\n\tlet type = '';\n\tswitch (event)\n\t{\n\t\tcase AnalyticsEvents.isMultipleChoice:\n\t\t\ttype = optionValue ? 'Y' : 'N';\n\t\t\tbreak;\n\t\tcase AnalyticsEvents.setCancelVote:\n\t\t\ttype = optionValue ? 'Y' : 'N';\n\t\t\tbreak;\n\t\tcase AnalyticsEvents.setTimeLimit:\n\t\t\ttype = optionValue ? 'limited' : '';\n\t\t\tbreak;\n\t\tcase AnalyticsEvents.setOptions:\n\t\t\ttype = optionValue > 2 ? 'multiple' : 'two';\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t}\n\n\tconst options = {\n\t\ttool: 'im',\n\t\tcategory: AnalyticsCategories.pollSettings,\n\t\tevent,\n\t\ttype,\n\t\tp3: `pollId_${messageId}`,\n\t};\n\tsendData(options);\n};\n\nexport const VoteAnalytics = {\n\tpublishVote,\n\tdownloadResult,\n\tsetupVote,\n\tvote: (dialogId: string, messageId: number): void => {\n\t\tsendDataByImOptions(dialogId, messageId, AnalyticsEvents.vote);\n\t},\n\trevokeVote: (dialogId: string, messageId: number): void => {\n\t\tsendDataByImOptions(dialogId, messageId, AnalyticsEvents.cancelVote);\n\t},\n\tcompleteVote: (dialogId: string, messageId: number): void => {\n\t\tsendDataByImOptions(dialogId, messageId, AnalyticsEvents.finishPoll, 'user');\n\t},\n\tcopyLink: (dialogId: string, messageId: number, type: string): void => {\n\t\tsendDataByImOptions(dialogId, messageId, AnalyticsEvents.copyPollLink, type);\n\t},\n};\n\nexport { AnalyticsEvents };\n"],"names":["AnalyticsEvents","Object","freeze","publishPoll","finishPoll","vote","cancelVote","copyPollLink","setOptions","isMultipleChoice","setCancelVote","setTimeLimit","downloadResult","AnalyticsCategories","pollSettings","polls","getAnalyticsOptions","dialogId","messageId","Analytics","ImAnalytics","Runtime","loadExtension","analyticsInstance","getInstance","options","p3","ex","console","error","publishVote","anonymousVote","searchParams","URL","document","location","href","tool","get","event","type","category","p1","p2","p5","has","p4","sendData","sendDataByImOptions","analyticsOptions","rest","setupVote","optionValue","VoteAnalytics","revokeVote","completeVote","copyLink"],"mappings":"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"}