this.BX=this.BX||{};(function(e,s,t,r,a){"use strict";let l=e=>e,i;var o=babelHelpers.classPrivateFieldLooseKey("formConstructor");var n=babelHelpers.classPrivateFieldLooseKey("handler");var c=babelHelpers.classPrivateFieldLooseKey("redirect");var b=babelHelpers.classPrivateFieldLooseKey("clientId");var d=babelHelpers.classPrivateFieldLooseKey("wrapper");var v=babelHelpers.classPrivateFieldLooseKey("loader");var p=babelHelpers.classPrivateFieldLooseKey("overlay");class h extends r.EventEmitter{constructor(e){super();Object.defineProperty(this,o,{writable:true,value:void 0});Object.defineProperty(this,n,{writable:true,value:void 0});Object.defineProperty(this,c,{writable:true,value:void 0});Object.defineProperty(this,b,{writable:true,value:void 0});Object.defineProperty(this,d,{writable:true,value:void 0});Object.defineProperty(this,v,{writable:true,value:void 0});Object.defineProperty(this,p,{writable:true,value:void 0});if(!(e.formConstructor instanceof a.FormConstructor)){throw new Error('"formConstructor" is required parameters')}babelHelpers.classPrivateFieldLooseBase(this,c)[c]=null;babelHelpers.classPrivateFieldLooseBase(this,d)[d]=s.Type.isElementNode(e.wrapper)?e.wrapper:null;this.setFormConstructor(e.formConstructor);babelHelpers.classPrivateFieldLooseBase(this,n)[n]=s.Type.isStringFilled(e.handler)?e.handler:null;babelHelpers.classPrivateFieldLooseBase(this,b)[b]=s.Type.isStringFilled(e.clientId)?e.clientId:null;this.setRedirect(e.redirect);babelHelpers.classPrivateFieldLooseBase(this,v)[v]=new t.Loader({target:babelHelpers.classPrivateFieldLooseBase(this,d)[d]});babelHelpers.classPrivateFieldLooseBase(this,p)[p]=s.Tag.render(i||(i=l`<div class="rest-app-settings-overlay"></div>`))}setRedirect(e){const t=new RegExp("^(?:/|https?://"+location.host+")","g");if(s.Type.isStringFilled(e)&&!!e.match(t)){babelHelpers.classPrivateFieldLooseBase(this,c)[c]=e}}show(){if(s.Type.isNil(babelHelpers.classPrivateFieldLooseBase(this,d)[d])){throw new Error('Property "wrapper" is undefined')}babelHelpers.classPrivateFieldLooseBase(this,o)[o].renderTo(babelHelpers.classPrivateFieldLooseBase(this,d)[d]);BX.UI.ButtonPanel.show()}subscribeEvents(){if(!(babelHelpers.classPrivateFieldLooseBase(this,o)[o]instanceof a.FormConstructor)){return}r.EventEmitter.subscribe(r.EventEmitter.GLOBAL_TARGET,"button-click",(e=>{const[s]=e.data;if(s.TYPE==="save"){const e={clientId:babelHelpers.classPrivateFieldLooseBase(this,b)[b],settings:babelHelpers.classPrivateFieldLooseBase(this,o)[o].getFormData(),handler:babelHelpers.classPrivateFieldLooseBase(this,n)[n]};this.save(e)}}));babelHelpers.classPrivateFieldLooseBase(this,o)[o].subscribe("onFieldChange",(()=>{this.reload()}))}unsubscribeEvents(){if(!(babelHelpers.classPrivateFieldLooseBase(this,o)[o]instanceof a.FormConstructor)){return}r.EventEmitter.unsubscribeAll(r.EventEmitter.GLOBAL_TARGET,"button-click");babelHelpers.classPrivateFieldLooseBase(this,o)[o].unsubscribeAll("onSave");babelHelpers.classPrivateFieldLooseBase(this,o)[o].unsubscribeAll("onFieldChange")}setFormConstructor(e){this.unsubscribeEvents();babelHelpers.classPrivateFieldLooseBase(this,o)[o]=e;this.subscribeEvents()}reload(){s.Dom.append(babelHelpers.classPrivateFieldLooseBase(this,p)[p],babelHelpers.classPrivateFieldLooseBase(this,d)[d]);babelHelpers.classPrivateFieldLooseBase(this,v)[v].show();if(s.Type.isNil(babelHelpers.classPrivateFieldLooseBase(this,b)[b])){console.log('Property "clientId" is undefined');return}s.ajax.runComponentAction("bitrix:rest.app.settings","reload",{mode:"class",data:{clientId:babelHelpers.classPrivateFieldLooseBase(this,b)[b],settings:babelHelpers.classPrivateFieldLooseBase(this,o)[o].getFormData()}}).then((e=>{const t=e.data;this.setFormConstructor(new a.FormConstructor({steps:t.STEPS}));babelHelpers.classPrivateFieldLooseBase(this,n)[n]=s.Type.isStringFilled(t.HANDLER)?t.HANDLER:babelHelpers.classPrivateFieldLooseBase(this,n)[n];babelHelpers.classPrivateFieldLooseBase(this,b)[b]=s.Type.isStringFilled(t.CLIENT_ID)?t.CLIENT_ID:babelHelpers.classPrivateFieldLooseBase(this,b)[b];this.setRedirect(t.REDIRECT);this.show();babelHelpers.classPrivateFieldLooseBase(this,v)[v].hide();s.Dom.remove(babelHelpers.classPrivateFieldLooseBase(this,p)[p])})).catch((e=>{console.log(e.errors);babelHelpers.classPrivateFieldLooseBase(this,o)[o].showTextInBalloon(s.Loc.getMessage("REST_APP_SETTINGS_ERROR"))}))}isReadySave(){let e=true;babelHelpers.classPrivateFieldLooseBase(this,o)[o].getFields().forEach((s=>{if(!s.isReadySave()){e=false}}));return e}save(e){s.ajax.runAction("rest.einvoice.save",{mode:"class",data:e}).then((()=>{if(s.Type.isNil(babelHelpers.classPrivateFieldLooseBase(this,c)[c])){top.BX.SidePanel.Instance.close()}else{top.document.location.href=babelHelpers.classPrivateFieldLooseBase(this,c)[c]}const e=BX.UI.ButtonPanel.getContainer().querySelector(".ui-btn-wait");s.Dom.removeClass(e,"ui-btn-wait")})).catch((e=>{const t=e.errors;let{fieldErrors:r,otherErrors:a}=h.formatErrors(t);babelHelpers.classPrivateFieldLooseBase(this,o)[o].showFieldErrors(r);if(s.Type.isArrayFilled(a)){babelHelpers.classPrivateFieldLooseBase(this,o)[o].showTextInBalloon(s.Loc.getMessage("REST_APP_SETTINGS_ERROR"))}const l=BX.UI.ButtonPanel.getContainer().querySelector(".ui-btn-wait");if(l){s.Dom.removeClass(l,"ui-btn-wait")}}))}static formatErrors(e){let t={};let r=[];e.forEach((e=>{var a;if(s.Type.isStringFilled((a=e.customData)==null?void 0:a.fieldName)){var l,i,o;Array.isArray(t[(l=e.customData)==null?void 0:l.fieldName])?t[(i=e.customData)==null?void 0:i.fieldName].push(e.message):t[(o=e.customData)==null?void 0:o.fieldName]=[e.message]}else{r.push(e.message)}}));return{fieldErrors:t,otherErrors:r}}}e.AppSettings=h})(this.BX.Rest=this.BX.Rest||{},BX,BX,BX.Event,BX.Rest);
//# sourceMappingURL=script.map.js