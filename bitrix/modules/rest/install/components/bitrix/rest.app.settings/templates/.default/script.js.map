{"version":3,"file":"script.js","sources":["src/app-settings.js"],"sourcesContent":["import { Dom, Tag, ajax, Type, Loc } from 'main.core';\nimport { Loader } from 'main.loader';\nimport { EventEmitter } from 'main.core.events';\nimport { FormConstructor } from 'rest.form-constructor';\n\nexport class AppSettings extends EventEmitter\n{\n\t#formConstructor: FormConstructor;\n\t#handler: string;\n\t#redirect: ?string\n\t#clientId: ?string\n\t#wrapper: HTMLElement;\n\t#loader: Loader\n\t#overlay: HTMLElement;\n\n\tconstructor(options)\n\t{\n\t\tsuper();\n\t\tif (!(options.formConstructor instanceof FormConstructor))\n\t\t{\n\t\t\tthrow new Error('\"formConstructor\" is required parameters')\n\t\t}\n\n\t\tthis.#redirect = null;\n\t\tthis.#wrapper = Type.isElementNode(options.wrapper) ? options.wrapper : null;\n\t\tthis.setFormConstructor(options.formConstructor);\n\t\tthis.#handler = Type.isStringFilled(options.handler) ? options.handler : null;\n\t\tthis.#clientId = Type.isStringFilled(options.clientId) ? options.clientId : null;\n\t\tthis.setRedirect(options.redirect);\n\t\tthis.#loader = new Loader({\n\t\t\ttarget: this.#wrapper\n\t\t});\n\t\tthis.#overlay = Tag.render`<div class=\"rest-app-settings-overlay\"></div>`\n\t}\n\n\tsetRedirect(url: string)\n\t{\n\t\tconst reqExp = new RegExp('^(?:/|https?://' + location.host + ')', \"g\");\n\t\tif (Type.isStringFilled(url) && !!url.match(reqExp))\n\t\t{\n\t\t\tthis.#redirect = url;\n\t\t}\n\t}\n\n\tshow(): void\n\t{\n\t\tif (Type.isNil(this.#wrapper))\n\t\t{\n\t\t\tthrow new Error('Property \"wrapper\" is undefined')\n\t\t}\n\n\t\tthis.#formConstructor.renderTo(this.#wrapper);\n\t\tBX.UI.ButtonPanel.show();\n\t}\n\n\tsubscribeEvents(): void\n\t{\n\t\tif (!(this.#formConstructor instanceof FormConstructor))\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tEventEmitter.subscribe(\n\t\t\tEventEmitter.GLOBAL_TARGET,\n\t\t\t'button-click',\n\t\t\t(event) => {\n\t\t\t\tconst [clickedBtn] = event.data;\n\t\t\t\tif (clickedBtn.TYPE === 'save')\n\t\t\t\t{\n\t\t\t\t\tconst data = {\n\t\t\t\t\t\tclientId: this.#clientId,\n\t\t\t\t\t\tsettings: this.#formConstructor.getFormData(),\n\t\t\t\t\t\thandler: this.#handler\n\t\t\t\t\t};\n\t\t\t\t\tthis.save(data);\n\t\t\t\t}\n\t\t\t},\n\t\t);\n\t\tthis.#formConstructor.subscribe('onFieldChange', () => {\n\t\t\tthis.reload();\n\t\t});\n\t}\n\n\tunsubscribeEvents(): void\n\t{\n\t\tif (!(this.#formConstructor instanceof FormConstructor))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tEventEmitter.unsubscribeAll(EventEmitter.GLOBAL_TARGET, 'button-click');\n\t\tthis.#formConstructor.unsubscribeAll('onSave');\n\t\tthis.#formConstructor.unsubscribeAll('onFieldChange');\n\t}\n\n\tsetFormConstructor(formConstructor: FormConstructor): void\n\t{\n\t\tthis.unsubscribeEvents();\n\t\tthis.#formConstructor = formConstructor;\n\t\tthis.subscribeEvents();\n\t}\n\n\treload(): void\n\t{\n\t\tDom.append(this.#overlay,this.#wrapper);\n\t\tthis.#loader.show();\n\n\t\tif (Type.isNil(this.#clientId))\n\t\t{\n\t\t\tconsole.log('Property \"clientId\" is undefined');\n\t\t\treturn;\n\t\t}\n\t\tajax.runComponentAction('bitrix:rest.app.settings', 'reload',{\n\t\t\tmode: 'class',\n\t\t\tdata: {\n\t\t\t\tclientId: this.#clientId,\n\t\t\t\tsettings: this.#formConstructor.getFormData()\n\t\t\t},\n\t\t}).then((response) => {\n\t\t\tconst data = response.data;\n\t\t\tthis.setFormConstructor(new FormConstructor({\n\t\t\t\tsteps: data.STEPS,\n\t\t\t}));\n\t\t\tthis.#handler = Type.isStringFilled(data.HANDLER) ? data.HANDLER : this.#handler;\n\t\t\tthis.#clientId = Type.isStringFilled(data.CLIENT_ID) ? data.CLIENT_ID : this.#clientId;\n\t\t\tthis.setRedirect(data.REDIRECT);\n\n\t\t\tthis.show();\n\t\t\tthis.#loader.hide();\n\t\t\tDom.remove(this.#overlay);\n\t\t}).catch((response) => {\n\t\t\tconsole.log(response.errors);\n\t\t\tthis.#formConstructor.showTextInBalloon(Loc.getMessage('REST_APP_SETTINGS_ERROR'));\n\t\t});\n\t}\n\n\tisReadySave(): boolean\n\t{\n\t\tlet isAllFieldReady = true;\n\n\t\tthis.#formConstructor.getFields().forEach((field) => {\n\t\t\tif (!field.isReadySave())\n\t\t\t{\n\t\t\t\tisAllFieldReady = false;\n\t\t\t}\n\t\t});\n\n\t\treturn isAllFieldReady;\n\t}\n\n\tsave(data): void\n\t{\n\t\tajax.runAction('rest.einvoice.save', {\n\t\t\tmode: 'class',\n\t\t\tdata: data,\n\t\t}).then(() => {\n\t\t\tif (Type.isNil(this.#redirect))\n\t\t\t{\n\t\t\t\ttop.BX.SidePanel.Instance.close();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\ttop.document.location.href = this.#redirect;\n\t\t\t}\n\n\t\t\tconst buttonWaitState = BX.UI.ButtonPanel.getContainer().querySelector('.ui-btn-wait');\n\t\t\tDom.removeClass(buttonWaitState, 'ui-btn-wait');\n\t\t}).catch((response) => {\n\t\t\tconst errors = response.errors;\n\t\t\tlet { fieldErrors, otherErrors } = AppSettings.formatErrors(errors);\n\t\t\tthis.#formConstructor.showFieldErrors(fieldErrors);\n\t\t\tif (Type.isArrayFilled(otherErrors))\n\t\t\t{\n\t\t\t\tthis.#formConstructor.showTextInBalloon(Loc.getMessage('REST_APP_SETTINGS_ERROR'));\n\t\t\t}\n\n\t\t\tconst buttonWaitState = BX.UI.ButtonPanel.getContainer().querySelector('.ui-btn-wait');\n\n\t\t\tif (buttonWaitState)\n\t\t\t{\n\t\t\t\tDom.removeClass(buttonWaitState, 'ui-btn-wait');\n\t\t\t}\n\t\t});\n\t}\n\n\tstatic formatErrors(errors: Array): Object\n\t{\n\t\tlet fieldErrors = {};\n\t\tlet otherErrors = [];\n\t\terrors.forEach((error) => {\n\t\t\tif (Type.isStringFilled(error.customData?.fieldName))\n\t\t\t{\n\t\t\t\tArray.isArray(fieldErrors[error.customData?.fieldName]) ?\n\t\t\t\t\tfieldErrors[error.customData?.fieldName].push(error.message) :\n\t\t\t\t\tfieldErrors[error.customData?.fieldName] = [error.message];\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\totherErrors.push(error.message)\n\t\t\t}\n\t\t});\n\n\t\treturn {\n\t\t\tfieldErrors: fieldErrors,\n\t\t\totherErrors: otherErrors\n\t\t};\n\t}\n}"],"names":["AppSettings","EventEmitter","constructor","options","formConstructor","FormConstructor","Error","Type","isElementNode","wrapper","setFormConstructor","isStringFilled","handler","clientId","setRedirect","redirect","Loader","target","Tag","render","url","reqExp","RegExp","location","host","match","show","isNil","renderTo","BX","UI","ButtonPanel","subscribeEvents","subscribe","GLOBAL_TARGET","event","clickedBtn","data","TYPE","settings","getFormData","save","reload","unsubscribeEvents","unsubscribeAll","Dom","append","console","log","ajax","runComponentAction","mode","then","response","steps","STEPS","HANDLER","CLIENT_ID","REDIRECT","hide","remove","catch","errors","showTextInBalloon","Loc","getMessage","isReadySave","isAllFieldReady","getFields","forEach","field","runAction","top","SidePanel","Instance","close","document","href","buttonWaitState","getContainer","querySelector","removeClass","fieldErrors","otherErrors","formatErrors","showFieldErrors","isArrayFilled","error","customData","fieldName","Array","isArray","push","message"],"mappings":"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"}