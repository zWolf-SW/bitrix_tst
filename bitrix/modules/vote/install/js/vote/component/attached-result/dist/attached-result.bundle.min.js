this.BX=this.BX||{};this.BX.Vote=this.BX.Vote||{};(function(t,e,s,r,a,o,n){"use strict";var i=babelHelpers.classPrivateFieldLooseKey("signedAttachId");var l=babelHelpers.classPrivateFieldLooseKey("limit");class u{constructor(t,e=10){Object.defineProperty(this,i,{writable:true,value:void 0});Object.defineProperty(this,l,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,i)[i]=t;babelHelpers.classPrivateFieldLooseBase(this,l)[l]=e}async loadAnswer(t,e=1){var s,r;const a={signedAttachId:babelHelpers.classPrivateFieldLooseBase(this,i)[i],answerId:t};const o={size:babelHelpers.classPrivateFieldLooseBase(this,l)[l],page:e};const n=await BX.ajax.runAction("vote.AttachedVote.getAnswerVoted",{data:a,navigation:o});return(s=n==null?void 0:(r=n.data)==null?void 0:r.items)!=null?s:[]}}const d={name:"VotedUsersList",components:{Popup:s.Popup,BIcon:r.BIcon},props:{count:{type:Number,required:true},votedUsers:{type:Array,required:true},signedAttachId:{type:String,required:true},answerId:{type:Number,required:true},maxVisibleAvatarsCount:{type:Number,required:false,default:3},pageSize:{type:Number,required:true},showUsers:{type:Boolean,required:true}},data(){return{users:this.votedUsers,page:1,loading:false,isShowPopup:false}},computed:{summaryText(){return e.Loc.getMessagePlural("VOTE_JS_ATTACHED_RESULT_ANSWER_VOTED_COUNT",this.count,{"#COUNT#":this.count})},visibleVotedUsers(){return this.votedUsers.slice(0,this.maxVisibleAvatarsCount)},popupOptions(){return{bindElement:this.$refs.showPopupBtn,borderRadius:"18px",autoHide:true}}},methods:{async popupScrollHandler(t){if(this.loading){return}if(this.count<=this.users.length){return}if(t.target.scrollHeight-t.target.scrollTop>t.target.clientHeight){return}this.loading=true;const e=this.page+1;const s=new u(this.signedAttachId,this.pageSize);try{const t=await s.loadAnswer(this.answerId,e);this.page=e;this.users=[...this.users,...t]}catch(t){console.error(t)}finally{this.loading=false}},getUserImage(t){return`background-image: url('${encodeURI(t.IMAGE)}')`}},template:`\n\t\t<div class="vote-result__users">\n\t\t\t<div class="vote-result__avatars" v-if="showUsers">\n\t\t\t\t<span class="vote-result__avatar" v-for="user in visibleVotedUsers" :key="user.INDEX" >\n\t\t\t\t\t<i v-if="user.IMAGE" :style="getUserImage(user)" :title="user.NAME" class="vote-result__avatar-img"/>\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t\t<div @click="isShowPopup = true" ref="showPopupBtn" class="vote-result__users-more" :class = "{ '--disable': !showUsers }">\n\t\t\t\t{{ summaryText }}\n\t\t\t</div>\n\t\t\t<Popup v-if="isShowPopup" :options="popupOptions" @close="isShowPopup = false">\n\t\t\t\t<div class="vote-result__users-popup" @scroll="this.popupScrollHandler($event)">\n\t\t\t\t\t<div v-for="(user, index) in users" :key="index" class="vote-result__users-popup-item">\n\t\t\t\t\t\t<img v-if="user.IMAGE" class="vote-result__users-popup-avatar" :src="user.IMAGE" alt=""/>\n\t\t\t\t\t\t<BIcon v-else\n\t\t\t\t\t\t   class="vote-result__users-popup-avatar"\n\t\t\t\t\t\t   :name="'person'"\n\t\t\t\t\t\t   :size="26"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div class="vote-result__users-popup-name">{{ user.NAME }}</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<BIcon v-if="loading" :name="'loader-wait'" :size="20" />\n\t\t\t\t</div>\n\t\t\t</Popup>\n\t\t</div>\n\t`};const c=2;const p={name:"VoteResultDisplay",components:{VotedUsersList:d},props:{loadedData:{type:Object,required:true},votedPageSize:{type:Number,required:true}},computed:{currentVote(){const{VOTE_ID:t,isVoted:e,signedAttachId:s,downloadUrl:r,canRevote:a,isFinished:o}=this.loadedData.attach;return{id:t,isAnonymousVote:this.isAnonymousVote,isVoted:e,signedAttachId:s,downloadUrl:r,canRevoke:a,isFinished:o}},questions(){var t;const e=(t=this.loadedData.attach)==null?void 0:t.QUESTIONS;const s=this.calculatePercentages(e);const r={};Object.keys(e).forEach((t=>{const a=e[t];const o={};const n=a.FIELD_TYPE==="1";Object.keys(a.ANSWERS).forEach(((e,r)=>{const i=a.ANSWERS[e];o[e]={id:Number(i.ID),percent:n?Math.round(i.PERCENT):s[t][r],text:i.MESSAGE,counter:Number(i.COUNTER)}}));r[t]={id:Number(a.ID),counter:Number(a.COUNTER),text:a.QUESTION,answers:o}}));return r},currentUserVotes(){var t;const e={};const s=(t=this.loadedData.attach)==null?void 0:t.userAnswerMap;Object.entries(s).forEach((([t,s])=>{e[t]=Object.keys(s).map((t=>Number(t)))}));return e},isAnonymousVote(){var t;return((t=this.loadedData.attach)==null?void 0:t.ANONYMITY)===c},voteTypeText(){return this.isAnonymousVote?e.Loc.getMessage("VOTE_JS_ATTACHED_RESULT_ANONYMOUS"):e.Loc.getMessage("VOTE_JS_ATTACHED_RESULT_PUBLIC")},isFinishedVote(){return this.currentVote.isFinished},canRevoke(){if(this.currentVote.isFinished){return this.currentVote.isFinished}return this.currentVote.canRevoke}},methods:{hasCurrentUserVote(t,e){return this.currentUserVotes[t]&&this.currentUserVotes[t].includes(e)},getSummaryText(t){return e.Loc.getMessagePlural("VOTE_JS_ATTACHED_RESULT_QUESTION_VOTED_COUNT",t,{"#COUNT#":t})},getVotedUsers(t){var e,s;return(e=(s=this.loadedData.voted)==null?void 0:s[t])!=null?e:[]},hasVotes(t){return t>0},getSelectedClass(t,e){return this.hasCurrentUserVote(t,e)?"--selected":""},calculatePercentages(t){const e={};Object.values(t).forEach((t=>{const s=t.ANSWERS;const r=Object.values(s).map((t=>Number(t.COUNTER)));const a=r.reduce(((t,e)=>t+e),0);if(a===0){e[t.ID]=r.map((()=>0));return}const o=r.map((t=>t/a*100));const n=o.map((t=>Math.floor(t)));const i=100-n.reduce(((t,e)=>t+e),0);const l=o.map(((t,e)=>({index:e,fraction:t%1}))).sort(((t,e)=>e.fraction-t.fraction));for(let t=0;t<i;t++){n[l[t].index]+=1}e[t.ID]=n}));return e}},template:`\n\t\t<div class="vote-result__wrapper">\n\t\t\t<div class="vote-result__info">\n\t\t\t  <span>{{ voteTypeText }}</span>\n\t\t\t  <span v-if="!canRevoke">{{ $Bitrix.Loc.getMessage('VOTE_JS_ATTACHED_RESULT_REVOKE_IS_NOT_AVAILABLE') }} </span>\n\t\t\t  <span v-if="isFinishedVote">{{ $Bitrix.Loc.getMessage('VOTE_JS_ATTACHED_RESULT_VOTE_IS_FINISHED') }}</span>\n\t\t\t</div>\n\t\t\t<div v-for="question in questions" :key="question.id">\n\t\t\t\t<div class="vote-result__title">{{ question.text }}</div>\n\t\t\t\t<div class="vote-result__summary">{{ getSummaryText(question.counter) }}</div>\n\t\t\t\t<div class="vote-result__answers">\n\t\t\t\t\t<div class="vote-result__answer" v-for="answer in question.answers" :key="answer.id">\n\t\t\t\t\t\t<div class="vote-result__answer-inner" :class="getSelectedClass(question.id, answer.id)">\n\t\t\t\t\t\t\t<div class="vote-result__answer-text">{{ answer.text }}</div>\n\t\t\t\t\t\t\t<div class="vote-result__answer-percent">\n\t\t\t\t\t\t\t\t<span>{{ answer.percent }}</span>\n\t\t\t\t\t\t\t\t%\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="vote-result__answer-fill"\n\t\t\t\t\t\t\t\t:style="{ width: answer.percent + '%' }"\n\t\t\t\t\t\t\t></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<VotedUsersList\n\t\t\t\t\t\t\tv-if="hasVotes(answer.counter)"\n\t\t\t\t\t\t\t:count="answer.counter"\n\t\t\t\t\t\t\t:votedUsers="getVotedUsers(answer.id)"\n\t\t\t\t\t\t\t:signedAttachId="currentVote.signedAttachId"\n\t\t\t\t\t\t\t:answerId="answer.id"\n\t\t\t\t\t\t\t:pageSize="votedPageSize"\n\t\t\t\t\t\t\t:showUsers="!isAnonymousVote"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};var v=babelHelpers.classPrivateFieldLooseKey("application");var h=babelHelpers.classPrivateFieldLooseKey("votedPageSize");class _{constructor(t){Object.defineProperty(this,v,{writable:true,value:void 0});Object.defineProperty(this,h,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,h)[h]=t.votedPageSize||10}createApplicationWithResult(t){return n.BitrixVue.createApp({name:"VoteAttachedResultRoot",components:{VoteResultDisplay:p},props:{loaded:{type:Object,required:true},votedPageSize:{type:Number,required:true}},template:'<VoteResultDisplay :loadedData="loaded" :votedPageSize="votedPageSize"/>'},{loaded:t,votedPageSize:babelHelpers.classPrivateFieldLooseBase(this,h)[h]})}renderTo(t,e){babelHelpers.classPrivateFieldLooseBase(this,v)[v]=this.createApplicationWithResult(t);babelHelpers.classPrivateFieldLooseBase(this,v)[v].mount(e)}}t.VoteAttachedResult=_})(this.BX.Vote.Component=this.BX.Vote.Component||{},BX,BX.UI.Vue3.Components,BX.UI.IconSet,BX,BX,BX.Vue3);
//# sourceMappingURL=attached-result.bundle.map.js