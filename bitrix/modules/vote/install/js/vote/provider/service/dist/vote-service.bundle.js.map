{"version":3,"file":"vote-service.bundle.js","sources":["../src/vote-service.js"],"sourcesContent":["import { Type, ajax } from 'main.core';\nimport { UI } from 'ui.notification';\nimport { type BaseEvent } from 'main.core.events';\n\nimport { VoteApplication } from 'vote.application';\nimport { type BackendVote } from './type';\n\nexport const BackendModuleId = 'im';\nexport const BackendEntityType = 'Bitrix\\\\Vote\\\\Attachment\\\\ImMessageConnector';\n\nexport type EntityAuthParams = {\n\tmoduleId: string,\n\tentityType: string,\n};\n\nexport class ImVoteService\n{\n\tstatic instance: ImVoteService;\n\t#app: VoteApplication = null;\n\n\tstatic init(): ImVoteService\n\t{\n\t\treturn ImVoteService.getInstance();\n\t}\n\n\tstatic getInstance(): ImVoteService\n\t{\n\t\tif (!ImVoteService.instance)\n\t\t{\n\t\t\tImVoteService.instance = new ImVoteService();\n\t\t}\n\n\t\treturn ImVoteService.instance;\n\t}\n\n\tconstructor()\n\t{\n\t\tthis.#app = VoteApplication.init();\n\t\tthis.#app.subscribe('loadVotes', ({ data }: BaseEvent) => {\n\t\t\tconst { entityIds, voteIds } = data;\n\t\t\tthis.#load(entityIds, voteIds);\n\t\t});\n\t}\n\n\tasync #load(entityIds: Array<number>, voteIds: Array<string>): Promise<void>\n\t{\n\t\ttry\n\t\t{\n\t\t\tconst response = await this.#getManyVotes(entityIds);\n\t\t\tif (!response?.data?.items)\n\t\t\t{\n\t\t\t\tthis.#setLoading(voteIds, false);\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tresponse.data.items.forEach((item) => {\n\t\t\t\tthis.#updateStore(item);\n\t\t\t});\n\t\t}\n\t\tcatch (ex)\n\t\t{\n\t\t\tthis.#app.handleLoadError(entityIds);\n\t\t\tthis.#notifyAjaxError(ex);\n\t\t\tthis.#setLoading(voteIds, false);\n\t\t}\n\t}\n\n\t#notifyAjaxError(ex): void\n\t{\n\t\tif (Type.isObject(ex) && Type.isArrayFilled(ex.errors))\n\t\t{\n\t\t\tconst content = ex?.errors[0]?.message ?? 'Unexpected error';\n\t\t\tUI.Notification.Center.notify({\n\t\t\t\tcontent,\n\t\t\t\tautoHideDelay: 4000,\n\t\t\t});\n\t\t}\n\t\telse\n\t\t{\n\t\t\tconsole.error(ex);\n\t\t}\n\t}\n\n\t#getManyVotes(entityIds: Array<number>): Promise\n\t{\n\t\treturn ajax.runAction('vote.AttachedVote.getMany', {\n\t\t\tdata: {\n\t\t\t\t...this.#getEntityParams(),\n\t\t\t\tentityIds,\n\t\t\t},\n\t\t});\n\t}\n\n\t#setLoading(voteIds: Array<string>, isLoading: boolean): void\n\t{\n\t\tvoteIds.forEach((voteId) => {\n\t\t\tthis.#app.getStore().dispatch('vote/setLoadingStatus', {\n\t\t\t\tisLoading,\n\t\t\t\tvoteId,\n\t\t\t});\n\t\t});\n\t}\n\n\tasync sendVote(ballot: Record<number, number[]>, voteId: string, entityId: number): Promise<void>\n\t{\n\t\tthis.#setLoading([voteId], true);\n\t\ttry\n\t\t{\n\t\t\tconst response = await this.#sendBackendVote(ballot, entityId);\n\t\t\tif (!response?.data?.attach)\n\t\t\t{\n\t\t\t\tthis.#setLoading([voteId], false);\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.#updateStore(response.data.attach);\n\t\t}\n\t\tcatch (ex)\n\t\t{\n\t\t\tthis.#setLoading([voteId], false);\n\t\t\tthrow ex;\n\t\t}\n\t}\n\n\tasync revokeVote(entityId: number, voteId: string): Promise<boolean>\n\t{\n\t\tthis.#setLoading([voteId], true);\n\t\ttry\n\t\t{\n\t\t\tconst response = await this.#sendVoteRevokeRequest(entityId);\n\t\t\tthis.#updateStore(response?.data?.attach);\n\n\t\t\treturn true;\n\t\t}\n\t\tcatch (response)\n\t\t{\n\t\t\tthis.#setLoading([voteId], false);\n\t\t\tconsole.error(response.errors[0].code);\n\t\t\tthrow response;\n\t\t}\n\t}\n\n\tcompleteVote(entityId: number): Promise<boolean>\n\t{\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.#sendVoteStopRequest(entityId)\n\t\t\t\t.then(() => {\n\t\t\t\t\tresolve(true);\n\t\t\t\t})\n\t\t\t\t.catch((response) => {\n\t\t\t\t\tconsole.error(response.errors[0].code);\n\t\t\t\t\treject(response);\n\t\t\t\t});\n\t\t});\n\t}\n\n\t#sendVoteStopRequest(entityId: number): Promise<void>\n\t{\n\t\treturn ajax.runAction('vote.AttachedVote.stop', {\n\t\t\tdata: {\n\t\t\t\t...this.#getEntityParams(),\n\t\t\t\tentityId,\n\t\t\t},\n\t\t});\n\t}\n\n\t#sendVoteRevokeRequest(entityId: number): Promise\n\t{\n\t\treturn ajax.runAction('vote.AttachedVote.recall', {\n\t\t\tdata: {\n\t\t\t\t...this.#getEntityParams(),\n\t\t\t\tentityId,\n\t\t\t},\n\t\t});\n\t}\n\n\t#sendBackendVote(ballot: Record<number, number[]>, entityId: number): Promise\n\t{\n\t\treturn ajax.runAction('vote.AttachedVote.vote', {\n\t\t\tdata: {\n\t\t\t\t...this.#getEntityParams(),\n\t\t\t\tentityId,\n\t\t\t\tballot,\n\t\t\t},\n\t\t});\n\t}\n\n\t#getEntityParams(): EntityAuthParams\n\t{\n\t\treturn {\n\t\t\tmoduleId: BackendModuleId,\n\t\t\tentityType: BackendEntityType,\n\t\t};\n\t}\n\n\t#updateStore(payload: ?BackendVote): void\n\t{\n\t\tif (!payload)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#app.getStore().dispatch('vote/setCurrentUserVotes', payload.userAnswerMap);\n\t\tthis.#app.getStore().dispatch('vote/addVote', payload);\n\t\tthis.#app.getStore().dispatch('vote/addQuestion', payload.QUESTIONS);\n\t\tthis.#app.getStore().dispatch('vote/addAnswer', payload.QUESTIONS);\n\t}\n}\n"],"names":["BackendModuleId","BackendEntityType","ImVoteService","init","getInstance","instance","constructor","VoteApplication","subscribe","data","entityIds","voteIds","sendVote","ballot","voteId","entityId","response","attach","ex","revokeVote","console","error","errors","code","completeVote","Promise","resolve","reject","then","catch","items","forEach","item","handleLoadError","Type","isObject","isArrayFilled","content","message","UI","Notification","Center","notify","autoHideDelay","ajax","runAction","isLoading","getStore","dispatch","moduleId","entityType","payload","userAnswerMap","QUESTIONS"],"mappings":"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"}