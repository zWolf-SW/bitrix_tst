<? namespace Bitrix\Main\Security\W;$GLOBALS['____1418230899']= array(base64_decode('dG'.'ltZQ=='),base64_decode('dGltZQ=='),base64_decode('anNvb'.'l9kZWNvZGU'.'='),base64_decode('YXJyYX'.'lfbWVyZ'.'2'.'U'.'='),base64_decode('am9pbg=='),base64_decode('a'.'m9'.'p'.'bg=='),base64_decode('a'.'m9pbg='.'='),base64_decode('Y'.'XJy'.'Y'.'XlfcG9w'),base64_decode(''.'YXJyYX'.'l'.'fc2hpZnQ='),base64_decode(''.'YX'.'JyYXlfc'.'2'.'hpZnQ='),base64_decode('YX'.'J'.'y'.'YXlfc2hpZnQ='),base64_decode(''.'YXJyYXlfc2h'.'pZnQ'.'='),base64_decode('YX'.'J'.'yYX'.'lfb'.'WVy'.'Z2'.'U='),base64_decode('aXNfYX'.'JyYX'.'k'.'='),base64_decode('YXJ'.'yYX'.'lfbWVyZ2U'.'='),base64_decode(''.'a'.'W5'.'fYXJyYXk'.'='),base64_decode('aW'.'5fYX'.'JyYXk'.'='),base64_decode(''.'aW5fYXJyYX'.'k='),base64_decode('aW5fY'.'XJyYX'.'k='),base64_decode('a'.'W5fYXJ'.'yYXk='),base64_decode('d'.'Glt'.'ZQ=='),base64_decode('dGltZQ='.'='),base64_decode(''.'Y'.'XJ'.'yYXlf'.'bWFw'),base64_decode('Z2'.'V'.'0X2xvYWR'.'l'.'ZF9leHRlb'.'nNpb2'.'5z'),base64_decode('anNvbl'.'9l'.'bmNv'.'ZG'.'U'.'='),base64_decode('anNvb'.'l9l'.'bmNvZGU'.'='),base64_decode(''.'cG'.'hwdmVyc2'.'lv'.'bg=='),base64_decode('anNv'.'bl9lbm'.'Nv'.'ZGU='),base64_decode(''.'am9pbg=='));if(!function_exists(__NAMESPACE__.'\\___193120374')){function ___193120374($_1956269982){static $_1970836888= false; if($_1970836888 == false) $_1970836888=array('V1dBTE'.'xfT'.'E9D'.'S'.'w==','c2Vj'.'dXJ'.'pdHk'.'=','RE'.'F'.'UQQ==','eyI=',''.'V1dBTEx'.'f'.'TE'.'9DSw='.'=','c2VjdXJ'.'pdHk'.'=','U0'.'VDVVJJVFl'.'fV'.'1d'.'BTExfRV'.'hDRVBUSU9O','RkFJTF9DSEVDS0l'.'O'.'Rw==','Q'.'2FuIG'.'5vdCB'.'leGVjd'.'X'.'R'.'lIHd3'.'YWxsIHJ1bGVzOiA=','IFRyY'.'WNlOiA=','UkVRVU'.'VTV'.'F9VUkk=','a2V5c'.'w==','dm'.'FsdW'.'Vz','U'.'0VDV'.'VJJVFl'.'f'.'V1dB'.'TEx'.'fTU9E'.'SUZZ','L'.'g==','U0VDVVJJVFlf'.'V1dBTE'.'xfVU5TRVQ=','Lg==','U0VDVVJJVF'.'lfV1'.'dBT'.'ExfR'.'VhJVA==','Lg='.'=','Z'.'2xvYm'.'Fs','a2V'.'5cw'.'='.'=','d'.'mFsdW'.'Vz','Z'.'2V0','Z2V0','cG9z'.'dA='.'=','cG9z'.'dA==','Y29va2ll','Y2'.'9'.'va2l'.'l','cmVx'.'dW'.'VzdA==',''.'cmVx'.'d'.'WVzdA==','Z2xvYmF'.'s','Z2xvYm'.'Fs','b'.'WFpb'.'l'.'9z'.'ZWM=','V'.'1dBTExfQU'.'NUVUFM'.'S'.'V'.'pFX1JV'.'T'.'E'.'VT','d'.'g='.'=','dmVyc2lvbg==','aQ==','aXNJbnN0YWxsZ'.'WQ'.'=','dg==','a'.'W5p',''.'bW9kdWxlcw==',''.'bGlj'.'Z'.'W5zZQ==','cGh'.'w','dg='.'=',''.'ZXh'.'0','c2'.'Vj'.'dXJp'.'dHk=','Z'.'G'.'I=','dH'.'lw'.'ZQ==','ZGI'.'=','dm'.'Vyc'.'2lvbg='.'=','ZGI=','dHlw'.'ZQ==',''.'ZGI=','d'.'HlwZQ==','dmV'.'yc2lv'.'bg==','Z'.'GI=','dmVyc2lvbg==','ZW52a'.'XJv'.'bm1lbnQ=','dm1fdmVyc2lvbg'.'==','dm0=','dg==','ZW52aXJvbm1lbnQ=','dm1fdmV'.'yc2l'.'vb'.'g==','c29j'.'a2V0'.'VGltZW'.'91dA==','c3RyZW'.'FtVGltZW91dA'.'==',''.'KCc=','ZGF0YQ==','Jyw'.'g'.'J'.'w==','bW9kdWxl','J'.'ywgJ'.'w==','bW9k'.'d'.'WxlX3ZlcnNpb24=',''.'Jy'.'k=','LCA=','U0'.'VDVVJJ'.'VF'.'l'.'fV1dBT'.'E'.'xfRVhDRVBUS'.'U9O','bWF'.'pbg'.'==','RkFJTF'.'9SRUZSR'.'VNI'.'SU'.'5H',''.'Q2'.'FuI'.'G5vdCByZWZyZX'.'NoIHd3YWxs'.'IH'.'J1b'.'GVzOi'.'A=','IFRy'.'YWNlO'.'iA=','ZGF0Y'.'Q'.'==',''.'eyI=','LS0tLS'.'1CRUdJTiBQV'.'UJMSUM'.'gS0'.'VZL'.'S0tLS'.'0=','Ck1JSUJJakF'.'OQ'.'m'.'drcWhra'.'Uc'.'5d'.'z'.'BC'.'QVF'.'FRkFBT0'.'NBU'.'ThB'.'TU'.'lJQ'.'kNnS'.'0NBUUVBc'.'ThR'.'RTB'.'Iam1ISlVT'.'d'.'FdW'.'Nm4wemEKU'.'lZvTHgw'.'Mk'.'t6'.'YmZy'.'YlM'.'v'.'U'.'DZzV2'.'F4VHp3OF'.'NlR1'.'R0'.'Yl'.'RDT3JwS'.'Gk1U'.'UY2T1J5alo'.'vWHh'.'6'.'L0tM'.'V'.'TFHY'.'m9mOU'.'N'.'aM'.'wo'.'0ejdTa3FV'.'dDY'.'2aW'.'JYdk9G'.'Qn'.'g0'.'Z'.'ncvQ'.'VBQUkdEc'.'XR'.'tMG5EM2'.'Z'.'nR3N'.'1M1'.'JlUGd'.'3MjlpO'.'Ct2bTdt'.'d'.'EJLSlVZbDRy'.'ClZ'.'wYjZzZlpF'.'VDlLRWI2VDFI'.'RF'.'ltRX'.'Z'.'j'.'MWhxL2'.'lpdXl4'.'THJaWm'.'k'.'1UTZVZmY'.'0VUV2VE'.'kr'.'Njhzc0ZSa1E'.'r'.'b3d'.'UUnkKZU9'.'JTWJ'.'GaE0vV'.'V'.'RtZlZZ'.'Y'.'lRSRnkyb'.'1V'.'R'.'OFdNem'.'Eybko1U2Foe'.'mkxVUtPMW'.'p'.'BalhUUF'.'Jy'.'emM3QWp1Nj'.'M5a'.'jFPMA'.'pwcH'.'FmbT'.'V'.'4Z1'.'dsRkFKa0'.'hRVGdiZGQ1QV'.'d'.'xREZRa3Q5SEtr'.'WStU'.'bmZ'.'CTEdWTXZW'.'eVB3'.'V'.'E'.'hOV'.'1'.'FZQ'.'Xc0'.'e'.'HBnL'.'3'.'dBClp3SURBU'.'UFCCi0'.'t'.'LS0'.'tRU5EIFBVQkx'.'J'.'QyBLRV'.'k'.'tLS0tLQ==');return base64_decode($_1970836888[$_1956269982]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use Bitrix\Main\License\UrlProvider; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; protected $_330785880= true; public function handle(){ try{  $_1823679911= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_1823679911)){ return;}  $_684631680= Cache::createInstance(); $_59913589= false; if($_684631680->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_1456096909= $_684631680->getVars(); if($GLOBALS['____1418230899'][0]()- $_1456096909> round(0+5+5+5+5)){  $_83546938= Application::getConnection(); $_328892769= RuleRecordTable::getTableName(); $_83546938->truncateTable($_328892769); RuleRecordTable::cleanCache(); $_684631680->clean(___193120374(0), ___193120374(1));}} elseif($_684631680->startDataCache()){  $_684631680->endDataCache($GLOBALS['____1418230899'][1]()); $_59913589= true;} foreach($_1823679911 as $_619688433){ $_1168244265= new PublicKeyCipher; $_1337779483= $_1168244265->decrypt($_619688433[___193120374(2)], static::__492488679()); if(!str_starts_with($_1337779483, ___193120374(3))){ continue;} $_822030147= $GLOBALS['____1418230899'][2]($_1337779483, true); if(!empty($_822030147)){ $_595260875= Rule::make($_822030147); $_1231385006= $this->handleRule($_595260875); $this->applyHandlingResults($_1231385006);}}  if($_59913589){ $_684631680->clean(___193120374(4), ___193120374(5));}} catch(\Throwable $_305818058){ $this->logEvent( ___193120374(6), ___193120374(7), ___193120374(8). $_305818058->getMessage(). ___193120374(9). $_305818058->getTraceAsString());}}  public function handleRule(Rule $_595260875): array{ $_1231385006=[]; if($_595260875->matchPath($_SERVER[___193120374(10)])){  $_125385769= $this->getContextElements($_595260875->getContext()); foreach($_125385769 as $_961049046 => &$_1923269816){ $_1231385006= $GLOBALS['____1418230899'][3]($_1231385006, $this->recursiveContextKeyHandle($_961049046, $_1923269816,[], $_595260875));}} return $_1231385006;}  public function applyHandlingResults(array $_1231385006){ $_125385769= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_1231385006 as $_137625207){ $_1923269816=& $_125385769[$_137625207->getContextName()]; $_1524959755= $_137625207->getRuleResult(); $_595260875= $_137625207->getRule(); if($_1524959755 instanceof ModifyResult){ if($_595260875->getProcess() === ___193120374(11)){  static::rewriteContextKey( $_137625207->getContextName(), $_1923269816, $_137625207->getContextKey(), $_1524959755->getCleanValue());} elseif($_595260875->getProcess() === ___193120374(12)){ static::rewriteContextValue( $_137625207->getContextName(), $_1923269816, $_137625207->getContextKey(), $_1524959755->getCleanValue());} $this->logEvent( ___193120374(13), $_137625207->getContextName(), $GLOBALS['____1418230899'][4](___193120374(14), $_137625207->getContextKey()));} elseif($_1524959755 instanceof CheckResult &&!$_1524959755->isSuccess()){ if($_1524959755->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_137625207->getContextName(), $_1923269816, $_137625207->getContextKey(),); $this->logEvent( ___193120374(15), $_137625207->getContextName(), $GLOBALS['____1418230899'][5](___193120374(16), $_137625207->getContextKey()));} elseif($_1524959755->getAction() === RuleAction::EXIT){ $this->logEvent( ___193120374(17), $_137625207->getContextName(), $GLOBALS['____1418230899'][6](___193120374(18), $_137625207->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_330785880= false;} protected function rewriteContextKey($_961049046, &$_1923269816, $_222741148, $_414373728){ $_1537047229= $_222741148;  $GLOBALS['____1418230899'][7]($_1537047229); $_1537047229[]= $_414373728; if($_961049046 === ___193120374(19)){ $_866563296= $GLOBALS['____1418230899'][8]($_222741148); $GLOBALS['____1418230899'][9]($_1537047229); if(empty($_222741148)){ $GLOBALS[$_414373728]= $GLOBALS[$_866563296]; unset($GLOBALS[$_866563296]);} else{ $_1923269816=& $GLOBALS[$_866563296]; $_1245231548= ArrayHelper::getByNestedKey($_1923269816, $_222741148);  ArrayHelper::setByNestedKey($_1923269816, $_1537047229, $_1245231548);  ArrayHelper::unsetByNestedKey($_1923269816, $_222741148);}} else{ $_1245231548= ArrayHelper::getByNestedKey($_1923269816, $_222741148);  ArrayHelper::setByNestedKey($_1923269816, $_1537047229, $_1245231548);  ArrayHelper::unsetByNestedKey($_1923269816, $_222741148);}} protected function rewriteContextValue($_961049046, &$_1923269816, $_317864328, $_1245231548){ if($_961049046 === 'global'){ $_866563296= $GLOBALS['____1418230899'][10]($_317864328); if(empty($_317864328)){ $GLOBALS[$_866563296]= $_1245231548;} else{ $_1923269816=& $GLOBALS[$_866563296]; ArrayHelper::setByNestedKey($_1923269816, $_317864328, $_1245231548);}} else{  ArrayHelper::setByNestedKey($_1923269816, $_317864328, $_1245231548);}} protected function unsetContextValue($_961049046, &$_1923269816, $_317864328){ if($_961049046 === 'global'){ $_866563296= $GLOBALS['____1418230899'][11]($_317864328); if(empty($_317864328)){ unset($GLOBALS[$_866563296]);} else{ $_1923269816=& $GLOBALS[$_866563296]; ArrayHelper::unsetByNestedKey($_1923269816, $_317864328);}} else{ ArrayHelper::unsetByNestedKey($_1923269816, $_317864328);}}  protected function recursiveContextKeyHandle(string $_961049046, array &$_1923269816, array $_114393942, Rule $_595260875): array{  $_1231385006=[]; foreach($_1923269816 as $_2146483345 => $_1245231548){ $_317864328= $GLOBALS['____1418230899'][12]($_114393942,[$_2146483345]); if($_595260875->matchKey($_317864328)){  if($_595260875->getProcess() === ___193120374(20)){ $_1524959755= $_595260875->evaluate($_2146483345);} elseif($_595260875->getProcess() === ___193120374(21)){ $_1524959755= $_595260875->evaluateValue($_1245231548);}  if(!empty($_1524959755) && $_1524959755 instanceof RuleResult){ $_1231385006[]= new HandlingResult($_961049046, $_317864328, $_1524959755, $_595260875);}}  if($GLOBALS['____1418230899'][13]($_1245231548)){ $_1231385006= $GLOBALS['____1418230899'][14]($_1231385006, $this->recursiveContextKeyHandle( $_961049046, $_1923269816[$_2146483345], $_317864328, $_595260875));}} return $_1231385006;} protected function getContextElements(array $_123079310){ $_728079490=[]; if($GLOBALS['____1418230899'][15](___193120374(22), $_123079310, true)){ $_728079490[___193120374(23)]= &$_GET;} if($GLOBALS['____1418230899'][16](___193120374(24), $_123079310, true)){ $_728079490[___193120374(25)]= &$_POST;} if($GLOBALS['____1418230899'][17](___193120374(26), $_123079310, true)){ $_728079490[___193120374(27)]= &$_COOKIE;} if($GLOBALS['____1418230899'][18](___193120374(28), $_123079310, true)){ $_728079490[___193120374(29)]= &$_REQUEST;} if($GLOBALS['____1418230899'][19](___193120374(30), $_123079310, true)){ $_728079490[___193120374(31)]= $GLOBALS;} return $_728079490;} public static function refreshRules(){ try{ $_2078140672= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____1418230899'][20]()- $_2078140672)< static::CACHE_RULES_TTL){ return;} Option::set(___193120374(32), ___193120374(33), $GLOBALS['____1418230899'][21]()); $_1890628271= null;  $_2034671967= $GLOBALS['____1418230899'][22](function($_1032331937){ return[___193120374(34) => $_1032331937[___193120374(35)], ___193120374(36) => (int) $_1032331937[___193120374(37)]];}, ModuleManager::getModulesFromDisk());  $_25647801=[]; foreach($GLOBALS['____1418230899'][23]() as $_872210080){ $_853208683= new ReflectionExtension($_872210080); $_25647801[$_872210080]=[ ___193120374(38) => $_853208683->getVersion(), ___193120374(39) => $_853208683->getINIEntries()];} $_485751366=[ ___193120374(40) => $GLOBALS['____1418230899'][24]($_2034671967), ___193120374(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___193120374(42) => $GLOBALS['____1418230899'][25]([ ___193120374(43) => $GLOBALS['____1418230899'][26](), ___193120374(44) => $_25647801])]; if(Loader::includeModule(___193120374(45))){ $_1354319002= CSecuritySystemInformation::getSystemInformation(); if(isset($_1354319002[___193120374(46)][___193120374(47)]) && isset($_1354319002[___193120374(48)][___193120374(49)])){ $_485751366[___193120374(50)]=[ ___193120374(51) => $_1354319002[___193120374(52)][___193120374(53)], ___193120374(54) => $_1354319002[___193120374(55)][___193120374(56)]];} if(isset($_1354319002[___193120374(57)][___193120374(58)])){ $_485751366[___193120374(59)]=[___193120374(60) => $_1354319002[___193120374(61)][___193120374(62)]];}}  $_1198645640= new HttpClient([ ___193120374(63) => round(0+1.6666666666667+1.6666666666667+1.6666666666667), ___193120374(64) => round(0+5)]); $_37886811=(new UrlProvider())->getTechDomain(); $_1315318185="https://wwall.{$_37886811}/rules.php"; $_1621122273= $_1198645640->post($_1315318185, $_485751366); if($_1198645640->getStatus() == round(0+200) &&!empty($_1621122273)){ $_1890628271= Json::decode($_1621122273);}  if($_1890628271 !== null){ $_83546938= Application::getConnection(); $_328892769= RuleRecordTable::getTableName(); if(!empty($_1890628271)){ foreach($_1890628271 as $_51220224){ if(!static::checkRuleSign($_51220224)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____1418230899'][27]($_51220224));}}}  $_83546938->truncateTable($_328892769);  if(!empty($_1890628271)){ $_1990985652=[]; foreach($_1890628271 as $_51220224){ $_1990985652[]= ___193120374(65). $_83546938->getSqlHelper()->forSql($_51220224[___193120374(66)]). ___193120374(67). $_83546938->getSqlHelper()->forSql($_51220224[___193120374(68)]). ___193120374(69). $_83546938->getSqlHelper()->forSql($_51220224[___193120374(70)]). ___193120374(71);} $_1392550216= $GLOBALS['____1418230899'][28](___193120374(72), $_1990985652);  $_83546938->query("INSERT INTO {$_328892769} (DATA, MODULE, MODULE_VERSION) VALUES {$_1392550216}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_305818058){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___193120374(73), ___193120374(74), ___193120374(75), ___193120374(76). $_305818058->getMessage(). ___193120374(77). $_305818058->getTraceAsString());}} protected static function checkRuleSign($_595260875){ $_1168244265= new PublicKeyCipher; $_822030147= $_1168244265->decrypt($_595260875[___193120374(78)], static::__492488679()); return str_starts_with($_822030147, ___193120374(79));} private static function __492488679(){ $_183147101= ''; $_183147101 .= ___193120374(80); $_183147101 .= ___193120374(81); return $_183147101;} protected function logEvent($_173275907, $_2127581289, $_1948239962){ if($this->_330785880){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_173275907, 'main', $_2127581289, $_1948239962);}}}?>