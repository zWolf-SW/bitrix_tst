if(!BX.getClass("BX.Bizproc.UserSelector"))(function(e){"use strict";e.namespace("BX.Bizproc");const t=new WeakMap;const i=function(t,i){if(!e.type.isPlainObject(i)){i={}}const s=t.getAttribute("data-config")?e.parseJSON(t.getAttribute("data-config")):null;t.removeAttribute("data-config");if(e.type.isPlainObject(s)){Object.assign(i,s)}this.config=i;this.container=t||e.create("div");this.isOnlyDialogMode=i.isOnlyDialogMode||false;this.multiple=i.multiple||false;this.required=i.required||false;this.additionalFields=e.type.isArray(i.additionalFields)?i.additionalFields:[];this.preloadedItems=e.Type.isArray(i.items)?i.items:[];this.prepareRoles();if(!this.isOnlyDialogMode){this.prepareNodes()}else{this.prepareDialogOnly()}};i.decorateNode=function(e,s){let n=t.get(e);if(!n){n=new i(e,s);t.set(e,n)}return n};i.getByNode=function(e){return t.get(e)};i.prototype={prepareNodes:function(){const t=this.config.value?this.parseValue(this.config.value):[];this.tagSelector=new e.UI.EntitySelector.TagSelector({multiple:this.multiple,addButtonCaption:e.Loc.getMessage("BIZPROC_JS_USER_SELECTOR_CHOOSE"),addButtonCaptionMore:e.Loc.getMessage("BIZPROC_JS_USER_SELECTOR_EDIT"),items:t,tagMaxWidth:184,events:{onTagAdd:e=>this.addItem(e.getData().tag),onTagRemove:e=>this.removeItem(e.getData().tag)},dialogOptions:this.getDialogOptions()});this.container.classList.remove(...this.container.classList);this.container.className="bizproc-type-control-user--width";this.tagSelector.renderTo(this.container);this.createValueNode(this.config.valueInputName||"");this.tagSelector.getTags().forEach((e=>this.addItem(e)))},getDialogOptions(){return{context:"BIZPROC",showCreateButton:false,width:400,tabs:[{id:"bpuserroles",title:e.Loc.getMessage("BIZPROC_JS_USER_SELECTOR_ROLE_TAB")}],entities:[{id:"user",options:{inviteEmployeeLink:false,inviteGuestLink:false,emailUsers:this.config.allowEmailUsers===true,myEmailUsers:this.config.allowEmailUsers===true}},{id:this.config.canUseHumanResources?"structure-node":"department",options:{selectMode:"usersAndDepartments"}},{id:"bpuserroles",name:e.Loc.getMessage("BIZPROC_JS_USER_SELECTOR_ROLE_TAB"),tagOptions:{default:{textColor:"#207976",bgColor:"#ade7e4"},inactive:{textColor:"grey"}}}],items:Object.values(this.roles)}},prepareDialogOnly:function(){const t={events:{"Item:onBeforeSelect":t=>{t.preventDefault();t.getTarget().hide();const i=t.getData().item;const s=this.convertItemToValue(i,i.getEntityId());if(this.config.callbacks&&e.type.isFunction(this.config.callbacks.select)){this.config.callbacks.select(s,this)}}}};this.dialog=new e.UI.EntitySelector.Dialog(Object.assign(this.getDialogOptions(),t));e.bind(this.container,"click",(e=>{e.preventDefault();this.dialog.show()}))},createValueNode:function(t){this.valueNode=e.create("input",{props:{type:"hidden",name:t}});this.container.appendChild(this.valueNode)},addItem:function(e){this.setValue(e)},toggleItem:function(e){if(!this.tagSelector){return}const t=this.tagSelector.getTag(e);if(t){this.tagSelector.removeTag(t)}else{this.tagSelector.addTag(e)}},removeItem:function(e){this.unsetValue(e)},destroy:function(){this.tagSelector=null;this.dialog=null;this.container=null;this.valueNode=null},setValue:function(e){const t=this.getValueId(e,e.getEntityId());const i=this.convertItemToValue(e,e.getEntityId());if(!this.multiple){this.valueNode.value=i}else{var s,n=[],o=this.valueNode.value.split(",");for(s=0;s<o.length;++s){if(!o[s]||o[s].indexOf(t)>=0){continue}n.push(o[s])}n.push(i);this.valueNode.value=n.join(",")}},convertItemToValue(e,t){const i=this.getValueId(e,t);const s=i;const n=this.getItemName(e);if(["user","department","structure-node"].includes(t)||t==="bpuserroles"&&s.indexOf("G")===1){return[n,i].join(" ")}if(t==="bpuserroles"&&!s.includes("{")){return n}return s},unsetValue:function(e){const t=this.getValueId(e,e.getEntityId());if(!this.multiple){this.valueNode.value=""}else{const e=[];const i=this.valueNode.value.split(",");for(let s=0;s<i.length;++s){if(!i[s]||i[s].indexOf(t)>=0){continue}e.push(i[s])}this.valueNode.value=e.join(",")}},getValueId(e,t){const i=e.getId().toString();if(t==="user"){return`[${i}]`}if(t==="department"){return`[DR${i}]`}if(t==="structure-node"){return`[HRR${i}]`}if(t==="bpuserroles"&&i.indexOf("G")===0){return`[${i}]`}if(t==="bpuserroles"&&!i.includes("{")){return this.getItemName(e)}return i},getItemName(e){return e.getTitle().replace(/[,\.\_\>\<\"]/g,"")},getValue:function(){return this.valueNode.value},parseValue(t){const i=this.prepareValueString(t).split(",");const s=[];i.forEach((t=>{const i=t.trim();let n=i.match(/(.*)\[([A-Z]{0,2})(\d+)]/);if(n){const t=n[3];const i=n[2];const o=i!=="G";let r=i+t;let a=i===""?"user":"bpuserroles";if(a==="user"&&r[0]==="U"){r=r.replace("U","")}if(i==="DR"){a="department";r=r.replace("DR","")}if(o){r=e.Text.toInteger(r)}const l=this.preloadedItems.find((e=>e.id===r&&e.entityId===a));s.push(l||{id:r,entityId:a,title:n[1].trim()});return}n=i.match(/(.*)\[HRR(\d+)]/);if(n){const t=e.Text.toInteger(n[2]);const i=this.preloadedItems.find((e=>e.id===t&&e.entityId==="structure-node"));s.push(i||{id:t,entityId:"bpuserroles",title:n[1].trim()});return}if(this.roles[i]){s.push(this.roles[i]);return}if(this.getGroups().length>0){const e=this.getGroups().find((e=>e.name===i));if(e){s.push({id:e.id,entityId:"bpuserroles",title:e.name});return}}s.push({id:i,entityId:"bpuserroles",title:i})}));return s},prepareValueString(t){let i=t.toString();if(i.includes("{{")){const t=e.Bizproc.FieldType.getDocumentFields();t.forEach((e=>{if(e.Type==="user"){i=i.replace(e.Expression,e.SystemExpression)}}))}return i},prepareRoles:function(){var t=e.Bizproc.FieldType.getDocumentFields();var i={};if(this.getGroups().length){this.getGroups().forEach((function(e){i[e["id"]]={id:e["id"],entityId:"bpuserroles",title:e["name"],tabs:"bpuserroles",name:e.name}}))}t.forEach((function(e){if(e["Type"]==="user"){i[e["SystemExpression"]]={id:e["SystemExpression"],entityId:"bpuserroles",title:e["Name"],tabs:"bpuserroles"}}}));this.additionalFields.forEach((function(e){i[e["id"]]={id:e["id"],entityId:e.entityId?String(e.entityId).toLowerCase():"bpuserroles",title:e.title||e.name,tabs:e.tabs||"bpuserroles",sort:e.sort}}));this.roles=i},getGroups:function(){return this.config.groups||e.Bizproc.FieldType.getDocumentUserGroups()}};e.Bizproc.UserSelector=i})(window.BX||window.top.BX);
//# sourceMappingURL=user_selector.map.js