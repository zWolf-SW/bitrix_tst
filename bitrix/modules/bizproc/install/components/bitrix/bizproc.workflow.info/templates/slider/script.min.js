this.BX=this.BX||{};this.BX.Bizproc=this.BX.Bizproc||{};(function(e,s,t,a,i,l){"use strict";var o=babelHelpers.classPrivateFieldLooseKey("NEED_PATTERN");var r=babelHelpers.classPrivateFieldLooseKey("MULTIPLE_WITH_NO_BRACKETS");var n=babelHelpers.classPrivateFieldLooseKey("getFieldId");var d=babelHelpers.classPrivateFieldLooseKey("getFieldValues");var c=babelHelpers.classPrivateFieldLooseKey("isFieldEmpty");var b=babelHelpers.classPrivateFieldLooseKey("isValueEmpty");var u=babelHelpers.classPrivateFieldLooseKey("getPattern");var p=babelHelpers.classPrivateFieldLooseKey("getPatternValues");class f{static checkRequiredFieldsFilled(e,s){const t=[];for(const i of s){const s=babelHelpers.classPrivateFieldLooseBase(this,n)[n](i);const o=babelHelpers.classPrivateFieldLooseBase(this,d)[d](e,i,s);if(!l.Type.isArrayFilled(o)){var a;const s=(a=i.FieldId)!=null?a:i.Id;if(!e.keys().every((e=>!e.includes(s)))){continue}}if(babelHelpers.classPrivateFieldLooseBase(this,c)[c](i,o)){t.push({message:l.Loc.getMessage("BPWFI_SLIDER_ARGUMENT_NULL",{"#PARAM#":i.Name}),fieldId:i.Id})}}return t}}function h(e){let s=l.Type.isNil(e.FieldId)?e.Id:e.FieldId;if(e.Multiple||e.Type==="S:DiskFile"){s=babelHelpers.classPrivateFieldLooseBase(f,r)[r].has(e.Type)?s:`${s}[]`}return s}function v(e,s,t){return babelHelpers.classPrivateFieldLooseBase(f,o)[o].has(s.Type)?babelHelpers.classPrivateFieldLooseBase(this,p)[p](e,babelHelpers.classPrivateFieldLooseBase(this,u)[u](s,t)):e.getAll(t)}function P(e,s){if(e.Multiple||e.Type==="S:DiskFile"||babelHelpers.classPrivateFieldLooseBase(f,o)[o].has(e.Type)){return!l.Type.isArrayFilled(s)||s.every((s=>babelHelpers.classPrivateFieldLooseBase(this,b)[b](e,s)))}return babelHelpers.classPrivateFieldLooseBase(this,b)[b](e,s[0])}function m(e,s){if(e.Type==="file"){return l.Type.isFile(s)&&s.name===""}return!l.Type.isStringFilled(s)}function B(e,s){if(e.Type==="S:HTML"){return e.Multiple?`${s}\\[n\\d+\\]\\[TEXT\\]`:`${s}\\[TEXT\\]`}if(e.Type==="E:EList"){return e.Multiple?`${s}\\[[n]?\\d+\\]\\[VALUE\\]`:`^${s}$`}if(e.Type==="email"||e.Type==="phone"||e.Type==="web"||e.Type==="im"){return`${s}\\[${e.Type.toUpperCase()}\\]\\[n\\d+\\]\\[VALUE\\]`}return""}function F(e,s){const t=[];for(const[a,i]of e.entries()){if(new RegExp(s).test(a)){t.push(i)}}return t}Object.defineProperty(f,p,{value:F});Object.defineProperty(f,u,{value:B});Object.defineProperty(f,b,{value:m});Object.defineProperty(f,c,{value:P});Object.defineProperty(f,d,{value:v});Object.defineProperty(f,n,{value:h});Object.defineProperty(f,o,{writable:true,value:new Set(["S:HTML","email","phone","web","im","E:EList"])});Object.defineProperty(f,r,{writable:true,value:new Set([...babelHelpers.classPrivateFieldLooseBase(f,o)[o],"user","S:employee","sms_sender","mail_sender"])});function y(e,s,t){BX.SidePanel.Instance.postMessage(window,"try-do-bp-task-event",{workflowId:e.get("workflowId")});return new Promise(((a,i)=>{l.ajax.runAction("bizproc.task.do",{data:e}).then((i=>{if(t){BX.SidePanel.Instance.postMessage(s,"success-do-bp-task-event",{taskName:e.get("taskName")})}a(i)})).catch((t=>{BX.SidePanel.Instance.postMessage(s,"error-do-bp-task-event",{workflowId:e.get("workflowId")});i(t)}))}))}let w=e=>e,k;var L=babelHelpers.classPrivateFieldLooseKey("isChanged");var I=babelHelpers.classPrivateFieldLooseKey("messageBox");var g=babelHelpers.classPrivateFieldLooseKey("canClose");var H=babelHelpers.classPrivateFieldLooseKey("workflowResult");var E=babelHelpers.classPrivateFieldLooseKey("canUseHumanResources");var T=babelHelpers.classPrivateFieldLooseKey("renderButtons");var C=babelHelpers.classPrivateFieldLooseKey("handleTaskButtonClick");var S=babelHelpers.classPrivateFieldLooseKey("isNeedValidate");var D=babelHelpers.classPrivateFieldLooseKey("getRequiredFields");var O=babelHelpers.classPrivateFieldLooseKey("getNextTaskOrClose");var R=babelHelpers.classPrivateFieldLooseKey("prepareErrors");var U=babelHelpers.classPrivateFieldLooseKey("handleDelegateButtonClick");var _=babelHelpers.classPrivateFieldLooseKey("delegateTask");var M=babelHelpers.classPrivateFieldLooseKey("sendMarkAsRead");var X=babelHelpers.classPrivateFieldLooseKey("clearError");var A=babelHelpers.classPrivateFieldLooseKey("showErrors");var N=babelHelpers.classPrivateFieldLooseKey("showError");var j=babelHelpers.classPrivateFieldLooseKey("renderNextTask");var x=babelHelpers.classPrivateFieldLooseKey("renderTaskFields");var K=babelHelpers.classPrivateFieldLooseKey("showConfirmDialog");class W{constructor(e){Object.defineProperty(this,K,{value:le});Object.defineProperty(this,x,{value:ie});Object.defineProperty(this,j,{value:ae});Object.defineProperty(this,N,{value:te});Object.defineProperty(this,A,{value:se});Object.defineProperty(this,X,{value:ee});Object.defineProperty(this,M,{value:Y});Object.defineProperty(this,_,{value:Q});Object.defineProperty(this,U,{value:J});Object.defineProperty(this,R,{value:Z});Object.defineProperty(this,O,{value:G});Object.defineProperty(this,D,{value:V});Object.defineProperty(this,S,{value:$});Object.defineProperty(this,C,{value:z});Object.defineProperty(this,T,{value:q});Object.defineProperty(this,L,{writable:true,value:false});Object.defineProperty(this,I,{writable:true,value:void 0});Object.defineProperty(this,g,{writable:true,value:false});Object.defineProperty(this,H,{writable:true,value:null});Object.defineProperty(this,E,{writable:true,value:void 0});this.currentUserId=e.currentUserId;this.workflowId=e.workflowId;this.taskId=e.taskId;this.taskUserId=e.taskUserId;this.taskButtons=e.taskButtons;this.taskForm=e.taskForm;this.taskFields=e.taskFields;this.taskName=e.taskName;this.buttonsPanel=e.buttonsPanel;this.workflowContent=e.workflowContent;this.canDelegateTask=e.canDelegateTask;this.fastClose=e.fastClose;this.saveVariables=e.saveVariables;babelHelpers.classPrivateFieldLooseBase(this,E)[E]=l.Text.toBoolean(e.canUseHumanResources);this.handleMarkAsRead=l.Runtime.debounce(babelHelpers.classPrivateFieldLooseBase(this,M)[M],100,this);babelHelpers.classPrivateFieldLooseBase(this,H)[H]=l.Type.isNil(e.workflowResult)?null:e.workflowResult}init(){if(this.buttonsPanel){babelHelpers.classPrivateFieldLooseBase(this,T)[T]()}this.handleMarkAsRead();s.EventEmitter.subscribe("OnUCCommentWasRead",(e=>{const[s]=e.getData();if(s===`WF_${this.workflowId}`){this.handleMarkAsRead()}}));if(this.taskForm){l.Event.bind(this.taskForm,"change",(()=>{babelHelpers.classPrivateFieldLooseBase(this,L)[L]=true}));l.Event.bind(this.taskForm,"input",(e=>{const s=e.target;if(s.matches("input, textarea, select")){const e=s.closest(".ui-form-content");if(e){babelHelpers.classPrivateFieldLooseBase(this,X)[X](e)}}babelHelpers.classPrivateFieldLooseBase(this,L)[L]=true}));this.taskForm.querySelectorAll(".ui-form-content").forEach((e=>{l.Event.bind(e,"click",(e=>{const s=e.currentTarget;babelHelpers.classPrivateFieldLooseBase(this,X)[X](s)}))}));s.EventEmitter.subscribe("BX.UI.Selector:onChange",(e=>{const s=BX(`crm-${e.data[0].selectorId}-box`);const t=s.closest(".ui-form-content");if(t){babelHelpers.classPrivateFieldLooseBase(this,X)[X](t);babelHelpers.classPrivateFieldLooseBase(this,L)[L]=true}}));s.EventEmitter.subscribe("BX.UI.EntitySelector.Dialog:Item:onSelect",(e=>{if(e.target.context==="BIZPROC"){babelHelpers.classPrivateFieldLooseBase(this,L)[L]=true}}));s.EventEmitter.subscribe("BX.UI.EntitySelector.Dialog:Item:onDeselect",(e=>{if(e.target.context==="BIZPROC"){babelHelpers.classPrivateFieldLooseBase(this,L)[L]=true}}));s.EventEmitter.subscribe("OnIframeKeyup",(e=>{const s=e.target.dom.cont;const t=s.closest(".ui-form-content");if(t){babelHelpers.classPrivateFieldLooseBase(this,X)[X](t)}}));s.EventEmitter.subscribe("OnContentChanged",(e=>{if(e.target.dom.cont.closest(".ui-form-content")){babelHelpers.classPrivateFieldLooseBase(this,L)[L]=true}}));s.EventEmitter.subscribe("BX.Disk.Uploader.Integration:Item:onAdd",(e=>{if(e.target.getUploader().getHiddenFieldsContainer().closest(".ui-form-content")){babelHelpers.classPrivateFieldLooseBase(this,L)[L]=true}}));s.EventEmitter.subscribe("BX.Disk.Uploader.Integration:Item:onRemove",(e=>{if(e.target.getUploader().getHiddenFieldsContainer().closest(".ui-form-content")){babelHelpers.classPrivateFieldLooseBase(this,L)[L]=true}}));s.EventEmitter.subscribe("SidePanel.Slider:onClose",(e=>{if(e.getTarget().getWindow()===window&&babelHelpers.classPrivateFieldLooseBase(this,L)[L]&&!babelHelpers.classPrivateFieldLooseBase(this,g)[g]){var s;e.getCompatData()[0].denyAction();if(!((s=babelHelpers.classPrivateFieldLooseBase(this,I)[I])!=null&&s.getPopupWindow().isShown())){babelHelpers.classPrivateFieldLooseBase(this,K)[K]()}}}))}const e=this.workflowContent.querySelector(".bp-workflow-info__desc-inner");if(e){BX.UI.Hint.init(e)}const t=this.workflowContent.querySelector('[data-role="bp-workflow-result"]');if(t&&babelHelpers.classPrivateFieldLooseBase(this,H)[H]){l.Runtime.loadExtension("bizproc.workflow.result").then((e=>{if(e!=null&&e.WorkflowResult){new e.WorkflowResult(babelHelpers.classPrivateFieldLooseBase(this,H)[H]).renderTo(t)}})).catch((()=>{}))}}}function q(){if(this.taskButtons){l.Dom.clean(this.buttonsPanel);this.taskButtons.forEach((e=>{const s=new a.UserStatus(e.TARGET_USER_STATUS);const i=s.isNo()||s.isCancel();const o=new t.Button({color:i?t.ButtonColor.LIGHT_BORDER:t.ButtonColor.SUCCESS,round:true,size:t.ButtonSize.MEDIUM,text:e.TEXT,onclick:s=>babelHelpers.classPrivateFieldLooseBase(this,C)[C](e,s)});l.Dom.style(o.getContainer(),"minWidth","160px");l.Dom.style(o.getContainer(),"maxWidth","200px");l.Dom.attr(o.getContainer(),"title",e.TEXT);l.Dom.append(o.getContainer(),this.buttonsPanel)}))}if(this.canDelegateTask){const e=new t.Button({color:t.ButtonColor.LINK,size:t.ButtonSize.MEDIUM,text:l.Loc.getMessage("BPWFI_SLIDER_BUTTON_DELEGATE"),onclick:e=>babelHelpers.classPrivateFieldLooseBase(this,U)[U](e)});l.Dom.style(e.getContainer(),"minWidth","160px");l.Dom.style(e.getContainer(),"maxWidth","200px");l.Dom.append(e.getContainer(),this.buttonsPanel)}}function z(e,s){const t=new FormData(this.taskForm);const a=babelHelpers.classPrivateFieldLooseBase(this,S)[S](e.NAME)?f.checkRequiredFieldsFilled(t,babelHelpers.classPrivateFieldLooseBase(this,D)[D]()):[];if(l.Type.isArrayFilled(a)){babelHelpers.classPrivateFieldLooseBase(this,A)[A](a);return}t.append("taskId",this.taskId);t.append("workflowId",this.workflowId);t.append("taskName",this.taskName);t.append(e.NAME,e.VALUE);const i=BX.SidePanel.Instance.getSliderByWindow(window);s.setDisabled(true);if(this.fastClose){babelHelpers.classPrivateFieldLooseBase(this,g)[g]=true;i==null?void 0:i.close();i.setCacheable(true)}y(t,i,this.fastClose).then((()=>{i==null?void 0:i.setCacheable(false);l.Dom.addClass(this.workflowContent,"fade-out");babelHelpers.classPrivateFieldLooseBase(this,O)[O](t)})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,A)[A](babelHelpers.classPrivateFieldLooseBase(this,R)[R](e.errors))})).finally((()=>s.setDisabled(false)))}function $(e){return!(e==="cancel"&&!this.saveVariables)}function V(){if(l.Type.isNil(this.taskFields)){return[]}return this.taskFields.filter((e=>e.Required))}function G(e){l.ajax.runAction("bizproc.task.getUserTaskByWorkflowId",{data:e}).then((e=>{if(BX.type.isArray(e.data.additionalParams)&&e.data.additionalParams.length===0){var s;babelHelpers.classPrivateFieldLooseBase(this,g)[g]=true;(s=BX.SidePanel.Instance.getSliderByWindow(window))==null?void 0:s.close()}else{babelHelpers.classPrivateFieldLooseBase(this,j)[j](e.data)}})).catch((e=>{l.Dom.toggleClass(this.workflowContent,"fade-out fade-in");i.MessageBox.alert(e.errors.pop().message)}))}function Z(e){const s=[];for(const a of e){var t;s.push({fieldId:(t=a.customData)!=null?t:null,message:a.message})}return s}function J(e){e.setDisabled(true);l.Runtime.loadExtension("ui.entity-selector").then((s=>{const{Dialog:t}=s;e.setDisabled(false);const a=new t({targetNode:e.getContainer(),context:"bp-task-delegation",entities:[{id:"user",options:{intranetUsersOnly:true,emailUsers:false,inviteEmployeeLink:false,inviteGuestLink:false}},{id:babelHelpers.classPrivateFieldLooseBase(this,E)[E]?"structure-node":"department",options:{selectMode:"usersOnly"}}],popupOptions:{bindOptions:{forceBindPosition:true}},enableSearch:true,events:{"Item:onSelect":e=>{const s=e.getData().item;babelHelpers.classPrivateFieldLooseBase(this,_)[_](s.getId())},onHide:e=>{e.getTarget().destroy()}},hideOnSelect:true,offsetTop:3,clearUnavailableItems:true,multiple:false});a.show()})).catch((s=>{console.error(s);e.setDisabled(false)}))}function Q(e){const s={taskIds:[this.taskId],fromUserId:this.taskUserId||this.currentUserId,toUserId:e};l.ajax.runAction("bizproc.task.delegate",{data:s}).then((e=>{var s;babelHelpers.classPrivateFieldLooseBase(this,g)[g]=true;(s=BX.SidePanel.Instance.getSliderByWindow(window))==null?void 0:s.close()})).catch((e=>{i.MessageBox.alert(e.errors.pop().message)}))}function Y(){l.ajax.runAction("bizproc.workflow.comment.markAsRead",{data:{workflowId:this.workflowId,userId:this.currentUserId}})}function ee(e){const s=e.querySelector(".ui-form-notice");if(s){BX.Dom.remove(s)}}function se(e){if(BX.type.isArray(e)){const s=[];e.forEach((e=>{const t=e.fieldId;if(this.taskForm&&t){babelHelpers.classPrivateFieldLooseBase(this,N)[N](e.message,t)}else{s.push(e.message)}}));if(s.length>0){i.MessageBox.alert(s.join(", "))}}}function te(e,s){const t=this.taskForm.querySelector(`[data-cid="${s}"]`);if(!t){return}const a=t.querySelector(".ui-form-content");let i=t.querySelector(".ui-form-notice");if(!i){i=BX.Dom.create("div",{attrs:{className:"ui-form-notice"}});i.innerText=e;if(a){BX.Dom.append(i,a)}}}function ae(e){babelHelpers.classPrivateFieldLooseBase(this,L)[L]=false;babelHelpers.classPrivateFieldLooseBase(this,x)[x](e);if(e.additionalParams){this.taskId=e.additionalParams.ID;this.fastClose=e.additionalParams.IS_LAST_TASK_FOR_USER;this.saveVariables=e.additionalParams.saveVariables;this.taskFields=e.additionalParams.FIELDS;const s=this.workflowContent.querySelector(".bp-workflow-info__subject");if(s){s.innerText=e.additionalParams.NAME}const t=this.workflowContent.querySelector(".bp-workflow-info__desc-inner");if(t){const s=t.closest(".bp-workflow-info__tabs-block");if(e.additionalParams.DESCRIPTION.length>0){l.Dom.removeClass(s,"block-hidden")}else{l.Dom.addClass(s,"block-hidden")}t.innerHTML=e.additionalParams.DESCRIPTION;BX.UI.Hint.init(t)}const a=BX.SidePanel.Instance.getSliderByWindow(window);if(a){const e=a.getUrl();const s=e.replace(/\/bizproc\/\d+\//,`/bizproc/${this.taskId}/`);a.setUrl(s);top.history.replaceState({},"",s)}}if(e.additionalParams&&e.additionalParams.BUTTONS){this.taskButtons=e.additionalParams.BUTTONS}this.init();l.Dom.removeClass(this.workflowContent,"fade-out");l.Dom.addClass(this.workflowContent,"fade-in");l.Event.bindOnce(this.workflowContent,"animationend",(()=>{l.Dom.removeClass(this.workflowContent,"fade-in")}))}function ie(e){const s=this.workflowContent.querySelector(".bp-workflow-info__editor");if(BX.type.isArray(e.html)&&e.html.length>0){l.Dom.removeClass(s,"block-hidden");l.Dom.clean(this.taskForm);e.html.forEach(((s,t)=>{var a,i;const o=(a=e.additionalParams)==null?void 0:(i=a.FIELDS)==null?void 0:i[t];if(o){const e=o.Required?"ui-form-label --required":"ui-form-label";const t=l.Tag.render(k||(k=w`
						<div class="ui-form-row" data-cid="${0}">
							<div class="${0}">
								<div class="ui-ctl-label-text">${0}</div>
							</div>
							<div class="ui-form-content"></div>
						</div>
					`),l.Text.encode(o.Id),e,l.Text.encode(o.Name));BX.Runtime.html(t.querySelector(".ui-form-content"),s);this.taskForm.append(t)}}))}else{l.Dom.addClass(s,"block-hidden")}}function le(){babelHelpers.classPrivateFieldLooseBase(this,I)[I]=i.MessageBox.confirm(l.Loc.getMessage("BPWFI_SLIDER_CONFIRM_DESCRIPTION"),l.Loc.getMessage("BPWFI_SLIDER_CONFIRM_TITLE"),(()=>{var e;babelHelpers.classPrivateFieldLooseBase(this,g)[g]=true;(e=BX.SidePanel.Instance.getSliderByWindow(window))==null?void 0:e.close()}),l.Loc.getMessage("BPWFI_SLIDER_CONFIRM_ACCEPT"),(()=>{babelHelpers.classPrivateFieldLooseBase(this,I)[I].close();babelHelpers.classPrivateFieldLooseBase(this,I)[I]=null}),l.Loc.getMessage("BPWFI_SLIDER_CONFIRM_CANCEL"))}e.WorkflowInfo=W})(this.BX.Bizproc.Component=this.BX.Bizproc.Component||{},BX.Event,BX.UI,BX.Bizproc,BX.UI.Dialogs,BX);
//# sourceMappingURL=script.map.js