this.BX=this.BX||{};this.BX.UI=this.BX.UI||{};this.BX.UI.BBCode=this.BX.UI.BBCode||{};(function(e,t,r,a,o,n,s,i){"use strict";function l(e,t=1){const r=[];for(let a=0;a<t;a++){r.push(e.createElement({name:"p"}))}return r}function c(e){return e.getType()!==a.BBCodeNode.ELEMENT_NODE||e.hasGroup("#inline")||e.hasGroup("#inlineBlock")}function d(e,t){const r=[];let a=null;let o=0;for(const n of e){if(t.isNewLine(n)){o++;continue}if(c(n)){if(a===null||o>=2){r.push(...l(t,o-2));a=t.createElement({name:"p"});r.push(a)}else if(o===1){a.appendChild(t.createNewLine())}a.appendChild(n)}else{if(o>2){r.push(...l(t,o-2))}r.push(n);a=null}o=0}if(r.length===0){return[t.createElement({name:"p"})]}return r}function u(e){const t=e.getScheme();const r=d(e.getChildren(),t);e.setChildren(r);return e}let m=e=>e,p;class g extends n.NodeFormatter{constructor(e={}){super({name:"#root",convert(){return document.createDocumentFragment()},before({node:e}){return u(e)},after({element:e,formatter:t}){const r=t.getContainerMode();if(r==="void"||r==="collapsed"){const t=i.Tag.render(p||(p=m`<div class="ui-typography-container --${0}"></div>`),r);t.appendChild(e);return t}return e},...e})}}function h(e,t){let r=e;while(r!==null&&r.getType()!==a.BBCodeNode.ROOT_NODE){if(t(r)){return r}r=r.getParent()}return null}var f=babelHelpers.classPrivateFieldLooseKey("smileyParser");class b extends n.NodeFormatter{constructor(e={}){super({name:"#text",convert({node:e}){const r=e.toString({encode:false});if(h(e,(e=>e.getName()==="code"))){return document.createTextNode(r)}const a=babelHelpers.classPrivateFieldLooseBase(this,f)[f].parse(r);if(a.length===0){return document.createTextNode(r)}const o=document.createDocumentFragment();let n=0;for(const e of a){if(n<e.start){const t=document.createTextNode(r.slice(n,e.start));o.appendChild(t)}const a=r.slice(e.start,e.end);const s=t.SmileyManager.get(a);if(s===null){o.appendChild(document.createTextNode(a))}else{o.appendChild(this.createImg(s))}n=e.end}if(n<r.length){const e=document.createTextNode(r.slice(n));o.appendChild(e)}return o},...e});Object.defineProperty(this,f,{writable:true,value:null});babelHelpers.classPrivateFieldLooseBase(this,f)[f]=new t.SmileyParser(t.SmileyManager.getAll())}createImg(e){const t=document.createElement("img");t.src=encodeURI(e.getImage());t.className="ui-typography-smiley";t.alt=e.getTyping();if(e.getWidth()>0&&e.getHeight()>0){t.width=e.getWidth();t.height=e.getHeight()}return t}}class y extends n.NodeFormatter{constructor(e={}){super({name:"#tab",convert({node:e}){if(e.getParent().getName()==="code"){return document.createTextNode(e.toString())}return document.createTextNode(" ")},...e})}}class N extends n.NodeFormatter{constructor(e={}){super({name:"#linebreak",convert({node:e}){return document.createElement("br")},...e})}}function F(e){const t=e.getScheme();e.appendChild(t.createNewLine());return e}class v extends n.NodeFormatter{constructor(e={}){super({name:"p",convert({node:e}){return i.Dom.create({tag:e.getName(),attrs:{className:"ui-typography-paragraph"}})},before({node:e}){return F(e)},...e})}}class T extends n.NodeFormatter{constructor(e={}){super({name:"b",convert({node:e}){return i.Dom.create({tag:"b",attrs:{...e.getAttributes(),className:"ui-typography-text-bold"}})},...e})}}class x extends n.NodeFormatter{constructor(e={}){super({name:"u",convert({node:e}){return i.Dom.create({tag:"u",attrs:{...e.getAttributes(),className:"ui-typography-text-underline"}})},...e})}}class A extends n.NodeFormatter{constructor(e={}){super({name:"i",convert({node:e}){return i.Dom.create({tag:"i",attrs:{...e.getAttributes(),className:"ui-typography-text-italic"}})},...e})}}class C extends n.NodeFormatter{constructor(e={}){super({name:"s",convert({node:e}){return i.Dom.create({tag:"s",attrs:{...e.getAttributes(),className:"ui-typography-text-strikethrough"}})},...e})}}class L extends n.NodeFormatter{constructor(e={}){super({name:"table",convert(){return i.Dom.create({tag:"table",attrs:{classname:"ui-typography-table"}})},...e})}}class S extends n.NodeFormatter{constructor(e={}){super({name:"th",convert(){return i.Dom.create({tag:"th",attrs:{classname:"ui-typography-table-cell ui-typography-table-cell-header"}})},before({node:e}){return u(e)},...e})}}class D extends n.NodeFormatter{constructor(e={}){super({name:"td",convert(){return i.Dom.create({tag:"td",attrs:{classname:"ui-typography-table-cell"}})},before({node:e}){return u(e)},...e})}}class B extends n.NodeFormatter{constructor(e={}){super({name:"tr",convert(){return i.Dom.create({tag:"tr",attrs:{classname:"ui-typography-table-row"}})},...e})}}class w extends n.NodeFormatter{constructor(e){super({name:"list",convert({node:e}){const t=e.getValue()==="1"?"ol":"ul";return i.Dom.create({tag:t,attrs:{...e.getAttributes(),className:`ui-typography-${t}`}})},...e})}}class I extends n.NodeFormatter{constructor(e){super({name:"*",convert({node:e}){return i.Dom.create({tag:"li",attrs:{...e.getAttributes(),className:"ui-typography-li"}})},...e})}}class P extends n.NodeFormatter{constructor(e={}){super({name:"quote",convert(){return i.Dom.create({tag:"blockquote",attrs:{className:"ui-typography-quote"}})},before({node:e}){return u(e)},...e})}}var E=babelHelpers.classPrivateFieldLooseKey("codeParser");class M extends n.NodeFormatter{constructor(e={}){super({name:"code",before({node:e}){return F(e)},convert({node:e}){const t=e.getTextContent();return i.Dom.create({tag:"code",attrs:{className:"ui-typography-code"},dataset:{decorator:true},children:k(babelHelpers.classPrivateFieldLooseBase(this,E)[E].parse(t))})},...e});Object.defineProperty(this,E,{writable:true,value:new r.CodeParser})}}function k(e){const t=[];e.forEach((e=>{const r=e.content.split(/([\t\n])/);const a=r.length;for(let o=0;o<a;o++){const a=r[o];if(a==="\n"||a==="\r\n"){t.push(document.createElement("br"))}else if(a==="\t"){t.push(document.createTextNode("\t"))}else if(a.length>0){const r=document.createElement("span");r.className=`ui-typography-token-${e.type}`;r.textContent=a;t.push(r)}}}));return t}class H extends n.NodeFormatter{constructor(e={}){super({name:"url",validate({node:e}){const t=H.fetchNodeValue(e);return!H.startsWithJavascriptScheme(t)},before({node:e,formatter:t}){if(t.isShortLinkEnabled()){const r=e.getChildren().some((e=>e.getName()==="img"));if(!r){const r=e.getScheme();const a=e.getPlainTextLength();const{shortLink:o}=t.getLinkSettings();if(a>o.maxLength){const t=H.fetchNodeValue(e);const a=r.createRoot({children:e.getChildren()});const[n,s]=a.split({offset:o.maxLength-o.lastFragmentLength});const i=s.getPlainTextLength();const l=e.clone();l.setValue(t);if(i>o.lastFragmentLength){l.appendChild(...n.getChildren(),r.createText("..."));const[,e]=s.split({offset:i-o.lastFragmentLength});l.appendChild(...e.getChildren());return l}l.setChildren([...n.getChildren(),r.createText("..."),...s.getChildren()]);return l}}}return e},convert({node:e,formatter:t}){const r=(()=>{const t=e.getValue();if(i.Type.isStringFilled(t)){return t}return e.getContent()})();const a=e.getAttributes();const{defaultTarget:o="_blank",attributes:n}=t.getLinkSettings();return i.Dom.create({tag:"a",attrs:{...a,...n,href:r,target:o,className:"ui-typography-link"}})},...e})}static fetchNodeValue(e){const t=e.getValue();if(i.Type.isStringFilled(t)){return t}return e.toPlainText()}static startsWithJavascriptScheme(e){if(i.Type.isStringFilled(e)){const t=/^[\u0000-\u001F ]*j[\t\n\r]*a[\t\n\r]*v[\t\n\r]*a[\t\n\r]*s[\t\n\r]*c[\t\n\r]*r[\t\n\r]*i[\t\n\r]*p[\t\n\r]*t[\t\n\r]*:/i;return t.test(e)}return false}}class O extends n.NodeFormatter{constructor(e={}){super({name:"spoiler",convert({node:e}){const t=e.getValue().trim();const r=i.Type.isStringFilled(t)?t:i.Loc.getMessage("HTML_FORMATTER_SPOILER_TITLE");return i.Dom.create({tag:"details",attrs:{className:"ui-typography-spoiler ui-icon-set__scope"},children:[i.Dom.create({tag:"summary",attrs:{className:"ui-typography-spoiler-title"},text:r})]})},before({node:e}){return u(e)},after({element:e}){const[t,...r]=e.children;e.appendChild(t);e.appendChild(i.Dom.create({tag:"div",attrs:{className:"ui-typography-spoiler-content"},dataset:{spoilerContent:"true"},children:[...r]}));return e},...e})}}class V extends n.NodeFormatter{constructor(e){super({name:"user",convert({node:e,formatter:t}){var r;const a=t.getMentionSettings();if(i.Type.isStringFilled(a==null?void 0:(r=a.urlTemplate)==null?void 0:r.user)){const t=a.urlTemplate.user;const r=t.replaceAll("#ID#",e.getValue());return i.Dom.create({tag:"a",attrs:{href:r,className:"ui-typography-mention"},dataset:{mentionEntityId:"user",mentionId:e.getValue()}})}return i.Dom.create({tag:"span",attrs:{className:"ui-typography-mention"},dataset:{mentionEntityId:"user",mentionId:e.getValue()}})},...e})}}class j extends n.NodeFormatter{constructor(e={}){super({name:"department",convert({node:e,formatter:t}){var r;const a=t.getMentionSettings();if(i.Type.isStringFilled(a==null?void 0:(r=a.urlTemplate)==null?void 0:r.department)){const t=a.urlTemplate.department;const r=t.replaceAll("#ID#",e.getValue());return i.Dom.create({tag:"a",attrs:{href:r,className:"ui-typography-mention"},dataset:{mentionEntityId:"department",mentionId:e.getValue()}})}return i.Dom.create({tag:"span",attrs:{className:"ui-typography-mention"},dataset:{mentionEntityId:"department",mentionId:e.getValue()}})},...e})}}class U extends n.NodeFormatter{constructor(e={}){super({name:"project",convert({node:e,formatter:t}){var r;const a=t.getMentionSettings();if(i.Type.isStringFilled(a==null?void 0:(r=a.urlTemplate)==null?void 0:r.project)){const t=a.urlTemplate.project;const r=t.replaceAll("#group_id#",e.getValue());return i.Dom.create({tag:"a",attrs:{href:r,className:"ui-typography-mention"},dataset:{mentionEntityId:"project",mentionId:e.getValue()}})}return i.Dom.create({tag:"span",attrs:{className:"ui-typography-mention"},dataset:{mentionEntityId:"project",mentionId:e.getValue()}})},...e})}}function _({src:e,width:t,height:r}){return i.Dom.create({tag:"span",attrs:{className:"ui-typography-image-container"},dataset:{decorator:true},children:[i.Dom.create({tag:"img",attrs:{src:e,className:"ui-typography-image",width:t,loading:"lazy"},style:{aspectRatio:t>0&&r>0?`${t} / ${r}`:"auto"},events:{error:e=>{const t=e.target;t.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";i.Dom.addClass(t.parentNode,"--error ui-icon-set__scope")}}})]})}function $(e){return/^(http:|https:|ftp:|\/)/i.test(e)}class R extends n.NodeFormatter{constructor(e={}){super({name:"img",convert({node:e}){const t=e.getContent().trim();let r=Number(e.getAttribute("width"));let a=Number(e.getAttribute("height"));r=i.Type.isNumber(r)&&r>0?Math.round(r):null;a=i.Type.isNumber(a)&&a>0?Math.round(a):null;if($(t)){return _({src:t,width:r,height:a})}return document.createTextNode(e.toString())},...e})}}function X({url:e,width:t,height:r,type:a}){const o=i.Dom.create({tag:"video",attrs:{controls:true,className:"ui-typography-video-object",preload:"metadata",playsinline:true,src:e,width:t},dataset:{decorator:true},style:{aspectRatio:t>0&&r>0?`${t} / ${r}`:"auto"}});return i.Dom.create({tag:"span",attrs:{className:"ui-typography-video-container"},dataset:{decorator:true},children:[o]})}const K=/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g;const z=/^(?:(?:https?|ftps?|mailto):|[^a-z]|[+.a-z-]+(?:[^+.:a-z-]|$))/i;function W(e){if(!i.Type.isStringFilled(e)){return""}const t=e.replaceAll(K,"");return z.test(t)?t:""}function G(e){return/^(http:|https:|\/)/i.test(e)}class q extends n.NodeFormatter{constructor(e={}){super({name:"video",convert({node:e}){const t=W(e.getContent().trim());if(!G(t)){return document.createTextNode(e.toString())}let r=Number(e.getAttribute("width"));let a=Number(e.getAttribute("height"));r=i.Type.isNumber(r)&&r>0?Math.round(r):560;a=i.Type.isNumber(a)&&a>0?Math.round(a):315;const n=/^https?:/.test(t)?t:`https://${t.replace(/^\/\//,"")}`;const s=new i.Uri(n);const l=o.VideoService.createByHost(s.getHost())!==null;if(l){const e=i.Dom.create({tag:"iframe",attrs:{src:t,className:"ui-typography-video-object",width:r,height:"auto",frameborder:0,allowfullscreen:true},style:{aspectRatio:`${r} / ${a}`}});return i.Dom.create({tag:"span",attrs:{className:"ui-typography-video-container"},dataset:{decorator:true},children:[e]})}return X({url:n,width:r,height:a})},...e})}}class J extends n.NodeFormatter{constructor(e={}){const t=e.formatter;const r=t.getFileMode();super({name:r||"__unknown__",convert({node:e,data:t}){var a;if(r===null){return e}const o=e.getAttribute("id");const n=()=>document.createTextNode(e.toString());if(!i.Type.isStringFilled(o)||r==="disk"&&!/^n?\d+$/i.test(o)||r==="file"&&!/^(\d+|[\da-f-]{36}\.[\da-f]{32,})$/i.test(o)){return n()}const s=t==null?void 0:(a=t.files)==null?void 0:a.find((e=>e.serverFileId.toString()===o.toString()));if(!s){return n()}if(s.isImage){let t=i.Text.toInteger(e.getAttribute("width"));let r=i.Text.toInteger(e.getAttribute("height"));t=i.Type.isNumber(t)&&t>0?Math.round(t):s.serverPreviewWidth;r=i.Type.isNumber(r)&&r>0?Math.round(r):s.serverPreviewHeight;return _({width:t,height:r,src:s.serverPreviewUrl})}if(s.isVideo){let t=Number(e.getAttribute("width"));let r=Number(e.getAttribute("height"));t=i.Type.isNumber(t)&&t>0?Math.round(t):600;r=i.Type.isNumber(r)&&r>0?Math.round(r):null;return X({url:s.downloadUrl,width:t,height:r})}return i.Dom.create({tag:"a",attrs:{href:s.downloadUrl,className:"ui-typography-link"},text:s.name||"unknown",dataset:{fileId:s.serverFileId,fileInfo:JSON.stringify(s)}})},...e})}}var Q=Object.freeze({RootNodeFormatter:g,TextNodeFormatter:b,TabNodeFormatter:y,LinebreakNodeFormatter:N,ParagraphNodeFormatter:v,BoldNodeFormatter:T,UnderlineNodeFormatter:x,ItalicNodeFormatter:A,StrikethroughNodeFormatter:C,TableNodeFormatter:L,TableHeadCellNodeFormatter:S,TableDataCellNodeFormatter:D,TableRowNodeFormatter:B,ListNodeFormatter:w,ListItemNodeFormatter:I,QuoteNodeFormatter:P,CodeNodeFormatter:M,LinkNodeFormatter:H,SpoilerNodeFormatter:O,UserNodeFormatter:V,DepartmentNodeFormatter:j,ProjectNodeFormatter:U,ImageNodeFormatter:R,VideoNodeFormatter:q,FileNodeFormatter:J});const Y=i.Extension.getSettings("ui.bbcode.formatter.html-formatter");var Z=babelHelpers.classPrivateFieldLooseKey("linkSettings");var ee=babelHelpers.classPrivateFieldLooseKey("mentionSettings");var te=babelHelpers.classPrivateFieldLooseKey("fileMode");var re=babelHelpers.classPrivateFieldLooseKey("containerMode");var ae=babelHelpers.classPrivateFieldLooseKey("isVoidElement");class oe extends n.Formatter{constructor(e={}){super();Object.defineProperty(this,ae,{value:ne});Object.defineProperty(this,Z,{writable:true,value:void 0});Object.defineProperty(this,ee,{writable:true,value:void 0});Object.defineProperty(this,te,{writable:true,value:void 0});Object.defineProperty(this,re,{writable:true,value:void 0});this.setLinkSettings({...Y.linkSettings,...e.linkSettings});this.setMentionSettings({...Y.mention,...e.mention});babelHelpers.classPrivateFieldLooseBase(this,te)[te]=["file","disk"].includes(e.fileMode)?e.fileMode:null;const t=Object.values(Q).map((e=>new e({formatter:this})));this.setContainerMode(e.containerMode);this.setNodeFormatters(t);this.setNodeFormatters(e.formatters)}isShortLinkEnabled(){const{shortLink:e}=this.getLinkSettings();return i.Type.isPlainObject(e)&&e.enabled===true&&i.Type.isInteger(e.maxLength)}setLinkSettings(e){babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]={...e}}getLinkSettings(){return babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]}getFileMode(){return babelHelpers.classPrivateFieldLooseBase(this,te)[te]}setMentionSettings(e){babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]={...e}}getMentionSettings(){return babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]}setContainerMode(e){babelHelpers.classPrivateFieldLooseBase(this,re)[re]=e}getContainerMode(){return babelHelpers.classPrivateFieldLooseBase(this,re)[re]}isElement(e){if(e.nodeType===Node.DOCUMENT_FRAGMENT_NODE){return true}if(e.nodeType!==Node.ELEMENT_NODE||babelHelpers.classPrivateFieldLooseBase(this,ae)[ae](e)){return false}return i.Type.isUndefined(e.dataset.decorator)}getDefaultUnknownNodeCallback(e){return()=>new n.NodeFormatter({name:"unknown",before({node:e}){const t=e.getScheme();if(e.isVoid()){return t.createFragment({children:[t.createText(e.getOpeningTag())]})}return t.createFragment({children:[t.createText(e.getOpeningTag()),...e.getChildren(),t.createText(e.getClosingTag())]})},convert(){return document.createDocumentFragment()}})}}function ne(e){return["img","br","hr","input"].includes(e.tagName.toLowerCase())}const se={props:{bbcode:{type:String,default:""},options:{type:Object,default:undefined},formatData:{type:Object,default:()=>({})}},beforeCreate(){this.htmlFormatter=null},mounted(){this.format()},unmounted(){this.htmlFormatter=null},watch:{bbcode(){this.format()},formatData(){this.format()}},methods:{format(){const e=this.getHtmlFormatter().format({source:this.bbcode,data:this.formatData});i.Dom.clean(this.$el);i.Dom.append(e,this.$el)},getHtmlFormatter(){var e;(e=this.htmlFormatter)!=null?e:this.htmlFormatter=new oe(this.options);return this.htmlFormatter}},template:`\n\t\t<div class="ui-typography-container"></div>\n\t`};e.HtmlFormatter=oe;e.HtmlFormatterComponent=se})(this.BX.UI.BBCode.Formatter=this.BX.UI.BBCode.Formatter||{},BX.UI.Smiley,BX.UI.CodeParser,BX.UI.BBCode,BX.UI.VideoService,BX.UI.BBCode,window,BX);
//# sourceMappingURL=html-formatter.bundle.map.js