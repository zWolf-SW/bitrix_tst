this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,t,i,s,o,r){"use strict";class n{constructor(){this.store=null;this.restClient=null;this.limitPerPage=50;this.isLoading=false;this.lastId=0;this.lastType=0;this.hasMoreItemsToLoad=true;this.notificationsToDelete=new Set;this.store=i.Core.getStore();this.restClient=i.Core.getRestClient();this.deleteWithDebounce=t.Runtime.debounce(this.deleteRequest,500,this);this.userManager=new r.UserManager}loadFirstPage(){this.isLoading=true;return this.requestItems({firstPage:true})}loadNextPage(){if(this.isLoading||!this.hasMoreItemsToLoad){return Promise.resolve()}this.isLoading=true;return this.requestItems()}delete(e){this.notificationsToDelete.add(e);this.store.dispatch("notifications/delete",{id:e});this.store.dispatch("notifications/deleteFromSearch",{id:e});this.deleteWithDebounce()}sendConfirmAction(e,t){const i={NOTIFY_ID:e,NOTIFY_VALUE:t};this.store.dispatch("notifications/delete",{id:e});this.restClient.callMethod("im.notify.confirm",i).catch((e=>{console.error("NotificationService: sendConfirmAction error",e.error())}))}async sendQuickAnswer(e){const{id:t,text:i,callbackSuccess:s=()=>{},callbackError:r=()=>{}}=e;try{const e=await this.restClient.callMethod(o.RestMethod.imNotifyAnswer,{notify_id:t,answer_text:i});s(e)}catch(e){console.error("NotificationService: sendQuickAnswer error",e);r()}}deleteRequest(){const e=[...this.notificationsToDelete];this.restClient.callMethod("im.notify.delete",{id:e}).catch((e=>{console.error("NotificationService: deleteRequest error",e.error())}));this.notificationsToDelete.clear()}requestItems({firstPage:e=false}={}){const t={LIMIT:this.limitPerPage,CONVERT_TEXT:"Y"};const i={[o.RestMethod.imNotifyGet]:[o.RestMethod.imNotifyGet,t]};if(e){i[o.RestMethod.imNotifySchemaGet]=[o.RestMethod.imNotifySchemaGet,{}]}else{t.LAST_ID=this.lastId;t.LAST_TYPE=this.lastType}return new Promise((e=>{this.restClient.callBatch(i,(t=>{s.Logger.warn("im.notify.get: result",t);e(this.handleResponse(t))}))}))}handleResponse(e){const t=e[o.RestMethod.imNotifyGet].data();this.hasMoreItemsToLoad=!this.isLastPage(t.notifications);if(t.notifications.length===0){s.Logger.warn("im.notify.get: no notifications",t);return Promise.resolve()}this.lastId=this.getLastItemId(t.notifications);this.lastType=this.getLastItemType(t.notifications);return this.updateModels(t).then((()=>{this.isLoading=false;if(e[o.RestMethod.imNotifySchemaGet]){return e[o.RestMethod.imNotifySchemaGet].data()}return{}}))}updateModels(e){this.userManager.setUsersToModel(e.users);return this.store.dispatch("notifications/initialSet",e)}getLastItemId(e){return e[e.length-1].id}getLastItemType(e){return this.getItemType(e[e.length-1])}getItemType(e){return e.notify_type===o.NotificationTypesCodes.confirm?o.NotificationTypesCodes.confirm:o.NotificationTypesCodes.simple}isLastPage(e){if(!t.Type.isArrayFilled(e)){return true}return e.length<this.limitPerPage}destroy(){s.Logger.warn("Notification service destroyed")}}e.NotificationService=n})(this.BX.Messenger.v2.Service=this.BX.Messenger.v2.Service||{},BX,BX.Messenger.v2.Application,BX.Messenger.v2.Lib,BX.Messenger.v2.Const,BX.Messenger.v2.Lib);
//# sourceMappingURL=notification.bundle.map.js