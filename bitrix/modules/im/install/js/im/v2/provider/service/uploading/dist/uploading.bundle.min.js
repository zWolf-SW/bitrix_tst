this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,s,a,t,l,i,r,o,d,n,c){"use strict";const p=10;var b=babelHelpers.classPrivateFieldLooseKey("uploaderRegistry");var v=babelHelpers.classPrivateFieldLooseKey("onUploadCancelHandler");var F=babelHelpers.classPrivateFieldLooseKey("addFile");var u=babelHelpers.classPrivateFieldLooseKey("onUploadCancel");var h=babelHelpers.classPrivateFieldLooseKey("removeFileFromUploader");class P extends r.EventEmitter{constructor(){super();Object.defineProperty(this,h,{value:f});Object.defineProperty(this,u,{value:L});Object.defineProperty(this,F,{value:g});Object.defineProperty(this,b,{writable:true,value:{}});Object.defineProperty(this,v,{writable:true,value:void 0});this.setEventNamespace(P.eventNamespace);babelHelpers.classPrivateFieldLooseBase(this,v)[v]=babelHelpers.classPrivateFieldLooseBase(this,u)[u].bind(this);r.EventEmitter.subscribe(o.EventType.uploader.cancel,babelHelpers.classPrivateFieldLooseBase(this,v)[v])}createUploader(e){const{diskFolderId:s,uploaderId:a,chatId:t,dialogId:l,autoUpload:i=false,maxParallelLoads:r,maxParallelUploads:o}=e;babelHelpers.classPrivateFieldLooseBase(this,b)[b][a]=new c.Uploader({autoUpload:i,maxParallelLoads:r,maxParallelUploads:o,controller:"disk.uf.integration.diskUploaderController",multiple:true,controllerOptions:{folderId:s,chat:{chatId:t,dialogId:l}},imageResizeWidth:1280,imageResizeHeight:1280,imageResizeMode:"contain",imageResizeFilter:e=>!e.getCustomData("sendAsFile")&&!e.isAnimated(),imageResizeMimeType:"image/jpeg",imageResizeMimeTypeMode:"force",imagePreviewHeight:720,imagePreviewWidth:720,treatOversizeImageAsFile:true,ignoreUnknownImageTypes:true,maxFileSize:null,events:{[c.UploaderEvent.FILE_ADD_START]:e=>{this.emit(P.events.onFileAddStart,{...e.getData(),uploaderId:a})},[c.UploaderEvent.FILE_UPLOAD_START]:e=>{this.emit(P.events.onFileUploadStart,{...e.getData(),uploaderId:a})},[c.UploaderEvent.FILE_ADD]:e=>{this.emit(P.events.onFileAdd,{...e.getData(),uploaderId:a})},[c.UploaderEvent.FILE_UPLOAD_PROGRESS]:e=>{this.emit(P.events.onFileUploadProgress,{...e.getData(),uploaderId:a})},[c.UploaderEvent.FILE_UPLOAD_COMPLETE]:e=>{this.emit(P.events.onFileUploadComplete,{...e.getData(),uploaderId:a})},[c.UploaderEvent.ERROR]:e=>{this.emit(P.events.onFileUploadError,{...e.getData(),uploaderId:a})},[c.UploaderEvent.FILE_ERROR]:e=>{this.emit(P.events.onFileUploadError,{...e.getData(),uploaderId:a})},[c.UploaderEvent.MAX_FILE_COUNT_EXCEEDED]:e=>{this.emit(P.events.onMaxFileCountExceeded,{...e.getData(),uploaderId:a})},[c.UploaderEvent.UPLOAD_COMPLETE]:e=>{this.emit(P.events.onUploadComplete,{...e.getData(),uploaderId:a})}}})}start(e){babelHelpers.classPrivateFieldLooseBase(this,b)[b][e].setAutoUpload(true);babelHelpers.classPrivateFieldLooseBase(this,b)[b][e].start()}stop(e){babelHelpers.classPrivateFieldLooseBase(this,b)[b][e].stop()}destroyUploader(e){babelHelpers.classPrivateFieldLooseBase(this,b)[b][e].destroy({removeFilesFromServer:false});delete babelHelpers.classPrivateFieldLooseBase(this,b)[b][e]}addFiles(e){const s=e.slice(0,p);const a=[];s.forEach((e=>{const s=babelHelpers.classPrivateFieldLooseBase(this,F)[F](e);if(s){a.push(s)}}));return a}getFiles(e){return babelHelpers.classPrivateFieldLooseBase(this,b)[b][e].getFiles()}destroy(){r.EventEmitter.unsubscribe(o.EventType.uploader.cancel,babelHelpers.classPrivateFieldLooseBase(this,v)[v])}}function g(e){return babelHelpers.classPrivateFieldLooseBase(this,b)[b][e.uploaderId].addFile(e.file,{id:e.tempFileId,customData:{dialogId:e.dialogId,chatId:e.chatId,tempMessageId:e.tempMessageId,sendAsFile:e.sendAsFile}})}function L(e){const{tempFileId:s,tempMessageId:a}=e.getData();if(!s||!a){return}babelHelpers.classPrivateFieldLooseBase(this,h)[h](s);this.emit(P.events.onFileUploadCancel,{tempMessageId:a,tempFileId:s})}function f(e){const s=Object.values(babelHelpers.classPrivateFieldLooseBase(this,b)[b]);for(const a of s){if(!a.getFile){continue}const s=a.getFile(e);if(s){s.remove();break}}}P.eventNamespace="BX.Messenger.v2.Service.Uploading.UploaderWrapper";P.events={onFileAddStart:"onFileAddStart",onFileAdd:"onFileAdd",onFileUploadStart:"onFileUploadStart",onFileUploadProgress:"onFileUploadProgress",onFileUploadComplete:"onFileUploadComplete",onFileUploadError:"onFileUploadError",onFileUploadCancel:"onFileUploadCancel",onMaxFileCountExceeded:"onMaxFileCountExceeded",onUploadComplete:"onUploadComplete"};const H="BX.Messenger.v2.Service.UploadingService";var m=babelHelpers.classPrivateFieldLooseKey("store");var B=babelHelpers.classPrivateFieldLooseKey("restClient");var I=babelHelpers.classPrivateFieldLooseKey("isRequestingDiskFolderId");var y=babelHelpers.classPrivateFieldLooseKey("diskFolderIdRequestPromise");var U=babelHelpers.classPrivateFieldLooseKey("uploaderWrapper");var S=babelHelpers.classPrivateFieldLooseKey("sendingService");var C=babelHelpers.classPrivateFieldLooseKey("uploaderFilesRegistry");var M=babelHelpers.classPrivateFieldLooseKey("queue");var O=babelHelpers.classPrivateFieldLooseKey("isUploading");var D=babelHelpers.classPrivateFieldLooseKey("createUploader");var E=babelHelpers.classPrivateFieldLooseKey("addToQueue");var w=babelHelpers.classPrivateFieldLooseKey("processQueue");var j=babelHelpers.classPrivateFieldLooseKey("addFileFromDiskToModel");var x=babelHelpers.classPrivateFieldLooseKey("initUploader");var K=babelHelpers.classPrivateFieldLooseKey("isMediaFile");var A=babelHelpers.classPrivateFieldLooseKey("setFileMapping");var T=babelHelpers.classPrivateFieldLooseKey("requestDiskFolderId");var k=babelHelpers.classPrivateFieldLooseKey("tryCommit");var _=babelHelpers.classPrivateFieldLooseKey("uploadPreview");var R=babelHelpers.classPrivateFieldLooseKey("prepareFileForUploader");var X=babelHelpers.classPrivateFieldLooseKey("updateFileProgress");var z=babelHelpers.classPrivateFieldLooseKey("cancelUpload");var W=babelHelpers.classPrivateFieldLooseKey("addFileToStore");var N=babelHelpers.classPrivateFieldLooseKey("updateFilePreviewInStore");var q=babelHelpers.classPrivateFieldLooseKey("updateFileSizeInStore");var V=babelHelpers.classPrivateFieldLooseKey("preparePreview");var $=babelHelpers.classPrivateFieldLooseKey("getDiskFolderId");var G=babelHelpers.classPrivateFieldLooseKey("getFileType");var Q=babelHelpers.classPrivateFieldLooseKey("getFileExtension");var Y=babelHelpers.classPrivateFieldLooseKey("getDialog");var Z=babelHelpers.classPrivateFieldLooseKey("getCurrentUser");var J=babelHelpers.classPrivateFieldLooseKey("getChatId");var ee=babelHelpers.classPrivateFieldLooseKey("registerFiles");var se=babelHelpers.classPrivateFieldLooseKey("unregisterFiles");var ae=babelHelpers.classPrivateFieldLooseKey("setPreviewCreatedStatus");var te=babelHelpers.classPrivateFieldLooseKey("setPreviewSentStatus");var le=babelHelpers.classPrivateFieldLooseKey("setMessagesText");var ie=babelHelpers.classPrivateFieldLooseKey("setAutoUpload");var re=babelHelpers.classPrivateFieldLooseKey("createMessagesFromFiles");var oe=babelHelpers.classPrivateFieldLooseKey("createMessageFromFiles");var de=babelHelpers.classPrivateFieldLooseKey("readyToAddMessages");var ne=babelHelpers.classPrivateFieldLooseKey("readyToCommit");var ce=babelHelpers.classPrivateFieldLooseKey("tryToSendMessage");var pe=babelHelpers.classPrivateFieldLooseKey("tryToSendMessages");var be=babelHelpers.classPrivateFieldLooseKey("prepareFileFromDisk");var ve=babelHelpers.classPrivateFieldLooseKey("isMaxFileSizeExceeded");var Fe=babelHelpers.classPrivateFieldLooseKey("setMessageError");var ue=babelHelpers.classPrivateFieldLooseKey("destroyUploader");var he=babelHelpers.classPrivateFieldLooseKey("getBinaryFiles");class Pe extends r.EventEmitter{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}constructor(){super();Object.defineProperty(this,he,{value:ts});Object.defineProperty(this,ue,{value:as});Object.defineProperty(this,Fe,{value:ss});Object.defineProperty(this,ve,{value:es});Object.defineProperty(this,be,{value:Je});Object.defineProperty(this,pe,{value:Ze});Object.defineProperty(this,ce,{value:Ye});Object.defineProperty(this,ne,{value:Qe});Object.defineProperty(this,de,{value:Ge});Object.defineProperty(this,oe,{value:$e});Object.defineProperty(this,re,{value:Ve});Object.defineProperty(this,ie,{value:qe});Object.defineProperty(this,le,{value:Ne});Object.defineProperty(this,te,{value:We});Object.defineProperty(this,ae,{value:ze});Object.defineProperty(this,se,{value:Xe});Object.defineProperty(this,ee,{value:Re});Object.defineProperty(this,J,{value:_e});Object.defineProperty(this,Z,{value:ke});Object.defineProperty(this,Y,{value:Te});Object.defineProperty(this,Q,{value:Ae});Object.defineProperty(this,G,{value:Ke});Object.defineProperty(this,$,{value:xe});Object.defineProperty(this,V,{value:je});Object.defineProperty(this,q,{value:we});Object.defineProperty(this,N,{value:Ee});Object.defineProperty(this,W,{value:De});Object.defineProperty(this,z,{value:Oe});Object.defineProperty(this,X,{value:Me});Object.defineProperty(this,R,{value:Ce});Object.defineProperty(this,_,{value:Se});Object.defineProperty(this,k,{value:Ue});Object.defineProperty(this,T,{value:ye});Object.defineProperty(this,A,{value:Ie});Object.defineProperty(this,K,{value:Be});Object.defineProperty(this,x,{value:me});Object.defineProperty(this,j,{value:He});Object.defineProperty(this,w,{value:fe});Object.defineProperty(this,E,{value:Le});Object.defineProperty(this,D,{value:ge});Object.defineProperty(this,m,{writable:true,value:void 0});Object.defineProperty(this,B,{writable:true,value:void 0});Object.defineProperty(this,I,{writable:true,value:false});Object.defineProperty(this,y,{writable:true,value:{}});Object.defineProperty(this,U,{writable:true,value:void 0});Object.defineProperty(this,S,{writable:true,value:void 0});Object.defineProperty(this,C,{writable:true,value:{}});Object.defineProperty(this,M,{writable:true,value:[]});Object.defineProperty(this,O,{writable:true,value:false});this.setEventNamespace(H);babelHelpers.classPrivateFieldLooseBase(this,m)[m]=a.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,B)[B]=a.Core.getRestClient();babelHelpers.classPrivateFieldLooseBase(this,S)[S]=i.SendingService.getInstance();babelHelpers.classPrivateFieldLooseBase(this,x)[x]()}async uploadFromClipboard(e){const{clipboardEvent:s,dialogId:a,autoUpload:t,imagesOnly:l}=e;const{clipboardData:i}=s;if(!i||!c.isFilePasted(i)){return""}s.preventDefault();let r=await c.getFilesFromDataTransfer(i);if(l){r=r.filter((e=>d.Utils.file.isImage(e.name)));if(l.length===0){return""}}const{uploaderFiles:o,uploaderId:n}=await this.addFiles({files:r,dialogId:a,autoUpload:t});if(o.length===0){return""}return n}async uploadFromInput(e){const{event:s,sendAsFile:a,autoUpload:t,dialogId:l}=e;const i=Object.values(s.target.files);if(i.length===0){return""}const{uploaderId:r}=await this.addFiles({files:i,dialogId:l,autoUpload:t,sendAsFile:a});return r}async uploadFromDragAndDrop(e){const{event:s,dialogId:a,autoUpload:t,sendAsFile:l}=e;s.preventDefault();const i=await c.getFilesFromDataTransfer(s.dataTransfer);if(i.length===0){return""}const{uploaderId:r}=await this.addFiles({files:i,dialogId:a,autoUpload:t,sendAsFile:l});return r}addFiles(e){const{files:s,dialogId:a,autoUpload:t,sendAsFile:l=false,maxParallelUploads:i,maxParallelLoads:r}=e;const o={dialogId:a,autoUpload:t,maxParallelUploads:i,maxParallelLoads:r};return babelHelpers.classPrivateFieldLooseBase(this,D)[D](o).then((e=>{const i=[];s.forEach((s=>{const t=babelHelpers.classPrivateFieldLooseBase(this,R)[R](s,a,e,l);i.push(t)}));const r=babelHelpers.classPrivateFieldLooseBase(this,U)[U].addFiles(i);babelHelpers.classPrivateFieldLooseBase(this,ee)[ee](e,r,a,t);return{uploaderFiles:r,uploaderId:e}}))}getFiles(e){return babelHelpers.classPrivateFieldLooseBase(this,U)[U].getFiles(e)}start(e){babelHelpers.classPrivateFieldLooseBase(this,E)[E](e)}stop(e){babelHelpers.classPrivateFieldLooseBase(this,U)[U].stop(e)}uploadFileFromDisk(e,s){Object.values(e).forEach((e=>{const a=babelHelpers.classPrivateFieldLooseBase(this,be)[be](e,s);babelHelpers.classPrivateFieldLooseBase(this,j)[j](a).then((()=>{const e={tempMessageId:a.tempMessageId,fileIds:[a.tempFileId],dialogId:a.dialogId};return babelHelpers.classPrivateFieldLooseBase(this,S)[S].sendMessageWithFiles(e)})).then((()=>{this.commitFile({chatId:a.chatId,temporaryFileId:a.tempFileId,tempMessageId:a.tempMessageId,realFileId:a.file.id.slice(1),fromDisk:true})})).catch((e=>{console.error("SendingService: sendFilesFromDisk error:",e)}))}))}checkDiskFolderId(e){if(babelHelpers.classPrivateFieldLooseBase(this,$)[$](e)>0){return Promise.resolve(babelHelpers.classPrivateFieldLooseBase(this,$)[$](e))}if(babelHelpers.classPrivateFieldLooseBase(this,I)[I]){return babelHelpers.classPrivateFieldLooseBase(this,y)[y][e]}babelHelpers.classPrivateFieldLooseBase(this,y)[y][e]=babelHelpers.classPrivateFieldLooseBase(this,T)[T](e);return babelHelpers.classPrivateFieldLooseBase(this,y)[y][e]}commitFile(e){const{temporaryFileId:s,tempMessageId:a,chatId:t,realFileId:l,fromDisk:i,messageText:r="",sendAsFile:d=false}=e;const n={};if(i){n.disk_id=l}else{n.upload_id=l.toString().slice(1)}babelHelpers.classPrivateFieldLooseBase(this,B)[B].callMethod(o.RestMethod.imDiskFileCommit,{chat_id:t,message:r,template_id:a,file_template_id:s,as_file:d?"Y":"N",...n}).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,Fe)[Fe](a);babelHelpers.classPrivateFieldLooseBase(this,X)[X](s,0,o.FileStatus.error);console.error("commitFile error",e)}))}commitMessage(e){const s=babelHelpers.classPrivateFieldLooseBase(this,C)[C][e].dialogId;const a=babelHelpers.classPrivateFieldLooseBase(this,J)[J](s);const t=babelHelpers.classPrivateFieldLooseBase(this,U)[U].getFiles(e).map((e=>e.getServerFileId().toString().slice(1)));const l=babelHelpers.classPrivateFieldLooseBase(this,U)[U].getFiles(e).every((e=>e.getCustomData("sendAsFile")));return babelHelpers.classPrivateFieldLooseBase(this,B)[B].callMethod(o.RestMethod.imDiskFileCommit,{chat_id:a,message:babelHelpers.classPrivateFieldLooseBase(this,C)[C][e].text,template_id:babelHelpers.classPrivateFieldLooseBase(this,C)[C][e].tempMessageId,as_file:l?"Y":"N",upload_id:t})}sendSeparateMessagesWithFiles(e){const{uploaderId:s,text:a}=e;babelHelpers.classPrivateFieldLooseBase(this,le)[le](s,a);babelHelpers.classPrivateFieldLooseBase(this,ie)[ie](s,true);babelHelpers.classPrivateFieldLooseBase(this,pe)[pe](s)}sendMessageWithFiles(e){const{uploaderId:s,text:a}=e;babelHelpers.classPrivateFieldLooseBase(this,le)[le](s,a);babelHelpers.classPrivateFieldLooseBase(this,ie)[ie](s,true);babelHelpers.classPrivateFieldLooseBase(this,ce)[ce](s)}getUploaderIdByFileId(e){const s=Object.keys(babelHelpers.classPrivateFieldLooseBase(this,C)[C]);return s.find((s=>this.getFiles(s).some((s=>s.getId()===e))))}removeFileFromUploader(e){const{uploaderId:s,filesIds:a,restartUploading:t=false}=e;const l=babelHelpers.classPrivateFieldLooseBase(this,U)[U].getFiles(s).filter((e=>a.includes(e.getId())));l.forEach((e=>{e.remove();e.abort()}));babelHelpers.classPrivateFieldLooseBase(this,se)[se](s,l);if(t){const[e]=this.getFiles(s);if(e){e.upload()}}}destroy(){babelHelpers.classPrivateFieldLooseBase(this,U)[U].destroy()}async retry(e){const{dialogId:s,text:a,tempMessageId:t}=babelHelpers.classPrivateFieldLooseBase(this,C)[C][e];const l=this.getFiles(e).some((e=>e.getCustomData("sendAsFile")));const i=babelHelpers.classPrivateFieldLooseBase(this,he)[he](e);const{uploaderId:r}=await this.addFiles({dialogId:s,files:i,sendAsFile:l});void babelHelpers.classPrivateFieldLooseBase(this,m)[m].dispatch("messages/delete",{id:t});this.sendMessageWithFiles({uploaderId:r,text:a});babelHelpers.classPrivateFieldLooseBase(this,ue)[ue](e)}}function ge(e){const{dialogId:s,autoUpload:a,maxParallelUploads:t,maxParallelLoads:l}=e;const i=d.Utils.text.getUuidV4();const r=babelHelpers.classPrivateFieldLooseBase(this,J)[J](s);return this.checkDiskFolderId(s).then((e=>{babelHelpers.classPrivateFieldLooseBase(this,U)[U].createUploader({diskFolderId:e,uploaderId:i,autoUpload:a,chatId:r,dialogId:s,maxParallelUploads:t,maxParallelLoads:l});return i}))}function Le(e){babelHelpers.classPrivateFieldLooseBase(this,M)[M].push(e);babelHelpers.classPrivateFieldLooseBase(this,w)[w]()}function fe(){if(babelHelpers.classPrivateFieldLooseBase(this,O)[O]||babelHelpers.classPrivateFieldLooseBase(this,M)[M].length===0){return}babelHelpers.classPrivateFieldLooseBase(this,O)[O]=true;const e=babelHelpers.classPrivateFieldLooseBase(this,M)[M].shift();babelHelpers.classPrivateFieldLooseBase(this,C)[C][e].autoUpload=true;babelHelpers.classPrivateFieldLooseBase(this,U)[U].start(e)}function He(e){return babelHelpers.classPrivateFieldLooseBase(this,m)[m].dispatch("files/add",{id:e.tempFileId,chatId:e.chatId,authorId:a.Core.getUserId(),name:e.file.name,type:d.Utils.file.getFileTypeByExtension(e.file.ext),extension:e.file.ext,size:e.file.sizeInt,status:o.FileStatus.wait,progress:0,authorName:babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]().name})}function me(){babelHelpers.classPrivateFieldLooseBase(this,U)[U]=new P;babelHelpers.classPrivateFieldLooseBase(this,U)[U].subscribe(P.events.onFileAddStart,(e=>{const{file:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,W)[W](s)}));babelHelpers.classPrivateFieldLooseBase(this,U)[U].subscribe(P.events.onFileAdd,(e=>{const{file:s,uploaderId:a}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,N)[N](s);babelHelpers.classPrivateFieldLooseBase(this,ae)[ae](a,s.getId());babelHelpers.classPrivateFieldLooseBase(this,ce)[ce](a)}));babelHelpers.classPrivateFieldLooseBase(this,U)[U].subscribe(P.events.onFileUploadStart,(e=>{const{file:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,q)[q](s);this.emit(Pe.event.uploadStart)}));babelHelpers.classPrivateFieldLooseBase(this,U)[U].subscribe(P.events.onFileUploadProgress,(e=>{const{file:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,X)[X](s.getId(),s.getProgress(),o.FileStatus.upload)}));babelHelpers.classPrivateFieldLooseBase(this,U)[U].subscribe(P.events.onFileUploadComplete,(async e=>{const{file:s,uploaderId:a}=e.getData();const t=s.getServerFileId().toString().slice(1);const l=s.getId();if(babelHelpers.classPrivateFieldLooseBase(this,K)[K](l)){babelHelpers.classPrivateFieldLooseBase(this,A)[A]({serverFileId:t,temporaryFileId:l})}babelHelpers.classPrivateFieldLooseBase(this,X)[X](l,s.getProgress(),o.FileStatus.wait);await babelHelpers.classPrivateFieldLooseBase(this,_)[_](s);babelHelpers.classPrivateFieldLooseBase(this,te)[te](a,l);void babelHelpers.classPrivateFieldLooseBase(this,k)[k](a);this.emit(Pe.event.uploadComplete)}));babelHelpers.classPrivateFieldLooseBase(this,U)[U].subscribe(P.events.onFileUploadError,(e=>{const{file:s,error:a,uploaderId:i}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,Fe)[Fe](s.getCustomData("tempMessageId"));this.getFiles(i).forEach((e=>{babelHelpers.classPrivateFieldLooseBase(this,X)[X](e.getId(),0,o.FileStatus.error)}));if(babelHelpers.classPrivateFieldLooseBase(this,ve)[ve](a)){l.Notifier.file.handleUploadError(a)}t.Logger.error("UploadingService: upload error",a);this.emit(Pe.event.uploadError);babelHelpers.classPrivateFieldLooseBase(this,O)[O]=false;babelHelpers.classPrivateFieldLooseBase(this,w)[w]();this.stop(i)}));babelHelpers.classPrivateFieldLooseBase(this,U)[U].subscribe(P.events.onFileUploadCancel,(e=>{const{tempMessageId:s,tempFileId:a}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,z)[z](s,a);this.emit(Pe.event.uploadCancel)}));babelHelpers.classPrivateFieldLooseBase(this,U)[U].subscribe(P.events.onUploadComplete,(()=>{babelHelpers.classPrivateFieldLooseBase(this,O)[O]=false;babelHelpers.classPrivateFieldLooseBase(this,w)[w]()}))}function Be(e){const s=[o.FileType.image,o.FileType.video];const a=babelHelpers.classPrivateFieldLooseBase(this,m)[m].getters["files/get"](e);return Boolean(a)&&s.includes(a.type)}function Ie(e){void babelHelpers.classPrivateFieldLooseBase(this,m)[m].dispatch("files/setTemporaryFileMapping",e)}function ye(e){return new Promise(((s,a)=>{babelHelpers.classPrivateFieldLooseBase(this,I)[I]=true;const t=babelHelpers.classPrivateFieldLooseBase(this,J)[J](e);babelHelpers.classPrivateFieldLooseBase(this,B)[B].callMethod(o.RestMethod.imDiskFolderGet,{chat_id:t}).then((a=>{const{ID:t}=a.data();babelHelpers.classPrivateFieldLooseBase(this,I)[I]=false;void babelHelpers.classPrivateFieldLooseBase(this,m)[m].dispatch("chats/update",{dialogId:e,fields:{diskFolderId:t}});s(t)})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,I)[I]=false;a(e)}))}))}async function Ue(e){if(!babelHelpers.classPrivateFieldLooseBase(this,ne)[ne](e)){return}await this.commitMessage(e);babelHelpers.classPrivateFieldLooseBase(this,ue)[ue](e)}async function Se(e){const a=babelHelpers.classPrivateFieldLooseBase(this,G)[G](e.getBinary())===o.FileType.video||e.isAnimated();if(!a){return Promise.resolve()}const t=e.getServerFileId().toString().slice(1);const l=e.getClientPreview();if(!l){e.setCustomData("sendAsFile",true);return Promise.resolve()}const i=new FormData;i.append("id",t);i.append("previewFile",l,`preview_${e.getName()}.jpg`);return s.runAction(o.RestMethod.imDiskFilePreviewUpload,{data:i}).catch((([e])=>{console.error("imDiskFilePreviewUpload request error",e)}))}function Ce(e,s,a,t){const l=d.Utils.text.getUuidV4();const i=d.Utils.text.getUuidV4();const r=babelHelpers.classPrivateFieldLooseBase(this,J)[J](s);return{tempMessageId:l,tempFileId:i,file:e,dialogId:s,chatId:r,uploaderId:a,sendAsFile:t}}function Me(e,s,a){void babelHelpers.classPrivateFieldLooseBase(this,m)[m].dispatch("files/update",{id:e,fields:{progress:s===100?99:s,status:a}})}function Oe(e,s){const a=babelHelpers.classPrivateFieldLooseBase(this,m)[m].getters["messages/getById"](e);if(a){void babelHelpers.classPrivateFieldLooseBase(this,m)[m].dispatch("messages/delete",{id:e});void babelHelpers.classPrivateFieldLooseBase(this,m)[m].dispatch("files/delete",{id:s});const t=babelHelpers.classPrivateFieldLooseBase(this,m)[m].getters["chats/getByChatId"](a.chatId);const l=babelHelpers.classPrivateFieldLooseBase(this,m)[m].getters["messages/findLastChatMessageId"](a.chatId);if(n.Type.isString(l)||n.Type.isNumber(l)){void babelHelpers.classPrivateFieldLooseBase(this,m)[m].dispatch("recent/update",{id:t.dialogId,fields:{messageId:l}})}else{void babelHelpers.classPrivateFieldLooseBase(this,m)[m].dispatch("recent/delete",{id:t.dialogId})}}}function De(e){const s=e.getId();const t=e.getBinary();const l=babelHelpers.classPrivateFieldLooseBase(this,V)[V](e);const i=e.getCustomData("sendAsFile");void babelHelpers.classPrivateFieldLooseBase(this,m)[m].dispatch("files/add",{id:s,chatId:e.getCustomData("chatId"),authorId:a.Core.getUserId(),name:t.name,size:e.getSize(),type:i?o.FileType.file:babelHelpers.classPrivateFieldLooseBase(this,G)[G](t),extension:babelHelpers.classPrivateFieldLooseBase(this,Q)[Q](t),status:e.isFailed()?o.FileStatus.error:o.FileStatus.progress,progress:0,authorName:babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]().name,urlDownload:URL.createObjectURL(e.getBinary()),...l})}function Ee(e){const s=babelHelpers.classPrivateFieldLooseBase(this,V)[V](e);void babelHelpers.classPrivateFieldLooseBase(this,m)[m].dispatch("files/update",{id:e.getId(),fields:{...s}})}function we(e){void babelHelpers.classPrivateFieldLooseBase(this,m)[m].dispatch("files/update",{id:e.getId(),fields:{size:e.getSize()}})}function je(e){if(e.getCustomData("sendAsFile")){return{}}const s={blob:e.getPreviewUrl(),width:e.getPreviewWidth(),height:e.getPreviewHeight()};const a={};if(s.blob){a.image={width:s.width,height:s.height};a.urlPreview=s.blob}if(e.getClientPreview()){a.urlPreview=URL.createObjectURL(e.getClientPreview())}return a}function xe(e){return babelHelpers.classPrivateFieldLooseBase(this,Y)[Y](e).diskFolderId}function Ke(e){let s=o.FileType.file;if(e.type.startsWith("image")){s=o.FileType.image}else if(e.type.startsWith("video")){s=o.FileType.video}return s}function Ae(e){return e.name.split(".").splice(-1)[0]}function Te(e){return babelHelpers.classPrivateFieldLooseBase(this,m)[m].getters["chats/get"](e)}function ke(){const e=a.Core.getUserId();return babelHelpers.classPrivateFieldLooseBase(this,m)[m].getters["users/get"](e)}function _e(e){var s;return(s=babelHelpers.classPrivateFieldLooseBase(this,Y)[Y](e))==null?void 0:s.chatId}function Re(e,s,a,t){if(!babelHelpers.classPrivateFieldLooseBase(this,C)[C][e]){babelHelpers.classPrivateFieldLooseBase(this,C)[C][e]={previewCreatedStatus:{},previewSentStatus:{},dialogId:a,text:"",autoUpload:t}}s.forEach((s=>{const a=s.getId();if(!babelHelpers.classPrivateFieldLooseBase(this,C)[C][e].previewCreatedStatus){babelHelpers.classPrivateFieldLooseBase(this,C)[C][e].previewCreatedStatus={}}babelHelpers.classPrivateFieldLooseBase(this,C)[C][e].previewCreatedStatus[a]=false;babelHelpers.classPrivateFieldLooseBase(this,C)[C][e].previewSentStatus[a]=false}))}function Xe(e,s){const a=babelHelpers.classPrivateFieldLooseBase(this,C)[C][e];if(a){s.forEach((s=>{const a=s.getId();if(babelHelpers.classPrivateFieldLooseBase(this,C)[C][e].previewCreatedStatus){delete babelHelpers.classPrivateFieldLooseBase(this,C)[C][e].previewCreatedStatus[a];delete babelHelpers.classPrivateFieldLooseBase(this,C)[C][e].previewSentStatus[a]}}))}}function ze(e,s){babelHelpers.classPrivateFieldLooseBase(this,C)[C][e].previewCreatedStatus[s]=true}function We(e,s){babelHelpers.classPrivateFieldLooseBase(this,C)[C][e].previewSentStatus[s]=true}function Ne(e,s){babelHelpers.classPrivateFieldLooseBase(this,C)[C][e].text=s}function qe(e,s){babelHelpers.classPrivateFieldLooseBase(this,C)[C][e].autoUpload=s}function Ve(e){const s={comment:{},files:[]};const a=this.getFiles(e);const t=babelHelpers.classPrivateFieldLooseBase(this,C)[C][e].text;const l=babelHelpers.classPrivateFieldLooseBase(this,C)[C][e].dialogId;const i=t.length>0;if(a.length>1&&i){s.comment={dialogId:l,text:t}}a.forEach((e=>{var r;if(e.getError()){return}const o=d.Utils.text.getUuidV4();e.setCustomData("messageId",o);if(a.length===1&&i){e.setCustomData("messageText",t)}s.files.push({fileIds:[e.getId()],tempMessageId:e.getCustomData("tempMessageId"),dialogId:l,text:(r=e.getCustomData("messageText"))!=null?r:""})}));return s}function $e(e){const s=[];const a=this.getFiles(e);a.forEach((e=>{if(!e.getError()){s.push(e.getId())}}));const t=babelHelpers.classPrivateFieldLooseBase(this,C)[C][e].text;const l=babelHelpers.classPrivateFieldLooseBase(this,C)[C][e].dialogId;const i=a[0].getCustomData("tempMessageId");babelHelpers.classPrivateFieldLooseBase(this,C)[C][e].tempMessageId=i;return{fileIds:s,tempMessageId:i,dialogId:l,text:t}}function Ge(e){if(!babelHelpers.classPrivateFieldLooseBase(this,C)[C][e]||!babelHelpers.classPrivateFieldLooseBase(this,C)[C][e].autoUpload||babelHelpers.classPrivateFieldLooseBase(this,C)[C][e].wasSent){return false}const{previewCreatedStatus:s}=babelHelpers.classPrivateFieldLooseBase(this,C)[C][e];return Object.values(s).every((e=>e===true))}function Qe(e){if(!babelHelpers.classPrivateFieldLooseBase(this,C)[C][e]){return false}const{previewSentStatus:s}=babelHelpers.classPrivateFieldLooseBase(this,C)[C][e];return Object.values(s).every((e=>e===true))}function Ye(e){if(!babelHelpers.classPrivateFieldLooseBase(this,de)[de](e)){return}babelHelpers.classPrivateFieldLooseBase(this,C)[C][e].wasSent=true;const s=babelHelpers.classPrivateFieldLooseBase(this,oe)[oe](e);void babelHelpers.classPrivateFieldLooseBase(this,S)[S].sendMessageWithFiles(s);this.start(e)}function Ze(e){if(!babelHelpers.classPrivateFieldLooseBase(this,de)[de](e)){return}babelHelpers.classPrivateFieldLooseBase(this,C)[C][e].wasSent=true;const{comment:s,files:a}=babelHelpers.classPrivateFieldLooseBase(this,re)[re](e);if(s.text){babelHelpers.classPrivateFieldLooseBase(this,S)[S].sendMessage(s)}a.forEach((e=>{void babelHelpers.classPrivateFieldLooseBase(this,S)[S].sendMessageWithFiles(e)}));this.start(e)}function Je(e,s){const a=d.Utils.text.getUuidV4();const t=e.id.slice(1);const l=`${a}|${t}`;return{tempMessageId:a,tempFileId:l,dialogId:s,file:e,chatId:babelHelpers.classPrivateFieldLooseBase(this,Y)[Y](s).chatId}}function es(e){return e.getCode()==="MAX_FILE_SIZE_EXCEEDED"}function ss(e){void babelHelpers.classPrivateFieldLooseBase(this,m)[m].dispatch("messages/update",{id:e,fields:{error:true}})}function as(e){babelHelpers.classPrivateFieldLooseBase(this,U)[U].destroyUploader(e);delete babelHelpers.classPrivateFieldLooseBase(this,C)[C][e]}function ts(e){return this.getFiles(e).map((e=>e.getBinary()))}Pe.event={uploadStart:"uploadStart",uploadComplete:"uploadComplete",uploadError:"uploadError",uploadCancel:"uploadCancel"};Pe.instance=null;const ls=10;const is=100;const rs=10;const os=3;var ds=babelHelpers.classPrivateFieldLooseKey("getUploadingService");class ns{constructor(){Object.defineProperty(this,ds,{value:cs})}static makeChunks(e){const{files:s,chunkSize:a=ls,maxFilesCount:t=is}=e;const l=[];if(n.Type.isArray(s)){const e=s.slice(0,t);for(let s=0;s<e.length;s+=a){const t=e.slice(s,s+a);l.push(t)}}return l}static getMaxParallelLoads(e){return Math.floor(rs/e.length)}async addFiles(e){return babelHelpers.classPrivateFieldLooseBase(this,ds)[ds]().addFiles(e)}async uploadFromInput(e){const{event:s,sendAsFile:a,autoUpload:t,dialogId:l}=e;const i=Object.values(s.target.files);const r=ns.makeChunks({files:i});const o=await Promise.all(r.map((e=>this.addFiles({files:e,maxParallelLoads:ns.getMaxParallelLoads(r),maxParallelUploads:os,dialogId:l,autoUpload:t,sendAsFile:a}))));const d=o.map((({uploaderId:e})=>e));const n=i.length;return{uploaderIds:d,sourceFilesCount:n}}async uploadFromClipboard(e){const{clipboardEvent:s,dialogId:a,autoUpload:t,imagesOnly:l}=e;const{clipboardData:i}=s;if(!i||!c.isFilePasted(i)){return{uploaderIds:[],sourceFilesCount:0}}s.preventDefault();let r=await c.getFilesFromDataTransfer(i);if(l){r=r.filter((e=>d.Utils.file.isImage(e.name)));if(l.length===0){return{uploaderIds:[],sourceFilesCount:0}}}const o=ns.makeChunks({files:r});const n=await Promise.all(o.map((e=>this.addFiles({files:e,maxParallelLoads:ns.getMaxParallelLoads(o),maxParallelUploads:os,dialogId:a,autoUpload:t}))));const p=n.filter((e=>e.uploaderFiles.length>0)).map((({uploaderId:e})=>e));const b=r.length;return{uploaderIds:p,sourceFilesCount:b}}async uploadFromDragAndDrop(e){const{event:s,dialogId:a,autoUpload:t,sendAsFile:l}=e;const i=await c.getFilesFromDataTransfer(s.dataTransfer);const r=ns.makeChunks({files:i});const o=await Promise.all(r.map((e=>this.addFiles({files:e,maxParallelLoads:ns.getMaxParallelLoads(r),maxParallelUploads:os,dialogId:a,autoUpload:t,sendAsFile:l}))));const d=o.map((({uploaderId:e})=>e));const n=i.length;return{uploaderIds:d,sourceFilesCount:n}}}function cs(){return Pe.getInstance()}e.UploadingService=Pe;e.MultiUploadingService=ns})(this.BX.Messenger.v2.Service=this.BX.Messenger.v2.Service||{},BX.Messenger.v2.Lib,BX.Messenger.v2.Application,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Service,BX.Event,BX.Messenger.v2.Const,BX.Messenger.v2.Lib,BX,BX.UI.Uploader);
//# sourceMappingURL=uploading.bundle.map.js