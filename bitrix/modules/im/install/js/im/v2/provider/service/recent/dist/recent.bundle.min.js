this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,s,t,a,r,i,l){"use strict";var o=babelHelpers.classPrivateFieldLooseKey("restResult");var d=babelHelpers.classPrivateFieldLooseKey("withBirthdays");var c=babelHelpers.classPrivateFieldLooseKey("users");var n=babelHelpers.classPrivateFieldLooseKey("chats");var h=babelHelpers.classPrivateFieldLooseKey("messages");var b=babelHelpers.classPrivateFieldLooseKey("files");var u=babelHelpers.classPrivateFieldLooseKey("recentItems");var v=babelHelpers.classPrivateFieldLooseKey("extractUser");var p=babelHelpers.classPrivateFieldLooseKey("extractChat");var g=babelHelpers.classPrivateFieldLooseKey("extractMessage");var P=babelHelpers.classPrivateFieldLooseKey("extractRecentItem");var L=babelHelpers.classPrivateFieldLooseKey("extractBirthdayItems");var f=babelHelpers.classPrivateFieldLooseKey("prepareGroupChat");var y=babelHelpers.classPrivateFieldLooseKey("prepareChatForUser");var F=babelHelpers.classPrivateFieldLooseKey("prepareChatForAdditionalUser");var m=babelHelpers.classPrivateFieldLooseKey("getBirthdayPlaceholder");var B=babelHelpers.classPrivateFieldLooseKey("mergeFileIds");class H{constructor(e){Object.defineProperty(this,B,{value:T});Object.defineProperty(this,m,{value:K});Object.defineProperty(this,F,{value:j});Object.defineProperty(this,y,{value:R});Object.defineProperty(this,f,{value:w});Object.defineProperty(this,L,{value:S});Object.defineProperty(this,P,{value:O});Object.defineProperty(this,g,{value:C});Object.defineProperty(this,p,{value:M});Object.defineProperty(this,v,{value:I});Object.defineProperty(this,o,{writable:true,value:void 0});Object.defineProperty(this,d,{writable:true,value:void 0});Object.defineProperty(this,c,{writable:true,value:{}});Object.defineProperty(this,n,{writable:true,value:{}});Object.defineProperty(this,h,{writable:true,value:{}});Object.defineProperty(this,b,{writable:true,value:{}});Object.defineProperty(this,u,{writable:true,value:{}});const{rawData:s,withBirthdays:t=true}=e;babelHelpers.classPrivateFieldLooseBase(this,d)[d]=t;babelHelpers.classPrivateFieldLooseBase(this,o)[o]=s}getItems(){const{items:e=[],copilot:s,messagesAutoDeleteConfigs:t}=babelHelpers.classPrivateFieldLooseBase(this,o)[o];e.forEach((e=>{babelHelpers.classPrivateFieldLooseBase(this,v)[v](e);babelHelpers.classPrivateFieldLooseBase(this,p)[p](e);babelHelpers.classPrivateFieldLooseBase(this,g)[g](e);babelHelpers.classPrivateFieldLooseBase(this,P)[P](e)}));babelHelpers.classPrivateFieldLooseBase(this,L)[L]();return{users:Object.values(babelHelpers.classPrivateFieldLooseBase(this,c)[c]),chats:Object.values(babelHelpers.classPrivateFieldLooseBase(this,n)[n]),messages:Object.values(babelHelpers.classPrivateFieldLooseBase(this,h)[h]),files:Object.values(babelHelpers.classPrivateFieldLooseBase(this,b)[b]),recentItems:Object.values(babelHelpers.classPrivateFieldLooseBase(this,u)[u]),copilot:s,messagesAutoDeleteConfigs:t}}}function I(e){var s;if((s=e.user)!=null&&s.id&&!babelHelpers.classPrivateFieldLooseBase(this,c)[c][e.user.id]){babelHelpers.classPrivateFieldLooseBase(this,c)[c][e.user.id]=e.user}}function M(e){if(e.type===l.ChatType.chat){babelHelpers.classPrivateFieldLooseBase(this,n)[n][e.id]=babelHelpers.classPrivateFieldLooseBase(this,f)[f](e);if(e.user.id&&!babelHelpers.classPrivateFieldLooseBase(this,n)[n][e.user.id]){babelHelpers.classPrivateFieldLooseBase(this,n)[n][e.user.id]=babelHelpers.classPrivateFieldLooseBase(this,F)[F](e.user)}}else if(e.type===l.ChatType.user){const s=i.Core.getStore().getters["recent/get"](e.user.id);if(!s||!e.options.default_user_record){babelHelpers.classPrivateFieldLooseBase(this,n)[n][e.user.id]=babelHelpers.classPrivateFieldLooseBase(this,y)[y](e)}}}function C(e){const s=e.message;if(!s){return}if(s.id===0){s.id=`${l.FakeMessagePrefix}-${e.id}`}let t=false;if(s.status===l.MessageStatus.delivered){t=true}const a=i.Core.getStore().getters["messages/getById"](s.id);if(r.Type.isArrayFilled(a==null?void 0:a.attach)){delete s.attach}if(r.Type.isPlainObject(s.file)){const e=s.file;if(a){s.files=babelHelpers.classPrivateFieldLooseBase(this,B)[B](a,e.id)}else{s.files=[e.id]}const t=i.Core.getStore().getters["files/get"](e.id);if(!t){babelHelpers.classPrivateFieldLooseBase(this,b)[b][e.id]=e}}babelHelpers.classPrivateFieldLooseBase(this,h)[h][s.id]={...s,viewedByOthers:t}}function O(e){var s,t;const a=(s=(t=e.message)==null?void 0:t.id)!=null?s:0;babelHelpers.classPrivateFieldLooseBase(this,u)[u][e.id]={...e,messageId:a}}function S(){if(!babelHelpers.classPrivateFieldLooseBase(this,d)[d]){return}const{birthdayList:e=[]}=babelHelpers.classPrivateFieldLooseBase(this,o)[o];e.forEach((e=>{if(!babelHelpers.classPrivateFieldLooseBase(this,c)[c][e.id]){babelHelpers.classPrivateFieldLooseBase(this,c)[c][e.id]=e}if(!babelHelpers.classPrivateFieldLooseBase(this,n)[n][e.id]){babelHelpers.classPrivateFieldLooseBase(this,n)[n][e.id]=babelHelpers.classPrivateFieldLooseBase(this,F)[F](e)}if(!babelHelpers.classPrivateFieldLooseBase(this,u)[u][e.id]){const s=`${l.FakeMessagePrefix}-${e.id}`;babelHelpers.classPrivateFieldLooseBase(this,u)[u][e.id]={...babelHelpers.classPrivateFieldLooseBase(this,m)[m](e),messageId:s};babelHelpers.classPrivateFieldLooseBase(this,h)[h][s]={id:s}}}))}function w(e){return{...e.chat,counter:e.counter,dialogId:e.id}}function R(e){return{chatId:e.chat_id,avatar:e.user.avatar,color:e.user.color,dialogId:e.id,name:e.user.name,type:l.ChatType.user,counter:e.counter,role:l.UserRole.member,backgroundId:e.chat.background_id,textFieldEnabled:e.chat.text_field_enabled}}function j(e){return{dialogId:e.id,avatar:e.avatar,color:e.color,name:e.name,type:l.ChatType.user,role:l.UserRole.member}}function K(e){return{id:e.id,isBirthdayPlaceholder:true}}function T(e,s){const t=e.files.map((e=>Number.parseInt(e,10)));const a=new Set([...t,s]);return[...a]}class D{constructor(){this.dataIsPreloaded=false;this.firstPageIsLoaded=false;this.itemsPerPage=50;this.isLoading=false;this.pagesLoaded=0;this.hasMoreItemsToLoad=true;this.lastMessageDate=null}static getInstance(){if(!this.instance){this.instance=new this}return this.instance}getCollection(){return i.Core.getStore().getters["recent/getRecentCollection"]}async loadFirstPage({ignorePreloadedItems:e=false}={}){if(this.dataIsPreloaded&&!e){s.Logger.warn("Im.RecentList: first page was preloaded");return Promise.resolve()}this.isLoading=true;const t=await this.requestItems({firstPage:true});this.firstPageIsLoaded=true;return t}loadNextPage(){if(this.isLoading||!this.hasMoreItemsToLoad){return Promise.resolve()}this.isLoading=true;return this.requestItems()}setPreloadedData(e){s.Logger.warn("Im.RecentList: setting preloaded data",e);const{items:t,hasMore:a}=e;this.lastMessageDate=this.getLastMessageDate(t);if(!a){this.hasMoreItemsToLoad=false}this.dataIsPreloaded=true;void this.updateModels(e)}hideChat(e){s.Logger.warn("Im.RecentList: hide chat",e);const t=i.Core.getStore().getters["recent/get"](e);if(!t){return}void i.Core.getStore().dispatch("recent/delete",{id:e});const r=i.Core.getStore().getters["application/isChatOpen"](e);if(r){a.LayoutManager.getInstance().clearCurrentLayoutEntityId();void a.LayoutManager.getInstance().deleteLastOpenedElementById(e)}i.Core.getRestClient().callMethod(l.RestMethod.imRecentHide,{DIALOG_ID:e}).catch((e=>{console.error("Im.RecentList: hide chat error",e.error())}))}async requestItems({firstPage:e=false}={}){const t=this.getQueryParams(e);const a=await i.Core.getRestClient().callMethod(this.getQueryMethod(),t).catch((e=>{console.error("Im.RecentList: page request error",e.error())}));this.pagesLoaded++;s.Logger.warn(`Im.RecentList: ${e?"First":this.pagesLoaded} page request result`,a.data());const{items:r,hasMore:l}=a.data();this.lastMessageDate=this.getLastMessageDate(r);if(!l){this.hasMoreItemsToLoad=false}this.isLoading=false;return this.updateModels(a.data())}getQueryMethod(){return l.RestMethod.imRecentList}getQueryParams(e){return{SKIP_OPENLINES:"Y",LIMIT:this.itemsPerPage,LAST_MESSAGE_DATE:e?null:this.lastMessageDate,GET_ORIGINAL_TEXT:"Y",PARSE_TEXT:"Y"}}getModelSaveMethod(){return"recent/setRecent"}updateModels(e){const a=new H({rawData:e,...this.getExtractorOptions()});const r=a.getItems();const{users:l,chats:o,messages:d,files:c,recentItems:n,copilot:h,messagesAutoDeleteConfigs:b}=r;s.Logger.warn("RecentService: prepared data for models",r);const u=i.Core.getStore().dispatch("users/set",l);const v=i.Core.getStore().dispatch("chats/set",o);const p=i.Core.getStore().dispatch("chats/autoDelete/set",b);const g=i.Core.getStore().dispatch("messages/store",d);const P=i.Core.getStore().dispatch("files/set",c);const L=i.Core.getStore().dispatch(this.getModelSaveMethod(),n);const f=new t.CopilotManager;const y=f.handleRecentListResponse(h);return Promise.all([u,v,g,P,L,y,p])}getLastMessageDate(e){if(e.length===0){return""}return e.slice(-1)[0].message.date}getExtractorOptions(){return{}}}D.instance=null;e.RecentService=D})(this.BX.Messenger.v2.Service=this.BX.Messenger.v2.Service||{},BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX,BX.Messenger.v2.Application,BX.Messenger.v2.Const);
//# sourceMappingURL=recent.bundle.map.js