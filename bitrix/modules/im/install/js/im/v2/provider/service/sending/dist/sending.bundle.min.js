this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,s,a,r,t,i,l,o,d){"use strict";var n=babelHelpers.classPrivateFieldLooseKey("store");var c=babelHelpers.classPrivateFieldLooseKey("addLoadingMessage");var b=babelHelpers.classPrivateFieldLooseKey("processMessageSending");var p=babelHelpers.classPrivateFieldLooseKey("handleAddingMessageToModels");var v=babelHelpers.classPrivateFieldLooseKey("sendAndProcessMessage");var h=babelHelpers.classPrivateFieldLooseKey("prepareMessage");var g=babelHelpers.classPrivateFieldLooseKey("prepareMessageWithFiles");var P=babelHelpers.classPrivateFieldLooseKey("preparePrompt");var u=babelHelpers.classPrivateFieldLooseKey("handlePagination");var f=babelHelpers.classPrivateFieldLooseKey("addMessageToModels");var F=babelHelpers.classPrivateFieldLooseKey("addMessageToRecent");var L=babelHelpers.classPrivateFieldLooseKey("sendMessageToServer");var y=babelHelpers.classPrivateFieldLooseKey("updateModels");var I=babelHelpers.classPrivateFieldLooseKey("updateMessageError");var H=babelHelpers.classPrivateFieldLooseKey("removeMessageError");var B=babelHelpers.classPrivateFieldLooseKey("sendScrollEvent");var m=babelHelpers.classPrivateFieldLooseKey("getDialog");var w=babelHelpers.classPrivateFieldLooseKey("getDialogByChatId");var M=babelHelpers.classPrivateFieldLooseKey("needToSetAsViewed");var S=babelHelpers.classPrivateFieldLooseKey("handleForwardMessageResponse");var O=babelHelpers.classPrivateFieldLooseKey("handleForwardMessageError");var j=babelHelpers.classPrivateFieldLooseKey("prepareForwardMessages");var K=babelHelpers.classPrivateFieldLooseKey("prepareForwardParams");var T=babelHelpers.classPrivateFieldLooseKey("prepareSendForwardRequest");var x=babelHelpers.classPrivateFieldLooseKey("addForwardsToModels");var E=babelHelpers.classPrivateFieldLooseKey("getForwardUuidMap");var X=babelHelpers.classPrivateFieldLooseKey("buildForwardContextId");var U=babelHelpers.classPrivateFieldLooseKey("logSendErrors");var C=babelHelpers.classPrivateFieldLooseKey("clearLastMessageViews");var A=babelHelpers.classPrivateFieldLooseKey("sendForwardRequest");class D{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}constructor(){Object.defineProperty(this,A,{value:he});Object.defineProperty(this,C,{value:ve});Object.defineProperty(this,U,{value:pe});Object.defineProperty(this,X,{value:be});Object.defineProperty(this,E,{value:ce});Object.defineProperty(this,x,{value:ne});Object.defineProperty(this,T,{value:de});Object.defineProperty(this,K,{value:oe});Object.defineProperty(this,j,{value:le});Object.defineProperty(this,O,{value:ie});Object.defineProperty(this,S,{value:te});Object.defineProperty(this,M,{value:re});Object.defineProperty(this,w,{value:ae});Object.defineProperty(this,m,{value:se});Object.defineProperty(this,B,{value:ee});Object.defineProperty(this,H,{value:Z});Object.defineProperty(this,I,{value:Y});Object.defineProperty(this,y,{value:Q});Object.defineProperty(this,L,{value:J});Object.defineProperty(this,F,{value:G});Object.defineProperty(this,f,{value:z});Object.defineProperty(this,u,{value:_});Object.defineProperty(this,P,{value:N});Object.defineProperty(this,g,{value:q});Object.defineProperty(this,h,{value:k});Object.defineProperty(this,v,{value:W});Object.defineProperty(this,p,{value:R});Object.defineProperty(this,b,{value:V});Object.defineProperty(this,c,{value:$});Object.defineProperty(this,n,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,n)[n]=l.Core.getStore()}async sendMessage(e){const{text:a=""}=e;if(!s.Type.isStringFilled(a)){return}t.Logger.warn("SendingService: sendMessage",e);const r=babelHelpers.classPrivateFieldLooseBase(this,h)[h](e);void babelHelpers.classPrivateFieldLooseBase(this,b)[b](r)}async sendMessageWithFiles(e){const{text:a="",fileIds:r=[]}=e;if(!s.Type.isStringFilled(a)&&!s.Type.isArrayFilled(r)){return Promise.resolve()}t.Logger.warn("SendingService: sendMessage with files",e);const i=babelHelpers.classPrivateFieldLooseBase(this,g)[g](e);await babelHelpers.classPrivateFieldLooseBase(this,u)[u](i.dialogId);await babelHelpers.classPrivateFieldLooseBase(this,c)[c](i);await babelHelpers.classPrivateFieldLooseBase(this,F)[F](i);await babelHelpers.classPrivateFieldLooseBase(this,C)[C](i.dialogId);babelHelpers.classPrivateFieldLooseBase(this,B)[B]({force:true,dialogId:i.dialogId});return Promise.resolve()}async forwardMessages(e){const{forwardIds:a,dialogId:r,text:i}=e;if(!s.Type.isArrayFilled(a)){return Promise.resolve()}t.Logger.warn("SendingService: forwardMessages",e);await babelHelpers.classPrivateFieldLooseBase(this,u)[u](r);let l=null;if(s.Type.isStringFilled(i)){l=babelHelpers.classPrivateFieldLooseBase(this,h)[h](e);await babelHelpers.classPrivateFieldLooseBase(this,f)[f](l)}const o=[...a].sort();const d=babelHelpers.classPrivateFieldLooseBase(this,E)[E](o);const n=babelHelpers.classPrivateFieldLooseBase(this,j)[j](e,d);await babelHelpers.classPrivateFieldLooseBase(this,x)[x](n);babelHelpers.classPrivateFieldLooseBase(this,B)[B]({force:true,dialogId:r});return babelHelpers.classPrivateFieldLooseBase(this,A)[A]({forwardUuidMap:d,commentMessage:l,dialogId:r})}async retrySendMessage(e){const{tempMessageId:a,dialogId:r}=e;const t=babelHelpers.classPrivateFieldLooseBase(this,n)[n].getters["messages/getById"](a);if(!t){return Promise.resolve()}babelHelpers.classPrivateFieldLooseBase(this,H)[H](a);const i=babelHelpers.classPrivateFieldLooseBase(this,h)[h]({text:t.text,dialogId:r,tempMessageId:t.id,replyId:t.replyId});if(s.Type.isStringFilled(t.forward.id)){const[,e]=t.forward.id.split("/");const s={[t.id]:e};return babelHelpers.classPrivateFieldLooseBase(this,A)[A]({forwardUuidMap:s,dialogId:r})}return babelHelpers.classPrivateFieldLooseBase(this,v)[v](i)}async sendCopilotPrompt(e){const{text:a=""}=e;if(!s.Type.isStringFilled(a)){return Promise.resolve()}t.Logger.warn("SendingService: sendCopilotPrompt",e);const r=babelHelpers.classPrivateFieldLooseBase(this,P)[P](e);return babelHelpers.classPrivateFieldLooseBase(this,b)[b](r)}}async function $(e){return babelHelpers.classPrivateFieldLooseBase(this,n)[n].dispatch("messages/addLoadingMessage",{message:e})}async function V(e){await babelHelpers.classPrivateFieldLooseBase(this,p)[p](e);return babelHelpers.classPrivateFieldLooseBase(this,v)[v](e)}async function R(e){await babelHelpers.classPrivateFieldLooseBase(this,u)[u](e.dialogId);await babelHelpers.classPrivateFieldLooseBase(this,f)[f](e);babelHelpers.classPrivateFieldLooseBase(this,B)[B]({force:true,dialogId:e.dialogId})}async function W(e){const s=await babelHelpers.classPrivateFieldLooseBase(this,L)[L](e).catch((s=>{babelHelpers.classPrivateFieldLooseBase(this,I)[I](e.temporaryId);babelHelpers.classPrivateFieldLooseBase(this,U)[U](s,"sendAndProcessMessage")}));t.Logger.warn("SendingService: sendAndProcessMessage result -",s);const{id:a}=s;if(!a){return Promise.resolve()}babelHelpers.classPrivateFieldLooseBase(this,y)[y]({oldId:e.temporaryId,newId:a,dialogId:e.dialogId});return Promise.resolve()}function k(e){const{text:s,tempMessageId:a,dialogId:t,replyId:i,forwardIds:o}=e;const d={authorId:l.Core.getUserId(),unread:false,sending:true};return{text:s,dialogId:t,chatId:babelHelpers.classPrivateFieldLooseBase(this,m)[m](t).chatId,temporaryId:a!=null?a:r.Utils.text.getUuidV4(),replyId:i,forwardIds:o,viewedByOthers:babelHelpers.classPrivateFieldLooseBase(this,M)[M](t),...d}}function q(e){const{fileIds:a}=e;if(!s.Type.isArrayFilled(a)){throw new Error("SendingService: sendMessageWithFile: no fileId provided")}return{...babelHelpers.classPrivateFieldLooseBase(this,h)[h](e),params:{FILE_ID:a}}}function N(e){const{copilot:s}=e;if(!s||!s.promptCode){throw new Error("SendingService: preparePrompt: no code provided")}return{...babelHelpers.classPrivateFieldLooseBase(this,h)[h](e),copilot:s}}async function _(e){if(!babelHelpers.classPrivateFieldLooseBase(this,m)[m](e).hasNextPage){return Promise.resolve()}t.Logger.warn("SendingService: sendMessage: there are unread pages, move to chat end");const s=new d.MessageService({chatId:babelHelpers.classPrivateFieldLooseBase(this,m)[m](e).chatId});await s.loadContext(babelHelpers.classPrivateFieldLooseBase(this,m)[m](e).lastMessageId);babelHelpers.classPrivateFieldLooseBase(this,B)[B]({dialogId:e});return Promise.resolve()}function z(e){babelHelpers.classPrivateFieldLooseBase(this,F)[F](e);void babelHelpers.classPrivateFieldLooseBase(this,C)[C](e.dialogId);return babelHelpers.classPrivateFieldLooseBase(this,n)[n].dispatch("messages/add",e)}function G(e){var a;const r=s.Type.isStringFilled(e.text);const t=s.Type.isArrayFilled((a=e.params)==null?void 0:a.FILE_ID);if(r||t){void babelHelpers.classPrivateFieldLooseBase(this,n)[n].dispatch("recent/update",{id:e.dialogId,fields:{messageId:e.temporaryId}})}}function J(e){const s={};if(e.replyId){s.replyId=e.replyId}if(e.forwardIds){s.forwardIds=e.forwardIds}if(e.text){s.message=e.text;s.templateId=e.temporaryId}if(e.copilot){s.copilot=e.copilot}const a={dialogId:e.dialogId.toString(),fields:s};return i.runAction(o.RestMethod.imV2ChatMessageSend,{data:a})}function Q(e){const{oldId:s,newId:a,dialogId:r}=e;void babelHelpers.classPrivateFieldLooseBase(this,n)[n].dispatch("messages/updateWithId",{id:s,fields:{id:a}});void babelHelpers.classPrivateFieldLooseBase(this,n)[n].dispatch("chats/update",{dialogId:r,fields:{lastId:a,lastMessageId:a}});void babelHelpers.classPrivateFieldLooseBase(this,n)[n].dispatch("recent/update",{id:r,fields:{messageId:a}})}function Y(e){void babelHelpers.classPrivateFieldLooseBase(this,n)[n].dispatch("messages/update",{id:e,fields:{error:true}})}function Z(e){void babelHelpers.classPrivateFieldLooseBase(this,n)[n].dispatch("messages/update",{id:e,fields:{sending:true,error:false}})}function ee(e={}){const{force:s=false,dialogId:r}=e;a.EventEmitter.emit(o.EventType.dialog.scrollToBottom,{chatId:babelHelpers.classPrivateFieldLooseBase(this,m)[m](r).chatId,threshold:s?o.DialogScrollThreshold.none:o.DialogScrollThreshold.halfScreenUp})}function se(e){return babelHelpers.classPrivateFieldLooseBase(this,n)[n].getters["chats/get"](e,true)}function ae(e){return babelHelpers.classPrivateFieldLooseBase(this,n)[n].getters["chats/getByChatId"](e,true)}function re(e){return babelHelpers.classPrivateFieldLooseBase(this,n)[n].getters["users/bots/isNetwork"](e)}function te(e){const{response:s,dialogId:a,commentMessage:r}=e;const{id:t,uuidMap:i}=s;if(t){babelHelpers.classPrivateFieldLooseBase(this,y)[y]({oldId:r.temporaryId,newId:t,dialogId:a})}Object.entries(i).forEach((([e,s])=>{babelHelpers.classPrivateFieldLooseBase(this,y)[y]({oldId:e,newId:s,dialogId:a})}))}function ie({commentMessage:e,forwardUuidMap:s}){if(e){void babelHelpers.classPrivateFieldLooseBase(this,n)[n].dispatch("messages/update",{id:e.temporaryId,fields:{error:true}})}Object.keys(s).forEach((e=>{void babelHelpers.classPrivateFieldLooseBase(this,n)[n].dispatch("messages/update",{id:e,fields:{error:true}})}))}function le(e,s){const{forwardIds:a,dialogId:r}=e;if(a.length===0){return[]}const t=[];Object.entries(s).forEach((([e,s])=>{const a=babelHelpers.classPrivateFieldLooseBase(this,n)[n].getters["messages/getById"](s);if(!a){return}t.push({...babelHelpers.classPrivateFieldLooseBase(this,h)[h]({dialogId:r,text:a.text,tempMessageId:e,replyId:a.replyId}),forward:babelHelpers.classPrivateFieldLooseBase(this,K)[K](s),attach:a.attach,isDeleted:a.isDeleted,files:a.files})}));return t}function oe(e){const s=babelHelpers.classPrivateFieldLooseBase(this,n)[n].getters["messages/getById"](e);const a=babelHelpers.classPrivateFieldLooseBase(this,w)[w](s.chatId);const r=babelHelpers.classPrivateFieldLooseBase(this,n)[n].getters["messages/isForward"](e);const t=r?s.forward.userId:s.authorId;const i=r?s.forward.chatType:a.type;let l=r?s.forward.chatTitle:a.name;if(i===o.ChatType.channel){l=null}return{id:babelHelpers.classPrivateFieldLooseBase(this,X)[X](s.chatId,e),userId:t,chatType:i,chatTitle:l}}function de(e){const{dialogId:s,forwardUuidMap:a,commentMessage:r}=e;const t={dialogId:s,forwardIds:a};if(r){t.text=r.text;t.temporaryId=r.temporaryId}return t}function ne(e){const s=[];e.forEach((e=>{s.push(babelHelpers.classPrivateFieldLooseBase(this,f)[f](e))}));return Promise.all(s)}function ce(e){const s={};e.forEach((e=>{s[r.Utils.text.getUuidV4()]=e}));return s}function be(e,s){const a=babelHelpers.classPrivateFieldLooseBase(this,w)[w](e).dialogId;if(a.startsWith("chat")){return`${a}/${s}`}const r=l.Core.getUserId();return`${a}:${r}/${s}`}function pe(e,s){e.forEach((e=>{console.error(`SendingService: ${s} error: code: ${e.code} message: ${e.message}`)}))}function ve(e){return babelHelpers.classPrivateFieldLooseBase(this,n)[n].dispatch("chats/clearLastMessageViews",{dialogId:e})}async function he({forwardUuidMap:e,commentMessage:s,dialogId:a}){try{const r=babelHelpers.classPrivateFieldLooseBase(this,T)[T]({forwardUuidMap:e,commentMessage:s,dialogId:a});const i=await babelHelpers.classPrivateFieldLooseBase(this,L)[L](r);t.Logger.warn("SendingService: forwardMessage result -",i);babelHelpers.classPrivateFieldLooseBase(this,S)[S]({response:i,dialogId:a,commentMessage:s})}catch(a){babelHelpers.classPrivateFieldLooseBase(this,O)[O]({commentMessage:s,forwardUuidMap:e});babelHelpers.classPrivateFieldLooseBase(this,U)[U](a,"forwardMessage")}return Promise.resolve()}D.instance=null;e.SendingService=D})(this.BX.Messenger.v2.Service=this.BX.Messenger.v2.Service||{},BX,BX.Event,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Application,BX.Messenger.v2.Const,BX.Messenger.v2.Service);
//# sourceMappingURL=sending.bundle.map.js