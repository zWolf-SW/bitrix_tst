this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,s,a,t,r,i,l,o,d,c,n,b,h,v,p,u,g,P,F,L,H,f,m,B){"use strict";var y=babelHelpers.classPrivateFieldLooseKey("restResult");var I=babelHelpers.classPrivateFieldLooseKey("withBirthdays");var M=babelHelpers.classPrivateFieldLooseKey("users");var C=babelHelpers.classPrivateFieldLooseKey("chats");var w=babelHelpers.classPrivateFieldLooseKey("messages");var S=babelHelpers.classPrivateFieldLooseKey("files");var O=babelHelpers.classPrivateFieldLooseKey("recentItems");var U=babelHelpers.classPrivateFieldLooseKey("extractUser");var j=babelHelpers.classPrivateFieldLooseKey("extractChat");var R=babelHelpers.classPrivateFieldLooseKey("extractMessage");var K=babelHelpers.classPrivateFieldLooseKey("extractRecentItem");var D=babelHelpers.classPrivateFieldLooseKey("extractBirthdayItems");var E=babelHelpers.classPrivateFieldLooseKey("prepareGroupChat");var T=babelHelpers.classPrivateFieldLooseKey("prepareChatForUser");var A=babelHelpers.classPrivateFieldLooseKey("prepareChatForAdditionalUser");var x=babelHelpers.classPrivateFieldLooseKey("getBirthdayPlaceholder");var k=babelHelpers.classPrivateFieldLooseKey("mergeFileIds");class N{constructor(e){Object.defineProperty(this,k,{value:Y});Object.defineProperty(this,x,{value:Q});Object.defineProperty(this,A,{value:z});Object.defineProperty(this,T,{value:W});Object.defineProperty(this,E,{value:G});Object.defineProperty(this,D,{value:$});Object.defineProperty(this,K,{value:q});Object.defineProperty(this,R,{value:X});Object.defineProperty(this,j,{value:V});Object.defineProperty(this,U,{value:_});Object.defineProperty(this,y,{writable:true,value:void 0});Object.defineProperty(this,I,{writable:true,value:void 0});Object.defineProperty(this,M,{writable:true,value:{}});Object.defineProperty(this,C,{writable:true,value:{}});Object.defineProperty(this,w,{writable:true,value:{}});Object.defineProperty(this,S,{writable:true,value:{}});Object.defineProperty(this,O,{writable:true,value:{}});const{rawData:s,withBirthdays:a=true}=e;babelHelpers.classPrivateFieldLooseBase(this,I)[I]=a;babelHelpers.classPrivateFieldLooseBase(this,y)[y]=s}getItems(){const{items:e=[],copilot:s,messagesAutoDeleteConfigs:a}=babelHelpers.classPrivateFieldLooseBase(this,y)[y];e.forEach((e=>{babelHelpers.classPrivateFieldLooseBase(this,U)[U](e);babelHelpers.classPrivateFieldLooseBase(this,j)[j](e);babelHelpers.classPrivateFieldLooseBase(this,R)[R](e);babelHelpers.classPrivateFieldLooseBase(this,K)[K](e)}));babelHelpers.classPrivateFieldLooseBase(this,D)[D]();return{users:Object.values(babelHelpers.classPrivateFieldLooseBase(this,M)[M]),chats:Object.values(babelHelpers.classPrivateFieldLooseBase(this,C)[C]),messages:Object.values(babelHelpers.classPrivateFieldLooseBase(this,w)[w]),files:Object.values(babelHelpers.classPrivateFieldLooseBase(this,S)[S]),recentItems:Object.values(babelHelpers.classPrivateFieldLooseBase(this,O)[O]),copilot:s,messagesAutoDeleteConfigs:a}}}function _(e){var s;if((s=e.user)!=null&&s.id&&!babelHelpers.classPrivateFieldLooseBase(this,M)[M][e.user.id]){babelHelpers.classPrivateFieldLooseBase(this,M)[M][e.user.id]=e.user}}function V(e){if(e.type===m.ChatType.chat){babelHelpers.classPrivateFieldLooseBase(this,C)[C][e.id]=babelHelpers.classPrivateFieldLooseBase(this,E)[E](e);if(e.user.id&&!babelHelpers.classPrivateFieldLooseBase(this,C)[C][e.user.id]){babelHelpers.classPrivateFieldLooseBase(this,C)[C][e.user.id]=babelHelpers.classPrivateFieldLooseBase(this,A)[A](e.user)}}else if(e.type===m.ChatType.user){const s=f.Core.getStore().getters["recent/get"](e.user.id);if(!s||!e.options.default_user_record){babelHelpers.classPrivateFieldLooseBase(this,C)[C][e.user.id]=babelHelpers.classPrivateFieldLooseBase(this,T)[T](e)}}}function X(e){const s=e.message;if(!s){return}if(s.id===0){s.id=`${m.FakeMessagePrefix}-${e.id}`}let a=false;if(s.status===m.MessageStatus.delivered){a=true}const t=f.Core.getStore().getters["messages/getById"](s.id);if(h.Type.isArrayFilled(t==null?void 0:t.attach)){delete s.attach}if(h.Type.isPlainObject(s.file)){const e=s.file;if(t){s.files=babelHelpers.classPrivateFieldLooseBase(this,k)[k](t,e.id)}else{s.files=[e.id]}const a=f.Core.getStore().getters["files/get"](e.id);if(!a){babelHelpers.classPrivateFieldLooseBase(this,S)[S][e.id]=e}}babelHelpers.classPrivateFieldLooseBase(this,w)[w][s.id]={...s,viewedByOthers:a}}function q(e){var s,a;const t=(s=(a=e.message)==null?void 0:a.id)!=null?s:0;babelHelpers.classPrivateFieldLooseBase(this,O)[O][e.id]={...e,messageId:t}}function $(){if(!babelHelpers.classPrivateFieldLooseBase(this,I)[I]){return}const{birthdayList:e=[]}=babelHelpers.classPrivateFieldLooseBase(this,y)[y];e.forEach((e=>{if(!babelHelpers.classPrivateFieldLooseBase(this,M)[M][e.id]){babelHelpers.classPrivateFieldLooseBase(this,M)[M][e.id]=e}if(!babelHelpers.classPrivateFieldLooseBase(this,C)[C][e.id]){babelHelpers.classPrivateFieldLooseBase(this,C)[C][e.id]=babelHelpers.classPrivateFieldLooseBase(this,A)[A](e)}if(!babelHelpers.classPrivateFieldLooseBase(this,O)[O][e.id]){const s=`${m.FakeMessagePrefix}-${e.id}`;babelHelpers.classPrivateFieldLooseBase(this,O)[O][e.id]={...babelHelpers.classPrivateFieldLooseBase(this,x)[x](e),messageId:s};babelHelpers.classPrivateFieldLooseBase(this,w)[w][s]={id:s}}}))}function G(e){return{...e.chat,counter:e.counter,dialogId:e.id}}function W(e){return{chatId:e.chat_id,avatar:e.user.avatar,color:e.user.color,dialogId:e.id,name:e.user.name,type:m.ChatType.user,counter:e.counter,role:m.UserRole.member,backgroundId:e.chat.background_id,textFieldEnabled:e.chat.text_field_enabled}}function z(e){return{dialogId:e.id,avatar:e.avatar,color:e.color,name:e.name,type:m.ChatType.user,role:m.UserRole.member}}function Q(e){return{id:e.id,isBirthdayPlaceholder:true}}function Y(e,s){const a=e.files.map((e=>Number.parseInt(e,10)));const t=new Set([...a,s]);return[...t]}class J{constructor(){this.dataIsPreloaded=false;this.firstPageIsLoaded=false;this.itemsPerPage=50;this.isLoading=false;this.pagesLoaded=0;this.hasMoreItemsToLoad=true;this.lastMessageDate=null}static getInstance(){if(!this.instance){this.instance=new this}return this.instance}getCollection(){return f.Core.getStore().getters["recent/getRecentCollection"]}async loadFirstPage({ignorePreloadedItems:e=false}={}){if(this.dataIsPreloaded&&!e){F.Logger.warn("Im.RecentList: first page was preloaded");return Promise.resolve()}this.isLoading=true;const s=await this.requestItems({firstPage:true});this.firstPageIsLoaded=true;return s}loadNextPage(){if(this.isLoading||!this.hasMoreItemsToLoad){return Promise.resolve()}this.isLoading=true;return this.requestItems()}setPreloadedData(e){F.Logger.warn("Im.RecentList: setting preloaded data",e);const{items:s,hasMore:a}=e;this.lastMessageDate=this.getLastMessageDate(s);if(!a){this.hasMoreItemsToLoad=false}this.dataIsPreloaded=true;void this.updateModels(e)}hideChat(e){F.Logger.warn("Im.RecentList: hide chat",e);const s=f.Core.getStore().getters["recent/get"](e);if(!s){return}void f.Core.getStore().dispatch("recent/delete",{id:e});const a=f.Core.getStore().getters["application/isChatOpen"](e);if(a){o.LayoutManager.getInstance().clearCurrentLayoutEntityId();void o.LayoutManager.getInstance().deleteLastOpenedElementById(e)}f.Core.getRestClient().callMethod(m.RestMethod.imRecentHide,{DIALOG_ID:e}).catch((e=>{console.error("Im.RecentList: hide chat error",e.error())}))}async requestItems({firstPage:e=false}={}){const s=this.getQueryParams(e);const a=await f.Core.getRestClient().callMethod(this.getQueryMethod(),s).catch((e=>{console.error("Im.RecentList: page request error",e.error())}));this.pagesLoaded++;F.Logger.warn(`Im.RecentList: ${e?"First":this.pagesLoaded} page request result`,a.data());const{items:t,hasMore:r}=a.data();this.lastMessageDate=this.getLastMessageDate(t);if(!r){this.hasMoreItemsToLoad=false}this.isLoading=false;return this.updateModels(a.data())}getQueryMethod(){return m.RestMethod.imRecentList}getQueryParams(e){return{SKIP_OPENLINES:"Y",LIMIT:this.itemsPerPage,LAST_MESSAGE_DATE:e?null:this.lastMessageDate,GET_ORIGINAL_TEXT:"Y",PARSE_TEXT:"Y"}}getModelSaveMethod(){return"recent/setRecent"}updateModels(e){const s=new N({rawData:e,...this.getExtractorOptions()});const a=s.getItems();const{users:t,chats:r,messages:i,files:l,recentItems:o,copilot:d,messagesAutoDeleteConfigs:n}=a;F.Logger.warn("RecentService: prepared data for models",a);const b=f.Core.getStore().dispatch("users/set",t);const h=f.Core.getStore().dispatch("chats/set",r);const v=f.Core.getStore().dispatch("chats/autoDelete/set",n);const p=f.Core.getStore().dispatch("messages/store",i);const u=f.Core.getStore().dispatch("files/set",l);const g=f.Core.getStore().dispatch(this.getModelSaveMethod(),o);const P=new c.CopilotManager;const L=P.handleRecentListResponse(d);return Promise.all([b,h,p,u,g,L,v])}getLastMessageDate(e){if(e.length===0){return""}return e.slice(-1)[0].message.date}getExtractorOptions(){return{}}}J.instance=null;var Z=babelHelpers.classPrivateFieldLooseKey("store");var ee=babelHelpers.classPrivateFieldLooseKey("updateModels");class se{constructor(){Object.defineProperty(this,ee,{value:ae});Object.defineProperty(this,Z,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]=f.Core.getStore()}async deleteChat(e){F.Logger.warn(`ChatService: deleteChat, dialogId: ${e}`);const s=await B.runAction(m.RestMethod.imV2ChatDelete,{data:{dialogId:e}}).catch((([e])=>{console.error("ChatService: deleteChat error:",e);g.Notifier.chat.onDeleteError()}));await babelHelpers.classPrivateFieldLooseBase(this,ee)[ee](e);return s}async deleteCollab(e){F.Logger.warn(`ChatService: deleteCollab, dialogId: ${e}`);try{await B.runAction(m.RestMethod.socialnetworkCollabDelete,{data:{dialogId:e}});await babelHelpers.classPrivateFieldLooseBase(this,ee)[ee](e);return Promise.resolve()}catch(e){const[s]=e;console.error("ChatService: deleteCollab error:",s);g.Notifier.collab.handleDeleteError(s);return Promise.resolve()}}}function ae(e){void babelHelpers.classPrivateFieldLooseBase(this,Z)[Z].dispatch("chats/update",{dialogId:e,fields:{inited:false}});void babelHelpers.classPrivateFieldLooseBase(this,Z)[Z].dispatch("recent/delete",{id:e});const s=babelHelpers.classPrivateFieldLooseBase(this,Z)[Z].getters["chats/get"](e,true);void babelHelpers.classPrivateFieldLooseBase(this,Z)[Z].dispatch("messages/clearChatCollection",{chatId:s.chatId})}var te=babelHelpers.classPrivateFieldLooseKey("restResult");class re{constructor(e){Object.defineProperty(this,te,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,te)[te]=e}getChatId(){return babelHelpers.classPrivateFieldLooseBase(this,te)[te].chat.id}getDialogId(){return babelHelpers.classPrivateFieldLooseBase(this,te)[te].chat.dialogId}isOpenlinesChat(){return babelHelpers.classPrivateFieldLooseBase(this,te)[te].chat.type===m.ChatType.lines}isCopilotChat(){return babelHelpers.classPrivateFieldLooseBase(this,te)[te].chat.type===m.ChatType.copilot}getChats(){const e={...babelHelpers.classPrivateFieldLooseBase(this,te)[te].chat,hasPrevPage:babelHelpers.classPrivateFieldLooseBase(this,te)[te].hasPrevPage,hasNextPage:babelHelpers.classPrivateFieldLooseBase(this,te)[te].hasNextPage,tariffRestrictions:babelHelpers.classPrivateFieldLooseBase(this,te)[te].tariffRestrictions};const s={[babelHelpers.classPrivateFieldLooseBase(this,te)[te].chat.dialogId]:e};babelHelpers.classPrivateFieldLooseBase(this,te)[te].users.forEach((e=>{if(s[e.id]){s[e.id]={...s[e.id],...v.UserManager.getDialogForUser(e)}}else{s[e.id]=v.UserManager.getDialogForUser(e)}}));return Object.values(s)}getFiles(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,te)[te].files)!=null?e:[]}getUsers(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,te)[te].users)!=null?e:[]}getAdditionalUsers(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,te)[te].usersShort)!=null?e:[]}getMessages(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,te)[te].messages)!=null?e:[]}getCommentInfo(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,te)[te].commentInfo)!=null?e:[]}getCollabInfo(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,te)[te].collabInfo)!=null?e:null}getMessagesToStore(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,te)[te].additionalMessages)!=null?e:[]}getPinnedMessageIds(){var e;const s=[];const a=(e=babelHelpers.classPrivateFieldLooseBase(this,te)[te].pins)!=null?e:[];a.forEach((e=>{s.push(e.messageId)}));return s}getReactions(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,te)[te].reactions)!=null?e:[]}getCopilot(){return babelHelpers.classPrivateFieldLooseBase(this,te)[te].copilot}getSession(){return babelHelpers.classPrivateFieldLooseBase(this,te)[te].session}getAutoDeleteConfig(){return babelHelpers.classPrivateFieldLooseBase(this,te)[te].messagesAutoDeleteConfigs}}var ie=babelHelpers.classPrivateFieldLooseKey("store");var le=babelHelpers.classPrivateFieldLooseKey("requestChat");var oe=babelHelpers.classPrivateFieldLooseKey("markDialogAsLoading");var de=babelHelpers.classPrivateFieldLooseKey("markDialogAsLoaded");var ce=babelHelpers.classPrivateFieldLooseKey("markDialogAsNotLoaded");var ne=babelHelpers.classPrivateFieldLooseKey("isDialogLoadedMarkNeeded");var be=babelHelpers.classPrivateFieldLooseKey("updateModels");var he=babelHelpers.classPrivateFieldLooseKey("needLayoutRedirect");var ve=babelHelpers.classPrivateFieldLooseKey("redirectToLayout");var pe=babelHelpers.classPrivateFieldLooseKey("needRedirectToOpenLinesLayout");class ue{constructor(){Object.defineProperty(this,pe,{value:ye});Object.defineProperty(this,ve,{value:Be});Object.defineProperty(this,he,{value:me});Object.defineProperty(this,be,{value:fe});Object.defineProperty(this,ne,{value:He});Object.defineProperty(this,ce,{value:Le});Object.defineProperty(this,de,{value:Fe});Object.defineProperty(this,oe,{value:Pe});Object.defineProperty(this,le,{value:ge});Object.defineProperty(this,ie,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,ie)[ie]=f.Core.getStore()}loadChat(e){const s={dialogId:e};return babelHelpers.classPrivateFieldLooseBase(this,le)[le](m.RestMethod.imV2ChatShallowLoad,s)}loadChatByChatId(e){const s={chatId:e,messageLimit:a.MessageService.getMessageRequestLimit()};return babelHelpers.classPrivateFieldLooseBase(this,le)[le](m.RestMethod.imV2ChatLoad,s)}loadChatWithMessages(e){const s={dialogId:e,messageLimit:a.MessageService.getMessageRequestLimit()};return babelHelpers.classPrivateFieldLooseBase(this,le)[le](m.RestMethod.imV2ChatLoad,s)}loadChatWithContext(e,s){const t={dialogId:e,messageId:s,messageLimit:a.MessageService.getMessageRequestLimit()};return babelHelpers.classPrivateFieldLooseBase(this,le)[le](m.RestMethod.imV2ChatLoadInContext,t)}prepareDialogId(e){if(!u.Utils.dialog.isExternalId(e)){return Promise.resolve(e)}return B.runAction(m.RestMethod.imV2ChatGetDialogId,{data:{externalId:e}}).then((e=>e.dialogId)).catch((e=>{console.error("ChatService: Load: error preparing external id",e)}))}async loadComments(e){const s={postId:e,messageLimit:a.MessageService.getMessageRequestLimit(),autoJoin:true,createIfNotExists:true};const{chatId:t}=await babelHelpers.classPrivateFieldLooseBase(this,le)[le](m.RestMethod.imV2ChatLoad,s);return babelHelpers.classPrivateFieldLooseBase(this,ie)[ie].dispatch("messages/comments/set",{messageId:e,chatId:t})}async loadCommentInfo(e){const s=babelHelpers.classPrivateFieldLooseBase(this,ie)[ie].getters["chats/get"](e,true);const a=babelHelpers.classPrivateFieldLooseBase(this,ie)[ie].getters["messages/getByChatId"](s.chatId);const t=a.map((e=>e.id));const{commentInfo:r,usersShort:i}=await B.runAction(m.RestMethod.imV2ChatMessageCommentInfoList,{data:{messageIds:t}}).catch((e=>{console.error("ChatService: Load: error loading comment info",e)}));const l=new v.UserManager;void babelHelpers.classPrivateFieldLooseBase(this,ie)[ie].dispatch("messages/comments/set",r);void l.addUsersToModel(i)}resetChat(e){const s=babelHelpers.classPrivateFieldLooseBase(this,ie)[ie].getters["chats/get"](e,true);babelHelpers.classPrivateFieldLooseBase(this,ie)[ie].dispatch("messages/clearChatCollection",{chatId:s.chatId});babelHelpers.classPrivateFieldLooseBase(this,ie)[ie].dispatch("chats/update",{dialogId:e,fields:{inited:false}})}}async function ge(e,s){const{dialogId:a,messageId:t}=s;babelHelpers.classPrivateFieldLooseBase(this,oe)[oe](a);const i=await B.runAction(e,{data:s}).catch((([e])=>{console.error("ChatService: Load: error loading chat",e);g.Notifier.chat.handleLoadError(e);babelHelpers.classPrivateFieldLooseBase(this,ce)[ce](a);throw e}));if(babelHelpers.classPrivateFieldLooseBase(this,he)[he](i)){return babelHelpers.classPrivateFieldLooseBase(this,ve)[ve](i,t)}const{dialogId:l,chatId:o}=await babelHelpers.classPrivateFieldLooseBase(this,be)[be](i);const{callInfo:d}=i;r.CallTokenManager.setToken(d.chatId,d.token);if(babelHelpers.classPrivateFieldLooseBase(this,ne)[ne](e)){await babelHelpers.classPrivateFieldLooseBase(this,de)[de](l)}return{dialogId:l,chatId:o}}function Pe(e){void babelHelpers.classPrivateFieldLooseBase(this,ie)[ie].dispatch("chats/update",{dialogId:e,fields:{loading:true}})}function Fe(e){return babelHelpers.classPrivateFieldLooseBase(this,ie)[ie].dispatch("chats/update",{dialogId:e,fields:{inited:true,loading:false}})}function Le(e){return babelHelpers.classPrivateFieldLooseBase(this,ie)[ie].dispatch("chats/update",{dialogId:e,fields:{loading:false}})}function He(e){return e!==m.RestMethod.imV2ChatShallowLoad}async function fe(e){const s=new re(e);const a=babelHelpers.classPrivateFieldLooseBase(this,ie)[ie].dispatch("chats/set",s.getChats());const r=babelHelpers.classPrivateFieldLooseBase(this,ie)[ie].dispatch("files/set",s.getFiles());const i=babelHelpers.classPrivateFieldLooseBase(this,ie)[ie].dispatch("chats/autoDelete/set",s.getAutoDeleteConfig());const l=new v.UserManager;const o=Promise.all([babelHelpers.classPrivateFieldLooseBase(this,ie)[ie].dispatch("users/set",s.getUsers()),l.addUsersToModel(s.getAdditionalUsers())]);const d=Promise.all([babelHelpers.classPrivateFieldLooseBase(this,ie)[ie].dispatch("messages/setChatCollection",{messages:s.getMessages(),clearCollection:true}),babelHelpers.classPrivateFieldLooseBase(this,ie)[ie].dispatch("messages/store",s.getMessagesToStore()),babelHelpers.classPrivateFieldLooseBase(this,ie)[ie].dispatch("messages/pin/setPinned",{chatId:s.getChatId(),pinnedMessages:s.getPinnedMessageIds()}),babelHelpers.classPrivateFieldLooseBase(this,ie)[ie].dispatch("messages/reactions/set",s.getReactions()),babelHelpers.classPrivateFieldLooseBase(this,ie)[ie].dispatch("messages/comments/set",s.getCommentInfo())]);const n=new c.CopilotManager;const b=n.handleChatLoadResponse(s.getCopilot());let h=Promise.resolve();if(t.OpenLinesManager){h=t.OpenLinesManager.handleChatLoadResponse(s.getSession())}const p=babelHelpers.classPrivateFieldLooseBase(this,ie)[ie].dispatch("chats/collabs/set",{chatId:s.getChatId(),collabInfo:s.getCollabInfo()});await Promise.all([a,r,o,d,b,h,p,i]);return{dialogId:s.getDialogId(),chatId:s.getChatId()}}function me(e){return babelHelpers.classPrivateFieldLooseBase(this,pe)[pe](e)}function Be(e){const a=new re(e);o.LayoutManager.getInstance().setLastOpenedElement(m.Layout.chat.name,"");if(babelHelpers.classPrivateFieldLooseBase(this,pe)[pe](e)){return s.Messenger.openLines(a.getDialogId())}return Promise.resolve()}function ye(e){const s=d.FeatureManager.isFeatureAvailable(d.Feature.openLinesV2);if(s){return false}const a=new re(e);return a.isOpenlinesChat()&&h.Type.isStringFilled(a.getDialogId())}const Ie="CHAT";const Me="OPEN";var Ce=babelHelpers.classPrivateFieldLooseKey("restClient");var we=babelHelpers.classPrivateFieldLooseKey("store");var Se=babelHelpers.classPrivateFieldLooseKey("prepareFields");var Oe=babelHelpers.classPrivateFieldLooseKey("addCollabToModel");var Ue=babelHelpers.classPrivateFieldLooseKey("addChatToModel");var je=babelHelpers.classPrivateFieldLooseKey("sendAnalytics");class Re{constructor(){Object.defineProperty(this,je,{value:Te});Object.defineProperty(this,Ue,{value:Ee});Object.defineProperty(this,Oe,{value:De});Object.defineProperty(this,Se,{value:Ke});Object.defineProperty(this,Ce,{writable:true,value:void 0});Object.defineProperty(this,we,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce]=f.Core.getRestClient();babelHelpers.classPrivateFieldLooseBase(this,we)[we]=f.Core.getStore()}async createChat(e){F.Logger.warn("ChatService: createChat",e);const s=await babelHelpers.classPrivateFieldLooseBase(this,Se)[Se](e);const a=await babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce].callMethod(m.RestMethod.imV2ChatAdd,{fields:s}).catch((e=>{console.error("ChatService: createChat error:",e);g.Notifier.chat.onCreateError();throw e}));const{chatId:t}=a.data();F.Logger.warn("ChatService: createChat result",t);const r=`chat${t}`;babelHelpers.classPrivateFieldLooseBase(this,Ue)[Ue](r,s);babelHelpers.classPrivateFieldLooseBase(this,je)[je](r);return{newDialogId:r,newChatId:t}}async createCollab(e){F.Logger.warn("ChatService: createCollab",e);const s=await babelHelpers.classPrivateFieldLooseBase(this,Se)[Se](e);const a={ownerId:s.ownerId,name:s.title,description:s.description,avatarId:s.avatar,moderatorMembers:u.Utils.user.prepareSelectorIds(e.moderatorMembers),permissions:e.permissions,options:{...e.options,messagesAutoDeleteDelay:s.messagesAutoDeleteDelay}};const t=await B.runAction(m.RestMethod.socialnetworkCollabCreate,{data:a}).catch((([e])=>{console.error("ChatService: createCollab error:",e);g.Notifier.collab.handleCreateError(e);throw e}));const{chatId:r}=t;F.Logger.warn("ChatService: createCollab result",r);const i=`chat${r}`;babelHelpers.classPrivateFieldLooseBase(this,Oe)[Oe](i,s);babelHelpers.classPrivateFieldLooseBase(this,je)[je](i);return{newDialogId:i,newChatId:r}}}async function Ke(e){var s,a,t,r;const i={...e};if(i.avatar){i.avatar=await u.Utils.file.getBase64(e.avatar)}i.managers=(s=i.managers)!=null?s:[];i.members=(a=i.members)!=null?a:[];const l=[...i.members,...i.managers];if(i.ownerId){l.push(i.ownerId)}i.members=[...new Set(l)];const o={type:(t=i.type)==null?void 0:t.toUpperCase(),entityType:(r=i.entityType)==null?void 0:r.toUpperCase(),title:i.title,avatar:i.avatar,description:i.description,users:i.members,memberEntities:i.memberEntities,managers:i.managers,ownerId:i.ownerId,searchable:i.isAvailableInSearch?"Y":"N",manageUsersAdd:i.manageUsersAdd,manageUsersDelete:i.manageUsersDelete,manageUi:i.manageUi,manageSettings:i.manageSettings,manageMessages:i.manageMessages,conferencePassword:i.conferencePassword,copilotMainRole:i.copilotMainRole,messagesAutoDeleteDelay:i.autoDeleteDelay};Object.entries(o).forEach((([e,s])=>{if(h.Type.isUndefined(s)){delete o[e]}}));return o}function De(e,s){babelHelpers.classPrivateFieldLooseBase(this,we)[we].dispatch("chats/set",{dialogId:e,type:m.ChatType.collab,name:s.title})}function Ee(e,s){let a=s.searchable==="Y"?Me:Ie;if(h.Type.isStringFilled(s.entityType)){a=s.entityType.toLowerCase()}if(h.Type.isStringFilled(s.type)){a=s.type.toLowerCase()}babelHelpers.classPrivateFieldLooseBase(this,we)[we].dispatch("chats/set",{dialogId:e,type:a.toLowerCase(),name:s.title,userCounter:s.users.length,role:m.UserRole.owner,permissions:{manageUi:s.manageUi,manageSettings:s.manageSettings,manageUsersAdd:s.manageUsersAdd,manageUsersDelete:s.manageUsersDelete,manageMessages:s.manageMessages}})}function Te(e){H.Analytics.getInstance().ignoreNextChatOpen(e)}var Ae=babelHelpers.classPrivateFieldLooseKey("store");var xe=babelHelpers.classPrivateFieldLooseKey("prepareFields");var ke=babelHelpers.classPrivateFieldLooseKey("updateChatInModel");class Ne{constructor(){Object.defineProperty(this,ke,{value:Ve});Object.defineProperty(this,xe,{value:_e});Object.defineProperty(this,Ae,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Ae)[Ae]=f.Core.getStore()}async prepareAvatar(e){if(!P.isResizableImage(e)){return Promise.reject(new Error("UpdateService: prepareAvatar: incorrect image"))}const s=180;const{preview:a}=await P.resizeImage(e,{width:s,height:s});return a}async changeAvatar(e,s){F.Logger.warn("ChatService: changeAvatar",e,s);const a=await u.Utils.file.getBase64(s);return B.runAction(m.RestMethod.imV2ChatUpdateAvatar,{data:{id:e,avatar:a}}).catch((([e])=>{console.error("ChatService: changeAvatar error:",e)}))}async updateChat(e,s){F.Logger.warn(`ChatService: updateChat, chatId: ${e}`,s);const a=await babelHelpers.classPrivateFieldLooseBase(this,xe)[xe](s);const t=await B.runAction(m.RestMethod.imV2ChatUpdate,{data:{id:e,fields:a},id:e}).catch((([e])=>{console.error("ChatService: updateChat error:",e);g.Notifier.chat.onUpdateError();throw e}));F.Logger.warn("ChatService: updateChat result",t);const r=`chat${e}`;await babelHelpers.classPrivateFieldLooseBase(this,ke)[ke](r,s);return t}async updateCollab(e,s){F.Logger.warn(`ChatService: updateCollab, dialogId: ${e}`,s);const a=await babelHelpers.classPrivateFieldLooseBase(this,xe)[xe](s);let t={dialogId:e,name:a.title,description:a.description,avatarId:a.avatar};if(s.groupSettings){const e=s.groupSettings;t={...t,ownerId:e.ownerId,addModeratorMembers:u.Utils.user.prepareSelectorIds(e.addModeratorMembers),deleteModeratorMembers:u.Utils.user.prepareSelectorIds(e.deleteModeratorMembers),permissions:e.permissions,options:e.options}}const r=await B.runAction(m.RestMethod.socialnetworkCollabUpdate,{data:t}).catch((([e])=>{console.error("ChatService: updateCollab error:",e);g.Notifier.collab.handleUpdateError(e);throw e}));F.Logger.warn("ChatService: updateCollab result",r);return r}async getMemberEntities(e){return B.runAction(m.RestMethod.imV2ChatMemberEntitiesList,{data:{chatId:e}}).catch((([e])=>{console.error("ChatService: getMemberEntities error:",e)}))}}async function _e(e){const s={title:e.title,description:e.description,ownerId:e.ownerId,searchable:e.isAvailableInSearch?"Y":"N",manageUi:e.manageUi,manageUsersAdd:e.manageUsersAdd,manageUsersDelete:e.manageUsersDelete,manageMessages:e.manageMessages,addedMemberEntities:e.addedMemberEntities,deletedMemberEntities:e.deletedMemberEntities,addedManagers:e.addedManagers,deletedManagers:e.deletedManagers};if(e.avatar){s.avatar=await u.Utils.file.getBase64(e.avatar)}Object.entries(s).forEach((([e,a])=>{if(h.Type.isUndefined(a)){delete s[e]}}));return s}function Ve(e,s){return babelHelpers.classPrivateFieldLooseBase(this,Ae)[Ae].dispatch("chats/update",{dialogId:e,fields:{name:s.title,description:s.description,ownerId:s.ownerId,managerList:s.managers,type:s.type,role:i.getChatRoleForUser(s),permissions:{manageUi:s.manageUi,manageUsersAdd:s.manageUsersAdd,manageUsersDelete:s.manageUsersDelete,manageMessages:s.manageMessages}}})}var Xe=babelHelpers.classPrivateFieldLooseKey("store");var qe=babelHelpers.classPrivateFieldLooseKey("restClient");var $e=babelHelpers.classPrivateFieldLooseKey("updateChatTitleInModel");class Ge{constructor(){Object.defineProperty(this,$e,{value:We});Object.defineProperty(this,Xe,{writable:true,value:void 0});Object.defineProperty(this,qe,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe]=f.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,qe)[qe]=f.Core.getRestClient()}renameChat(e,s){F.Logger.warn("ChatService: renameChat",e,s);if(s===""){return Promise.resolve()}const a=babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe].getters["chats/get"](e);const t=a.name;babelHelpers.classPrivateFieldLooseBase(this,$e)[$e](e,s);return babelHelpers.classPrivateFieldLooseBase(this,qe)[qe].callMethod(m.RestMethod.imChatUpdateTitle,{dialog_id:e,title:s}).catch((s=>{babelHelpers.classPrivateFieldLooseBase(this,$e)[$e](e,t);console.error("ChatService: renameChat error",s.error());g.Notifier.chat.onRenameError()}))}}function We(e,s){babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe].dispatch("chats/update",{dialogId:e,fields:{name:s}})}var ze=babelHelpers.classPrivateFieldLooseKey("store");var Qe=babelHelpers.classPrivateFieldLooseKey("restClient");var Ye=babelHelpers.classPrivateFieldLooseKey("sendMuteRequestDebounced");var Je=babelHelpers.classPrivateFieldLooseKey("sendMuteRequest");class Ze{constructor(){Object.defineProperty(this,Je,{value:es});Object.defineProperty(this,ze,{writable:true,value:void 0});Object.defineProperty(this,Qe,{writable:true,value:void 0});Object.defineProperty(this,Ye,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,ze)[ze]=f.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Qe)[Qe]=f.Core.getRestClient();const e=500;babelHelpers.classPrivateFieldLooseBase(this,Ye)[Ye]=h.Runtime.debounce(babelHelpers.classPrivateFieldLooseBase(this,Je)[Je],e)}muteChat(e){F.Logger.warn("ChatService: muteChat",e);void babelHelpers.classPrivateFieldLooseBase(this,ze)[ze].dispatch("chats/mute",{dialogId:e});const s={dialog_id:e,action:"Y"};babelHelpers.classPrivateFieldLooseBase(this,Ye)[Ye](s)}unmuteChat(e){F.Logger.warn("ChatService: unmuteChat",e);void babelHelpers.classPrivateFieldLooseBase(this,ze)[ze].dispatch("chats/unmute",{dialogId:e});const s={dialog_id:e,action:"N"};babelHelpers.classPrivateFieldLooseBase(this,Ye)[Ye](s)}}function es(e){const{dialog_id:s,action:a}=e;return babelHelpers.classPrivateFieldLooseBase(this,Qe)[Qe].callMethod(m.RestMethod.imChatMute,e).catch((e=>{const t=a==="Y"?"muting":"unmuting";console.error(`Im.RecentList: error ${t} chat`,e.error());const r=a==="Y"?"chats/unmute":"chats/mute";void babelHelpers.classPrivateFieldLooseBase(this,ze)[ze].dispatch(r,{dialogId:s})}))}var ss=babelHelpers.classPrivateFieldLooseKey("store");class as{constructor(){Object.defineProperty(this,ss,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,ss)[ss]=f.Core.getStore()}pinChat(e){F.Logger.warn("PinService: pinChat",e);void babelHelpers.classPrivateFieldLooseBase(this,ss)[ss].dispatch("recent/pin",{id:e,action:true});B.runAction(m.RestMethod.imV2RecentPin,{data:{dialogId:e}}).catch((([s])=>{console.error("PinService: error pinning chat",s);g.Notifier.recent.handlePinError(s);void babelHelpers.classPrivateFieldLooseBase(this,ss)[ss].dispatch("recent/pin",{id:e,action:false})}))}unpinChat(e){F.Logger.warn("PinService: unpinChat",e);void babelHelpers.classPrivateFieldLooseBase(this,ss)[ss].dispatch("recent/pin",{id:e,action:false});B.runAction(m.RestMethod.imV2RecentUnpin,{data:{dialogId:e}}).catch((([s])=>{console.error("PinService: error unpinning chat",s);g.Notifier.recent.onUnpinError();void babelHelpers.classPrivateFieldLooseBase(this,ss)[ss].dispatch("recent/pin",{id:e,action:true})}))}}const ts=300;var rs=babelHelpers.classPrivateFieldLooseKey("store");var is=babelHelpers.classPrivateFieldLooseKey("restClient");var ls=babelHelpers.classPrivateFieldLooseKey("messagesToRead");var os=babelHelpers.classPrivateFieldLooseKey("readMessagesForChat");var ds=babelHelpers.classPrivateFieldLooseKey("readMessageOnClient");var cs=babelHelpers.classPrivateFieldLooseKey("decreaseCommentCounter");var ns=babelHelpers.classPrivateFieldLooseKey("decreaseChatCounter");var bs=babelHelpers.classPrivateFieldLooseKey("readMessageOnServer");var hs=babelHelpers.classPrivateFieldLooseKey("checkChatCounter");var vs=babelHelpers.classPrivateFieldLooseKey("getDialogIdByChatId");var ps=babelHelpers.classPrivateFieldLooseKey("getDialogByChatId");class us{constructor(){Object.defineProperty(this,ps,{value:Bs});Object.defineProperty(this,vs,{value:ms});Object.defineProperty(this,hs,{value:fs});Object.defineProperty(this,bs,{value:Hs});Object.defineProperty(this,ns,{value:Ls});Object.defineProperty(this,cs,{value:Fs});Object.defineProperty(this,ds,{value:Ps});Object.defineProperty(this,os,{value:gs});Object.defineProperty(this,rs,{writable:true,value:void 0});Object.defineProperty(this,is,{writable:true,value:void 0});Object.defineProperty(this,ls,{writable:true,value:{}});babelHelpers.classPrivateFieldLooseBase(this,rs)[rs]=f.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,is)[is]=f.Core.getRestClient()}readAll(){F.Logger.warn("ReadService: readAll");void babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].dispatch("chats/clearCounters");void babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].dispatch("recent/clearUnread");return babelHelpers.classPrivateFieldLooseBase(this,is)[is].callMethod(m.RestMethod.imV2ChatReadAll).catch((e=>{console.error("ReadService: readAll error",e.error())}))}readDialog(e){F.Logger.warn("ReadService: readDialog",e);void babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].dispatch("recent/unread",{id:e,action:false});void babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].dispatch("chats/update",{dialogId:e,fields:{counter:0}});babelHelpers.classPrivateFieldLooseBase(this,is)[is].callMethod(m.RestMethod.imV2ChatRead,{dialogId:e}).catch((e=>{console.error("ReadService: error reading chat",e.error())}))}unreadDialog(e){F.Logger.warn("ReadService: unreadDialog",e);void babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].dispatch("recent/unread",{id:e,action:true});babelHelpers.classPrivateFieldLooseBase(this,is)[is].callMethod(m.RestMethod.imV2ChatUnread,{dialogId:e}).catch((s=>{console.error("ReadService: error setting chat as unread",s.error());void babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].dispatch("recent/unread",{id:e,action:false})}))}readMessage(e,s){if(!babelHelpers.classPrivateFieldLooseBase(this,ls)[ls][e]){babelHelpers.classPrivateFieldLooseBase(this,ls)[ls][e]=new Set}babelHelpers.classPrivateFieldLooseBase(this,ls)[ls][e].add(s);clearTimeout(this.readTimeout);this.readTimeout=setTimeout((()=>{Object.entries(babelHelpers.classPrivateFieldLooseBase(this,ls)[ls]).forEach((([e,s])=>{void babelHelpers.classPrivateFieldLooseBase(this,os)[os](e,s)}))}),ts)}async readChatQueuedMessages(e){if(!babelHelpers.classPrivateFieldLooseBase(this,ls)[ls][e]){return}clearTimeout(this.readTimeout);void babelHelpers.classPrivateFieldLooseBase(this,os)[os](e,babelHelpers.classPrivateFieldLooseBase(this,ls)[ls][e])}clearDialogMark(e){F.Logger.warn("ReadService: clear dialog mark",e);const s=babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].getters["chats/get"](e);const a=babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].getters["recent/get"](e);if(s.markedId===0&&!(a!=null&&a.unread)){return}void babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].dispatch("recent/unread",{id:e,action:false});void babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].dispatch("chats/update",{dialogId:e,fields:{markedId:0}});babelHelpers.classPrivateFieldLooseBase(this,is)[is].callMethod(m.RestMethod.imV2ChatRead,{dialogId:e,onlyRecent:"Y"}).catch((e=>{console.error("ReadService: error clearing dialog mark",e.error())}))}}async function gs(e,s){const a=Number.parseInt(e,10);F.Logger.warn("ReadService: readMessages",s);if(s.size===0){return true}const t=[...s];delete babelHelpers.classPrivateFieldLooseBase(this,ls)[ls][a];const r=await babelHelpers.classPrivateFieldLooseBase(this,ds)[ds](a,t);F.Logger.warn("ReadService: readMessage, need to reduce counter by",r);await babelHelpers.classPrivateFieldLooseBase(this,ns)[ns](a,r);const i=await babelHelpers.classPrivateFieldLooseBase(this,bs)[bs](a,t).catch((([e])=>{console.error("ReadService: error reading message",e)}));babelHelpers.classPrivateFieldLooseBase(this,hs)[hs](i);return true}function Ps(e,s){const a=Math.max(...s);const t=babelHelpers.classPrivateFieldLooseBase(this,ps)[ps](e);if(a>t.lastReadId){void babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].dispatch("chats/update",{dialogId:babelHelpers.classPrivateFieldLooseBase(this,vs)[vs](e),fields:{lastId:a}})}return babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].dispatch("messages/readMessages",{chatId:e,messageIds:s})}function Fs(e,s){const a=babelHelpers.classPrivateFieldLooseBase(this,ps)[ps](e);let t=a.counter-s;if(t<0){t=0}const r={[a.parentChatId]:{[e]:t}};return f.Core.getStore().dispatch("counters/setCommentCounters",r)}function Ls(e,s){const a=babelHelpers.classPrivateFieldLooseBase(this,ps)[ps](e);if(a.type===m.ChatType.comment){return babelHelpers.classPrivateFieldLooseBase(this,cs)[cs](e,s)}let t=a.counter-s;if(t<0){t=0}return babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].dispatch("chats/update",{dialogId:babelHelpers.classPrivateFieldLooseBase(this,vs)[vs](e),fields:{counter:t}})}function Hs(e,s){F.Logger.warn("ReadService: readMessages on server",s);return B.runAction(m.RestMethod.imV2ChatMessageRead,{data:{chatId:e,ids:s,actionUuid:l.UuidManager.getInstance().getActionUuid()}})}function fs(e){if(!e){return}const{chatId:s,counter:a}=e;const t=babelHelpers.classPrivateFieldLooseBase(this,ps)[ps](s);if(t.counter>a){F.Logger.warn("ReadService: counter from server is lower than local one",t.counter,a);void babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].dispatch("chats/update",{dialogId:t.dialogId,fields:{counter:a}})}}function ms(e){const s=babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].getters["chats/getByChatId"](e);if(!s){return 0}return s.dialogId}function Bs(e){return babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].getters["chats/getByChatId"](e)}var ys=babelHelpers.classPrivateFieldLooseKey("store");var Is=babelHelpers.classPrivateFieldLooseKey("restClient");var Ms=babelHelpers.classPrivateFieldLooseKey("onChatLeave");class Cs{constructor(){Object.defineProperty(this,Ms,{value:ws});Object.defineProperty(this,ys,{writable:true,value:void 0});Object.defineProperty(this,Is,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,ys)[ys]=f.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Is)[Is]=f.Core.getRestClient()}async leaveChat(e){const s={dialogId:e,userId:f.Core.getUserId()};try{await babelHelpers.classPrivateFieldLooseBase(this,Is)[Is].callMethod(m.RestMethod.imV2ChatDeleteUser,s);babelHelpers.classPrivateFieldLooseBase(this,Ms)[Ms](e)}catch(e){console.error("UserService: leave chat error",e.error());g.Notifier.chat.handleLeaveError(e.error())}}async leaveCollab(e){const s={data:{dialogId:e}};try{await B.runAction(m.RestMethod.socialnetworkMemberLeave,s);babelHelpers.classPrivateFieldLooseBase(this,Ms)[Ms](e)}catch(e){console.error("UserService: leave collab error",e[0]);g.Notifier.collab.onLeaveError()}}async kickUserFromChat(e,s){const a={dialogId:e,userId:s};await babelHelpers.classPrivateFieldLooseBase(this,Is)[Is].callMethod(m.RestMethod.imV2ChatDeleteUser,a).catch((e=>{console.error("UserService: error kicking from chat",e.error());g.Notifier.chat.handleUserKickError(e.error())}))}async kickUserFromCollab(e,s){const a=u.Utils.user.prepareSelectorIds(s);const t={data:{dialogId:e,members:a}};await B.runAction(m.RestMethod.socialnetworkMemberDelete,t).catch((([e])=>{console.error("UserService: error kicking from collab",e);g.Notifier.collab.onKickUserError()}))}addToChat(e){const s={chat_id:e.chatId,users:e.members,hide_history:!e.showHistory};return babelHelpers.classPrivateFieldLooseBase(this,Is)[Is].callMethod(m.RestMethod.imChatUserAdd,s).catch((e=>{console.error("UserService: error adding to chat",e.error());throw e.error()}))}joinChat(e){F.Logger.warn(`UserService: join chat ${e}`);void babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].dispatch("chats/update",{dialogId:e,fields:{role:m.UserRole.member}});babelHelpers.classPrivateFieldLooseBase(this,Is)[Is].callMethod(m.RestMethod.imV2ChatJoin,{dialogId:e}).catch((e=>{console.error("UserService: error joining chat",e.error())}))}addManager(e,s){F.Logger.warn(`UserService: add manager ${s} to ${e}`);const{managerList:a}=babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].getters["chats/get"](e);if(a.includes(s)){return}const t=[...a,s];void babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].dispatch("chats/update",{dialogId:e,fields:{managerList:t}});const r={data:{dialogId:e,userIds:[s]}};B.runAction(m.RestMethod.imV2ChatAddManagers,r).catch((([e])=>{console.error("UserService: add manager error",e)}))}removeManager(e,s){F.Logger.warn(`UserService: remove manager ${s} from ${e}`);const{managerList:a}=babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].getters["chats/get"](e);if(!a.includes(s)){return}const t=a.filter((e=>e!==s));void babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].dispatch("chats/update",{dialogId:e,fields:{managerList:t}});const r={data:{dialogId:e,userIds:[s]}};B.runAction(m.RestMethod.imV2ChatDeleteManagers,r).catch((([e])=>{console.error("UserService: remove manager error",e)}))}}function ws(e){void babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].dispatch("chats/update",{dialogId:e,fields:{inited:false}});void babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].dispatch("recent/delete",{id:e});const s=babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].getters["application/isChatOpen"](e);if(s){o.LayoutManager.getInstance().clearCurrentLayoutEntityId();void o.LayoutManager.getInstance().deleteLastOpenedElementById(e)}}var Ss=babelHelpers.classPrivateFieldLooseKey("store");var Os=babelHelpers.classPrivateFieldLooseKey("sendRequestDebounced");var Us=babelHelpers.classPrivateFieldLooseKey("sendRequest");var js=babelHelpers.classPrivateFieldLooseKey("handleResponse");var Rs=babelHelpers.classPrivateFieldLooseKey("getChatId");class Ks{constructor(){Object.defineProperty(this,Rs,{value:Ts});Object.defineProperty(this,js,{value:Es});Object.defineProperty(this,Us,{value:Ds});Object.defineProperty(this,Ss,{writable:true,value:void 0});Object.defineProperty(this,Os,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Ss)[Ss]=f.Core.getStore();const e=500;babelHelpers.classPrivateFieldLooseBase(this,Os)[Os]=h.Runtime.debounce(babelHelpers.classPrivateFieldLooseBase(this,Us)[Us],e)}setDelay(e,s){F.Logger.warn("MessagesAutoDeleteService: setDelay",e,s);const a=babelHelpers.classPrivateFieldLooseBase(this,Rs)[Rs](e);const t=babelHelpers.classPrivateFieldLooseBase(this,Ss)[Ss].getters["chats/autoDelete/getDelay"](a);if(t===s){return}void babelHelpers.classPrivateFieldLooseBase(this,Ss)[Ss].dispatch("chats/autoDelete/set",{chatId:a,delay:s});babelHelpers.classPrivateFieldLooseBase(this,Os)[Os]({dialogId:e,delay:s,previousDelay:t})}}async function Ds(e){const{dialogId:s,delay:a,previousDelay:t}=e;try{const e=await B.runAction(m.RestMethod.imV2ChatSetMessagesAutoDeleteDelay,{data:{dialogId:s,hours:a}});babelHelpers.classPrivateFieldLooseBase(this,js)[js](a,e)}catch(e){console.error("MessagesAutoDeleteService: Error setting auto delete delay",e);void babelHelpers.classPrivateFieldLooseBase(this,Ss)[Ss].dispatch("chats/autoDelete/set",{chatId:babelHelpers.classPrivateFieldLooseBase(this,Rs)[Rs](s),delay:t})}}function Es(e,s){const[a]=s.messagesAutoDeleteConfigs;if(e!==a.delay&&a.delay===m.AutoDeleteDelay.Off){d.FeatureManager.messagesAutoDelete.openFeatureSlider()}void babelHelpers.classPrivateFieldLooseBase(this,Ss)[Ss].dispatch("chats/autoDelete/set",{chatId:a.chatId,delay:a.delay})}function Ts(e){return babelHelpers.classPrivateFieldLooseBase(this,Ss)[Ss].getters["chats/get"](e).chatId}var As=babelHelpers.classPrivateFieldLooseKey("loadService");var xs=babelHelpers.classPrivateFieldLooseKey("createService");var ks=babelHelpers.classPrivateFieldLooseKey("updateService");var Ns=babelHelpers.classPrivateFieldLooseKey("renameService");var _s=babelHelpers.classPrivateFieldLooseKey("muteService");var Vs=babelHelpers.classPrivateFieldLooseKey("pinService");var Xs=babelHelpers.classPrivateFieldLooseKey("readService");var qs=babelHelpers.classPrivateFieldLooseKey("userService");var $s=babelHelpers.classPrivateFieldLooseKey("deleteService");var Gs=babelHelpers.classPrivateFieldLooseKey("messagesAutoDeleteService");var Ws=babelHelpers.classPrivateFieldLooseKey("initServices");class zs{constructor(){Object.defineProperty(this,Ws,{value:Qs});Object.defineProperty(this,As,{writable:true,value:void 0});Object.defineProperty(this,xs,{writable:true,value:void 0});Object.defineProperty(this,ks,{writable:true,value:void 0});Object.defineProperty(this,Ns,{writable:true,value:void 0});Object.defineProperty(this,_s,{writable:true,value:void 0});Object.defineProperty(this,Vs,{writable:true,value:void 0});Object.defineProperty(this,Xs,{writable:true,value:void 0});Object.defineProperty(this,qs,{writable:true,value:void 0});Object.defineProperty(this,$s,{writable:true,value:void 0});Object.defineProperty(this,Gs,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Ws)[Ws]()}loadChat(e){return babelHelpers.classPrivateFieldLooseBase(this,As)[As].loadChat(e)}loadChatByChatId(e){return babelHelpers.classPrivateFieldLooseBase(this,As)[As].loadChatByChatId(e)}loadChatWithMessages(e){return babelHelpers.classPrivateFieldLooseBase(this,As)[As].loadChatWithMessages(e)}loadChatWithContext(e,s){return babelHelpers.classPrivateFieldLooseBase(this,As)[As].loadChatWithContext(e,s)}loadComments(e){return babelHelpers.classPrivateFieldLooseBase(this,As)[As].loadComments(e)}loadCommentInfo(e){return babelHelpers.classPrivateFieldLooseBase(this,As)[As].loadCommentInfo(e)}prepareDialogId(e){return babelHelpers.classPrivateFieldLooseBase(this,As)[As].prepareDialogId(e)}resetChat(e){return babelHelpers.classPrivateFieldLooseBase(this,As)[As].resetChat(e)}createChat(e){return babelHelpers.classPrivateFieldLooseBase(this,xs)[xs].createChat(e)}createCollab(e){return babelHelpers.classPrivateFieldLooseBase(this,xs)[xs].createCollab(e)}prepareAvatar(e){return babelHelpers.classPrivateFieldLooseBase(this,ks)[ks].prepareAvatar(e)}changeAvatar(e,s){return babelHelpers.classPrivateFieldLooseBase(this,ks)[ks].changeAvatar(e,s)}updateChat(e,s){return babelHelpers.classPrivateFieldLooseBase(this,ks)[ks].updateChat(e,s)}updateCollab(e,s){return babelHelpers.classPrivateFieldLooseBase(this,ks)[ks].updateCollab(e,s)}getMemberEntities(e){return babelHelpers.classPrivateFieldLooseBase(this,ks)[ks].getMemberEntities(e)}deleteChat(e){return babelHelpers.classPrivateFieldLooseBase(this,$s)[$s].deleteChat(e)}deleteCollab(e){return babelHelpers.classPrivateFieldLooseBase(this,$s)[$s].deleteCollab(e)}renameChat(e,s){return babelHelpers.classPrivateFieldLooseBase(this,Ns)[Ns].renameChat(e,s)}muteChat(e){babelHelpers.classPrivateFieldLooseBase(this,_s)[_s].muteChat(e)}unmuteChat(e){babelHelpers.classPrivateFieldLooseBase(this,_s)[_s].unmuteChat(e)}pinChat(e){babelHelpers.classPrivateFieldLooseBase(this,Vs)[Vs].pinChat(e)}unpinChat(e){babelHelpers.classPrivateFieldLooseBase(this,Vs)[Vs].unpinChat(e)}readAll(){babelHelpers.classPrivateFieldLooseBase(this,Xs)[Xs].readAll()}readDialog(e){babelHelpers.classPrivateFieldLooseBase(this,Xs)[Xs].readDialog(e)}unreadDialog(e){babelHelpers.classPrivateFieldLooseBase(this,Xs)[Xs].unreadDialog(e)}readMessage(e,s){babelHelpers.classPrivateFieldLooseBase(this,Xs)[Xs].readMessage(e,s)}readChatQueuedMessages(e){babelHelpers.classPrivateFieldLooseBase(this,Xs)[Xs].readChatQueuedMessages(e)}clearDialogMark(e){babelHelpers.classPrivateFieldLooseBase(this,Xs)[Xs].clearDialogMark(e)}leaveChat(e){babelHelpers.classPrivateFieldLooseBase(this,qs)[qs].leaveChat(e)}leaveCollab(e){babelHelpers.classPrivateFieldLooseBase(this,qs)[qs].leaveCollab(e)}kickUserFromChat(e,s){babelHelpers.classPrivateFieldLooseBase(this,qs)[qs].kickUserFromChat(e,s)}kickUserFromCollab(e,s){babelHelpers.classPrivateFieldLooseBase(this,qs)[qs].kickUserFromCollab(e,s)}addToChat(e){return babelHelpers.classPrivateFieldLooseBase(this,qs)[qs].addToChat(e)}joinChat(e){babelHelpers.classPrivateFieldLooseBase(this,qs)[qs].joinChat(e)}addManager(e,s){babelHelpers.classPrivateFieldLooseBase(this,qs)[qs].addManager(e,s)}removeManager(e,s){babelHelpers.classPrivateFieldLooseBase(this,qs)[qs].removeManager(e,s)}setMessagesAutoDeleteDelay(e,s){babelHelpers.classPrivateFieldLooseBase(this,Gs)[Gs].setDelay(e,s)}}function Qs(){babelHelpers.classPrivateFieldLooseBase(this,As)[As]=new ue;babelHelpers.classPrivateFieldLooseBase(this,xs)[xs]=new Re;babelHelpers.classPrivateFieldLooseBase(this,ks)[ks]=new Ne;babelHelpers.classPrivateFieldLooseBase(this,Ns)[Ns]=new Ge;babelHelpers.classPrivateFieldLooseBase(this,_s)[_s]=new Ze;babelHelpers.classPrivateFieldLooseBase(this,Vs)[Vs]=new as;babelHelpers.classPrivateFieldLooseBase(this,Xs)[Xs]=new us;babelHelpers.classPrivateFieldLooseBase(this,qs)[qs]=new Cs;babelHelpers.classPrivateFieldLooseBase(this,$s)[$s]=new se;babelHelpers.classPrivateFieldLooseBase(this,Gs)[Gs]=new Ks}var Ys=babelHelpers.classPrivateFieldLooseKey("store");var Js=babelHelpers.classPrivateFieldLooseKey("chatId");var Zs=babelHelpers.classPrivateFieldLooseKey("userManager");var ea=babelHelpers.classPrivateFieldLooseKey("preparedHistoryMessages");var sa=babelHelpers.classPrivateFieldLooseKey("preparedUnreadMessages");var aa=babelHelpers.classPrivateFieldLooseKey("isLoading");var ta=babelHelpers.classPrivateFieldLooseKey("prepareInitialMessages");var ra=babelHelpers.classPrivateFieldLooseKey("handleLoadedMessages");var ia=babelHelpers.classPrivateFieldLooseKey("updateModels");var la=babelHelpers.classPrivateFieldLooseKey("setDialogInited");var oa=babelHelpers.classPrivateFieldLooseKey("prepareTariffRestrictions");var da=babelHelpers.classPrivateFieldLooseKey("getDialog");var ca=babelHelpers.classPrivateFieldLooseKey("sendAnalytics");class na{constructor(e){Object.defineProperty(this,ca,{value:Pa});Object.defineProperty(this,da,{value:ga});Object.defineProperty(this,oa,{value:ua});Object.defineProperty(this,la,{value:pa});Object.defineProperty(this,ia,{value:va});Object.defineProperty(this,ra,{value:ha});Object.defineProperty(this,ta,{value:ba});Object.defineProperty(this,Ys,{writable:true,value:void 0});Object.defineProperty(this,Js,{writable:true,value:void 0});Object.defineProperty(this,Zs,{writable:true,value:void 0});Object.defineProperty(this,ea,{writable:true,value:[]});Object.defineProperty(this,sa,{writable:true,value:[]});Object.defineProperty(this,aa,{writable:true,value:false});babelHelpers.classPrivateFieldLooseBase(this,Ys)[Ys]=f.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Zs)[Zs]=new v.UserManager;babelHelpers.classPrivateFieldLooseBase(this,Js)[Js]=e}async loadUnread(){if(babelHelpers.classPrivateFieldLooseBase(this,aa)[aa]||!babelHelpers.classPrivateFieldLooseBase(this,da)[da]().hasNextPage){return Promise.resolve(false)}F.Logger.warn("MessageService: loadUnread");const e=babelHelpers.classPrivateFieldLooseBase(this,Ys)[Ys].getters["messages/getLastId"](babelHelpers.classPrivateFieldLooseBase(this,Js)[Js]);if(!e){F.Logger.warn("MessageService: no lastUnreadMessageId, cant load unread");return Promise.resolve(false)}babelHelpers.classPrivateFieldLooseBase(this,aa)[aa]=true;const s={chatId:babelHelpers.classPrivateFieldLooseBase(this,Js)[Js],filter:{lastId:e},order:{id:"ASC"},limit:na.MESSAGE_REQUEST_LIMIT};const a=await B.runAction(m.RestMethod.imV2ChatMessageTail,{data:s}).catch((e=>{console.error("MessageService: loadUnread error:",e);babelHelpers.classPrivateFieldLooseBase(this,aa)[aa]=false}));F.Logger.warn("MessageService: loadUnread result",a);babelHelpers.classPrivateFieldLooseBase(this,sa)[sa]=a.messages;const t={...a,tariffRestrictions:babelHelpers.classPrivateFieldLooseBase(this,oa)[oa](a.tariffRestrictions)};await babelHelpers.classPrivateFieldLooseBase(this,ia)[ia](t);babelHelpers.classPrivateFieldLooseBase(this,aa)[aa]=false;return Promise.resolve()}async loadHistory(){if(babelHelpers.classPrivateFieldLooseBase(this,aa)[aa]||!babelHelpers.classPrivateFieldLooseBase(this,da)[da]().hasPrevPage){return Promise.resolve(false)}F.Logger.warn("MessageService: loadHistory");const e=babelHelpers.classPrivateFieldLooseBase(this,Ys)[Ys].getters["messages/getFirstId"](babelHelpers.classPrivateFieldLooseBase(this,Js)[Js]);if(!e){F.Logger.warn("MessageService: no lastHistoryMessageId, cant load unread");return Promise.resolve()}babelHelpers.classPrivateFieldLooseBase(this,aa)[aa]=true;const s={chatId:babelHelpers.classPrivateFieldLooseBase(this,Js)[Js],filter:{lastId:e},order:{id:"DESC"},limit:na.MESSAGE_REQUEST_LIMIT};const a=await B.runAction(m.RestMethod.imV2ChatMessageTail,{data:s}).catch((e=>{console.error("MessageService: loadHistory error:",e);babelHelpers.classPrivateFieldLooseBase(this,aa)[aa]=false}));F.Logger.warn("MessageService: loadHistory result",a);babelHelpers.classPrivateFieldLooseBase(this,ea)[ea]=a.messages;const t=a.hasNextPage;const r={...a,hasPrevPage:t,hasNextPage:null};await babelHelpers.classPrivateFieldLooseBase(this,ia)[ia](r);babelHelpers.classPrivateFieldLooseBase(this,aa)[aa]=false;return Promise.resolve()}hasPreparedHistoryMessages(){return babelHelpers.classPrivateFieldLooseBase(this,ea)[ea].length>0}drawPreparedHistoryMessages(){if(!this.hasPreparedHistoryMessages()){return Promise.resolve()}return babelHelpers.classPrivateFieldLooseBase(this,Ys)[Ys].dispatch("messages/setChatCollection",{messages:babelHelpers.classPrivateFieldLooseBase(this,ea)[ea]}).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,ea)[ea]=[];return true}))}hasPreparedUnreadMessages(){return babelHelpers.classPrivateFieldLooseBase(this,sa)[sa].length>0}drawPreparedUnreadMessages(){if(!this.hasPreparedUnreadMessages()){return Promise.resolve()}return babelHelpers.classPrivateFieldLooseBase(this,Ys)[Ys].dispatch("messages/setChatCollection",{messages:babelHelpers.classPrivateFieldLooseBase(this,sa)[sa]}).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,sa)[sa]=[];return true}))}async loadFirstPage(){F.Logger.warn("MessageService: loadFirstPage for: ",babelHelpers.classPrivateFieldLooseBase(this,Js)[Js]);babelHelpers.classPrivateFieldLooseBase(this,aa)[aa]=true;const e={data:{chatId:babelHelpers.classPrivateFieldLooseBase(this,Js)[Js],limit:na.MESSAGE_REQUEST_LIMIT,order:{id:"ASC"}}};const s=await B.runAction(m.RestMethod.imV2ChatMessageTail,e).catch((([e])=>{console.error("MessageService: loadFirstPage error:",e);babelHelpers.classPrivateFieldLooseBase(this,aa)[aa]=false;throw e}));F.Logger.warn("MessageService: loadFirstPage result",s);await babelHelpers.classPrivateFieldLooseBase(this,ra)[ra](s);await babelHelpers.classPrivateFieldLooseBase(this,Ys)[Ys].dispatch("chats/update",{dialogId:babelHelpers.classPrivateFieldLooseBase(this,da)[da]().dialogId,fields:{hasPrevPage:false,hasNextPage:s.hasNextPage}});babelHelpers.classPrivateFieldLooseBase(this,aa)[aa]=false}loadContext(e){const s={[m.RestMethod.imV2ChatMessageGetContext]:{id:e,range:na.MESSAGE_REQUEST_LIMIT},[m.RestMethod.imV2ChatMessageRead]:{chatId:babelHelpers.classPrivateFieldLooseBase(this,Js)[Js],ids:[e]}};F.Logger.warn("MessageService: loadContext for: ",e);babelHelpers.classPrivateFieldLooseBase(this,aa)[aa]=true;return B.callBatch(s).then((e=>{F.Logger.warn("MessageService: loadContext result",e);return babelHelpers.classPrivateFieldLooseBase(this,ra)[ra](e[m.RestMethod.imV2ChatMessageGetContext])})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,ca)[ca](e);g.Notifier.message.handleLoadContextError(e);console.error("MessageService: loadContext error:",e)})).finally((()=>{babelHelpers.classPrivateFieldLooseBase(this,aa)[aa]=false}))}async loadContextByChatId(e){const s={data:{commentChatId:e}};const a=await B.runAction(m.RestMethod.imV2ChatMessageGetContext,s).catch((([e])=>{console.error("MessageService: loadContextByChatId error:",e);throw e}));const t=a.commentInfo;const r=t.find((s=>s.chatId===e));const i=r==null?void 0:r.messageId;F.Logger.warn("MessageService: loadContextByChatId result",a);void babelHelpers.classPrivateFieldLooseBase(this,ra)[ra](a);return i}reloadMessageList(){F.Logger.warn("MessageService: loadChatOnExit for: ",babelHelpers.classPrivateFieldLooseBase(this,Js)[Js]);let e=0;if(babelHelpers.classPrivateFieldLooseBase(this,da)[da]().chatId<=0){return}if(babelHelpers.classPrivateFieldLooseBase(this,da)[da]().markedId){e=babelHelpers.classPrivateFieldLooseBase(this,da)[da]().markedId}else if(babelHelpers.classPrivateFieldLooseBase(this,da)[da]().savedPositionMessageId){e=babelHelpers.classPrivateFieldLooseBase(this,da)[da]().savedPositionMessageId}const s=babelHelpers.classPrivateFieldLooseBase(this,da)[da]().inited;babelHelpers.classPrivateFieldLooseBase(this,la)[la](false);if(e){void this.loadContext(e).finally((()=>{babelHelpers.classPrivateFieldLooseBase(this,la)[la](true,s)}))}void this.loadInitialMessages().finally((()=>{babelHelpers.classPrivateFieldLooseBase(this,la)[la](true,s)}))}async loadInitialMessages(){F.Logger.warn("MessageService: loadInitialMessages for: ",babelHelpers.classPrivateFieldLooseBase(this,Js)[Js]);babelHelpers.classPrivateFieldLooseBase(this,aa)[aa]=true;const e={data:{chatId:babelHelpers.classPrivateFieldLooseBase(this,Js)[Js],limit:na.MESSAGE_REQUEST_LIMIT}};const s=await B.runAction(m.RestMethod.imV2ChatMessageList,e).catch((([e])=>{console.error("MessageService: loadInitialMessages error:",e);babelHelpers.classPrivateFieldLooseBase(this,aa)[aa]=false;throw e}));F.Logger.warn("MessageService: loadInitialMessages result",s);s.messages=babelHelpers.classPrivateFieldLooseBase(this,ta)[ta](s.messages);await babelHelpers.classPrivateFieldLooseBase(this,ra)[ra](s);babelHelpers.classPrivateFieldLooseBase(this,aa)[aa]=false;return Promise.resolve()}isLoading(){return babelHelpers.classPrivateFieldLooseBase(this,aa)[aa]}}function ba(e){if(e.length===0){return e}const s=babelHelpers.classPrivateFieldLooseBase(this,da)[da]().lastMessageId;const a=Math.max(...e.map((e=>e.id)));if(a>=s){return e}const t=babelHelpers.classPrivateFieldLooseBase(this,Ys)[Ys].getters["messages/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,Js)[Js]);const r=t.filter((e=>e.id>a));F.Logger.warn("MessageService: loadInitialMessages: local id is higher than server one",r);return[...e,...r]}function ha(e){const{messages:s}=e;const a=babelHelpers.classPrivateFieldLooseBase(this,Ys)[Ys].dispatch("messages/setChatCollection",{messages:s,clearCollection:true});const t=babelHelpers.classPrivateFieldLooseBase(this,ia)[ia](e);return Promise.all([a,t])}function va(e){const{files:s,users:a,usersShort:t,reactions:r,hasPrevPage:i,hasNextPage:l,additionalMessages:o,commentInfo:d,copilot:n,tariffRestrictions:b}=e;const h=babelHelpers.classPrivateFieldLooseBase(this,Ys)[Ys].dispatch("chats/update",{dialogId:babelHelpers.classPrivateFieldLooseBase(this,da)[da]().dialogId,fields:{hasPrevPage:i,hasNextPage:l,tariffRestrictions:b}});const v=Promise.all([babelHelpers.classPrivateFieldLooseBase(this,Zs)[Zs].setUsersToModel(a),babelHelpers.classPrivateFieldLooseBase(this,Zs)[Zs].addUsersToModel(t)]);const p=babelHelpers.classPrivateFieldLooseBase(this,Ys)[Ys].dispatch("files/set",s);const u=babelHelpers.classPrivateFieldLooseBase(this,Ys)[Ys].dispatch("messages/reactions/set",r);const g=babelHelpers.classPrivateFieldLooseBase(this,Ys)[Ys].dispatch("messages/store",o);const P=babelHelpers.classPrivateFieldLooseBase(this,Ys)[Ys].dispatch("messages/comments/set",d);const F=new c.CopilotManager;const L=F.handleChatLoadResponse(n);return Promise.all([h,p,v,u,g,P,L])}function pa(e,s=true){const a={inited:e,loading:!e};if(e===true&&!s){delete a.inited}babelHelpers.classPrivateFieldLooseBase(this,Ys)[Ys].dispatch("chats/update",{dialogId:babelHelpers.classPrivateFieldLooseBase(this,da)[da]().dialogId,fields:a})}function ua(e){const s=babelHelpers.classPrivateFieldLooseBase(this,da)[da]().dialogId;const a=babelHelpers.classPrivateFieldLooseBase(this,Ys)[Ys].getters["chats/get"](s);if(!a){return e}const{tariffRestrictions:{isHistoryLimitExceeded:t}}=a;if(t===true){return{...e,isHistoryLimitExceeded:true}}return e}function ga(){return babelHelpers.classPrivateFieldLooseBase(this,Ys)[Ys].getters["chats/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,Js)[Js])}function Pa(e){if(e.code!==m.ErrorCode.message.notFound){return}const s=babelHelpers.classPrivateFieldLooseBase(this,da)[da]();const a=s.dialogId;H.Analytics.getInstance().messageDelete.onNotFoundNotification({dialogId:a})}na.MESSAGE_REQUEST_LIMIT=25;var Fa=babelHelpers.classPrivateFieldLooseKey("store");var La=babelHelpers.classPrivateFieldLooseKey("restClient");class Ha{constructor(){Object.defineProperty(this,Fa,{writable:true,value:void 0});Object.defineProperty(this,La,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa]=f.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,La)[La]=f.Core.getRestClient()}pinMessage(e,s){F.Logger.warn(`Dialog: PinManager: pin message ${s}`);const a={chatId:e,messageId:s};void babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa].dispatch("messages/pin/add",a);babelHelpers.classPrivateFieldLooseBase(this,La)[La].callMethod(m.RestMethod.imV2ChatMessagePin,{id:s}).catch((e=>{console.error("Dialog: PinManager: error pinning message",e.error());void babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa].dispatch("messages/pin/delete",a)}))}unpinMessage(e,s){F.Logger.warn(`Dialog: PinManager: unpin message ${s}`);const a={chatId:e,messageId:s};void babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa].dispatch("messages/pin/delete",a);babelHelpers.classPrivateFieldLooseBase(this,La)[La].callMethod(m.RestMethod.imV2ChatMessageUnpin,{id:s}).catch((e=>{console.error("Dialog: PinManager: error unpinning message",e.error());void babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa].dispatch("messages/pin/add",a)}))}}var fa=babelHelpers.classPrivateFieldLooseKey("updateMessageModel");var ma=babelHelpers.classPrivateFieldLooseKey("getMessage");class Ba{constructor(){Object.defineProperty(this,ma,{value:Ia});Object.defineProperty(this,fa,{value:ya})}editMessageText(e,s){F.Logger.warn("MessageService: editMessageText",e,s);const a=babelHelpers.classPrivateFieldLooseBase(this,ma)[ma](e);if(!a){return}babelHelpers.classPrivateFieldLooseBase(this,fa)[fa](e,s);const t={data:{id:e,fields:{message:s}}};B.runAction(m.RestMethod.imV2ChatMessageUpdate,t).catch((([e])=>{console.error("MessageService: editMessageText error:",e)}))}}function ya(e,s){const a=babelHelpers.classPrivateFieldLooseBase(this,ma)[ma](e);const t=a.viewedByOthers;f.Core.getStore().dispatch("messages/update",{id:e,fields:{text:s,isEdited:t}})}function Ia(e){return f.Core.getStore().getters["messages/getById"](e)}var Ma=babelHelpers.classPrivateFieldLooseKey("store");var Ca=babelHelpers.classPrivateFieldLooseKey("chatId");var wa=babelHelpers.classPrivateFieldLooseKey("updateModels");var Sa=babelHelpers.classPrivateFieldLooseKey("shallowMessageDelete");var Oa=babelHelpers.classPrivateFieldLooseKey("canDeleteCompletely");var Ua=babelHelpers.classPrivateFieldLooseKey("completeMessageDelete");var ja=babelHelpers.classPrivateFieldLooseKey("updateRecentForCompleteDelete");var Ra=babelHelpers.classPrivateFieldLooseKey("updateChatForCompleteDelete");var Ka=babelHelpers.classPrivateFieldLooseKey("deleteMessageOnServer");var Da=babelHelpers.classPrivateFieldLooseKey("deleteTemporaryMessage");var Ea=babelHelpers.classPrivateFieldLooseKey("getPreviousMessageId");var Ta=babelHelpers.classPrivateFieldLooseKey("sendDeleteEvent");var Aa=babelHelpers.classPrivateFieldLooseKey("getChat");class xa{constructor(e){Object.defineProperty(this,Aa,{value:Qa});Object.defineProperty(this,Ta,{value:za});Object.defineProperty(this,Ea,{value:Wa});Object.defineProperty(this,Da,{value:Ga});Object.defineProperty(this,Ka,{value:$a});Object.defineProperty(this,Ra,{value:qa});Object.defineProperty(this,ja,{value:Xa});Object.defineProperty(this,Ua,{value:Va});Object.defineProperty(this,Oa,{value:_a});Object.defineProperty(this,Sa,{value:Na});Object.defineProperty(this,wa,{value:ka});Object.defineProperty(this,Ma,{writable:true,value:void 0});Object.defineProperty(this,Ca,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Ca)[Ca]=e;babelHelpers.classPrivateFieldLooseBase(this,Ma)[Ma]=f.Core.getStore()}async deleteMessages(e){F.Logger.warn("MessageService: deleteMessage",e);const s=[];e.forEach((e=>{if(u.Utils.text.isUuidV4(e)){babelHelpers.classPrivateFieldLooseBase(this,Da)[Da](e);return}babelHelpers.classPrivateFieldLooseBase(this,Ta)[Ta](e);babelHelpers.classPrivateFieldLooseBase(this,wa)[wa](e);s.push(e)}));if(s.length>0){void babelHelpers.classPrivateFieldLooseBase(this,Ka)[Ka](s)}}}function ka(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Ma)[Ma].getters["messages/getById"](e);if(babelHelpers.classPrivateFieldLooseBase(this,Oa)[Oa](s)){void babelHelpers.classPrivateFieldLooseBase(this,Ua)[Ua](s);return}void babelHelpers.classPrivateFieldLooseBase(this,Sa)[Sa](s)}function Na(e){babelHelpers.classPrivateFieldLooseBase(this,Ma)[Ma].dispatch("messages/update",{id:e.id,fields:{text:"",isDeleted:true,files:[],attach:[],replyId:0}})}function _a(e){const s=[m.ChatType.channel,m.ChatType.openChannel,m.ChatType.generalChannel];const a=[m.ChatType.comment,m.ChatType.lines];const t=babelHelpers.classPrivateFieldLooseBase(this,Aa)[Aa]();if(s.includes(t.type)){return true}if(a.includes(t.type)){return false}return!e.viewedByOthers}function Va(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Aa)[Aa]();if(e.id===s.lastMessageId){const s=babelHelpers.classPrivateFieldLooseBase(this,Ea)[Ea](e.id);babelHelpers.classPrivateFieldLooseBase(this,ja)[ja](s);babelHelpers.classPrivateFieldLooseBase(this,Ra)[Ra](s)}babelHelpers.classPrivateFieldLooseBase(this,Ma)[Ma].dispatch("messages/delete",{id:e.id})}function Xa(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Aa)[Aa]();if(!e){babelHelpers.classPrivateFieldLooseBase(this,Ma)[Ma].dispatch("recent/delete",{id:s.dialogId});return}babelHelpers.classPrivateFieldLooseBase(this,Ma)[Ma].dispatch("recent/update",{id:s.dialogId,fields:{messageId:e}})}function qa(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Aa)[Aa]();babelHelpers.classPrivateFieldLooseBase(this,Ma)[Ma].dispatch("chats/update",{dialogId:s.dialogId,fields:{lastMessageId:e,lastId:e}});babelHelpers.classPrivateFieldLooseBase(this,Ma)[Ma].dispatch("chats/clearLastMessageViews",{dialogId:s.dialogId})}function $a(e){return B.runAction(m.RestMethod.imV2ChatMessageDelete,{data:{messageIds:e}}).catch((e=>{console.error("MessageService: deleteMessage error:",e)}))}function Ga(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Aa)[Aa]();const a=babelHelpers.classPrivateFieldLooseBase(this,Ma)[Ma].getters["recent/get"](s.dialogId);if(a.messageId===e){const a=babelHelpers.classPrivateFieldLooseBase(this,Ea)[Ea](e);babelHelpers.classPrivateFieldLooseBase(this,Ma)[Ma].dispatch("recent/update",{id:s.dialogId,fields:{messageId:a}})}babelHelpers.classPrivateFieldLooseBase(this,Ma)[Ma].dispatch("messages/delete",{id:e})}function Wa(e){var s;const a=babelHelpers.classPrivateFieldLooseBase(this,Ma)[Ma].getters["messages/getPreviousMessage"]({messageId:e,chatId:babelHelpers.classPrivateFieldLooseBase(this,Ca)[Ca]});return(s=a==null?void 0:a.id)!=null?s:0}function za(e){L.EventEmitter.emit(m.EventType.dialog.onMessageDeleted,{messageId:e})}function Qa(){return babelHelpers.classPrivateFieldLooseBase(this,Ma)[Ma].getters["chats/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,Ca)[Ca])}var Ya=babelHelpers.classPrivateFieldLooseKey("chatId");var Ja=babelHelpers.classPrivateFieldLooseKey("store");var Za=babelHelpers.classPrivateFieldLooseKey("restClient");class et{constructor(e){Object.defineProperty(this,Ya,{writable:true,value:void 0});Object.defineProperty(this,Ja,{writable:true,value:void 0});Object.defineProperty(this,Za,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Ya)[Ya]=e;babelHelpers.classPrivateFieldLooseBase(this,Ja)[Ja]=f.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Za)[Za]=f.Core.getRestClient()}markMessage(e){F.Logger.warn("MessageService: markMessage",e);const{dialogId:s}=babelHelpers.classPrivateFieldLooseBase(this,Ja)[Ja].getters["chats/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,Ya)[Ya]);void babelHelpers.classPrivateFieldLooseBase(this,Ja)[Ja].dispatch("recent/unread",{id:s,action:true});void babelHelpers.classPrivateFieldLooseBase(this,Ja)[Ja].dispatch("chats/update",{dialogId:s,fields:{markedId:e}});babelHelpers.classPrivateFieldLooseBase(this,Za)[Za].callMethod(m.RestMethod.imV2ChatMessageMark,{dialogId:s,id:e}).catch((e=>{console.error("MessageService: error marking message",e.error())}))}}var st=babelHelpers.classPrivateFieldLooseKey("chatId");var at=babelHelpers.classPrivateFieldLooseKey("store");var tt=babelHelpers.classPrivateFieldLooseKey("restClient");class rt{constructor(e){Object.defineProperty(this,st,{writable:true,value:void 0});Object.defineProperty(this,at,{writable:true,value:void 0});Object.defineProperty(this,tt,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,st)[st]=e;babelHelpers.classPrivateFieldLooseBase(this,at)[at]=f.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,tt)[tt]=f.Core.getRestClient()}addMessageToFavorite(e){F.Logger.warn("MessageService: addMessageToFavorite",e);babelHelpers.classPrivateFieldLooseBase(this,tt)[tt].callMethod(m.RestMethod.imChatFavoriteAdd,{MESSAGE_ID:e}).catch((e=>{console.error("MessageService: error adding message to favorite",e.error())}));g.Notifier.message.onAddToFavoriteComplete()}removeMessageFromFavorite(e){F.Logger.warn("MessageService: removeMessageFromFavorite",e);void babelHelpers.classPrivateFieldLooseBase(this,at)[at].dispatch("sidebar/favorites/deleteByMessageId",{chatId:babelHelpers.classPrivateFieldLooseBase(this,st)[st],messageId:e});babelHelpers.classPrivateFieldLooseBase(this,tt)[tt].callMethod(m.RestMethod.imChatFavoriteDelete,{MESSAGE_ID:e}).catch((e=>{console.error("MessageService: error removing message from favorite",e.error())}))}}var it=babelHelpers.classPrivateFieldLooseKey("loadService");var lt=babelHelpers.classPrivateFieldLooseKey("pinService");var ot=babelHelpers.classPrivateFieldLooseKey("editService");var dt=babelHelpers.classPrivateFieldLooseKey("deleteService");var ct=babelHelpers.classPrivateFieldLooseKey("markService");var nt=babelHelpers.classPrivateFieldLooseKey("favoriteService");var bt=babelHelpers.classPrivateFieldLooseKey("initServices");class ht{static getMessageRequestLimit(){return na.MESSAGE_REQUEST_LIMIT}constructor(e){Object.defineProperty(this,bt,{value:vt});Object.defineProperty(this,it,{writable:true,value:void 0});Object.defineProperty(this,lt,{writable:true,value:void 0});Object.defineProperty(this,ot,{writable:true,value:void 0});Object.defineProperty(this,dt,{writable:true,value:void 0});Object.defineProperty(this,ct,{writable:true,value:void 0});Object.defineProperty(this,nt,{writable:true,value:void 0});const{chatId:s}=e;babelHelpers.classPrivateFieldLooseBase(this,bt)[bt](s)}loadUnread(){return babelHelpers.classPrivateFieldLooseBase(this,it)[it].loadUnread()}loadHistory(){return babelHelpers.classPrivateFieldLooseBase(this,it)[it].loadHistory()}hasPreparedHistoryMessages(){return babelHelpers.classPrivateFieldLooseBase(this,it)[it].hasPreparedHistoryMessages()}drawPreparedHistoryMessages(){return babelHelpers.classPrivateFieldLooseBase(this,it)[it].drawPreparedHistoryMessages()}hasPreparedUnreadMessages(){return babelHelpers.classPrivateFieldLooseBase(this,it)[it].hasPreparedUnreadMessages()}drawPreparedUnreadMessages(){return babelHelpers.classPrivateFieldLooseBase(this,it)[it].drawPreparedUnreadMessages()}isLoading(){return babelHelpers.classPrivateFieldLooseBase(this,it)[it].isLoading()}loadContext(e){return babelHelpers.classPrivateFieldLooseBase(this,it)[it].loadContext(e)}loadContextByChatId(e){return babelHelpers.classPrivateFieldLooseBase(this,it)[it].loadContextByChatId(e)}loadFirstPage(){return babelHelpers.classPrivateFieldLooseBase(this,it)[it].loadFirstPage()}reloadMessageList(){babelHelpers.classPrivateFieldLooseBase(this,it)[it].reloadMessageList()}loadInitialMessages(){return babelHelpers.classPrivateFieldLooseBase(this,it)[it].loadInitialMessages()}pinMessage(e,s){babelHelpers.classPrivateFieldLooseBase(this,lt)[lt].pinMessage(e,s)}unpinMessage(e,s){babelHelpers.classPrivateFieldLooseBase(this,lt)[lt].unpinMessage(e,s)}markMessage(e){babelHelpers.classPrivateFieldLooseBase(this,ct)[ct].markMessage(e)}addMessageToFavorite(e){babelHelpers.classPrivateFieldLooseBase(this,nt)[nt].addMessageToFavorite(e)}removeMessageFromFavorite(e){babelHelpers.classPrivateFieldLooseBase(this,nt)[nt].removeMessageFromFavorite(e)}editMessageText(e,s){babelHelpers.classPrivateFieldLooseBase(this,ot)[ot].editMessageText(e,s)}deleteMessages(e){babelHelpers.classPrivateFieldLooseBase(this,dt)[dt].deleteMessages(e)}}function vt(e){babelHelpers.classPrivateFieldLooseBase(this,it)[it]=new na(e);babelHelpers.classPrivateFieldLooseBase(this,ot)[ot]=new Ba;babelHelpers.classPrivateFieldLooseBase(this,dt)[dt]=new xa(e);babelHelpers.classPrivateFieldLooseBase(this,lt)[lt]=new Ha;babelHelpers.classPrivateFieldLooseBase(this,ct)[ct]=new et(e);babelHelpers.classPrivateFieldLooseBase(this,nt)[nt]=new rt(e)}var pt=babelHelpers.classPrivateFieldLooseKey("store");var ut=babelHelpers.classPrivateFieldLooseKey("addLoadingMessage");var gt=babelHelpers.classPrivateFieldLooseKey("processMessageSending");var Pt=babelHelpers.classPrivateFieldLooseKey("handleAddingMessageToModels");var Ft=babelHelpers.classPrivateFieldLooseKey("sendAndProcessMessage");var Lt=babelHelpers.classPrivateFieldLooseKey("prepareMessage");var Ht=babelHelpers.classPrivateFieldLooseKey("prepareMessageWithFiles");var ft=babelHelpers.classPrivateFieldLooseKey("preparePrompt");var mt=babelHelpers.classPrivateFieldLooseKey("handlePagination");var Bt=babelHelpers.classPrivateFieldLooseKey("addMessageToModels");var yt=babelHelpers.classPrivateFieldLooseKey("addMessageToRecent");var It=babelHelpers.classPrivateFieldLooseKey("sendMessageToServer");var Mt=babelHelpers.classPrivateFieldLooseKey("updateModels");var Ct=babelHelpers.classPrivateFieldLooseKey("updateMessageError");var wt=babelHelpers.classPrivateFieldLooseKey("removeMessageError");var St=babelHelpers.classPrivateFieldLooseKey("sendScrollEvent");var Ot=babelHelpers.classPrivateFieldLooseKey("getDialog");var Ut=babelHelpers.classPrivateFieldLooseKey("getDialogByChatId");var jt=babelHelpers.classPrivateFieldLooseKey("needToSetAsViewed");var Rt=babelHelpers.classPrivateFieldLooseKey("handleForwardMessageResponse");var Kt=babelHelpers.classPrivateFieldLooseKey("handleForwardMessageError");var Dt=babelHelpers.classPrivateFieldLooseKey("prepareForwardMessages");var Et=babelHelpers.classPrivateFieldLooseKey("prepareForwardParams");var Tt=babelHelpers.classPrivateFieldLooseKey("prepareSendForwardRequest");var At=babelHelpers.classPrivateFieldLooseKey("addForwardsToModels");var xt=babelHelpers.classPrivateFieldLooseKey("getForwardUuidMap");var kt=babelHelpers.classPrivateFieldLooseKey("buildForwardContextId");var Nt=babelHelpers.classPrivateFieldLooseKey("logSendErrors");var _t=babelHelpers.classPrivateFieldLooseKey("clearLastMessageViews");var Vt=babelHelpers.classPrivateFieldLooseKey("sendForwardRequest");class Xt{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}constructor(){Object.defineProperty(this,Vt,{value:Lr});Object.defineProperty(this,_t,{value:Fr});Object.defineProperty(this,Nt,{value:Pr});Object.defineProperty(this,kt,{value:gr});Object.defineProperty(this,xt,{value:ur});Object.defineProperty(this,At,{value:pr});Object.defineProperty(this,Tt,{value:vr});Object.defineProperty(this,Et,{value:hr});Object.defineProperty(this,Dt,{value:br});Object.defineProperty(this,Kt,{value:nr});Object.defineProperty(this,Rt,{value:cr});Object.defineProperty(this,jt,{value:dr});Object.defineProperty(this,Ut,{value:or});Object.defineProperty(this,Ot,{value:lr});Object.defineProperty(this,St,{value:ir});Object.defineProperty(this,wt,{value:rr});Object.defineProperty(this,Ct,{value:tr});Object.defineProperty(this,Mt,{value:ar});Object.defineProperty(this,It,{value:sr});Object.defineProperty(this,yt,{value:er});Object.defineProperty(this,Bt,{value:Zt});Object.defineProperty(this,mt,{value:Jt});Object.defineProperty(this,ft,{value:Yt});Object.defineProperty(this,Ht,{value:Qt});Object.defineProperty(this,Lt,{value:zt});Object.defineProperty(this,Ft,{value:Wt});Object.defineProperty(this,Pt,{value:Gt});Object.defineProperty(this,gt,{value:$t});Object.defineProperty(this,ut,{value:qt});Object.defineProperty(this,pt,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,pt)[pt]=f.Core.getStore()}async sendMessage(e){const{text:s=""}=e;if(!h.Type.isStringFilled(s)){return}F.Logger.warn("SendingService: sendMessage",e);const a=babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt](e);void babelHelpers.classPrivateFieldLooseBase(this,gt)[gt](a)}async sendMessageWithFiles(e){const{text:s="",fileIds:a=[]}=e;if(!h.Type.isStringFilled(s)&&!h.Type.isArrayFilled(a)){return Promise.resolve()}F.Logger.warn("SendingService: sendMessage with files",e);const t=babelHelpers.classPrivateFieldLooseBase(this,Ht)[Ht](e);await babelHelpers.classPrivateFieldLooseBase(this,mt)[mt](t.dialogId);await babelHelpers.classPrivateFieldLooseBase(this,ut)[ut](t);await babelHelpers.classPrivateFieldLooseBase(this,yt)[yt](t);await babelHelpers.classPrivateFieldLooseBase(this,_t)[_t](t.dialogId);babelHelpers.classPrivateFieldLooseBase(this,St)[St]({force:true,dialogId:t.dialogId});return Promise.resolve()}async forwardMessages(e){const{forwardIds:s,dialogId:a,text:t}=e;if(!h.Type.isArrayFilled(s)){return Promise.resolve()}F.Logger.warn("SendingService: forwardMessages",e);await babelHelpers.classPrivateFieldLooseBase(this,mt)[mt](a);let r=null;if(h.Type.isStringFilled(t)){r=babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt](e);await babelHelpers.classPrivateFieldLooseBase(this,Bt)[Bt](r)}const i=[...s].sort();const l=babelHelpers.classPrivateFieldLooseBase(this,xt)[xt](i);const o=babelHelpers.classPrivateFieldLooseBase(this,Dt)[Dt](e,l);await babelHelpers.classPrivateFieldLooseBase(this,At)[At](o);babelHelpers.classPrivateFieldLooseBase(this,St)[St]({force:true,dialogId:a});return babelHelpers.classPrivateFieldLooseBase(this,Vt)[Vt]({forwardUuidMap:l,commentMessage:r,dialogId:a})}async retrySendMessage(e){const{tempMessageId:s,dialogId:a}=e;const t=babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].getters["messages/getById"](s);if(!t){return Promise.resolve()}babelHelpers.classPrivateFieldLooseBase(this,wt)[wt](s);const r=babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt]({text:t.text,dialogId:a,tempMessageId:t.id,replyId:t.replyId});if(h.Type.isStringFilled(t.forward.id)){const[,e]=t.forward.id.split("/");const s={[t.id]:e};return babelHelpers.classPrivateFieldLooseBase(this,Vt)[Vt]({forwardUuidMap:s,dialogId:a})}return babelHelpers.classPrivateFieldLooseBase(this,Ft)[Ft](r)}async sendCopilotPrompt(e){const{text:s=""}=e;if(!h.Type.isStringFilled(s)){return Promise.resolve()}F.Logger.warn("SendingService: sendCopilotPrompt",e);const a=babelHelpers.classPrivateFieldLooseBase(this,ft)[ft](e);return babelHelpers.classPrivateFieldLooseBase(this,gt)[gt](a)}}async function qt(e){return babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].dispatch("messages/addLoadingMessage",{message:e})}async function $t(e){await babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt](e);return babelHelpers.classPrivateFieldLooseBase(this,Ft)[Ft](e)}async function Gt(e){await babelHelpers.classPrivateFieldLooseBase(this,mt)[mt](e.dialogId);await babelHelpers.classPrivateFieldLooseBase(this,Bt)[Bt](e);babelHelpers.classPrivateFieldLooseBase(this,St)[St]({force:true,dialogId:e.dialogId})}async function Wt(e){const s=await babelHelpers.classPrivateFieldLooseBase(this,It)[It](e).catch((s=>{babelHelpers.classPrivateFieldLooseBase(this,Ct)[Ct](e.temporaryId);babelHelpers.classPrivateFieldLooseBase(this,Nt)[Nt](s,"sendAndProcessMessage")}));F.Logger.warn("SendingService: sendAndProcessMessage result -",s);const{id:a}=s;if(!a){return Promise.resolve()}babelHelpers.classPrivateFieldLooseBase(this,Mt)[Mt]({oldId:e.temporaryId,newId:a,dialogId:e.dialogId});return Promise.resolve()}function zt(e){const{text:s,tempMessageId:a,dialogId:t,replyId:r,forwardIds:i}=e;const l={authorId:f.Core.getUserId(),unread:false,sending:true};return{text:s,dialogId:t,chatId:babelHelpers.classPrivateFieldLooseBase(this,Ot)[Ot](t).chatId,temporaryId:a!=null?a:u.Utils.text.getUuidV4(),replyId:r,forwardIds:i,viewedByOthers:babelHelpers.classPrivateFieldLooseBase(this,jt)[jt](t),...l}}function Qt(e){const{fileIds:s}=e;if(!h.Type.isArrayFilled(s)){throw new Error("SendingService: sendMessageWithFile: no fileId provided")}return{...babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt](e),params:{FILE_ID:s}}}function Yt(e){const{copilot:s}=e;if(!s||!s.promptCode){throw new Error("SendingService: preparePrompt: no code provided")}return{...babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt](e),copilot:s}}async function Jt(e){if(!babelHelpers.classPrivateFieldLooseBase(this,Ot)[Ot](e).hasNextPage){return Promise.resolve()}F.Logger.warn("SendingService: sendMessage: there are unread pages, move to chat end");const s=new ht({chatId:babelHelpers.classPrivateFieldLooseBase(this,Ot)[Ot](e).chatId});await s.loadContext(babelHelpers.classPrivateFieldLooseBase(this,Ot)[Ot](e).lastMessageId);babelHelpers.classPrivateFieldLooseBase(this,St)[St]({dialogId:e});return Promise.resolve()}function Zt(e){babelHelpers.classPrivateFieldLooseBase(this,yt)[yt](e);void babelHelpers.classPrivateFieldLooseBase(this,_t)[_t](e.dialogId);return babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].dispatch("messages/add",e)}function er(e){var s;const a=h.Type.isStringFilled(e.text);const t=h.Type.isArrayFilled((s=e.params)==null?void 0:s.FILE_ID);if(a||t){void babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].dispatch("recent/update",{id:e.dialogId,fields:{messageId:e.temporaryId}})}}function sr(e){const s={};if(e.replyId){s.replyId=e.replyId}if(e.forwardIds){s.forwardIds=e.forwardIds}if(e.text){s.message=e.text;s.templateId=e.temporaryId}if(e.copilot){s.copilot=e.copilot}const a={dialogId:e.dialogId.toString(),fields:s};return B.runAction(m.RestMethod.imV2ChatMessageSend,{data:a})}function ar(e){const{oldId:s,newId:a,dialogId:t}=e;void babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].dispatch("messages/updateWithId",{id:s,fields:{id:a}});void babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].dispatch("chats/update",{dialogId:t,fields:{lastId:a,lastMessageId:a}});void babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].dispatch("recent/update",{id:t,fields:{messageId:a}})}function tr(e){void babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].dispatch("messages/update",{id:e,fields:{error:true}})}function rr(e){void babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].dispatch("messages/update",{id:e,fields:{sending:true,error:false}})}function ir(e={}){const{force:s=false,dialogId:a}=e;L.EventEmitter.emit(m.EventType.dialog.scrollToBottom,{chatId:babelHelpers.classPrivateFieldLooseBase(this,Ot)[Ot](a).chatId,threshold:s?m.DialogScrollThreshold.none:m.DialogScrollThreshold.halfScreenUp})}function lr(e){return babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].getters["chats/get"](e,true)}function or(e){return babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].getters["chats/getByChatId"](e,true)}function dr(e){return babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].getters["users/bots/isNetwork"](e)}function cr(e){const{response:s,dialogId:a,commentMessage:t}=e;const{id:r,uuidMap:i}=s;if(r){babelHelpers.classPrivateFieldLooseBase(this,Mt)[Mt]({oldId:t.temporaryId,newId:r,dialogId:a})}Object.entries(i).forEach((([e,s])=>{babelHelpers.classPrivateFieldLooseBase(this,Mt)[Mt]({oldId:e,newId:s,dialogId:a})}))}function nr({commentMessage:e,forwardUuidMap:s}){if(e){void babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].dispatch("messages/update",{id:e.temporaryId,fields:{error:true}})}Object.keys(s).forEach((e=>{void babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].dispatch("messages/update",{id:e,fields:{error:true}})}))}function br(e,s){const{forwardIds:a,dialogId:t}=e;if(a.length===0){return[]}const r=[];Object.entries(s).forEach((([e,s])=>{const a=babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].getters["messages/getById"](s);if(!a){return}r.push({...babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt]({dialogId:t,text:a.text,tempMessageId:e,replyId:a.replyId}),forward:babelHelpers.classPrivateFieldLooseBase(this,Et)[Et](s),attach:a.attach,isDeleted:a.isDeleted,files:a.files})}));return r}function hr(e){const s=babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].getters["messages/getById"](e);const a=babelHelpers.classPrivateFieldLooseBase(this,Ut)[Ut](s.chatId);const t=babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].getters["messages/isForward"](e);const r=t?s.forward.userId:s.authorId;const i=t?s.forward.chatType:a.type;let l=t?s.forward.chatTitle:a.name;if(i===m.ChatType.channel){l=null}return{id:babelHelpers.classPrivateFieldLooseBase(this,kt)[kt](s.chatId,e),userId:r,chatType:i,chatTitle:l}}function vr(e){const{dialogId:s,forwardUuidMap:a,commentMessage:t}=e;const r={dialogId:s,forwardIds:a};if(t){r.text=t.text;r.temporaryId=t.temporaryId}return r}function pr(e){const s=[];e.forEach((e=>{s.push(babelHelpers.classPrivateFieldLooseBase(this,Bt)[Bt](e))}));return Promise.all(s)}function ur(e){const s={};e.forEach((e=>{s[u.Utils.text.getUuidV4()]=e}));return s}function gr(e,s){const a=babelHelpers.classPrivateFieldLooseBase(this,Ut)[Ut](e).dialogId;if(a.startsWith("chat")){return`${a}/${s}`}const t=f.Core.getUserId();return`${a}:${t}/${s}`}function Pr(e,s){e.forEach((e=>{console.error(`SendingService: ${s} error: code: ${e.code} message: ${e.message}`)}))}function Fr(e){return babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].dispatch("chats/clearLastMessageViews",{dialogId:e})}async function Lr({forwardUuidMap:e,commentMessage:s,dialogId:a}){try{const t=babelHelpers.classPrivateFieldLooseBase(this,Tt)[Tt]({forwardUuidMap:e,commentMessage:s,dialogId:a});const r=await babelHelpers.classPrivateFieldLooseBase(this,It)[It](t);F.Logger.warn("SendingService: forwardMessage result -",r);babelHelpers.classPrivateFieldLooseBase(this,Rt)[Rt]({response:r,dialogId:a,commentMessage:s})}catch(a){babelHelpers.classPrivateFieldLooseBase(this,Kt)[Kt]({commentMessage:s,forwardUuidMap:e});babelHelpers.classPrivateFieldLooseBase(this,Nt)[Nt](a,"forwardMessage")}return Promise.resolve()}Xt.instance=null;class Hr{constructor(){this.store=null;this.restClient=null;this.limitPerPage=50;this.isLoading=false;this.lastId=0;this.lastType=0;this.hasMoreItemsToLoad=true;this.notificationsToDelete=new Set;this.store=f.Core.getStore();this.restClient=f.Core.getRestClient();this.deleteWithDebounce=h.Runtime.debounce(this.deleteRequest,500,this);this.userManager=new v.UserManager}loadFirstPage(){this.isLoading=true;return this.requestItems({firstPage:true})}loadNextPage(){if(this.isLoading||!this.hasMoreItemsToLoad){return Promise.resolve()}this.isLoading=true;return this.requestItems()}delete(e){this.notificationsToDelete.add(e);this.store.dispatch("notifications/delete",{id:e});this.store.dispatch("notifications/deleteFromSearch",{id:e});this.deleteWithDebounce()}sendConfirmAction(e,s){const a={NOTIFY_ID:e,NOTIFY_VALUE:s};this.store.dispatch("notifications/delete",{id:e});this.restClient.callMethod("im.notify.confirm",a).catch((e=>{console.error("NotificationService: sendConfirmAction error",e.error())}))}async sendQuickAnswer(e){const{id:s,text:a,callbackSuccess:t=()=>{},callbackError:r=()=>{}}=e;try{const e=await this.restClient.callMethod(m.RestMethod.imNotifyAnswer,{notify_id:s,answer_text:a});t(e)}catch(e){console.error("NotificationService: sendQuickAnswer error",e);r()}}deleteRequest(){const e=[...this.notificationsToDelete];this.restClient.callMethod("im.notify.delete",{id:e}).catch((e=>{console.error("NotificationService: deleteRequest error",e.error())}));this.notificationsToDelete.clear()}requestItems({firstPage:e=false}={}){const s={LIMIT:this.limitPerPage,CONVERT_TEXT:"Y"};const a={[m.RestMethod.imNotifyGet]:[m.RestMethod.imNotifyGet,s]};if(e){a[m.RestMethod.imNotifySchemaGet]=[m.RestMethod.imNotifySchemaGet,{}]}else{s.LAST_ID=this.lastId;s.LAST_TYPE=this.lastType}return new Promise((e=>{this.restClient.callBatch(a,(s=>{F.Logger.warn("im.notify.get: result",s);e(this.handleResponse(s))}))}))}handleResponse(e){const s=e[m.RestMethod.imNotifyGet].data();this.hasMoreItemsToLoad=!this.isLastPage(s.notifications);if(s.notifications.length===0){F.Logger.warn("im.notify.get: no notifications",s);return Promise.resolve()}this.lastId=this.getLastItemId(s.notifications);this.lastType=this.getLastItemType(s.notifications);return this.updateModels(s).then((()=>{this.isLoading=false;if(e[m.RestMethod.imNotifySchemaGet]){return e[m.RestMethod.imNotifySchemaGet].data()}return{}}))}updateModels(e){this.userManager.setUsersToModel(e.users);return this.store.dispatch("notifications/initialSet",e)}getLastItemId(e){return e[e.length-1].id}getLastItemType(e){return this.getItemType(e[e.length-1])}getItemType(e){return e.notify_type===m.NotificationTypesCodes.confirm?m.NotificationTypesCodes.confirm:m.NotificationTypesCodes.simple}isLastPage(e){if(!h.Type.isArrayFilled(e)){return true}return e.length<this.limitPerPage}destroy(){F.Logger.warn("Notification service destroyed")}}var fr=babelHelpers.classPrivateFieldLooseKey("restClient");class mr{constructor(){Object.defineProperty(this,fr,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,fr)[fr]=f.Core.getRestClient()}delete({chatId:e,fileId:s}){const a={chat_id:e,file_id:s};return babelHelpers.classPrivateFieldLooseBase(this,fr)[fr].callMethod(m.RestMethod.imDiskFileDelete,a).catch((e=>{console.error("DiskService: error deleting file",e.error())}))}async save(e){const s=e.map((e=>Number.parseInt(e,10)));return B.runAction(m.RestMethod.imV2DiskFileSave,{data:{ids:s}}).catch((([e])=>{console.error("DiskService: error saving file on disk",e);throw e}))}}const Br=10;var yr=babelHelpers.classPrivateFieldLooseKey("uploaderRegistry");var Ir=babelHelpers.classPrivateFieldLooseKey("onUploadCancelHandler");var Mr=babelHelpers.classPrivateFieldLooseKey("addFile");var Cr=babelHelpers.classPrivateFieldLooseKey("onUploadCancel");var wr=babelHelpers.classPrivateFieldLooseKey("removeFileFromUploader");class Sr extends L.EventEmitter{constructor(){super();Object.defineProperty(this,wr,{value:jr});Object.defineProperty(this,Cr,{value:Ur});Object.defineProperty(this,Mr,{value:Or});Object.defineProperty(this,yr,{writable:true,value:{}});Object.defineProperty(this,Ir,{writable:true,value:void 0});this.setEventNamespace(Sr.eventNamespace);babelHelpers.classPrivateFieldLooseBase(this,Ir)[Ir]=babelHelpers.classPrivateFieldLooseBase(this,Cr)[Cr].bind(this);L.EventEmitter.subscribe(m.EventType.uploader.cancel,babelHelpers.classPrivateFieldLooseBase(this,Ir)[Ir])}createUploader(e){const{diskFolderId:s,uploaderId:a,autoUpload:t=false,chatId:r,dialogId:i}=e;babelHelpers.classPrivateFieldLooseBase(this,yr)[yr][a]=new P.Uploader({autoUpload:t,controller:"disk.uf.integration.diskUploaderController",multiple:true,controllerOptions:{folderId:s,chat:{chatId:r,dialogId:i}},imageResizeWidth:1280,imageResizeHeight:1280,imageResizeMode:"contain",imageResizeFilter:e=>!e.getCustomData("sendAsFile")&&!e.isAnimated(),imageResizeMimeType:"image/jpeg",imageResizeMimeTypeMode:"force",imagePreviewHeight:720,imagePreviewWidth:720,treatOversizeImageAsFile:true,ignoreUnknownImageTypes:true,maxFileSize:null,events:{[P.UploaderEvent.FILE_ADD_START]:e=>{this.emit(Sr.events.onFileAddStart,e)},[P.UploaderEvent.FILE_UPLOAD_START]:e=>{this.emit(Sr.events.onFileUploadStart,e)},[P.UploaderEvent.FILE_ADD]:e=>{const{file:s}=e.getData();this.emit(Sr.events.onFileAdd,{file:s,uploaderId:a})},[P.UploaderEvent.FILE_UPLOAD_PROGRESS]:e=>{this.emit(Sr.events.onFileUploadProgress,e)},[P.UploaderEvent.FILE_UPLOAD_COMPLETE]:e=>{const{file:s}=e.getData();this.emit(Sr.events.onFileUploadComplete,{file:s,uploaderId:a})},[P.UploaderEvent.ERROR]:e=>{this.emit(Sr.events.onFileUploadError,e)},[P.UploaderEvent.FILE_ERROR]:e=>{this.emit(Sr.events.onFileUploadError,e)},[P.UploaderEvent.MAX_FILE_COUNT_EXCEEDED]:e=>{this.emit(Sr.events.onMaxFileCountExceeded,e)},[P.UploaderEvent.UPLOAD_COMPLETE]:e=>{this.emit(Sr.events.onUploadComplete,{uploaderId:a})}}})}start(e){babelHelpers.classPrivateFieldLooseBase(this,yr)[yr][e].setAutoUpload(true);babelHelpers.classPrivateFieldLooseBase(this,yr)[yr][e].start()}destroyUploader(e){babelHelpers.classPrivateFieldLooseBase(this,yr)[yr][e].destroy({removeFilesFromServer:false})}addFiles(e){const s=e.slice(0,Br);const a=[];s.forEach((e=>{const s=babelHelpers.classPrivateFieldLooseBase(this,Mr)[Mr](e);if(s){a.push(s)}}));return a}getFiles(e){return babelHelpers.classPrivateFieldLooseBase(this,yr)[yr][e].getFiles()}destroy(){L.EventEmitter.unsubscribe(m.EventType.uploader.cancel,babelHelpers.classPrivateFieldLooseBase(this,Ir)[Ir])}}function Or(e){return babelHelpers.classPrivateFieldLooseBase(this,yr)[yr][e.uploaderId].addFile(e.file,{id:e.tempFileId,customData:{dialogId:e.dialogId,chatId:e.chatId,tempMessageId:e.tempMessageId,sendAsFile:e.sendAsFile}})}function Ur(e){const{tempFileId:s,tempMessageId:a}=e.getData();if(!s||!a){return}babelHelpers.classPrivateFieldLooseBase(this,wr)[wr](s);this.emit(Sr.events.onFileUploadCancel,{tempMessageId:a,tempFileId:s})}function jr(e){const s=Object.values(babelHelpers.classPrivateFieldLooseBase(this,yr)[yr]);for(const a of s){if(!a.getFile){continue}const s=a.getFile(e);if(s){s.remove();break}}}Sr.eventNamespace="BX.Messenger.v2.Service.Uploading.UploaderWrapper";Sr.events={onFileAddStart:"onFileAddStart",onFileAdd:"onFileAdd",onFileUploadStart:"onFileUploadStart",onFileUploadProgress:"onFileUploadProgress",onFileUploadComplete:"onFileUploadComplete",onFileUploadError:"onFileUploadError",onFileUploadCancel:"onFileUploadCancel",onMaxFileCountExceeded:"onMaxFileCountExceeded",onUploadComplete:"onUploadComplete"};const Rr="BX.Messenger.v2.Service.UploadingService";var Kr=babelHelpers.classPrivateFieldLooseKey("store");var Dr=babelHelpers.classPrivateFieldLooseKey("restClient");var Er=babelHelpers.classPrivateFieldLooseKey("isRequestingDiskFolderId");var Tr=babelHelpers.classPrivateFieldLooseKey("diskFolderIdRequestPromise");var Ar=babelHelpers.classPrivateFieldLooseKey("uploaderWrapper");var xr=babelHelpers.classPrivateFieldLooseKey("sendingService");var kr=babelHelpers.classPrivateFieldLooseKey("uploaderFilesRegistry");var Nr=babelHelpers.classPrivateFieldLooseKey("createUploader");var _r=babelHelpers.classPrivateFieldLooseKey("registerSourceFilesCount");var Vr=babelHelpers.classPrivateFieldLooseKey("addFiles");var Xr=babelHelpers.classPrivateFieldLooseKey("addFileFromDiskToModel");var qr=babelHelpers.classPrivateFieldLooseKey("initUploader");var $r=babelHelpers.classPrivateFieldLooseKey("isMediaFile");var Gr=babelHelpers.classPrivateFieldLooseKey("setFileMapping");var Wr=babelHelpers.classPrivateFieldLooseKey("requestDiskFolderId");var zr=babelHelpers.classPrivateFieldLooseKey("tryCommit");var Qr=babelHelpers.classPrivateFieldLooseKey("uploadPreview");var Yr=babelHelpers.classPrivateFieldLooseKey("prepareFileForUploader");var Jr=babelHelpers.classPrivateFieldLooseKey("updateFileProgress");var Zr=babelHelpers.classPrivateFieldLooseKey("cancelUpload");var ei=babelHelpers.classPrivateFieldLooseKey("addFileToStore");var si=babelHelpers.classPrivateFieldLooseKey("updateFilePreviewInStore");var ai=babelHelpers.classPrivateFieldLooseKey("updateFileSizeInStore");var ti=babelHelpers.classPrivateFieldLooseKey("preparePreview");var ri=babelHelpers.classPrivateFieldLooseKey("getDiskFolderId");var ii=babelHelpers.classPrivateFieldLooseKey("getFileType");var li=babelHelpers.classPrivateFieldLooseKey("getFileExtension");var oi=babelHelpers.classPrivateFieldLooseKey("getDialog");var di=babelHelpers.classPrivateFieldLooseKey("getCurrentUser");var ci=babelHelpers.classPrivateFieldLooseKey("getChatId");var ni=babelHelpers.classPrivateFieldLooseKey("registerFiles");var bi=babelHelpers.classPrivateFieldLooseKey("unregisterFiles");var hi=babelHelpers.classPrivateFieldLooseKey("setPreviewCreatedStatus");var vi=babelHelpers.classPrivateFieldLooseKey("setPreviewSentStatus");var pi=babelHelpers.classPrivateFieldLooseKey("setMessagesText");var ui=babelHelpers.classPrivateFieldLooseKey("setAutoUpload");var gi=babelHelpers.classPrivateFieldLooseKey("createMessagesFromFiles");var Pi=babelHelpers.classPrivateFieldLooseKey("createMessageFromFiles");var Fi=babelHelpers.classPrivateFieldLooseKey("readyToAddMessages");var Li=babelHelpers.classPrivateFieldLooseKey("readyToCommit");var Hi=babelHelpers.classPrivateFieldLooseKey("tryToSendMessage");var fi=babelHelpers.classPrivateFieldLooseKey("tryToSendMessages");var mi=babelHelpers.classPrivateFieldLooseKey("prepareFileFromDisk");var Bi=babelHelpers.classPrivateFieldLooseKey("setMessageError");class yi extends L.EventEmitter{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}constructor(){super();Object.defineProperty(this,Bi,{value:ol});Object.defineProperty(this,mi,{value:ll});Object.defineProperty(this,fi,{value:il});Object.defineProperty(this,Hi,{value:rl});Object.defineProperty(this,Li,{value:tl});Object.defineProperty(this,Fi,{value:al});Object.defineProperty(this,Pi,{value:sl});Object.defineProperty(this,gi,{value:el});Object.defineProperty(this,ui,{value:Zi});Object.defineProperty(this,pi,{value:Ji});Object.defineProperty(this,vi,{value:Yi});Object.defineProperty(this,hi,{value:Qi});Object.defineProperty(this,bi,{value:zi});Object.defineProperty(this,ni,{value:Wi});Object.defineProperty(this,ci,{value:Gi});Object.defineProperty(this,di,{value:$i});Object.defineProperty(this,oi,{value:qi});Object.defineProperty(this,li,{value:Xi});Object.defineProperty(this,ii,{value:Vi});Object.defineProperty(this,ri,{value:_i});Object.defineProperty(this,ti,{value:Ni});Object.defineProperty(this,ai,{value:ki});Object.defineProperty(this,si,{value:xi});Object.defineProperty(this,ei,{value:Ai});Object.defineProperty(this,Zr,{value:Ti});Object.defineProperty(this,Jr,{value:Ei});Object.defineProperty(this,Yr,{value:Di});Object.defineProperty(this,Qr,{value:Ki});Object.defineProperty(this,zr,{value:Ri});Object.defineProperty(this,Wr,{value:ji});Object.defineProperty(this,Gr,{value:Ui});Object.defineProperty(this,$r,{value:Oi});Object.defineProperty(this,qr,{value:Si});Object.defineProperty(this,Xr,{value:wi});Object.defineProperty(this,Vr,{value:Ci});Object.defineProperty(this,_r,{value:Mi});Object.defineProperty(this,Nr,{value:Ii});Object.defineProperty(this,Kr,{writable:true,value:void 0});Object.defineProperty(this,Dr,{writable:true,value:void 0});Object.defineProperty(this,Er,{writable:true,value:false});Object.defineProperty(this,Tr,{writable:true,value:{}});Object.defineProperty(this,Ar,{writable:true,value:void 0});Object.defineProperty(this,xr,{writable:true,value:void 0});Object.defineProperty(this,kr,{writable:true,value:{}});this.setEventNamespace(Rr);babelHelpers.classPrivateFieldLooseBase(this,Kr)[Kr]=f.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Dr)[Dr]=f.Core.getRestClient();babelHelpers.classPrivateFieldLooseBase(this,xr)[xr]=Xt.getInstance();babelHelpers.classPrivateFieldLooseBase(this,qr)[qr]()}async uploadFromClipboard(e){const{clipboardEvent:s,dialogId:a,autoUpload:t,imagesOnly:r}=e;const{clipboardData:i}=s;if(!i||!P.isFilePasted(i)){return""}s.preventDefault();let l=await P.getFilesFromDataTransfer(i);if(r){l=l.filter((e=>u.Utils.file.isImage(e.name)));if(r.length===0){return""}}const{uploaderFiles:o,uploaderId:d}=await babelHelpers.classPrivateFieldLooseBase(this,Vr)[Vr]({files:l,dialogId:a,autoUpload:t});if(o.length===0){return""}return d}async uploadFromInput(e){const{event:s,sendAsFile:a,autoUpload:t,dialogId:r}=e;const i=Object.values(s.target.files);if(i.length===0){return""}const{uploaderId:l}=await babelHelpers.classPrivateFieldLooseBase(this,Vr)[Vr]({files:i,dialogId:r,autoUpload:t,sendAsFile:a});return l}async uploadFromDragAndDrop(e){const{event:s,dialogId:a,autoUpload:t,sendAsFile:r}=e;s.preventDefault();const i=await P.getFilesFromDataTransfer(s.dataTransfer);if(i.length===0){return""}const{uploaderId:l}=await babelHelpers.classPrivateFieldLooseBase(this,Vr)[Vr]({files:i,dialogId:a,autoUpload:t,sendAsFile:r});return l}getSourceFilesCount(e){var s;return(s=babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e].sourceFilesCount)!=null?s:0}getFiles(e){return babelHelpers.classPrivateFieldLooseBase(this,Ar)[Ar].getFiles(e)}start(e){babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e].autoUpload=true;babelHelpers.classPrivateFieldLooseBase(this,Ar)[Ar].start(e)}uploadFileFromDisk(e,s){Object.values(e).forEach((e=>{const a=babelHelpers.classPrivateFieldLooseBase(this,mi)[mi](e,s);babelHelpers.classPrivateFieldLooseBase(this,Xr)[Xr](a).then((()=>{const e={tempMessageId:a.tempMessageId,fileIds:[a.tempFileId],dialogId:a.dialogId};return babelHelpers.classPrivateFieldLooseBase(this,xr)[xr].sendMessageWithFiles(e)})).then((()=>{this.commitFile({chatId:a.chatId,temporaryFileId:a.tempFileId,tempMessageId:a.tempMessageId,realFileId:a.file.id.slice(1),fromDisk:true})})).catch((e=>{console.error("SendingService: sendFilesFromDisk error:",e)}))}))}checkDiskFolderId(e){if(babelHelpers.classPrivateFieldLooseBase(this,ri)[ri](e)>0){return Promise.resolve(babelHelpers.classPrivateFieldLooseBase(this,ri)[ri](e))}if(babelHelpers.classPrivateFieldLooseBase(this,Er)[Er]){return babelHelpers.classPrivateFieldLooseBase(this,Tr)[Tr][e]}babelHelpers.classPrivateFieldLooseBase(this,Tr)[Tr][e]=babelHelpers.classPrivateFieldLooseBase(this,Wr)[Wr](e);return babelHelpers.classPrivateFieldLooseBase(this,Tr)[Tr][e]}commitFile(e){const{temporaryFileId:s,tempMessageId:a,chatId:t,realFileId:r,fromDisk:i,messageText:l="",sendAsFile:o=false}=e;const d={};if(i){d.disk_id=r}else{d.upload_id=r.toString().slice(1)}babelHelpers.classPrivateFieldLooseBase(this,Dr)[Dr].callMethod(m.RestMethod.imDiskFileCommit,{chat_id:t,message:l,template_id:a,file_template_id:s,as_file:o?"Y":"N",...d}).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,Bi)[Bi](a);babelHelpers.classPrivateFieldLooseBase(this,Jr)[Jr](s,0,m.FileStatus.error);console.error("commitFile error",e)}))}commitMessage(e){const s=babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e].dialogId;const a=babelHelpers.classPrivateFieldLooseBase(this,ci)[ci](s);const t=babelHelpers.classPrivateFieldLooseBase(this,Ar)[Ar].getFiles(e).map((e=>e.getServerFileId().toString().slice(1)));const r=babelHelpers.classPrivateFieldLooseBase(this,Ar)[Ar].getFiles(e).every((e=>e.getCustomData("sendAsFile")));return babelHelpers.classPrivateFieldLooseBase(this,Dr)[Dr].callMethod(m.RestMethod.imDiskFileCommit,{chat_id:a,message:babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e].text,template_id:babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e].tempMessageId,as_file:r?"Y":"N",upload_id:t})}sendSeparateMessagesWithFiles(e){const{uploaderId:s,text:a}=e;babelHelpers.classPrivateFieldLooseBase(this,pi)[pi](s,a);babelHelpers.classPrivateFieldLooseBase(this,ui)[ui](s,true);babelHelpers.classPrivateFieldLooseBase(this,fi)[fi](s)}sendMessageWithFiles(e){const{uploaderId:s,text:a}=e;babelHelpers.classPrivateFieldLooseBase(this,pi)[pi](s,a);babelHelpers.classPrivateFieldLooseBase(this,ui)[ui](s,true);babelHelpers.classPrivateFieldLooseBase(this,Hi)[Hi](s)}removeFileFromUploader(e){const{uploaderId:s,filesIds:a}=e;const t=babelHelpers.classPrivateFieldLooseBase(this,Ar)[Ar].getFiles(s).filter((e=>a.includes(e.getId())));t.forEach((e=>{e.remove()}));babelHelpers.classPrivateFieldLooseBase(this,bi)[bi](s,t)}destroy(){babelHelpers.classPrivateFieldLooseBase(this,Ar)[Ar].destroy()}}function Ii(e){const{dialogId:s,autoUpload:a}=e;const t=u.Utils.text.getUuidV4();const r=babelHelpers.classPrivateFieldLooseBase(this,ci)[ci](s);return this.checkDiskFolderId(s).then((e=>{babelHelpers.classPrivateFieldLooseBase(this,Ar)[Ar].createUploader({diskFolderId:e,uploaderId:t,autoUpload:a,chatId:r,dialogId:s});return t}))}function Mi({uploaderId:e,filesCount:s}){babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e].sourceFilesCount=s}function Ci(e){const{files:s,dialogId:a,autoUpload:t,sendAsFile:r=false}=e;return babelHelpers.classPrivateFieldLooseBase(this,Nr)[Nr]({dialogId:a,autoUpload:t}).then((e=>{const i=[];s.forEach((s=>{const t=babelHelpers.classPrivateFieldLooseBase(this,Yr)[Yr](s,a,e,r);i.push(t)}));const l=babelHelpers.classPrivateFieldLooseBase(this,Ar)[Ar].addFiles(i);babelHelpers.classPrivateFieldLooseBase(this,ni)[ni](e,l,a,t);babelHelpers.classPrivateFieldLooseBase(this,_r)[_r]({filesCount:s.length,uploaderId:e});return{uploaderFiles:l,uploaderId:e}}))}function wi(e){return babelHelpers.classPrivateFieldLooseBase(this,Kr)[Kr].dispatch("files/add",{id:e.tempFileId,chatId:e.chatId,authorId:f.Core.getUserId(),name:e.file.name,type:u.Utils.file.getFileTypeByExtension(e.file.ext),extension:e.file.ext,size:e.file.sizeInt,status:m.FileStatus.wait,progress:0,authorName:babelHelpers.classPrivateFieldLooseBase(this,di)[di]().name})}function Si(){babelHelpers.classPrivateFieldLooseBase(this,Ar)[Ar]=new Sr;babelHelpers.classPrivateFieldLooseBase(this,Ar)[Ar].subscribe(Sr.events.onFileAddStart,(e=>{const{file:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,ei)[ei](s)}));babelHelpers.classPrivateFieldLooseBase(this,Ar)[Ar].subscribe(Sr.events.onFileAdd,(e=>{const{file:s,uploaderId:a}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,si)[si](s);babelHelpers.classPrivateFieldLooseBase(this,hi)[hi](a,s.getId());babelHelpers.classPrivateFieldLooseBase(this,Hi)[Hi](a)}));babelHelpers.classPrivateFieldLooseBase(this,Ar)[Ar].subscribe(Sr.events.onFileUploadStart,(e=>{const{file:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,ai)[ai](s);this.emit(yi.event.uploadStart)}));babelHelpers.classPrivateFieldLooseBase(this,Ar)[Ar].subscribe(Sr.events.onFileUploadProgress,(e=>{const{file:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,Jr)[Jr](s.getId(),s.getProgress(),m.FileStatus.upload)}));babelHelpers.classPrivateFieldLooseBase(this,Ar)[Ar].subscribe(Sr.events.onFileUploadComplete,(async e=>{const{file:s,uploaderId:a}=e.getData();const t=s.getServerFileId().toString().slice(1);const r=s.getId();if(babelHelpers.classPrivateFieldLooseBase(this,$r)[$r](r)){babelHelpers.classPrivateFieldLooseBase(this,Gr)[Gr]({serverFileId:t,temporaryFileId:r})}babelHelpers.classPrivateFieldLooseBase(this,Jr)[Jr](r,s.getProgress(),m.FileStatus.wait);await babelHelpers.classPrivateFieldLooseBase(this,Qr)[Qr](s);babelHelpers.classPrivateFieldLooseBase(this,vi)[vi](a,r);void babelHelpers.classPrivateFieldLooseBase(this,zr)[zr](a);this.emit(yi.event.uploadComplete)}));babelHelpers.classPrivateFieldLooseBase(this,Ar)[Ar].subscribe(Sr.events.onFileUploadError,(e=>{const{file:s,error:a}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,Jr)[Jr](s.getId(),0,m.FileStatus.error);babelHelpers.classPrivateFieldLooseBase(this,Bi)[Bi](s.getCustomData("tempMessageId"));g.Notifier.file.handleUploadError(a);F.Logger.error("UploadingService: upload error",a);this.emit(yi.event.uploadError)}));babelHelpers.classPrivateFieldLooseBase(this,Ar)[Ar].subscribe(Sr.events.onFileUploadCancel,(e=>{const{tempMessageId:s,tempFileId:a}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,Zr)[Zr](s,a);this.emit(yi.event.uploadCancel)}))}function Oi(e){const s=[m.FileType.image,m.FileType.video];const a=babelHelpers.classPrivateFieldLooseBase(this,Kr)[Kr].getters["files/get"](e);return Boolean(a)&&s.includes(a.type)}function Ui(e){void babelHelpers.classPrivateFieldLooseBase(this,Kr)[Kr].dispatch("files/setTemporaryFileMapping",e)}function ji(e){return new Promise(((s,a)=>{babelHelpers.classPrivateFieldLooseBase(this,Er)[Er]=true;const t=babelHelpers.classPrivateFieldLooseBase(this,ci)[ci](e);babelHelpers.classPrivateFieldLooseBase(this,Dr)[Dr].callMethod(m.RestMethod.imDiskFolderGet,{chat_id:t}).then((a=>{const{ID:t}=a.data();babelHelpers.classPrivateFieldLooseBase(this,Er)[Er]=false;babelHelpers.classPrivateFieldLooseBase(this,Kr)[Kr].commit("chats/update",{dialogId:e,fields:{diskFolderId:t}});s(t)})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,Er)[Er]=false;a(e)}))}))}async function Ri(e){if(!babelHelpers.classPrivateFieldLooseBase(this,Li)[Li](e)){return}await this.commitMessage(e);babelHelpers.classPrivateFieldLooseBase(this,Ar)[Ar].destroyUploader(e)}async function Ki(e){const s=babelHelpers.classPrivateFieldLooseBase(this,ii)[ii](e.getBinary())===m.FileType.video||e.isAnimated();if(!s){return Promise.resolve()}const a=e.getServerFileId().toString().slice(1);const t=e.getClientPreview();if(!t){e.setCustomData("sendAsFile",true);return Promise.resolve()}const r=new FormData;r.append("id",a);r.append("previewFile",t,`preview_${e.getName()}.jpg`);return B.runAction(m.RestMethod.imDiskFilePreviewUpload,{data:r}).catch((([e])=>{console.error("imDiskFilePreviewUpload request error",e)}))}function Di(e,s,a,t){const r=u.Utils.text.getUuidV4();const i=u.Utils.text.getUuidV4();const l=babelHelpers.classPrivateFieldLooseBase(this,ci)[ci](s);return{tempMessageId:r,tempFileId:i,file:e,dialogId:s,chatId:l,uploaderId:a,sendAsFile:t}}function Ei(e,s,a){void babelHelpers.classPrivateFieldLooseBase(this,Kr)[Kr].dispatch("files/update",{id:e,fields:{progress:s===100?99:s,status:a}})}function Ti(e,s){const a=babelHelpers.classPrivateFieldLooseBase(this,Kr)[Kr].getters["messages/getById"](e);if(a){void babelHelpers.classPrivateFieldLooseBase(this,Kr)[Kr].dispatch("messages/delete",{id:e});void babelHelpers.classPrivateFieldLooseBase(this,Kr)[Kr].dispatch("files/delete",{id:s});const t=babelHelpers.classPrivateFieldLooseBase(this,Kr)[Kr].getters["chats/getByChatId"](a.chatId);const r=babelHelpers.classPrivateFieldLooseBase(this,Kr)[Kr].getters["messages/findLastChatMessageId"](a.chatId);if(r>-1){void babelHelpers.classPrivateFieldLooseBase(this,Kr)[Kr].dispatch("recent/update",{id:t.dialogId,fields:{messageId:r}})}else{void babelHelpers.classPrivateFieldLooseBase(this,Kr)[Kr].dispatch("recent/delete",{id:t.dialogId})}}}function Ai(e){const s=e.getId();const a=e.getBinary();const t=babelHelpers.classPrivateFieldLooseBase(this,ti)[ti](e);const r=e.getCustomData("sendAsFile");void babelHelpers.classPrivateFieldLooseBase(this,Kr)[Kr].dispatch("files/add",{id:s,chatId:e.getCustomData("chatId"),authorId:f.Core.getUserId(),name:a.name,size:e.getSize(),type:r?m.FileType.file:babelHelpers.classPrivateFieldLooseBase(this,ii)[ii](a),extension:babelHelpers.classPrivateFieldLooseBase(this,li)[li](a),status:e.isFailed()?m.FileStatus.error:m.FileStatus.progress,progress:0,authorName:babelHelpers.classPrivateFieldLooseBase(this,di)[di]().name,urlDownload:URL.createObjectURL(e.getBinary()),...t})}function xi(e){const s=babelHelpers.classPrivateFieldLooseBase(this,ti)[ti](e);void babelHelpers.classPrivateFieldLooseBase(this,Kr)[Kr].dispatch("files/update",{id:e.getId(),fields:{...s}})}function ki(e){void babelHelpers.classPrivateFieldLooseBase(this,Kr)[Kr].dispatch("files/update",{id:e.getId(),fields:{size:e.getSize()}})}function Ni(e){if(e.getCustomData("sendAsFile")){return{}}const s={blob:e.getPreviewUrl(),width:e.getPreviewWidth(),height:e.getPreviewHeight()};const a={};if(s.blob){a.image={width:s.width,height:s.height};a.urlPreview=s.blob}if(e.getClientPreview()){a.urlPreview=URL.createObjectURL(e.getClientPreview())}return a}function _i(e){return babelHelpers.classPrivateFieldLooseBase(this,oi)[oi](e).diskFolderId}function Vi(e){let s=m.FileType.file;if(e.type.startsWith("image")){s=m.FileType.image}else if(e.type.startsWith("video")){s=m.FileType.video}return s}function Xi(e){return e.name.split(".").splice(-1)[0]}function qi(e){return babelHelpers.classPrivateFieldLooseBase(this,Kr)[Kr].getters["chats/get"](e)}function $i(){const e=f.Core.getUserId();return babelHelpers.classPrivateFieldLooseBase(this,Kr)[Kr].getters["users/get"](e)}function Gi(e){var s;return(s=babelHelpers.classPrivateFieldLooseBase(this,oi)[oi](e))==null?void 0:s.chatId}function Wi(e,s,a,t){if(!babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e]){babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e]={previewCreatedStatus:{},previewSentStatus:{},dialogId:a,text:"",autoUpload:t}}s.forEach((s=>{const a=s.getId();if(!babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e].previewCreatedStatus){babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e].previewCreatedStatus={}}babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e].previewCreatedStatus[a]=false;babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e].previewSentStatus[a]=false}))}function zi(e,s){const a=babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e];if(a){s.forEach((s=>{const a=s.getId();if(babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e].previewCreatedStatus){delete babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e].previewCreatedStatus[a];delete babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e].previewSentStatus[a]}}))}}function Qi(e,s){babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e].previewCreatedStatus[s]=true}function Yi(e,s){babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e].previewSentStatus[s]=true}function Ji(e,s){babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e].text=s}function Zi(e,s){babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e].autoUpload=s}function el(e){const s={comment:{},files:[]};const a=this.getFiles(e);const t=babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e].text;const r=babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e].dialogId;const i=t.length>0;if(a.length>1&&i){s.comment={dialogId:r,text:t}}a.forEach((e=>{var l;if(e.getError()){return}const o=u.Utils.text.getUuidV4();e.setCustomData("messageId",o);if(a.length===1&&i){e.setCustomData("messageText",t)}s.files.push({fileIds:[e.getId()],tempMessageId:e.getCustomData("tempMessageId"),dialogId:r,text:(l=e.getCustomData("messageText"))!=null?l:""})}));return s}function sl(e){const s=u.Utils.text.getUuidV4();babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e].tempMessageId=s;const a=[];const t=this.getFiles(e);t.forEach((e=>{if(!e.getError()){a.push(e.getId())}}));const r=babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e].text;const i=babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e].dialogId;return{fileIds:a,tempMessageId:s,dialogId:i,text:r}}function al(e){if(!babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e]||!babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e].autoUpload||babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e].wasSent){return false}const{previewCreatedStatus:s}=babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e];return Object.values(s).every((e=>e===true))}function tl(e){if(!babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e]){return false}const{previewSentStatus:s}=babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e];return Object.values(s).every((e=>e===true))}function rl(e){if(!babelHelpers.classPrivateFieldLooseBase(this,Fi)[Fi](e)){return}babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e].wasSent=true;const s=babelHelpers.classPrivateFieldLooseBase(this,Pi)[Pi](e);void babelHelpers.classPrivateFieldLooseBase(this,xr)[xr].sendMessageWithFiles(s);this.start(e)}function il(e){if(!babelHelpers.classPrivateFieldLooseBase(this,Fi)[Fi](e)){return}babelHelpers.classPrivateFieldLooseBase(this,kr)[kr][e].wasSent=true;const{comment:s,files:a}=babelHelpers.classPrivateFieldLooseBase(this,gi)[gi](e);if(s.text){babelHelpers.classPrivateFieldLooseBase(this,xr)[xr].sendMessage(s)}a.forEach((e=>{void babelHelpers.classPrivateFieldLooseBase(this,xr)[xr].sendMessageWithFiles(e)}));this.start(e)}function ll(e,s){const a=u.Utils.text.getUuidV4();const t=e.id.slice(1);const r=`${a}|${t}`;return{tempMessageId:a,tempFileId:r,dialogId:s,file:e,chatId:babelHelpers.classPrivateFieldLooseBase(this,oi)[oi](s).chatId}}function ol(e){void babelHelpers.classPrivateFieldLooseBase(this,Kr)[Kr].dispatch("messages/update",{id:e,fields:{error:true}})}yi.event={uploadStart:"uploadStart",uploadComplete:"uploadComplete",uploadError:"uploadError",uploadCancel:"uploadCancel"};yi.instance=null;class dl{changeSetting(e,s){F.Logger.warn("SettingsService: changeSetting",e,s);void f.Core.getStore().dispatch("application/settings/set",{[e]:s});const a={data:{userId:f.Core.getUserId(),name:e,value:s}};B.runAction(m.RestMethod.imV2SettingsGeneralUpdate,a).catch((([e])=>{console.error("SettingsService: changeSetting error",e)}))}}class cl{async getDialogIdByUserCode(e){const s=await f.Core.getRestClient().callMethod(m.RestMethod.linesDialogGet,{USER_CODE:e}).catch((e=>{console.error("LinesService: error getting dialog id",e.error())}));const{dialog_id:a}=s.data();return a}}var nl=babelHelpers.classPrivateFieldLooseKey("sendBotContext");class bl{constructor(){Object.defineProperty(this,nl,{value:hl})}scheduleContextRequest(e,s){const a=t=>{const{dialogId:r}=t.getData();if(r!==e){return}L.EventEmitter.unsubscribe(m.EventType.dialog.onDialogInited,a);void babelHelpers.classPrivateFieldLooseBase(this,nl)[nl](e,s)};L.EventEmitter.subscribe(m.EventType.dialog.onDialogInited,a)}}function hl(e,s){return B.runAction(m.RestMethod.imV2ChatBotSendContext,{data:{dialogId:e,context:s}}).catch((([e])=>{console.error("BotContextService: send context error",e)}))}var vl=babelHelpers.classPrivateFieldLooseKey("sendAnalytics");class pl{constructor(){Object.defineProperty(this,vl,{value:ul})}async createChat({roleCode:e}){const s=new zs;const{newDialogId:a,newChatId:t}=await s.createChat({type:m.ChatType.copilot,copilotMainRole:e});babelHelpers.classPrivateFieldLooseBase(this,vl)[vl]({chatId:t,dialogId:a});await s.loadChatWithMessages(a);return a}}function ul({chatId:e,dialogId:s}){H.Analytics.getInstance().copilot.onCreateChat(e);H.Analytics.getInstance().ignoreNextChatOpen(s)}const gl={subscribe(e){void f.Core.getStore().dispatch("messages/comments/subscribe",e);return B.runAction(m.RestMethod.imV2ChatCommentSubscribe,{data:{postId:e,createIfNotExists:true,autoJoin:true}}).catch((([e])=>{console.error("CommentsService: subscribe error",e)}))},unsubscribe(e){void f.Core.getStore().dispatch("messages/comments/unsubscribe",e);return B.runAction(m.RestMethod.imV2ChatCommentUnsubscribe,{data:{postId:e,createIfNotExists:true,autoJoin:true}}).catch((([e])=>{console.error("CommentsService: unsubscribe error",e)}))},readAllChannelComments(e){const s=f.Core.getStore().getters["chats/get"](e,true);const a=f.Core.getStore().getters["counters/getChannelCommentsCounter"](s.chatId);if(a===0){return Promise.resolve()}void f.Core.getStore().dispatch("counters/readAllChannelComments",s.chatId);return B.runAction(m.RestMethod.imV2ChatCommentReadAll,{data:{dialogId:e}}).catch((([e])=>{console.error("CommentsService: readAllChannelComments error",e)}))}};const Pl=15e3;const Fl=5e3;var Ll=babelHelpers.classPrivateFieldLooseKey("dialogId");var Hl=babelHelpers.classPrivateFieldLooseKey("statusTimerMap");var fl=babelHelpers.classPrivateFieldLooseKey("requestDelayMap");var ml=babelHelpers.classPrivateFieldLooseKey("isActive");var Bl=babelHelpers.classPrivateFieldLooseKey("sendRequest");var yl=babelHelpers.classPrivateFieldLooseKey("isSelfChat");class Il{constructor(e){Object.defineProperty(this,yl,{value:wl});Object.defineProperty(this,Bl,{value:Cl});Object.defineProperty(this,ml,{value:Ml});Object.defineProperty(this,Ll,{writable:true,value:void 0});Object.defineProperty(this,Hl,{writable:true,value:{}});Object.defineProperty(this,fl,{writable:true,value:{}});babelHelpers.classPrivateFieldLooseBase(this,Ll)[Ll]=e}startAction(e){if(babelHelpers.classPrivateFieldLooseBase(this,ml)[ml](e)||babelHelpers.classPrivateFieldLooseBase(this,yl)[yl]()){return}babelHelpers.classPrivateFieldLooseBase(this,Hl)[Hl][e]=setTimeout((()=>{delete babelHelpers.classPrivateFieldLooseBase(this,Hl)[Hl][e]}),Pl);babelHelpers.classPrivateFieldLooseBase(this,fl)[fl][e]=setTimeout((()=>{babelHelpers.classPrivateFieldLooseBase(this,Bl)[Bl](e)}),Fl)}stopAction(e){clearTimeout(babelHelpers.classPrivateFieldLooseBase(this,Hl)[Hl][e]);delete babelHelpers.classPrivateFieldLooseBase(this,Hl)[Hl][e];clearTimeout(babelHelpers.classPrivateFieldLooseBase(this,fl)[fl][e]);delete babelHelpers.classPrivateFieldLooseBase(this,fl)[fl][e]}}function Ml(e){return Boolean(babelHelpers.classPrivateFieldLooseBase(this,Hl)[Hl][e])}function Cl(e){const s={dialogId:babelHelpers.classPrivateFieldLooseBase(this,Ll)[Ll],type:e};B.runAction(m.RestMethod.imV2ChatInputActionNotify,{data:s}).catch((([e])=>{console.error("InputSenderService: sendRequest error",e)}))}function wl(){return Number(babelHelpers.classPrivateFieldLooseBase(this,Ll)[Ll])===f.Core.getUserId()}e.RecentService=J;e.ChatService=zs;e.MessageService=ht;e.SendingService=Xt;e.NotificationService=Hr;e.DiskService=mr;e.UploadingService=yi;e.SettingsService=dl;e.LinesService=cl;e.BotContextService=bl;e.CopilotService=pl;e.CommentsService=gl;e.InputSenderService=Il})(this.BX.Messenger.v2.Service=this.BX.Messenger.v2.Service||{},BX?.Messenger?.v2?.Lib??{},BX?.Messenger?.v2?.Service??{},BX?.OpenLines?.v2?.Lib??{},BX?.Call?.Lib??{},BX?.Messenger?.v2?.Lib??{},BX?.Messenger?.v2?.Lib??{},BX?.Messenger?.v2?.Lib??{},BX?.Messenger?.v2?.Lib??{},BX?.Messenger?.v2?.Lib??{},BX?.Vue3?.Vuex??{},BX??{},BX??{},BX?.Messenger?.v2?.Lib??{},BX??{},BX?.Messenger?.v2?.Lib??{},BX?.Messenger?.v2?.Lib??{},BX?.UI?.Uploader??{},BX?.Messenger?.v2?.Lib??{},BX?.Event??{},BX?.Messenger?.v2?.Lib??{},BX?.Messenger?.v2?.Application??{},BX?.Messenger?.v2?.Const??{},BX?.Messenger?.v2?.Lib??{});
//# sourceMappingURL=registry.bundle.map.js