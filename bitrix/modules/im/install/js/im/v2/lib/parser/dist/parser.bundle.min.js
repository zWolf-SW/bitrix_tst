this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,t,r,s,i){"use strict";const n={decode(e){if(e.startsWith("/me")){return`[i]${e.substr(4)}[/i]`}if(e.startsWith("/loud")){return`[size=20]${e.substr(6)}[/size]`}return e},purify(e){if(e.startsWith("/me")){return e.substr(4)}if(e.startsWith("/loud")){return e.substr(6)}return e}};const a={_tagsReplacement:[],_putReplacement:[],_sendReplacement:[],_codeReplacement:[],clean(){this._tagsReplacement=[];this._putReplacement=[];this._sendReplacement=[];this._codeReplacement=[]},cutTags(e){e=e.replaceAll(/\[(.+?)](.*?)\[\/(.+?)]/gi,(e=>{const t=this._tagsReplacement.length;this._tagsReplacement.push(e);return"####REPLACEMENT_TAG_"+t+"####"}));return e},recoverTags(e){this._tagsReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_TAG_"+r+"####",t)}));return e},cutPutTag(e){e=e.replace(/\[PUT(?:=(.+?))?](.+?)?\[\/PUT]/gi,(e=>{const t=this._putReplacement.length;this._putReplacement.push(e);return"####REPLACEMENT_PUT_"+t+"####"}));return e},recoverPutTag(e){this._putReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_PUT_"+r+"####",t)}));return e},cutSendTag(e){e=e.replace(/\[SEND(?:=(.+?))?](.+?)?\[\/SEND]/gi,(e=>{const t=this._sendReplacement.length;this._sendReplacement.push(e);return"####REPLACEMENT_SEND_"+t+"####"}));return e},recoverSendTag(e){this._sendReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_SEND_"+r+"####",t)}));return e},cutCodeTag(e){e=e.replace(/\[CODE](<br \/>)?(.*?)\[\/CODE]/gis,(e=>{const t=this._codeReplacement.length;this._codeReplacement.push(e);return"####REPLACEMENT_CODE_"+t+"####"}));return e},recoverCodeTag(e){this._codeReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_CODE_"+r+"####",t)}));if(this._sendReplacement.length>0){do{this._sendReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_SEND_"+r+"####",t)}))}while(e.includes("####REPLACEMENT_SEND_"))}return e},recoverRecursionTag(e){if(this._sendReplacement.length>0){do{this._sendReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_SEND_"+r+"####",t)}))}while(e.includes("####REPLACEMENT_SEND_"))}e=e.split("####REPLACEMENT_SP_").join("####REPLACEMENT_PUT_");if(this._putReplacement.length>0){do{this._putReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_PUT_"+r+"####",t)}))}while(e.includes("####REPLACEMENT_PUT_"))}return e}};const c=i.Extension.getSettings("im.v2.lib.parser");const o=c.get("v2");const l=()=>o?BX.Messenger.v2.Application.Core:BX.Messenger.Embedding.Application.Core;const g=()=>o?BX.Messenger.v2.Lib.Utils:BX.Messenger.Embedding.Lib.Utils;const d=()=>o?BX.Messenger.v2.Lib.Logger:BX.Messenger.Embedding.Lib.Logger;const u=()=>o?BX.Messenger.v2.Const:BX.Messenger.Embedding.Const;const p=()=>o?BX.Messenger.v2.Lib.SmileManager:BX.Messenger.Embedding.Lib.SmileManager;const m=()=>{if(o){const e=BX.Messenger.v2.Const.Settings.message.bigSmiles;return l().getStore().getters["application/settings/get"](e)}return l().getStore().getters["application/getOption"]("bigSmileEnable")};const h=10;const f={recursiveReplace(e,t,r){if(!i.Type.isStringFilled(e)){return e}let s=0;let n=true;do{n=false;s++;e=e.replace(t,((...e)=>{n=true;return r(...e)}))}while(n&&s<=h);return e},getFinalContextTag(e){const t=e.match(/(chat\d+|(\d+):(\d+))\/(\d+)/i);if(!t){return""}let[,r,s,i,n]=t;if(r.toString().startsWith("chat")){if(r==="chat0"){return""}return e}s=Number.parseInt(s,10);i=Number.parseInt(i,10);if(l().getUserId()===s){return`${i}/${n}`}if(l().getUserId()===i){return`${s}/${n}`}return""},getDialogIdFromFinalContextTag(e){if(!/^(chat\d+|\d+)\/\d+$/.test(e)){return""}const[t]=e.split("/");return t},getDialogIdByChatId(e){const t=l().store.getters["chats/getByChatId"](e);if(!t){return""}return t.dialogId}};const{FileType:T,FileIconType:x,AttachDescription:E}=u();const y={getIcon(e,t=""){return t},addIconToShortText(e){let{text:t}=e;const{attach:r,files:s}=e;if(i.Type.isArrayFilled(s)||s===true){t=this.getTextForFile(t,s)}else if(r===true||i.Type.isArrayFilled(r)||i.Type.isStringFilled(r)){t=this.getTextForAttach(t,r)}return t.trim()},getQuoteBlock(){const e=this.getIcon(x.quote);if(e){return e}return`[${i.Loc.getMessage("IM_PARSER_ICON_TYPE_QUOTE")}]`},getCodeBlock(){const e=this.getIcon(x.code);if(e){return e}return`[${i.Loc.getMessage("IM_PARSER_ICON_TYPE_CODE")}]`},getImageBlock(){const e=this.getIcon(x.image);if(e){return e}return`[${i.Loc.getMessage("IM_PARSER_ICON_TYPE_IMAGE")}]`},getFileBlock(){const e=this.getIcon(x.file);if(e){return e}return`[${i.Loc.getMessage("IM_PARSER_ICON_TYPE_FILE")}]`},getTextForFile(e,t){let r=e;if(i.Type.isArray(t)&&t.length>0){r=this.getIconTextForFile(e,t)}else if(t===true){r=this.getIconTextForFileType(e,x.file)}return r},getTextForAttach(e,t){let r="";if(i.Type.isArray(t)&&t.length>0){const[e]=t;if(i.Type.isStringFilled(e.description)){r=e.description}}else if(i.Type.isStringFilled(t)){r=t}if(i.Type.isStringFilled(r)){if(r===E.skipMessage){r=""}else{r=de.purifyText(r)}}else{const e=this.getIcon(x.attach);if(e){r=`${e} ${i.Loc.getMessage("IM_PARSER_ICON_TYPE_ATTACH")}`}else{r=`[${i.Loc.getMessage("IM_PARSER_ICON_TYPE_ATTACH")}]`}}return`${e} ${r}`.trim()},getIconTextForFileType(e,t=x.file){let r=e;const s=this.getIcon(t);const n=i.Loc.getMessage(`IM_PARSER_ICON_TYPE_${t.toUpperCase()}`);if(s){const t=e.replace(/(\s|\n)/gi,"").length>0;const i=t?e:n;r=`${s} ${i}`}else{r=`[${n}] ${e}`}return r.trim()},getIconTextForFile(e,t){const r=e.replace(/(\s|\n)/gi,"").length>0;const[s]=t;if(!s||!s.type){return e}const n=t.every((e=>[x.image,x.video].includes(e.type)));if(s.type===T.image&&t.length===1){return this.getIconTextForFileType(e,x.image)}else if(n&&t.length>1){return this.getIconTextForFileType(e,x.gallery)}else if(s.type===T.audio){return this.getIconTextForFileType(e,x.audio)}else if(s.type===T.video){return this.getIconTextForFileType(e,x.video)}else{const t=this.getIcon(x.file);if(t){const i=r?e:"";e=`${t} ${s.name} ${i}`}else{e=`${i.Loc.getMessage("IM_PARSER_ICON_TYPE_FILE")}: ${s.name} ${e}`}return e.trim()}}};let b=e=>e,_,I;const{EventType:R}=u();const M="&gt;&gt;";const S="none";const L={decodeArrowQuote(e){if(!e.includes(M)){return e}let t=false;const r=e.split("<br />");for(let e=0;e<r.length;e++){if(!r[e].startsWith(M)){continue}const s=e;const i=`<div data-context="${S}" class="bx-im-message-quote --inline">`;const n='<div class="bx-im-message-quote__wrap">';const a="</div>";r[s]=r[s].replace(M,`${i}${n}`);while(++e<r.length&&r[e].startsWith(M)){r[e]=r[e].replace(M,"")}const c=e-1;r[c]+=`${a}${a}`;t=true}if(!t){return e}return r.join("<br />")},purifyArrowQuote(e,t=" "){e=e.replace(new RegExp(`^(${M}(.*))`,"gim"),y.getQuoteBlock()+t);return e},decodeQuote(e,{contextDialogId:t=""}={}){const r=a.cutTags(e);const s=r.replaceAll(/-{54}(<br \/>(.*?)\[(.*?)]( #(?:chat\d+|\d+:\d+)\/\d+)?)?<br \/>(.*?)-{54}(<br \/>)?/gs,((e,r,s,n,a,c)=>{const o=v(s,n,c);const l=N(s,n);const g=A(a,t);const d=i.Tag.render(_||(_=b`
					<div class='bx-im-message-quote' data-context='${0}'>
						<div class='bx-im-message-quote__wrap'>
							${0}
							<div class='bx-im-message-quote__text'>${0}</div>
						</div>
					</div>
				`),g,l,o);return d.outerHTML}));return a.recoverTags(s)},purifyQuote(e,t=" "){return e.replace(/-{54}(.*?)-{54}/gims,y.getQuoteBlock()+t)},decodeCode(e){return e.replace(/\[code](<br \/>)?([\0-\uFFFF]*?)\[\/code](<br \/>)?/gis,((e,t,r)=>i.Dom.create({tag:"div",attrs:{className:"bx-im-message-content-code"},html:r}).outerHTML))},purifyCode(e,t=" "){return e.replace(/\[code](<br \/>)?([\0-\uFFFF]*?)\[\/code]/gis,y.getCodeBlock()+t)},executeClickEvent(e){if(!e.target.className.startsWith("bx-im-message-quote")&&!(e.target.parentNode&&e.target.parentNode.className.startsWith("bx-im-message-quote"))){return}const t=g().dom.recursiveBackwardNodeSearch(e.target,"bx-im-message-quote");if(!t||t.dataset.context===S){return}const[s,i]=t.dataset.context.split("/");r.EventEmitter.emit(R.dialog.goToMessageContext,{messageId:Number.parseInt(i,10),dialogId:s.toString()})}};const v=(e,t,r)=>{const s=e&&t;if(!s&&!r){return String(t)}const i="<br />";if(r.endsWith(i)){return r.slice(0,-i.length)}return r};const N=(e,t)=>{const r=e&&t;if(!r){return""}return i.Tag.render(I||(I=b`
		<div class='bx-im-message-quote__name'>
			<div class="bx-im-message-quote__name-text">${0}</div>
			<div class="bx-im-message-quote__name-time">${0}</div>
		</div>
	`),e.trim(),t.trim())};const A=(e,t)=>{if(!e){return S}const r=e.trim().slice(1);const s=f.getFinalContextTag(r);if(!C(s,t)){return S}return s};const C=(e,t)=>{const r=f.getDialogIdFromFinalContextTag(e);return r===t};const P={decodeLink(e){return e.replaceAll(/>((https|http):\/\/(\S+)\.(jpg|jpeg|png|gif|webp)(\?\S+[^<])?)<\/a>/gi,((e,t)=>{const r=i.Text.decode(t);if(!/(\.(jpg|jpeg|png|gif|webp)\?|\.(jpg|jpeg|png|gif|webp)$)/i.test(r)||r.toLowerCase().indexOf("/docs/pub/")>0||r.toLowerCase().indexOf("logout=yes")>0){return e}if(!g().text.checkUrl(r)){return e}const s=i.Dom.create({tag:"span",attrs:{className:"bx-im-message-image"},children:[i.Dom.create({tag:"img",attrs:{className:"bx-im-message-image-source",src:r},events:{error(){P.hideErrorImage(this)}}})]}).outerHTML;return`>${s}</a>`}))},purifyLink(e){return e.replaceAll(/(.)?(https?:\/\/\S+)/gi,((e,t,r)=>{if(!B(t,r)){return e}const s=t||"";return`${s}${y.getImageBlock()}`}))},decodeIcon(e){let t=0;const r=m();if(r){t=e.replaceAll(/\[icon=([^\]]*)]/gi,"").trim().length}return e.replaceAll(/\[icon=([^\]]*)]/gi,(e=>{let s=e.match(/icon=(\S+[^\s!"'),.;>?\]])/i);if(s&&s[1]){s=s[1]}else{return""}if(!g().text.checkUrl(s)){return e}const n={src:s,border:0};const a=e.match(/size=(\d+)/i);if(a&&a[1]){n.width=a[1];n.height=a[1]}else{const t=e.match(/width=(\d+)/i);if(t&&t[1]){n.width=t[1]}const r=e.match(/height=(\d+)/i);if(r&&r[1]){n.height=r[1]}if(n.width&&!n.height){n.height=n.width}else if(n.height&&!n.width){n.width=n.height}else if(n.height&&n.width);else{n.width=20;n.height=20}}n.width=n.width>100?100:n.width;n.height=n.height>100?100:n.height;if(r&&t===0&&n.width===n.height&&n.width===20){n.width=40;n.height=40}let c=e.match(/title=(.*[^\s\]])/i);if(c&&c[1]){c=c[1];if(c.includes("width=")){c=c.slice(0,Math.max(0,c.indexOf("width=")))}if(c.includes("height=")){c=c.slice(0,Math.max(0,c.indexOf("height=")))}if(c.includes("size=")){c=c.slice(0,Math.max(0,c.indexOf("size=")))}if(c){n.title=i.Text.decode(c).trim();n.alt=n.title}}return i.Dom.create({tag:"img",attrs:{className:"bx-smile bx-icon",...n}}).outerHTML}))},purifyIcon(e){return e.replaceAll(/\[icon=([^\]]*)]/gi,(e=>{let t=e.match(/title=(.*[^\s\]])/i);if(t&&t[1]){t=t[1];if(t.includes("width=")){t=t.slice(0,Math.max(0,t.indexOf("width=")))}if(t.includes("height=")){t=t.slice(0,Math.max(0,t.indexOf("height=")))}if(t.includes("size=")){t=t.slice(0,Math.max(0,t.indexOf("size=")))}if(t){t=`(${t.trim()})`}}else{t=`(${i.Loc.getMessage("IM_PARSER_IMAGE_ICON")})`}return t}))},hideErrorImage(e){const t=e;if(t&&t.parentNode){t.parentNode.innerHTML=`<a href="${encodeURI(e.src)}" target="_blank">${e.src}</a>`}}};function $(e){return e.toLowerCase().indexOf("/docs/pub/")>0}function F(e){return e.toLowerCase().indexOf("logout=yes")>0}function D(e){const[t]=e.split("?");return/\.(jpg|jpeg|png|gif|webp)$/i.test(t)}function w(e){const t=new Set([">","]"," "]);return i.Type.isStringFilled(e)&&!t.has(e)}const B=(e,t)=>D(t)&&!$(t)&&!F(t)&&!w(e);let k=e=>e,O;const U=Object.freeze({Default:1,Big:1.6});const H=(e,t,r=U)=>{const s=e.replaceAll(new RegExp(t,"g"),"");const i=s.trim().length===0;const n=new RegExp(`(?:(?:${t})\\s*){4,}`);if(i&&!n.test(e)){return r.Big}return r.Default};const j=e=>{const t=e.reduce(((e,t)=>{const{image:r,typing:s,definition:n,name:a,width:c,height:o}=t;const l=i.Tag.render(O||(O=k`
			<img
				src="${0}"
				data-code="${0}"
				data-definition="${0}"
				title="${0}"
				alt="${0}"
				class="bx-smile bx-im-message-base__text_smile"
				style="width: ${0}px; height: ${0}px;"
				draggable="false"
			/>
		`),r,s,n,a!=null?a:s,s,c,o);return{...e,[s]:l}}),{});return t};const X=function(e,t,r){const s=e.slice(0,r+t.length);const i=g().text.escapeRegex(t);const n=new RegExp(`(?:^|&quot;|>|(?:${this.pattern})|\\s|<)(?:${i})$`);return s.match(n)};const q={typings:null,pattern:"",loadSmilePatterns(){var e,t;if(!p()){return}const r=p().getInstance();const s=(e=(t=r.smileList)==null?void 0:t.smiles)!=null?e:[];if(s.length===0){return}const i=[...s].sort(((e,t)=>t.typing.localeCompare(e.typing)));this.pattern=i.map((e=>g().text.escapeRegex(e.typing))).join("|");this.typings=j(i)},decodeSmile(e,t={}){if(!this.typings){this.loadSmilePatterns()}if(!this.pattern){return e}let r;if(i.Type.isBoolean(t.enableBigSmile)){r=t.enableBigSmile}else{r=m()}const s=i.Type.isObjectLike(t.ratioConfig)?t.ratioConfig:U;const n=r?H(e,this.pattern,s):s.Default;const a=`(?:(?:${this.pattern})(?=(?:(?:${this.pattern})|\\s|&quot;|<|$)))`;const c=new RegExp(a,"g");const o=e.replaceAll(c,((t,r)=>{const s=X.call(this,e,t,r);if(!s){return t}const a=this.typings[t].cloneNode();const{width:c,height:o}=a.style;i.Dom.style(a,"width",`${Number.parseInt(c,10)*n}px`);i.Dom.style(a,"height",`${Number.parseInt(o,10)*n}px`);return a.outerHTML}));return o}};const Q={decode(e,t={}){const{urlTarget:r="_blank",removeLinks:s=false}=t;e=e.replace(/\[url(?:=([^[\]]+))?](.*?)\[\/url]/gis,((e,t,s)=>{const n=i.Text.decode(t||s);if(!g().text.checkUrl(n)){return s}return i.Dom.create({tag:"a",attrs:{href:n,target:r},html:s}).outerHTML}));e=e.replace(/\[url(?:=(.+?[^[\]]))?](.*?)\[\/url]/gis,((e,t,s)=>{let n=i.Text.decode(t||s);if(!g().text.checkUrl(n)){return s}if(!n.slice(n.lastIndexOf("[")).includes("]")){if(s.startsWith("]")){n=`${n}]`;s=s.slice(1)}else if(s.startsWith("=")){const e=i.Text.decode(s.slice(1,s.lastIndexOf("]")));n=`${n}]=${e}`;s=s.slice(s.lastIndexOf("]")+1)}}return i.Dom.create({tag:"a",attrs:{href:n,target:r},html:s}).outerHTML}));if(s){e=e.replace(/<a.*?href="([^"]*)".*?>(.*?)<\/a>/gi,"$2")}return e},purify(e){e=e.replace(/\[url(?:=([^\[\]]+))?](.*?)\[\/url]/gis,((e,t,r)=>r?r:t));e=e.replace(/\[url(?:=(.+))?](.*?)\[\/url]/gis,((e,t,r)=>r?r:t));return e},removeSimpleUrlTag(e){e=e.replace(/\[url](.*?)\[\/url]/gis,((e,t)=>t));return e}};const W={decode(e){e=f.recursiveReplace(e,/\[b]([^[]*(?:\[(?!b]|\/b])[^[]*)*)\[\/b]/gi,((e,t)=>"<b>"+t+"</b>"));e=f.recursiveReplace(e,/\[u]([^[]*(?:\[(?!u]|\/u])[^[]*)*)\[\/u]/gi,((e,t)=>"<u>"+t+"</u>"));e=f.recursiveReplace(e,/\[i]([^[]*(?:\[(?!i]|\/i])[^[]*)*)\[\/i]/gi,((e,t)=>"<i>"+t+"</i>"));e=f.recursiveReplace(e,/\[s]([^[]*(?:\[(?!s]|\/s])[^[]*)*)\[\/s]/gi,((e,t)=>"<s>"+t+"</s>"));e=f.recursiveReplace(e,/\[size=(\d+)(?:pt|px)?](.*?)\[\/size]/gis,((e,t,r)=>{t=Number.parseInt(t,10);if(t<=8){t=8}else if(t>=30){t=30}return i.Dom.create({tag:"span",style:{fontSize:`${t}px`},html:r}).outerHTML}));e=f.recursiveReplace(e,/\[color=#([0-9a-f]{3}|[0-9a-f]{6})](.*?)\[\/color]/gis,((e,t,r)=>i.Dom.create({tag:"span",style:{color:"#"+t},html:r}).outerHTML));return e},purify(e,t=true){if(t){e=f.recursiveReplace(e,/\[s]([^[]*(?:\[(?!s]|\/s])[^[]*)*)\[\/s]/gi,(()=>" "))}e=f.recursiveReplace(e,/\[b]([^[]*(?:\[(?!b]|\/b])[^[]*)*)\[\/b]/gi,((e,t)=>t));e=f.recursiveReplace(e,/\[u]([^[]*(?:\[(?!u]|\/u])[^[]*)*)\[\/u]/gi,((e,t)=>t));e=f.recursiveReplace(e,/\[i]([^[]*(?:\[(?!i]|\/i])[^[]*)*)\[\/i]/gi,((e,t)=>t));e=f.recursiveReplace(e,/\[s]([^[]*(?:\[(?!s]|\/s])[^[]*)*)\[\/s]/gi,((e,t)=>t));e=f.recursiveReplace(e,/\[size=(\d+)(?:pt|px)?](.*?)\[\/size]/gis,((e,t,r)=>r));e=f.recursiveReplace(e,/\[color=#([0-9a-f]{3}|[0-9a-f]{6})](.*?)\[\/color]/gis,((e,t,r)=>r));return e}};let z=e=>e,G;const Y={decode(e){let t=e;t=t.replaceAll(/\[like]/gi,`<span class="bx-im-lines-vote-like" title="${i.Loc.getMessage("IM_PARSER_LINES_RATING_LIKE")}"></span>`);t=t.replaceAll(/\[dislike]/gi,`<span class="bx-im-lines-vote-dislike" title="${i.Loc.getMessage("IM_PARSER_LINES_RATING_DISLIKE")}"></span>`);t=t.replaceAll(/\[rating=([1-5])]/gi,((e,t)=>{const r=i.Tag.render(G||(G=z`
				<span class="bx-im-lines-rating" title="${0} - ${0}">
					<span class="bx-im-lines-rating-selected" style="width: ${0}%"></span>
				</span>
			`),i.Loc.getMessage("IM_PARSER_LINES_RATING"),t,t*20);return r.outerHTML}));return t},purify(e){let t=e;t=t.replaceAll(/\[like]/gi,i.Loc.getMessage("IM_PARSER_LINES_RATING_LIKE"));t=t.replaceAll(/\[dislike]/gi,i.Loc.getMessage("IM_PARSER_LINES_RATING_DISLIKE"));t=t.replaceAll(/\[rating=([1-5])]/gi,(()=>`[${i.Loc.getMessage("IM_PARSER_LINES_RATING")}] `));return t}};const{EventType:K}=u();const J="\\d{4}-\\d{2}-\\d{2}T[0-2]\\d:[0-5]\\d:[0-5]\\d[+-][0-2]\\d:[0-5]\\d";const V={put:"put",send:"send"};const Z={decodePut(e){e=e.replace(/\[PUT(?:=(?:.+?))?](?:.+?)?\[\/PUT]/gi,(e=>e.replace(/\[PUT(?:=(.+))?](.+?)?\[\/PUT]/gi,((e,t,r)=>{r=r?r:t;t=t?t:r;r=i.Text.decode(r);t=i.Text.decode(t).replace("<br />","\n");if(!r.trim()){return""}r=r.replace(/<(\w+)[^>]*>(.*?)<\/\1>/i,"$2",r);r=r.replace(/\[(\w+)[^\]]*](.*?)\[\/\1]/i,"$2",r);return this._getHtmlForAction("put",r,t)}))));return e},purifyPut(e){e=e.replace(/\[PUT(?:=(?:.+?))?](?:.+?)?\[\/PUT]/gi,(e=>e.replace(/\[PUT(?:=(.+))?](.+?)?\[\/PUT]/gi,((e,t,r)=>r?r:t))));return e},decodeSend(e){e=e.replace(/\[SEND(?:=(?:.+?))?](?:.+?)?\[\/SEND]/gi,(e=>e.replace(/\[SEND(?:=(.+))?](.+?)?\[\/SEND]/gi,((e,t,r)=>{r=r?r:t;t=t?t:r;r=i.Text.decode(r);t=i.Text.decode(t).replace("<br />","\n");if(!r.trim()){return""}r=r.replace(/<(\w+)[^>]*>(.*?)<\\1>/i,"$2",r);r=r.replace(/\[(\w+)[^\]]*](.*?)\[\/\1]/i,"$2",r);t=t.split("####REPLACEMENT_PUT_").join("####REPLACEMENT_SP_");return this._getHtmlForAction("send",r,t)}))));return e},purifySend(e){e=e.replace(/\[SEND(?:=(?:.+?))?](?:.+?)?\[\/SEND]/gi,(e=>e.replace(/\[SEND(?:=(.+))?](.+?)?\[\/SEND]/gi,((e,t,r)=>r?r:t))));return e},decodeDate(e){e=e.replace(RegExp("\\[DATE=("+J+")](.+?)\\[\\/DATE]","ig"),((e,t,r)=>{r=r.replace(/<(\w+)[^>]*>(.*?)<\\1>/i,"$2",r);r=r.replace(/\[(\w+)[^\]]*](.*?)\[\/\1]/i,"$2",r);return this._getHtmlForAction("date",r,t)}));return e},purifyDate(e){const t=g().date.atomRegexpString;e=e.replace(RegExp("[DATE=("+t+")](.+?)[/DATE]","ig"),((e,t,r)=>r));return e},_getHtmlForAction(e,t,r){return i.Dom.create({tag:"span",attrs:{className:"bx-im-message-command-wrap"},children:[i.Dom.create({tag:"span",attrs:{className:"bx-im-message-command","data-entity":e},text:t}),i.Dom.create({tag:"span",attrs:{className:"bx-im-message-command-data"},text:r})]}).outerHTML},executeClickEvent(e){var t;if(!i.Dom.hasClass(e.target,"bx-im-message-command")){return}const s=e.target;const n=ee(s);const a=(t=te(n))!=null?t:"";if(s.dataset.entity===V.put){const{innerText:e=""}=s.parentElement.querySelector(".bx-im-message-command-data");if(!e){return}r.EventEmitter.emit(K.textarea.insertText,{text:e,dialogId:a})}else if(s.dataset.entity===V.send){const{innerText:e=""}=s.parentElement.querySelector(".bx-im-message-command-data");if(!e){return}r.EventEmitter.emit(K.textarea.sendMessage,{text:e,dialogId:a})}}};const ee=e=>{const t=e.closest(".bx-im-message-base__wrap");if(!t||!t.dataset.id){return null}return t.dataset.id};const te=e=>{const t=l().getStore().getters["messages/getById"](e);if(!t){return null}const r=l().getStore().getters["chats/getByChatId"](t.chatId);if(!r){return null}return r.dialogId};const{MessageMentionType:re}=u();const se={decode(e){let t=e;t=t.replaceAll(/\[call(?:=([\d #()+./-]+))?](.+?)\[\/call]/gi,((e,t,r)=>{if(!r){return e}let s="";if(t){s=t}else if(g.call.isNumber(r)){s=r}else{return e}return i.Dom.create({tag:"span",attrs:{className:"bx-im-mention","data-type":re.call,"data-destination":s},text:i.Text.decode(r)}).outerHTML}));t=t.replaceAll(/\[pch=(\d+)](.*?)\[\/pch]/gi,((e,t,r)=>""));return t},purify(e){let t=e;t=t.replaceAll(/\[call(?:=([\d #()+./-]+))?](.+?)\[\/call]/gi,((e,t,r)=>r||t));t=t.replaceAll(/\[pch=(\d+)](.*?)\[\/pch]/gi,((e,t,r)=>r));return t}};const{UserType:ie,EventType:ne,MessageMentionType:ae}=u();const ce={decode(e){e=e.replace(/\[USER=([0-9]+)( REPLACE)?](.*?)\[\/USER]/gi,((e,t,r,s)=>{t=Number.parseInt(t,10);if(!i.Type.isNumber(t)||t===0){return s}const n=l().getStore().getters["users/get"](t);if(r||!s){if(n){s=n.name}}else{s=i.Text.decode(s)}if(!s){s=`User ${t}`}let a="bx-im-mention";if(l().getUserId()===t){a+=" --highlight"}if(n&&n.type===ie.extranet){a+=" --extranet"}return i.Dom.create({tag:"span",attrs:{className:a,"data-type":ae.user,"data-value":t},text:s}).outerHTML}));e=e.replace(/\[chat=(imol\|)?(\d+)](.*?)\[\/chat]/gi,((e,t,r,s)=>{if(r===0){return s}let n=s;if(n){n=i.Text.decode(n)}else{const e=l().store.getters["chats/get"](`chat${r}`);n=e?e.name:`Chat ${r}`}return i.Dom.create({tag:"span",attrs:{className:"bx-im-mention","data-type":t?ae.lines:ae.chat,"data-value":t?`imol|${r}`:`chat${r}`},text:n}).outerHTML}));e=e.replace(/\[context=((?:chat\d+|\d+:\d+)\/(\d+))](.*?)\[\/context]/gis,((e,t,r,s)=>{if(!s){return""}s=i.Text.decode(s);t=f.getFinalContextTag(t);if(!t){return s}const n=t.split("/")[0];let a="";r=Number.parseInt(r,10);if(i.Type.isNumber(r)&&r>0){const e=l().store.getters["messages/getById"](r);if(e){a=de.purifyMessage(e);const t=l().store.getters["users/get"](e.authorId);if(t){a=`${t.name}: ${a}`}}}if(!i.Type.isStringFilled(a)){a=i.Loc.getMessage("IM_PARSER_MENTION_DIALOG")}return i.Dom.create({tag:"span",attrs:{className:"bx-im-mention","data-type":ae.context,"data-dialog-id":n,"data-message-id":r,title:a},text:s}).outerHTML}));return e},purify(e){e=e.replace(/\[USER=([0-9]+)( REPLACE)?](.*?)\[\/USER]/gi,((e,t,r,s)=>{t=Number.parseInt(t,10);if(!i.Type.isNumber(t)||t===0){return s}if(r||!s){const e=l().getStore().getters["users/get"](t);if(e){s=e.name}}else{s=i.Text.decode(s)}if(!s){s=`User ${t}`}return s}));e=e.replace(/\[CHAT=(imol\|)?(\d+)](.*?)\[\/CHAT]/gi,((e,t,r,s)=>{r=Number.parseInt(r,10);if(!s){const e=l().store.getters["chats/get"]("chat"+r);s=e?e.name:"Chat "+r}return s}));e=e.replace(/\[context=(chat\d+|\d+:\d+)\/(\d+)](.*?)\[\/context]/gis,((e,t,r,s)=>{if(!s){const e=l().store.getters["chats/get"](t);s=e?e.name:"Dialog "+t}return s}));return e},executeClickEvent(e){if(!i.Dom.hasClass(e.target,"bx-im-mention")){return}if(e.target.dataset.type===ae.user||e.target.dataset.type===ae.chat){void s.Messenger.openChat(e.target.dataset.value)}else if(e.target.dataset.type===ae.lines){const t=e.target.dataset.value;if(g().dialog.isLinesHistoryId(t)){void s.Messenger.openLinesHistory(t)}else if(g().dialog.isLinesExternalId(t)){void s.Messenger.openLines(t)}}else if(e.target.dataset.type===ae.context){r.EventEmitter.emit(ne.dialog.goToMessageContext,{messageId:Number.parseInt(e.target.dataset.messageId,10),dialogId:e.target.dataset.dialogId.toString()})}else if(e.target.dataset.type===ae.call){if(g().call.isNumber(e.target.dataset.destination)){void s.Messenger.startPhoneCall(e.target.dataset.destination)}}}};const oe={decodeNewLine(e){e=e.replace(/\n/gi,"<br />");e=e.replace(/\[BR]/gi,"<br />");return e},purifyNewLine(e,t=" "){if(t!=="\n"){e=e.replace(/\n/gi,t)}e=e.replace(/\[BR]/gi,t);return e},purifyBreakLine(e,t=" "){e=e.replace(/<br><br \/>/gi,"<br />");e=e.replace(/<br \/><br>/gi,"<br />");e=e.replace(/\[BR]/gi,"<br />");e=e.replace(/<br \/>/gi,t);return e},decodeTabulation(e){e=e.replace(/( ){4}/gi,"\t");e=e.replace(/\t/gi,"&nbsp;&nbsp;&nbsp;&nbsp;");return e},purifyTabulation(e){e=e.replace(/&nbsp;&nbsp;&nbsp;&nbsp;/gi," ");return e},purifyNbsp(e){e=e.replace(/&nbsp;/gi," ");return e},removeDuplicateTags(e){if(e.substr(-6)==="<br />"){e=e.substr(0,e.length-6)}e=e.replace(/<br><br \/>/gi,"<br />");e=e.replace(/<br \/><br>/gi,"<br />");return e}};const{FileIconType:le}=u();const ge={decode(e){const t=y.getIcon(le.file);let r;if(t){r=`${t} ${i.Loc.getMessage("IM_PARSER_ICON_TYPE_FILE")}`}else{r=`[${i.Loc.getMessage("IM_PARSER_ICON_TYPE_FILE")}]`}e=e.replace(/\[disk=\d+]/gi,r);return e},purify(e){return this.decode(e)}};const de={decodeMessage(e){const t=l().store.getters["messages/getMessageFiles"](e.id);const r=f.getDialogIdByChatId(e.chatId);return this.decode({text:e.text,attach:e.attach,files:t,showIconIfEmptyText:false,contextDialogId:r})},decodeNotification(e){var r;return this.decode({text:e.text,attach:(r=e.params.attach)!=null?r:false,showIconIfEmptyText:false,showImageFromLink:false,urlTarget:t.DesktopApi.isDesktop()?"_blank":"_self"})},decodeText(e){return this.decode({text:e})},decodeHtml(e){return this.decode({text:e})},decodeSmile(e,t){return q.decodeSmile(e,t)},decodeSmileForLegacyCore(e,t){const r={...t};r.ratioConfig=Object.freeze({Default:1,Big:1.6});return q.decodeSmile(e,r)},decode(e){if(!i.Type.isPlainObject(e)){d().error("Parser.decode: the first parameter must be object",e);return'<b style="color:red">Parser.decode: the first parameter must be a parameter object</b'}let{text:t}=e;const{attach:r=false,files:s=false,removeLinks:c=false,showIconIfEmptyText:o=true,showImageFromLink:l=true,contextDialogId:g="",urlTarget:u="_blank"}=e;if(!i.Type.isString(t)){if(i.Type.isNumber(t)){return t.toString()}return""}if(!t){if(o){t=y.addIconToShortText({text:t,attach:r,files:s})}return t.trim()}t=i.Text.encode(t.trim());t=oe.decodeNewLine(t);t=oe.decodeTabulation(t);t=a.cutPutTag(t);t=a.cutSendTag(t);t=a.cutCodeTag(t);t=q.decodeSmile(t);t=n.decode(t);t=Q.decode(t,{urlTarget:u,removeLinks:c});t=W.decode(t);t=Y.decode(t);t=ce.decode(t);t=se.decode(t);t=P.decodeIcon(t);if(l){t=P.decodeLink(t)}t=ge.decode(t);t=Z.decodeDate(t);t=L.decodeArrowQuote(t);t=L.decodeQuote(t,{contextDialogId:g});t=a.recoverSendTag(t);t=Z.decodeSend(t);t=a.recoverPutTag(t);t=Z.decodePut(t);t=a.recoverCodeTag(t);t=L.decodeCode(t);t=a.recoverRecursionTag(t);t=oe.removeDuplicateTags(t);a.clean();return t},purifyMessage(e){const t=l().store.getters["messages/getMessageFiles"](e.id);return this.purify({text:e.text,attach:e.attach,files:t})},purifyNotification(e){var t;const r=l().store.getters["messages/getMessageFiles"](e.id);return this.purify({text:e.text,attach:(t=e.params.attach)!=null?t:false,files:r})},purifyRecent(e){const t=i.Extension.getSettings("im.v2.lib.parser");const r=t.get("v2");if(!r){const{files:t,attach:r,text:s}=this.prepareLegacyConfigForRecent(e);return this.purify({text:s,attach:r,files:t,showPhraseMessageWasDeleted:e.message.id!==0})}const{files:s,attach:n,text:a}=this.prepareConfigForRecent(e);return this.purify({text:a,attach:n,files:s,showPhraseMessageWasDeleted:e.messageId!==0})},purifyText(e){return this.purify({text:e})},purify(e){if(!i.Type.isPlainObject(e)){d().error("Parser.purify: the first parameter must be a object",e);return"Parser.purify: the first parameter must be a parameter object"}let{text:t}=e;const{attach:r=false,files:s=false,showPhraseMessageWasDeleted:a=true}=e;if(!i.Type.isString(t)){t=i.Type.isNumber(t)?t.toString():""}if(!t){t=y.addIconToShortText({text:t,attach:r,files:s});return t.trim()}t=i.Text.encode(t.trim());t=oe.purifyNewLine(t,"\n");t=n.purify(t);t=L.purifyArrowQuote(t);t=L.purifyQuote(t);t=L.purifyCode(t);t=Z.purifyPut(t);t=Z.purifySend(t);t=ce.purify(t);t=W.purify(t);t=Y.purify(t);t=se.purify(t);t=Q.purify(t);t=P.purifyLink(t);t=P.purifyIcon(t);t=ge.purify(t);t=oe.purifyNewLine(t);t=y.addIconToShortText({text:t,attach:r,files:s});if(t.length>0){t=i.Text.decode(t)}else if(a){t=i.Loc.getMessage("IM_PARSER_MESSAGE_DELETED")}return t.trim()},prepareQuote(e,t=""){const{id:r,attach:s}=e;let n=t===""?e.text:t;const a=l().store.getters["messages/getMessageFiles"](r);n=i.Text.encode(n.trim());n=ce.purify(n);n=se.purify(n);n=Y.purify(n);n=oe.purifyBreakLine(n,"\n");n=oe.purifyNbsp(n);n=Q.removeSimpleUrlTag(n);n=L.purifyCode(n," ");n=L.purifyQuote(n," ");n=L.purifyArrowQuote(n," ");if(t===""){n=y.addIconToShortText({text:n,attach:s,files:a})}n=n.length>0?i.Text.decode(n):i.Loc.getMessage("IM_PARSER_MESSAGE_DELETED");return n.trim()},prepareEdit(e){let{text:t}=e;t=Q.removeSimpleUrlTag(t);t=ce.purify(t);return t.trim()},prepareCopy(e){let{text:t}=e;t=Q.removeSimpleUrlTag(t);return t.trim()},prepareCopyFile(e){const{id:t}=e;const r=l().store.getters["messages/getMessageFiles"](t).map((e=>`[DISK=${e.id}]\n`));return r.join("\n").trim()},prepareConfigForRecent(e){let t=l().store.getters["messages/getMessageFiles"](e.messageId);if(t.length===0){t=false}const r=l().store.getters["messages/getById"](e.messageId);let s=false;if(i.Type.isBoolean(r==null?void 0:r.attach)||i.Type.isStringFilled(r==null?void 0:r.attach)||i.Type.isArray(r==null?void 0:r.attach)){s=r.attach}else if(i.Type.isPlainObject(r==null?void 0:r.attach)){s=[r.attach]}return{files:t,attach:s,text:r.text}},prepareLegacyConfigForRecent(e){let t=false;const r=e.message.params.withFile;if(i.Type.isBoolean(r)){t=r}else if(i.Type.isPlainObject(r)){t=[r]}let s=false;const n=e.message.params.withAttach;if(i.Type.isBoolean(n)||i.Type.isStringFilled(n)||i.Type.isArray(n)){s=n}else if(i.Type.isPlainObject(n)){s=[n]}return{files:t,attach:s,text:e.message.text}},executeClickEvent(e){ce.executeClickEvent(e);L.executeClickEvent(e);Z.executeClickEvent(e)},getContextCodeFromForwardId(e){return f.getFinalContextTag(e)}};e.Parser=de})(this.BX.Messenger.v2.Lib=this.BX.Messenger.v2.Lib||{},BX.Messenger.v2.Lib,BX.Event,BX.Messenger.v2.Lib,BX);
//# sourceMappingURL=parser.bundle.map.js