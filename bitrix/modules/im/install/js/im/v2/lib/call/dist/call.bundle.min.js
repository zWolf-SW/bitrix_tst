this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,s,t,a,l,i,r,o,n,c,b,d,v,u,h,p){"use strict";class g{static createRoom(e){d.runAction(v.RestMethod.imCallBetaCreateRoom,{data:{chatId:e}})}}let C=e=>e,L;const P=async e=>{const s=()=>{const s=l.getSelectedItems();const t=B(s);e.onSelect({users:t})};const t=()=>{l.hide()};const{Dialog:a}=await u.Runtime.loadExtension("ui.entity-selector");const l=new a({targetNode:e.bindElement,width:400,enableSearch:true,dropdownMode:true,context:"IM_CHAT_SEARCH",entities:[{id:"user",dynamicLoad:true,itemOptions:{default:{linkTitle:"",link:""}},options:{inviteEmployeeLink:false,"!userId":p.Core.getUserId()},filters:[{id:"im.userDataFilter"}]}],footer:F(s,t)});l.show();return Promise.resolve({close:()=>{l.hide()}})};const B=e=>e.map((e=>({id:e.id,name:e.title.text,avatar:e.avatar,avatar_hr:e.avatar,gender:e.customData.get("imUser").GENDER})));const F=(e,s)=>{const t=u.Loc.getMessage("IM_LIB_CALL_ADD_BUTTON");const a=u.Loc.getMessage("IM_LIB_CALL_CANCEL_BUTTON");return u.Tag.render(L||(L=C`
		<button class="ui-btn ui-btn-xs ui-btn-primary" onclick="${0}">${0}</button>
		<button class="ui-btn ui-btn-xs ui-btn-light-border" onclick="${0}">${0}</button>
	`),e,t,s,a)};var H=babelHelpers.classPrivateFieldLooseKey("controller");var f=babelHelpers.classPrivateFieldLooseKey("store");var y=babelHelpers.classPrivateFieldLooseKey("restClient");var E=babelHelpers.classPrivateFieldLooseKey("onCallJoinHandler");var m=babelHelpers.classPrivateFieldLooseKey("onCallLeaveHandler");var I=babelHelpers.classPrivateFieldLooseKey("onCallDestroyHandler");var A=babelHelpers.classPrivateFieldLooseKey("getController");var O=babelHelpers.classPrivateFieldLooseKey("subscribeToEvents");var S=babelHelpers.classPrivateFieldLooseKey("subscribeToCallEvents");var M=babelHelpers.classPrivateFieldLooseKey("unsubscribeFromCallEvents");var D=babelHelpers.classPrivateFieldLooseKey("onCallCreated");var j=babelHelpers.classPrivateFieldLooseKey("onCallJoin");var X=babelHelpers.classPrivateFieldLooseKey("onCallLeave");var K=babelHelpers.classPrivateFieldLooseKey("onCallDestroy");var T=babelHelpers.classPrivateFieldLooseKey("onOpenChat");var w=babelHelpers.classPrivateFieldLooseKey("checkCallSupport");var R=babelHelpers.classPrivateFieldLooseKey("checkUserCallSupport");var U=babelHelpers.classPrivateFieldLooseKey("checkChatCallSupport");var _=babelHelpers.classPrivateFieldLooseKey("pushServerIsActive");var N=babelHelpers.classPrivateFieldLooseKey("getCurrentDialogId");var k=babelHelpers.classPrivateFieldLooseKey("getDialog");var x=babelHelpers.classPrivateFieldLooseKey("getChatId");var V=babelHelpers.classPrivateFieldLooseKey("isUser");var J=babelHelpers.classPrivateFieldLooseKey("getChatInfo");var $=babelHelpers.classPrivateFieldLooseKey("prepareChatInfo");var G=babelHelpers.classPrivateFieldLooseKey("prepareCall");var q=babelHelpers.classPrivateFieldLooseKey("getChatUserCounter");class W{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}constructor(){Object.defineProperty(this,q,{value:ge});Object.defineProperty(this,G,{value:pe});Object.defineProperty(this,$,{value:he});Object.defineProperty(this,J,{value:ue});Object.defineProperty(this,V,{value:ve});Object.defineProperty(this,x,{value:de});Object.defineProperty(this,k,{value:be});Object.defineProperty(this,N,{value:ce});Object.defineProperty(this,_,{value:ne});Object.defineProperty(this,U,{value:oe});Object.defineProperty(this,R,{value:re});Object.defineProperty(this,w,{value:ie});Object.defineProperty(this,T,{value:le});Object.defineProperty(this,K,{value:ae});Object.defineProperty(this,X,{value:te});Object.defineProperty(this,j,{value:se});Object.defineProperty(this,D,{value:ee});Object.defineProperty(this,M,{value:Y});Object.defineProperty(this,S,{value:Q});Object.defineProperty(this,O,{value:z});Object.defineProperty(this,A,{value:Z});Object.defineProperty(this,H,{writable:true,value:void 0});Object.defineProperty(this,f,{writable:true,value:void 0});Object.defineProperty(this,y,{writable:true,value:void 0});Object.defineProperty(this,E,{writable:true,value:void 0});Object.defineProperty(this,m,{writable:true,value:void 0});Object.defineProperty(this,I,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,f)[f]=p.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,y)[y]=p.Core.getRestClient();if(this.isAvailable()){babelHelpers.classPrivateFieldLooseBase(this,H)[H]=babelHelpers.classPrivateFieldLooseBase(this,A)[A]()}babelHelpers.classPrivateFieldLooseBase(this,O)[O]();babelHelpers.classPrivateFieldLooseBase(this,E)[E]=babelHelpers.classPrivateFieldLooseBase(this,j)[j].bind(this);babelHelpers.classPrivateFieldLooseBase(this,m)[m]=babelHelpers.classPrivateFieldLooseBase(this,X)[X].bind(this);babelHelpers.classPrivateFieldLooseBase(this,I)[I]=babelHelpers.classPrivateFieldLooseBase(this,K)[K].bind(this)}isAvailable(){const{callInstalled:e}=u.Extension.getSettings("im.v2.lib.call");return e===true}createBetaCallRoom(e){if(!this.isAvailable()){return}g.createRoom(e)}startCall(e,s=true,t=""){if(!this.isAvailable()){return}o.Logger.warn("CallManager: startCall",e,s);babelHelpers.classPrivateFieldLooseBase(this,G)[G](e);babelHelpers.classPrivateFieldLooseBase(this,J)[J](e).then((t=>{babelHelpers.classPrivateFieldLooseBase(this,H)[H].startCall(e,s,t)}))}joinCall(e,s,t,a=true){if(!this.isAvailable()){return}o.Logger.warn("CallManager: joinCall",e,s,a);babelHelpers.classPrivateFieldLooseBase(this,G)[G](t);babelHelpers.classPrivateFieldLooseBase(this,J)[J](t).then((t=>{babelHelpers.classPrivateFieldLooseBase(this,H)[H].joinCall(e,s,a,{chatInfo:t})}))}leaveCurrentCall(){if(!this.isAvailable()){return}o.Logger.warn("CallManager: leaveCurrentCall");babelHelpers.classPrivateFieldLooseBase(this,H)[H].leaveCurrentCall()}onAnswerButtonClick(e,s){if(!this.isAvailable()){return}babelHelpers.classPrivateFieldLooseBase(this,H)[H].onAnswerButtonClick(e,s)}onJoinFromRecentItem(){babelHelpers.classPrivateFieldLooseBase(this,H)[H].closeCallNotification()}deleteRecentCall(e){babelHelpers.classPrivateFieldLooseBase(this,f)[f].dispatch("recent/calls/deleteActiveCall",{dialogId:e})}foldCurrentCall(){if(!this.isAvailable()||!babelHelpers.classPrivateFieldLooseBase(this,H)[H].hasActiveCall()||!babelHelpers.classPrivateFieldLooseBase(this,H)[H].hasVisibleCall()){return}babelHelpers.classPrivateFieldLooseBase(this,H)[H].fold()}unfoldCurrentCall(){if(!this.isAvailable()||!babelHelpers.classPrivateFieldLooseBase(this,H)[H].hasActiveCall()){return}babelHelpers.classPrivateFieldLooseBase(this,H)[H].unfold()}getCurrentCallDialogId(){var e,s;if(!this.isAvailable()||!babelHelpers.classPrivateFieldLooseBase(this,H)[H].hasActiveCall()){return""}return(e=babelHelpers.classPrivateFieldLooseBase(this,H)[H])==null?void 0:(s=e.currentCall)==null?void 0:s.associatedEntity.id}getCurrentCall(){if(!this.isAvailable()||!babelHelpers.classPrivateFieldLooseBase(this,H)[H].hasActiveCall()){return false}return babelHelpers.classPrivateFieldLooseBase(this,H)[H].currentCall}getCurrentUser(){const e=p.Core.getUserId();return p.Core.getStore().getters["users/get"](e)}hasCurrentCall(){if(!this.isAvailable()){return false}return babelHelpers.classPrivateFieldLooseBase(this,H)[H].hasActiveCall()}hasCurrentScreenSharing(){if(!this.isAvailable()||!babelHelpers.classPrivateFieldLooseBase(this,H)[H].hasActiveCall()){return false}return babelHelpers.classPrivateFieldLooseBase(this,H)[H].currentCall.isScreenSharingStarted()}hasVisibleCall(){if(!this.isAvailable()||!babelHelpers.classPrivateFieldLooseBase(this,H)[H].hasActiveCall()){return false}return babelHelpers.classPrivateFieldLooseBase(this,H)[H].hasVisibleCall()}startTest(){if(!this.isAvailable()){return}babelHelpers.classPrivateFieldLooseBase(this,H)[H].test()}toggleDebugFlag(e){if(!babelHelpers.classPrivateFieldLooseBase(this,H)[H]){return}babelHelpers.classPrivateFieldLooseBase(this,H)[H].debug=e}chatCanBeCalled(e){if(!this.isAvailable()){return false}const s=babelHelpers.classPrivateFieldLooseBase(this,w)[w](e);const t=babelHelpers.classPrivateFieldLooseBase(this,f)[f].getters["recent/calls/hasActiveCall"](e);return s&&!t}hasActiveCurrentCall(e){return babelHelpers.classPrivateFieldLooseBase(this,f)[f].getters["recent/calls/hasActiveCall"](e)&&this.getCurrentCallDialogId()===e}hasActiveAnotherCall(e){return babelHelpers.classPrivateFieldLooseBase(this,f)[f].getters["recent/calls/hasActiveCall"]()&&!this.hasActiveCurrentCall(e)}getCallUserLimit(){return BX.Call.Util.getUserLimit()}isChatUserLimitExceeded(e){return babelHelpers.classPrivateFieldLooseBase(this,q)[q](e)>this.getCallUserLimit()}updateRecentCallsList(e){const s=babelHelpers.classPrivateFieldLooseBase(this,f)[f].getters["recent/calls/get"];const t=new Map(Object.values(e).map((e=>[e.ID,e])));t.forEach((e=>{const s=babelHelpers.classPrivateFieldLooseBase(this,H)[H].isLegacyCall(e.PROVIDER,e.SCHEME)?a.EngineLegacy.instantiateCall(e,e.USERS,e.LOG_TOKEN,e.CONNECTION_DATA,e.USER_DATA):l.CallEngine.instantiateCall(e,e.CALL_TOKEN,e.LOG_TOKEN,e.USER_DATA);babelHelpers.classPrivateFieldLooseBase(this,S)[S](s)}));s.filter((e=>!t.has(e.call.id))).forEach((e=>{babelHelpers.classPrivateFieldLooseBase(this,f)[f].dispatch("recent/calls/deleteActiveCall",{dialogId:e.dialogId})}))}isConference(e){const s=babelHelpers.classPrivateFieldLooseBase(this,f)[f].getters["chats/get"](e);return s.type===v.ChatType.videoconf}}function Z(){return new a.Controller({init:true,language:p.Core.getLanguageId(),messengerFacade:{getDefaultZIndex:()=>r.MessengerSlider.getInstance().getZIndex(),isMessengerOpen:()=>r.MessengerSlider.getInstance().isOpened(),isSliderFocused:()=>r.MessengerSlider.getInstance().isFocused(),isThemeDark:()=>false,openMessenger:e=>i.Messenger.openChat(e),openHistory:e=>i.Messenger.openChat(e),openSettings:()=>i.Messenger.openSettings(),openHelpArticle:()=>{},getContainer:()=>document.querySelector(`.${W.viewContainerClass}`),getMessageCount:()=>babelHelpers.classPrivateFieldLooseBase(this,f)[f].getters["counters/getTotalChatCounter"],getCurrentDialogId:()=>babelHelpers.classPrivateFieldLooseBase(this,N)[N](),isPromoRequired:e=>n.PromoManager.getInstance().needToShow(e),repeatSound:(e,s,t)=>{c.SoundNotificationManager.getInstance().playLoop(e,s,t)},stopRepeatSound:e=>{c.SoundNotificationManager.getInstance().stop(e)},showUserSelector:P},events:{[a.Controller.Events.onPromoViewed]:e=>{const{code:s}=e.getData();n.PromoManager.getInstance().markAsWatched(s)},[a.Controller.Events.onOpenVideoConference]:e=>{var s;const{dialogId:t}=e.getData();const a=p.Core.getStore().getters["chats/get"](`chat${t}`,true);return i.Messenger.openConference({code:(s=a.public)==null?void 0:s.code})}}})}function z(){s.EventEmitter.subscribe(v.EventType.layout.onLayoutChange,babelHelpers.classPrivateFieldLooseBase(this,T)[T].bind(this));s.EventEmitter.subscribe(v.EventType.layout.onOpenNotifications,this.foldCurrentCall.bind(this));s.EventEmitter.subscribe(v.EventType.call.onJoinFromRecentItem,this.onJoinFromRecentItem.bind(this));s.EventEmitter.subscribe("CallEvents::callCreated",babelHelpers.classPrivateFieldLooseBase(this,D)[D].bind(this))}function Q(e){e.addEventListener(BX.Call.Event.onJoin,babelHelpers.classPrivateFieldLooseBase(this,E)[E]);e.addEventListener(BX.Call.Event.onLeave,babelHelpers.classPrivateFieldLooseBase(this,m)[m]);e.addEventListener(BX.Call.Event.onDestroy,babelHelpers.classPrivateFieldLooseBase(this,I)[I])}function Y(e){e.removeEventListener(BX.Call.Event.onJoin,babelHelpers.classPrivateFieldLooseBase(this,E)[E]);e.removeEventListener(BX.Call.Event.onLeave,babelHelpers.classPrivateFieldLooseBase(this,m)[m]);e.removeEventListener(BX.Call.Event.onDestroy,babelHelpers.classPrivateFieldLooseBase(this,I)[I])}function ee(e){const{call:s}=e.getData()[0];const t=babelHelpers.classPrivateFieldLooseBase(this,f)[f].getters["recent/calls/getCallByDialog"](s.associatedEntity.id);const l=(t==null?void 0:t.call.uuid)!==s.uuid;const i=s.state===a.State.Connected||s.state===a.State.Proceeding?v.RecentCallStatus.joined:v.RecentCallStatus.waiting;if(l){if(t){babelHelpers.classPrivateFieldLooseBase(this,M)[M](t.call)}babelHelpers.classPrivateFieldLooseBase(this,S)[S](s);babelHelpers.classPrivateFieldLooseBase(this,f)[f].dispatch("recent/calls/addActiveCall",{dialogId:s.associatedEntity.id,name:s.associatedEntity.name,call:s,state:i});return}babelHelpers.classPrivateFieldLooseBase(this,f)[f].dispatch("recent/calls/updateActiveCall",{dialogId:s.associatedEntity.id,fields:{name:s.associatedEntity.name,state:i,call:s}})}function se(e){babelHelpers.classPrivateFieldLooseBase(this,f)[f].dispatch("recent/calls/updateActiveCall",{dialogId:e.call.associatedEntity.id,fields:{state:v.RecentCallStatus.joined}})}function te(e){babelHelpers.classPrivateFieldLooseBase(this,f)[f].dispatch("recent/calls/updateActiveCall",{dialogId:e.call.associatedEntity.id,fields:{state:v.RecentCallStatus.waiting}})}function ae(e){const s=e.call.associatedEntity.id;const t=babelHelpers.classPrivateFieldLooseBase(this,f)[f].getters["recent/calls/getCallByDialog"](s);if(t){babelHelpers.classPrivateFieldLooseBase(this,M)[M](t.call)}if((t==null?void 0:t.call.uuid)===e.call.uuid){babelHelpers.classPrivateFieldLooseBase(this,f)[f].dispatch("recent/calls/deleteActiveCall",{dialogId:s})}}function le(e){const s=this.getCurrentCallDialogId();const t=e.getData().to.entityId;if(s===t){return}this.foldCurrentCall()}function ie(e){if(!babelHelpers.classPrivateFieldLooseBase(this,_)[_]()||!BX.Call.Util.isWebRTCSupported()){return false}const s=Number(e);return s>0?babelHelpers.classPrivateFieldLooseBase(this,R)[R](s):babelHelpers.classPrivateFieldLooseBase(this,U)[U](e)}function re(e){const s=babelHelpers.classPrivateFieldLooseBase(this,f)[f].getters["users/get"](e);const t=s.type===v.UserType.bot;return s&&s.status!=="guest"&&!t&&!s.network&&s.id!==p.Core.getUserId()&&Boolean(s.lastActivityDate)}function oe(e){const s=babelHelpers.classPrivateFieldLooseBase(this,q)[q](e);return(s>1||this.isConference(e))&&s<=this.getCallUserLimit()}function ne(){return true}function ce(){const e=babelHelpers.classPrivateFieldLooseBase(this,f)[f].getters["application/getLayout"];if(e.name!==v.Layout.chat.name){return""}return e.entityId}function be(e){return babelHelpers.classPrivateFieldLooseBase(this,f)[f].getters["chats/get"](e)}function de(e){var s;return(s=babelHelpers.classPrivateFieldLooseBase(this,k)[k](e))==null?void 0:s.chatId}function ve(e){const s=babelHelpers.classPrivateFieldLooseBase(this,k)[k](e);return(s==null?void 0:s.type)===v.ChatType.user}function ue(e){const s=babelHelpers.classPrivateFieldLooseBase(this,f)[f].getters["chats/get"](e,true);if(s.chatId===0){return i.Messenger.openChat(e).then((()=>{const s=babelHelpers.classPrivateFieldLooseBase(this,f)[f].getters["chats/get"](e,true);return babelHelpers.classPrivateFieldLooseBase(this,$)[$](s)})).catch((e=>{o.Logger.error("Open chat error",e);return babelHelpers.classPrivateFieldLooseBase(this,$)[$](s)}))}return new Promise((e=>{e(babelHelpers.classPrivateFieldLooseBase(this,$)[$](s))}))}function he(e){return{advanced:{chatType:e.type,entityType:e.entityType,entityId:e.entityId,entityData1:e.entityData1,entityData2:e.entityData2,entityData3:e.entityData3},id:e.dialogId,chatId:e.chatId,name:e.name,avatar:e.avatar||"/bitrix/js/im/images/blank.gif",avatarColor:e.color,type:"chat",userCounter:e.userCounter}}function pe(e){if(!this.isAvailable()){return}const s=p.Core.getUserId();const t=p.Core.getStore().getters["users/get"](s);const a={dialogId:e,userData:{[s]:t}};if(babelHelpers.classPrivateFieldLooseBase(this,V)[V](e)){const s=p.Core.getStore().getters["users/get"](e);a["user"]=s.id;a["userData"][s.id]=s}babelHelpers.classPrivateFieldLooseBase(this,H)[H].prepareCall(a)}function ge(e){const{userCounter:s}=babelHelpers.classPrivateFieldLooseBase(this,f)[f].getters["chats/get"](e,true);return s}W.viewContainerClass="bx-im-messenger__call_container";e.CallManager=W})(this.BX.Messenger.v2.Lib=this.BX.Messenger.v2.Lib||{},BX.Event,BX.Vue3.Vuex,BX.Call,BX,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX,BX.Messenger.v2.Lib,BX.Messenger.v2.Const,BX,BX.UI,BX.Messenger.v2.Application);
//# sourceMappingURL=call.bundle.map.js