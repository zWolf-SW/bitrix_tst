this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(t,e,s,r,i,a,n,o){"use strict";const c="bx-im-drafts";const h="recentDraft";const f="copilotDraft";class g{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}constructor(){this.db=new n.Dexie(c);this.db.version(1).stores({drafts:""})}async migrateFromLocalStorage(){const t=await this.db.drafts.get("migration_status");if(t){return}const e=o.LocalStorageManager.getInstance().get(h,{});this.set(h,e);o.LocalStorageManager.getInstance().remove(h);const s=o.LocalStorageManager.getInstance().get(f,{});this.set(f,s);o.LocalStorageManager.getInstance().remove(f);this.setMigrationFinished()}set(t,e){this.db.drafts.put(e,t)}setMigrationFinished(){const t={[h]:true,[f]:true};this.db.drafts.put(t,"migration_status")}async get(t,e=null){await this.migrateFromLocalStorage();const s=await this.db.drafts.get(t);return s||e}}const d=1e3;const u=1500;const l="recentDraft";const m=new Set([a.ChatType.comment]);class D{static getInstance(){if(!D.instance){D.instance=new D}return D.instance}constructor(){this.inited=false;this.drafts={};this.initPromise=new Promise((t=>{this.initPromiseResolver=t}));s.EventEmitter.subscribe(a.EventType.layout.onLayoutChange,this.onLayoutChange.bind(this))}async initDraftHistory(){if(this.inited){return}this.inited=true;let t=null;try{t=await g.getInstance().get(l,{})}catch(t){console.error("DraftManager: error initing draft history",t);this.initPromiseResolver();return}this.fillDraftsFromStorage(t);r.Logger.warn("DraftManager: initDrafts:",this.drafts);this.initPromiseResolver();this.setRecentListDraftText()}ready(){return this.initPromise}fillDraftsFromStorage(t){if(!e.Type.isPlainObject(t)){return}Object.entries(t).forEach((([t,s])=>{if(!e.Type.isPlainObject(s)){return}this.drafts[t]=s}))}setDraftText(t,e){if(!this.drafts[t]){this.drafts[t]={}}this.drafts[t].text=e.trim();this.refreshSaveTimeout()}setDraftPanel(t,e,s){if(!this.drafts[t]){this.drafts[t]={}}this.drafts[t].panelType=e;this.drafts[t].panelContext=s;this.refreshSaveTimeout()}setDraftMentions(t,e){if(!this.drafts[t]){this.drafts[t]={}}this.drafts[t].mentions=e;this.refreshSaveTimeout()}async getDraft(t){var e;if(!this.inited){await this.initDraftHistory()}return(e=this.drafts[t])!=null?e:{}}clearDraft(t){delete this.drafts[t];this.setRecentItemDraftText(t,"")}setRecentListDraftText(){Object.entries(this.drafts).forEach((([t,e])=>{var s;this.setRecentItemDraftText(t,(s=e.text)!=null?s:"")}))}setRecentItemDraftText(t,e){if(!this.canSetRecentItemDraftText(t)){return}void i.Core.getStore().dispatch("recent/setDraft",{id:t,text:e})}onLayoutChange(t){const{from:e}=t.getData();const s=e.entityId;if(s===""){return}setTimeout((async()=>{const{text:t=""}=await this.getDraft(s);this.setRecentItemDraftText(s,t)}),u)}refreshSaveTimeout(){clearTimeout(this.writeToStorageTimeout);this.writeToStorageTimeout=setTimeout((()=>{this.saveToIndexedDb()}),d)}saveToIndexedDb(){g.getInstance().set(l,this.prepareDrafts())}prepareDrafts(){const t={};Object.entries(this.drafts).forEach((([e,s])=>{if(!s.text&&!s.panelType){return}if(s.panelType===a.TextareaPanelType.edit){return}t[e]={text:s.text,mentions:s.mentions}}));return t}canSetRecentItemDraftText(t){const e=i.Core.getStore().getters["chats/get"](t);if(!e){return false}return!m.has(e.type)}}D.instance=null;t.DraftManager=D})(this.BX.Messenger.v2.Lib=this.BX.Messenger.v2.Lib||{},BX,BX.Event,BX.Messenger.v2.Lib,BX.Messenger.v2.Application,BX.Messenger.v2.Const,BX.DexieExport,BX.Messenger.v2.Lib);
//# sourceMappingURL=draft.bundle.map.js