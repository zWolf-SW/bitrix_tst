{"version":3,"file":"slider.bundle.js","sources":["../src/slider.js"],"sourcesContent":["import { Event, ZIndexManager, Runtime, Extension } from 'main.core';\nimport { SidePanel, type SliderManager } from 'main.sidepanel';\nimport { EventEmitter } from 'main.core.events';\n\nimport { Core } from 'im.v2.application.core';\nimport { EventType, Layout } from 'im.v2.const';\nimport { Logger } from 'im.v2.lib.logger';\nimport { Launch } from 'im.v2.application.launch';\nimport { DesktopManager } from 'im.v2.lib.desktop';\nimport { LayoutManager } from 'im.v2.lib.layout';\nimport { CallManager } from 'im.v2.lib.call';\nimport { showCloseWithActiveCallConfirm } from 'im.v2.lib.confirm';\n\nimport 'ui.notification';\nimport 'im.v2.lib.opener';\n\nimport type { Store } from 'ui.vue3.vuex';\nimport type { SettingsCollection } from 'main.core.collections';\n\nconst SLIDER_PREFIX = 'im:slider';\nconst BASE_STACK_INDEX = 1200;\nconst SLIDER_CONTAINER_CLASS = 'bx-im-messenger__slider';\n\nexport class MessengerSlider\n{\n\tstatic instance = null;\n\n\tinstances: Object = {};\n\tsidePanelManager: SliderManager = SidePanel.Instance;\n\tstore: Store;\n\n\tstatic init()\n\t{\n\t\tif (this.instance)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.instance = new this();\n\t}\n\n\tstatic getInstance(): MessengerSlider\n\t{\n\t\tthis.init();\n\n\t\treturn this.instance;\n\t}\n\n\tconstructor()\n\t{\n\t\tLogger.warn('Slider: class created');\n\t\tthis.bindEvents();\n\t\tthis.store = Core.getStore();\n\t}\n\n\tbindEvents(): boolean\n\t{\n\t\tEventEmitter.subscribe('SidePanel.Slider:onCloseByEsc', this.onCloseByEsc.bind(this));\n\t\tEventEmitter.subscribe('SidePanel.Slider:onClose', this.onClose.bind(this));\n\t\tEventEmitter.subscribe('SidePanel.Slider:onDestroy', this.onDestroy.bind(this));\n\n\t\tEvent.ready(this.initZIndex.bind(this));\n\n\t\treturn true;\n\t}\n\n\topenSlider(): Promise\n\t{\n\t\tif (this.isChatEmbeddedOnPage())\n\t\t{\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\tif (DesktopManager.isChatWindow())\n\t\t{\n\t\t\tthis.sidePanelManager.closeAll(true);\n\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\tif (this.isOpened())\n\t\t{\n\t\t\tZIndexManager.bringToFront(this.getCurrent().getOverlay());\n\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\tvoid this.launchMessengerApplication();\n\n\t\treturn new Promise((resolve) => {\n\t\t\tif (this.isFocused())\n\t\t\t{\n\t\t\t\tresolve();\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst nextId = this.getNextId();\n\n\t\t\tthis.sidePanelManager.open(`${SLIDER_PREFIX}:${nextId}`, {\n\t\t\t\tdata: { rightBoundary: 0 },\n\t\t\t\tcacheable: false,\n\t\t\t\tanimationDuration: 100,\n\t\t\t\thideControls: true,\n\t\t\t\tcustomLeftBoundary: 0,\n\t\t\t\tcustomRightBoundary: 0,\n\t\t\t\tloader: this.getLoaderPath(),\n\t\t\t\tcontentCallback: () => {\n\t\t\t\t\treturn `<div class=\"${SLIDER_CONTAINER_CLASS}\"></div>`;\n\t\t\t\t},\n\t\t\t\tevents: {\n\t\t\t\t\tonOpenComplete: async (event) => {\n\t\t\t\t\t\tevent.slider.showLoader();\n\t\t\t\t\t\tawait this.initMessengerComponent();\n\t\t\t\t\t\tevent.slider.closeLoader();\n\n\t\t\t\t\t\treturn resolve();\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tthis.instances[nextId] = this.sidePanelManager.getSlider(`${SLIDER_PREFIX}:${nextId}`);\n\t\t});\n\t}\n\n\tlaunchMessengerApplication(): Promise\n\t{\n\t\tif (this.applicationPromise)\n\t\t{\n\t\t\treturn this.applicationPromise;\n\t\t}\n\n\t\tthis.applicationPromise = Runtime.loadExtension('im.v2.application.messenger').then(() => {\n\t\t\treturn Launch('messenger');\n\t\t}).then((application) => {\n\t\t\tLogger.warn('Slider: Messenger application launched', application);\n\n\t\t\treturn application;\n\t\t});\n\n\t\treturn this.applicationPromise;\n\t}\n\n\tasync initMessengerComponent(): Promise\n\t{\n\t\tconst application = await this.applicationPromise;\n\n\t\treturn application.initComponent(`.${SLIDER_CONTAINER_CLASS}`);\n\t}\n\n\tonDialogOpen(event)\n\t{\n\t\tLogger.warn('Slider: onDialogOpen', event.data.dialogId);\n\t}\n\n\tasync onClose({ data: event })\n\t{\n\t\t[event] = event;\n\t\tconst sliderId = event.getSlider().getUrl().toString();\n\t\tif (!sliderId.startsWith(SLIDER_PREFIX))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.canClose())\n\t\t{\n\t\t\tevent.denyAction();\n\n\t\t\treturn;\n\t\t}\n\n\t\tconst hasCall = CallManager.getInstance().hasCurrentCall();\n\t\tif (hasCall)\n\t\t{\n\t\t\tevent.denyAction();\n\n\t\t\tconst result = await showCloseWithActiveCallConfirm();\n\t\t\tif (result)\n\t\t\t{\n\t\t\t\tCallManager.getInstance().leaveCurrentCall();\n\t\t\t\tevent.slider.close();\n\t\t\t}\n\n\t\t\treturn;\n\t\t}\n\n\t\t// TODO: emit event to close all popups\n\n\t\tconst id = this.getIdFromSliderId(sliderId);\n\t\tdelete this.instances[id];\n\n\t\tEventEmitter.emit(EventType.slider.onClose);\n\n\t\tLayoutManager.getInstance().setLayout({\n\t\t\tname: Layout.chat.name,\n\t\t});\n\t}\n\n\tonCloseByEsc({ data: event })\n\t{\n\t\t[event] = event;\n\t\tconst sliderId = event.getSlider().getUrl().toString();\n\t\tif (!sliderId.startsWith(SLIDER_PREFIX))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.canCloseByEsc())\n\t\t{\n\t\t\tevent.denyAction();\n\t\t}\n\t}\n\n\tonDestroy({ data: event })\n\t{\n\t\t[event] = event;\n\t\tconst sliderId = event.getSlider().getUrl().toString();\n\t\tif (!sliderId.startsWith(SLIDER_PREFIX))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst id = this.getIdFromSliderId(sliderId);\n\t\tdelete this.instances[id];\n\t}\n\n\tinitZIndex()\n\t{\n\t\tif (!ZIndexManager)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst stack = ZIndexManager.getOrAddStack(document.body);\n\t\tstack.baseIndex = BASE_STACK_INDEX;\n\t\tstack.sort();\n\t}\n\n\tgetZIndex(): number\n\t{\n\t\treturn BASE_STACK_INDEX;\n\t}\n\n\tisOpened(): boolean\n\t{\n\t\treturn Object.keys(this.instances).length > 0;\n\t}\n\n\tisFocused(): boolean\n\t{\n\t\tif (!this.isOpened())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst slider = this.sidePanelManager.getTopSlider();\n\t\tif (!slider)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\treturn slider.getUrl().toString().startsWith(SLIDER_PREFIX);\n\t}\n\n\tcanClose(): boolean\n\t{\n\t\treturn true;\n\t}\n\n\tcanCloseByEsc(): boolean\n\t{\n\t\treturn false;\n\t}\n\n\tgetCurrent(): Object\n\t{\n\t\treturn this.instances[this.getCurrentId()];\n\t}\n\n\tgetCurrentId(): number\n\t{\n\t\treturn Object.keys(this.instances).length;\n\t}\n\n\tgetNextId(): number\n\t{\n\t\treturn this.getCurrentId() + 1;\n\t}\n\n\tgetIdFromSliderId(sliderId: string): number\n\t{\n\t\treturn Number.parseInt(sliderId.slice(SLIDER_PREFIX.length + 1), 10);\n\t}\n\n\tgetLoaderPath(): string\n\t{\n\t\tconst LOADER = '/bitrix/js/im/v2/lib/slider/src/images/loader-chats.svg?v3';\n\t\tconst LOADER_WITHOUT_NAVIGATION = '/bitrix/js/im/v2/lib/slider/src/images/loader-chats-without-navigation.svg';\n\n\t\tconst hasNavigation = !LayoutManager.getInstance().isAirDesignEnabled();\n\n\t\treturn hasNavigation ? LOADER : LOADER_WITHOUT_NAVIGATION;\n\t}\n\n\tisChatEmbeddedOnPage(): boolean\n\t{\n\t\treturn LayoutManager.getInstance().isQuickAccessHidden();\n\t}\n}\n"],"names":["SLIDER_PREFIX","BASE_STACK_INDEX","SLIDER_CONTAINER_CLASS","MessengerSlider","init","instance","getInstance","constructor","instances","sidePanelManager","SidePanel","Instance","Logger","warn","bindEvents","store","Core","getStore","EventEmitter","subscribe","onCloseByEsc","bind","onClose","onDestroy","Event","ready","initZIndex","openSlider","isChatEmbeddedOnPage","Promise","resolve","DesktopManager","isChatWindow","closeAll","isOpened","ZIndexManager","bringToFront","getCurrent","getOverlay","launchMessengerApplication","isFocused","nextId","getNextId","open","data","rightBoundary","cacheable","animationDuration","hideControls","customLeftBoundary","customRightBoundary","loader","getLoaderPath","contentCallback","events","onOpenComplete","event","slider","showLoader","initMessengerComponent","closeLoader","getSlider","applicationPromise","Runtime","loadExtension","then","Launch","application","initComponent","onDialogOpen","dialogId","sliderId","getUrl","toString","startsWith","canClose","denyAction","hasCall","CallManager","hasCurrentCall","result","showCloseWithActiveCallConfirm","leaveCurrentCall","close","id","getIdFromSliderId","emit","EventType","LayoutManager","setLayout","name","Layout","chat","canCloseByEsc","stack","getOrAddStack","document","body","baseIndex","sort","getZIndex","Object","keys","length","getTopSlider","getCurrentId","Number","parseInt","slice","LOADER","LOADER_WITHOUT_NAVIGATION","hasNavigation","isAirDesignEnabled","isQuickAccessHidden"],"mappings":"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"}