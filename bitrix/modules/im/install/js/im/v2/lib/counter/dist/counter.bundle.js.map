{"version":3,"file":"counter.bundle.js","sources":["../src/helpers/update-browser-title-counter.js","../src/counter.js"],"sourcesContent":["export const updateBrowserTitleCounter = (newCounter: number) => {\n\tconst MAX_COUNTER_VALUE = 99;\n\tconst MAX_COUNTER_TEXT = `${MAX_COUNTER_VALUE}+`;\n\n\tconst regexp = /^\\((?<currentCounter>\\d+|\\d+\\+)\\)\\s(?<text>.*)/;\n\tconst matchResult: ?RegExpMatchArray = document.title.match(regexp);\n\tconst displayCounter = newCounter > MAX_COUNTER_VALUE ? MAX_COUNTER_TEXT : newCounter;\n\n\tif (matchResult?.groups.currentCounter)\n\t{\n\t\tconst currentCounter = Number.parseInt(matchResult.groups.currentCounter, 10);\n\t\tif (newCounter !== currentCounter)\n\t\t{\n\t\t\tconst counterPrefix = newCounter > 0 ? `(${displayCounter}) ` : '';\n\t\t\tdocument.title = `${counterPrefix}${matchResult.groups.text}`;\n\t\t}\n\t}\n\telse if (newCounter > 0)\n\t{\n\t\tdocument.title = `(${displayCounter}) ${document.title}`;\n\t}\n};\n","import { EventEmitter, BaseEvent } from 'main.core.events';\nimport { Runtime } from 'main.core';\n\nimport { Core } from 'im.v2.application.core';\nimport { DesktopManager } from 'im.v2.lib.desktop';\nimport { Logger } from 'im.v2.lib.logger';\nimport { EventType, NavigationMenuItem } from 'im.v2.const';\n\nimport { updateBrowserTitleCounter } from './helpers/update-browser-title-counter';\n\nimport type { Store } from 'ui.vue3.vuex';\n\ntype CounterMap = {[chatId: string]: number};\n\ntype InitialCounters = {\n\tCHAT: CounterMap,\n\tLINES: CounterMap,\n\tCOLLAB: CounterMap,\n\tCOPILOT: CounterMap,\n\tCHANNEL_COMMENT: {\n\t\t[channelChatId: string]: {\n\t\t\t[commentChatId: string]: number,\n\t\t}\n\t},\n\tCHAT_MUTED: number[],\n\tCHAT_UNREAD: number[],\n\tCOLLAB_UNREAD: number[],\n\tCOPILOT_UNREAD: number[],\n\tTYPE: {\n\t\t'ALL': number,\n\t\t'CHAT': number,\n\t\t'NOTIFY': number,\n\t\t'LINES': number,\n\t\t'COLLAB': number,\n\t\t'COPILOT': number,\n\t}\n};\n\ntype NavigationCountersPayload = {\n\tchat: number;\n\tcopilot: number;\n\tcollab: number;\n\topenlines: number;\n\topenlinesV2: number;\n\tnotification: number;\n};\n\nexport class CounterManager\n{\n\tstatic #instance: CounterManager;\n\n\t#store: Store;\n\t#emitCountersUpdateWithDebounce: Function;\n\n\tstatic getInstance(): CounterManager\n\t{\n\t\tif (!this.#instance)\n\t\t{\n\t\t\tthis.#instance = new this();\n\t\t}\n\n\t\treturn this.#instance;\n\t}\n\n\tconstructor()\n\t{\n\t\tthis.#store = Core.getStore();\n\t\tthis.#emitCountersUpdateWithDebounce = Runtime.debounce(this.#emitCountersUpdate, 0, this);\n\t\tconst { counters } = Core.getApplicationData();\n\t\tLogger.warn('CounterManager: counters', counters);\n\t\tthis.#init(counters);\n\t}\n\n\tstatic init()\n\t{\n\t\tCounterManager.getInstance();\n\t}\n\n\temitCounters()\n\t{\n\t\tthis.#emitCountersUpdate();\n\t}\n\n\tremoveBrowserTitleCounter()\n\t{\n\t\tconst regexp = /^(?<counterWithWhitespace>\\(\\d+\\)\\s).*/;\n\t\tconst matchResult: ?RegExpMatchArray = document.title.match(regexp);\n\t\tif (!matchResult?.groups.counterWithWhitespace)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst counterPrefixLength = matchResult.groups.counterWithWhitespace;\n\t\tdocument.title = document.title.slice(counterPrefixLength);\n\t}\n\n\t#init(counters: InitialCounters)\n\t{\n\t\tconst preparedChatCounters = this.#prepareChatCounters(counters.CHAT, counters.CHAT_UNREAD);\n\t\tthis.#store.dispatch('counters/setUnloadedChatCounters', preparedChatCounters);\n\t\tthis.#store.dispatch('counters/setUnloadedLinesCounters', counters.LINES);\n\t\tconst preparedCollabCounters = this.#prepareChatCounters(counters.COLLAB, counters.COLLAB_UNREAD);\n\t\tthis.#store.dispatch('counters/setUnloadedCollabCounters', preparedCollabCounters);\n\t\tconst preparedCopilotCounters = this.#prepareChatCounters(counters.COPILOT, counters.COPILOT_UNREAD);\n\t\tthis.#store.dispatch('counters/setUnloadedCopilotCounters', preparedCopilotCounters);\n\t\tthis.#store.dispatch('counters/setCommentCounters', counters.CHANNEL_COMMENT);\n\t\tthis.#store.dispatch('notifications/setCounter', counters.TYPE.NOTIFY);\n\n\t\tthis.#emitCountersUpdate();\n\t\tthis.#subscribeToCountersChange();\n\t\tthis.#emitLegacyChatCounterUpdate(counters.TYPE.CHAT);\n\t\tthis.#emitLegacyNotificationCounterUpdate(counters.TYPE.NOTIFY);\n\t\tthis.#emitLegacyLinesCounterUpdate(counters.TYPE.LINES);\n\t\tthis.#onTotalCounterChange();\n\t}\n\n\t#prepareChatCounters(counters: CounterMap, unreadCounters: number[]): CounterMap\n\t{\n\t\tconst resultCounters = { ...counters };\n\t\tunreadCounters.forEach((markedChatId) => {\n\t\t\tconst unreadChatHasCounter = Boolean(counters[markedChatId]);\n\t\t\tif (unreadChatHasCounter)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tresultCounters[markedChatId] = 1;\n\t\t});\n\n\t\treturn resultCounters;\n\t}\n\n\t#subscribeToCountersChange()\n\t{\n\t\tthis.#store.watch(notificationCounterWatch, (newValue: number) => {\n\t\t\tthis.#emitLegacyNotificationCounterUpdate(newValue);\n\t\t\tthis.#emitCountersUpdateWithDebounce();\n\t\t\tthis.#onTotalCounterChange();\n\t\t});\n\n\t\tthis.#store.watch(chatCounterWatch, (newValue: number) => {\n\t\t\tthis.#emitLegacyChatCounterUpdate(newValue);\n\t\t\tthis.#emitCountersUpdateWithDebounce();\n\t\t\tthis.#onTotalCounterChange();\n\t\t});\n\n\t\tthis.#store.watch(linesCounterWatch, (newValue: number) => {\n\t\t\tthis.#emitLegacyLinesCounterUpdate(newValue);\n\t\t\tthis.#emitCountersUpdateWithDebounce();\n\t\t\tthis.#onTotalCounterChange();\n\t\t});\n\n\t\tthis.#store.watch(copilotCounterWatch, () => this.#emitCountersUpdateWithDebounce());\n\t\tthis.#store.watch(collabCounterWatch, () => this.#emitCountersUpdateWithDebounce());\n\t}\n\n\t#emitLegacyNotificationCounterUpdate(notificationsCounter: number)\n\t{\n\t\tconst event = new BaseEvent({ compatData: [notificationsCounter] });\n\t\tEventEmitter.emit(window, EventType.counter.onNotificationCounterChange, event);\n\t}\n\n\t#emitLegacyChatCounterUpdate(chatCounter: number)\n\t{\n\t\tconst event = new BaseEvent({ compatData: [chatCounter] });\n\t\tEventEmitter.emit(window, EventType.counter.onChatCounterChange, event);\n\t}\n\n\t#emitLegacyLinesCounterUpdate(linesCounter: number)\n\t{\n\t\tconst LINES_TYPE = 'LINES';\n\t\tconst event = new BaseEvent({ compatData: [linesCounter, LINES_TYPE] });\n\t\tEventEmitter.emit(window, EventType.counter.onLinesCounterChange, event);\n\t}\n\n\t#emitCountersUpdate()\n\t{\n\t\tconst payload: NavigationCountersPayload = {\n\t\t\t[NavigationMenuItem.chat]: this.#store.getters['counters/getTotalChatCounter'],\n\t\t\t[NavigationMenuItem.copilot]: this.#store.getters['counters/getTotalCopilotCounter'],\n\t\t\t[NavigationMenuItem.collab]: this.#store.getters['counters/getTotalCollabCounter'],\n\t\t\t[NavigationMenuItem.openlines]: this.#store.getters['counters/getTotalLinesCounter'],\n\t\t\t[NavigationMenuItem.openlinesV2]: this.#store.getters['counters/getTotalLinesCounter'],\n\t\t\t[NavigationMenuItem.notification]: this.#store.getters['notifications/getCounter'],\n\t\t};\n\n\t\tLogger.warn('CounterManager: Emitting IM.Counters:onUpdate', payload);\n\t\tEventEmitter.emit(EventType.counter.onUpdate, payload);\n\t}\n\n\t#onTotalCounterChange()\n\t{\n\t\tconst notificationCounter = this.#store.getters['notifications/getCounter'];\n\t\tconst chatCounter = this.#store.getters['counters/getTotalChatCounter'];\n\t\tconst linesCounter = this.#store.getters['counters/getTotalLinesCounter'];\n\t\tconst totalCounter = notificationCounter + chatCounter + linesCounter;\n\n\t\tif (DesktopManager.getInstance().isDesktopActive())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tupdateBrowserTitleCounter(totalCounter);\n\t}\n}\n\nconst notificationCounterWatch = (state, getters) => getters['notifications/getCounter'];\nconst chatCounterWatch = (state, getters) => getters['counters/getTotalChatCounter'];\nconst linesCounterWatch = (state, getters) => getters['counters/getTotalLinesCounter'];\nconst copilotCounterWatch = (state, getters) => getters['counters/getTotalCopilotCounter'];\nconst collabCounterWatch = (state, getters) => getters['counters/getTotalCollabCounter'];\n"],"names":["updateBrowserTitleCounter","newCounter","MAX_COUNTER_VALUE","MAX_COUNTER_TEXT","regexp","matchResult","document","title","match","displayCounter","groups","currentCounter","Number","parseInt","counterPrefix","text","CounterManager","getInstance","constructor","Core","getStore","Runtime","debounce","counters","getApplicationData","Logger","warn","init","emitCounters","removeBrowserTitleCounter","counterWithWhitespace","counterPrefixLength","slice","preparedChatCounters","CHAT","CHAT_UNREAD","dispatch","LINES","preparedCollabCounters","COLLAB","COLLAB_UNREAD","preparedCopilotCounters","COPILOT","COPILOT_UNREAD","CHANNEL_COMMENT","TYPE","NOTIFY","unreadCounters","resultCounters","forEach","markedChatId","unreadChatHasCounter","Boolean","watch","notificationCounterWatch","newValue","chatCounterWatch","linesCounterWatch","copilotCounterWatch","collabCounterWatch","notificationsCounter","event","BaseEvent","compatData","EventEmitter","emit","window","EventType","counter","onNotificationCounterChange","chatCounter","onChatCounterChange","linesCounter","LINES_TYPE","onLinesCounterChange","payload","NavigationMenuItem","chat","getters","copilot","collab","openlines","openlinesV2","notification","onUpdate","notificationCounter","totalCounter","DesktopManager","isDesktopActive","state"],"mappings":"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"}