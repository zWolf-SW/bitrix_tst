{"version":3,"file":"input-action.bundle.js","sources":["../src/input-action.js"],"sourcesContent":["import { Core } from 'im.v2.application.core';\nimport { ChatType } from 'im.v2.const';\n\nimport type { ImModelChat } from 'im.v2.model';\n\nexport const InputAction = {\n\twriting: 'writing',\n\trecordingVoice: 'recordingVoice',\n\tsendingFile: 'sendingFile',\n};\n\nexport type InputActionType = $Values<typeof InputAction>;\n\ntype ActionPayload = {\n\ttype: InputActionType,\n\tdialogId: string,\n\tuserId: number,\n\tuserName?: string,\n};\n\nconst DEFAULT_ACTION_DURATION = 25000;\nconst ActionDurationMap = {\n\t[InputAction.writing]: {\n\t\t[ChatType.copilot]: 180_000,\n\t\tdefault: DEFAULT_ACTION_DURATION,\n\t},\n\t[InputAction.recordingVoice]: {\n\t\tdefault: DEFAULT_ACTION_DURATION,\n\t},\n\t[InputAction.sendingFile]: {\n\t\tdefault: DEFAULT_ACTION_DURATION,\n\t},\n};\n\nexport class InputActionListener\n{\n\tstatic #instance: InputActionListener;\n\n\t#actionTimers: {[timerId: string]: number} = {};\n\n\tstatic getInstance(): InputActionListener\n\t{\n\t\tif (!this.#instance)\n\t\t{\n\t\t\tthis.#instance = new this();\n\t\t}\n\n\t\treturn this.#instance;\n\t}\n\n\tstartAction(actionPayload: ActionPayload)\n\t{\n\t\tconst timerId = this.#buildTimerId(actionPayload);\n\n\t\tif (this.#isAlreadyActive(actionPayload))\n\t\t{\n\t\t\tthis.#clearTimer(timerId);\n\t\t\tthis.#actionTimers[timerId] = this.#setTimer(actionPayload);\n\n\t\t\treturn;\n\t\t}\n\n\t\tCore.getStore().dispatch('chats/inputActions/start', actionPayload);\n\n\t\tthis.#actionTimers[timerId] = this.#setTimer(actionPayload);\n\t}\n\n\tstopAction(actionPayload: ActionPayload)\n\t{\n\t\tif (!this.#isAlreadyActive(actionPayload))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tCore.getStore().dispatch('chats/inputActions/stop', actionPayload);\n\t}\n\n\tstopUserActionsInChat(payload: { userId: number, dialogId: string })\n\t{\n\t\tCore.getStore().dispatch('chats/inputActions/stopUserActionsInChat', payload);\n\t}\n\n\tclear()\n\t{\n\t\tObject.values(this.#actionTimers).forEach((timerId) => {\n\t\t\tclearTimeout(timerId);\n\t\t});\n\t\tthis.#actionTimers = {};\n\t}\n\n\t#isAlreadyActive(payload: ActionPayload): boolean\n\t{\n\t\tconst { type, dialogId, userId } = payload;\n\n\t\treturn Core.getStore().getters['chats/inputActions/isActionActive']({\n\t\t\ttype,\n\t\t\tdialogId,\n\t\t\tuserId,\n\t\t});\n\t}\n\n\t#buildTimerId(payload: ActionPayload): string\n\t{\n\t\tconst { type, dialogId, userId } = payload;\n\n\t\treturn `${type}|${dialogId}|${userId}`;\n\t}\n\n\t#setTimer(payload: ActionPayload): number\n\t{\n\t\tconst { type, dialogId } = payload;\n\t\tconst actionDuration = this.#getActionDuration(type, dialogId);\n\n\t\treturn setTimeout(() => {\n\t\t\tthis.stopAction(payload);\n\t\t}, actionDuration);\n\t}\n\n\t#clearTimer(timerId: string): void\n\t{\n\t\tclearTimeout(this.#actionTimers[timerId]);\n\t\tdelete this.#actionTimers[timerId];\n\t}\n\n\t#getActionDuration(type: InputActionType, dialogId: string): number\n\t{\n\t\tconst typeDurationMap = ActionDurationMap[type];\n\t\tconst chat: ImModelChat = Core.getStore().getters['chats/get'](dialogId, true);\n\n\t\treturn typeDurationMap[chat.type] ?? typeDurationMap.default;\n\t}\n}\n"],"names":["InputAction","writing","recordingVoice","sendingFile","DEFAULT_ACTION_DURATION","ActionDurationMap","ChatType","copilot","default","InputActionListener","getInstance","startAction","actionPayload","timerId","Core","getStore","dispatch","stopAction","stopUserActionsInChat","payload","clear","Object","values","forEach","clearTimeout","type","dialogId","userId","getters","actionDuration","setTimeout","typeDurationMap","chat"],"mappings":"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"}