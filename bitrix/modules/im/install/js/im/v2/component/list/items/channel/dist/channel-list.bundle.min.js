this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};this.BX.Messenger.v2.Component=this.BX.Messenger.v2.Component||{};(function(e,t,s,a,i,r,n,l,o,c,d,h,g,m,u,v){"use strict";const p={name:"MessageText",components:{MessageAvatar:i.MessageAvatar},props:{item:{type:Object,required:true}},computed:{AvatarSize:()=>i.AvatarSize,recentItem(){return this.item},dialog(){return this.$store.getters["chats/get"](this.recentItem.dialogId,true)},message(){return this.$store.getters["recent/getMessage"](this.recentItem.dialogId)},formattedDate(){return this.formatDate(this.message.date)},isLastMessageAuthor(){return this.message.authorId===d.Core.getUserId()},lastMessageAuthorAvatar(){const e=this.$store.getters["users/get"](this.message.authorId);if(!e){return""}return e.avatar},lastMessageAuthorAvatarStyle(){return{backgroundImage:`url('${this.lastMessageAuthorAvatar}')`}},messageText(){if(this.message.isDeleted){return this.loc("IM_LIST_RECENT_DELETED_MESSAGE")}const e=n.Parser.purifyRecent(this.recentItem);if(!e){return this.loc("IM_LIST_RECENT_CHAT_TYPE_GROUP_V2")}return e},formattedMessageText(){const e=27;return r.Utils.text.insertUnseenWhitespace(this.messageText,e)}},methods:{formatDate(e){return l.DateFormatter.formatByTemplate(e,l.DateTemplate.recent)},loc(e,t={}){return this.$Bitrix.Loc.getMessage(e,t)}},template:`\n\t\t<div class="bx-im-list-channel-item__message_container">\n\t\t\t<span class="bx-im-list-channel-item__message_text">\n\t\t\t\t<span v-if="isLastMessageAuthor" class="bx-im-list-channel-item__message_author-icon --self"></span>\n\t\t\t\t<MessageAvatar\n\t\t\t\t\tv-else-if="message.authorId"\n\t\t\t\t\t:messageId="message.id"\n\t\t\t\t\t:authorId="message.authorId"\n\t\t\t\t\t:size="AvatarSize.XXS"\n\t\t\t\t\tclass="bx-im-list-channel-item__message_author-avatar"\n\t\t\t\t/>\n\t\t\t\t<span class="bx-im-list-channel-item__message_text_content">{{ formattedMessageText }}</span>\n\t\t\t</span>\n\t\t</div>\n\t`};const b={name:"ChannelItem",components:{ChatAvatar:i.ChatAvatar,ChatTitle:a.ChatTitle,MessageText:p},props:{item:{type:Object,required:true}},data(){return{}},computed:{AvatarSize:()=>i.AvatarSize,recentItem(){return this.item},formattedDate(){if(this.needsBirthdayPlaceholder){return this.loc("IM_LIST_RECENT_BIRTHDAY_DATE")}return this.formatDate(this.message.date)},formattedCounter(){return this.dialog.counter>99?"99+":this.dialog.counter.toString()},dialog(){return this.$store.getters["chats/get"](this.recentItem.dialogId,true)},layout(){return this.$store.getters["application/getLayout"]},message(){return this.$store.getters["recent/getMessage"](this.recentItem.dialogId)},isUser(){return this.dialog.type===m.ChatType.user},isChat(){return!this.isUser},isChatSelected(){if(this.layout.name!==m.Layout.channel.name){return false}return this.layout.entityId===this.recentItem.dialogId},isChatMuted(){if(this.isUser){return false}const e=this.dialog.muteList.find((e=>e===d.Core.getUserId()));return Boolean(e)},needsBirthdayPlaceholder(){return this.$store.getters["recent/needsBirthdayPlaceholder"](this.recentItem.dialogId)},showLastMessage(){return this.$store.getters["application/settings/get"](m.Settings.recent.showLastMessage)},invitation(){return this.recentItem.invitation},wrapClasses(){return{"--selected":this.isChatSelected}}},methods:{formatDate(e){return l.DateFormatter.formatByTemplate(e,l.DateTemplate.recent)},loc(e){return this.$Bitrix.Loc.getMessage(e)}},template:`\n\t\t<div :data-id="recentItem.dialogId" :class="wrapClasses" class="bx-im-list-channel-item__wrap">\n\t\t\t<div class="bx-im-list-channel-item__container">\n\t\t\t\t<div class="bx-im-list-channel-item__avatar_container">\n\t\t\t\t\t<div class="bx-im-list-channel-item__avatar_content">\n\t\t\t\t\t\t<ChatAvatar \n\t\t\t\t\t\t\t:avatarDialogId="recentItem.dialogId" \n\t\t\t\t\t\t\t:contextDialogId="recentItem.dialogId"\n\t\t\t\t\t\t\t:size="AvatarSize.XL" \n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="bx-im-list-channel-item__content_container">\n\t\t\t\t\t<div class="bx-im-list-channel-item__content_header">\n\t\t\t\t\t\t<ChatTitle :dialogId="recentItem.dialogId" />\n\t\t\t\t\t\t<div class="bx-im-list-channel-item__date">\n\t\t\t\t\t\t\t<span>{{ formattedDate }}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="bx-im-list-channel-item__content_bottom">\n\t\t\t\t\t\t<MessageText :item="recentItem" />\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const L={name:"EmptyState",data(){return{}},methods:{loc(e){return this.$Bitrix.Loc.getMessage(e)}},template:`\n\t\t<div class="bx-im-list-channel__empty">\n\t\t\t<div class="bx-im-list-channel__empty_icon"></div>\n\t\t\t<div class="bx-im-list-channel__empty_text">{{ loc('IM_LIST_CHANNEL_EMPTY') }}</div>\n\t\t</div>\n\t`};var M=babelHelpers.classPrivateFieldLooseKey("itemsPerPage");var I=babelHelpers.classPrivateFieldLooseKey("isLoading");var _=babelHelpers.classPrivateFieldLooseKey("pagesLoaded");var f=babelHelpers.classPrivateFieldLooseKey("hasMoreItemsToLoad");var P=babelHelpers.classPrivateFieldLooseKey("lastMessageId");var C=babelHelpers.classPrivateFieldLooseKey("requestItems");var B=babelHelpers.classPrivateFieldLooseKey("updateModels");var y=babelHelpers.classPrivateFieldLooseKey("getMinMessageId");class x{constructor(){Object.defineProperty(this,y,{value:H});Object.defineProperty(this,B,{value:F});Object.defineProperty(this,C,{value:S});this.firstPageIsLoaded=false;Object.defineProperty(this,M,{writable:true,value:50});Object.defineProperty(this,I,{writable:true,value:false});Object.defineProperty(this,_,{writable:true,value:0});Object.defineProperty(this,f,{writable:true,value:true});Object.defineProperty(this,P,{writable:true,value:0})}async loadFirstPage(){babelHelpers.classPrivateFieldLooseBase(this,I)[I]=true;const e=await babelHelpers.classPrivateFieldLooseBase(this,C)[C]({firstPage:true});this.firstPageIsLoaded=true;return e}loadNextPage(){if(babelHelpers.classPrivateFieldLooseBase(this,I)[I]||!babelHelpers.classPrivateFieldLooseBase(this,f)[f]){return Promise.resolve()}babelHelpers.classPrivateFieldLooseBase(this,I)[I]=true;return babelHelpers.classPrivateFieldLooseBase(this,C)[C]()}hasMoreItemsToLoad(){return babelHelpers.classPrivateFieldLooseBase(this,f)[f]}}async function S({firstPage:e=false}={}){const t={data:{limit:babelHelpers.classPrivateFieldLooseBase(this,M)[M],filter:{lastMessageId:e?null:babelHelpers.classPrivateFieldLooseBase(this,P)[P]}}};const s=await h.runAction(m.RestMethod.imV2RecentChannelTail,t).catch((([e])=>{console.error("Im.ChannelList: page request error",e)}));babelHelpers.classPrivateFieldLooseBase(this,_)[_]++;o.Logger.warn(`Im.ChannelList: ${e?"First":babelHelpers.classPrivateFieldLooseBase(this,_)[_]} page request result`,s);const{messages:a,hasNextPage:i}=s;babelHelpers.classPrivateFieldLooseBase(this,P)[P]=babelHelpers.classPrivateFieldLooseBase(this,y)[y](a);if(!i){babelHelpers.classPrivateFieldLooseBase(this,f)[f]=false}babelHelpers.classPrivateFieldLooseBase(this,I)[I]=false;if(e){void d.Core.getStore().dispatch("recent/clearChannelCollection")}return babelHelpers.classPrivateFieldLooseBase(this,B)[B](s)}function F(e){const{users:t,chats:s,messages:a,files:i,recentItems:r}=e;const n=(new c.UserManager).setUsersToModel(t);const l=d.Core.getStore().dispatch("chats/set",s);const o=d.Core.getStore().dispatch("messages/store",a);const h=d.Core.getStore().dispatch("files/set",i);const g=d.Core.getStore().dispatch("recent/setChannel",r);return Promise.all([n,l,o,h,g])}function H(e){if(e.length===0){return 0}const t=e[0].id;return e.reduce(((e,t)=>Math.min(e,t.id)),t)}const T="IM_SHARED_CHANNEL_LIST";var A=babelHelpers.classPrivateFieldLooseKey("pullClient");var E=babelHelpers.classPrivateFieldLooseKey("requestWatchStart");class X{constructor(){Object.defineProperty(this,E,{value:w});Object.defineProperty(this,A,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,A)[A]=d.Core.getPullClient()}subscribe(){babelHelpers.classPrivateFieldLooseBase(this,A)[A].extendWatch(T);babelHelpers.classPrivateFieldLooseBase(this,E)[E]()}unsubscribe(){babelHelpers.classPrivateFieldLooseBase(this,A)[A].clearWatch(T)}}function w(){void h.runAction(m.RestMethod.imV2RecentChannelExtendPullWatch)}class D extends v.RecentMenu{getMenuItems(){return[this.getOpenItem()]}getOpenItem(){return{text:g.Loc.getMessage("IM_LIB_MENU_OPEN"),onclick:()=>{u.LayoutManager.getInstance().setLayout({name:m.Layout.channel.name,entityId:this.context.dialogId});this.menuInstance.close()}}}}const R={name:"ChannelList",components:{EmptyState:L,LoadingState:t.ListLoadingState,ChannelItem:b},emits:["chatClick"],data(){return{isLoading:false,isLoadingNextPage:false,firstPageLoaded:false}},computed:{collection(){return this.$store.getters["recent/getChannelCollection"]},preparedItems(){return[...this.collection].sort(((e,t)=>{const s=this.$store.getters["messages/getById"](e.messageId);const a=this.$store.getters["messages/getById"](t.messageId);return a.date-s.date}))},isEmptyCollection(){return this.collection.length===0}},created(){this.contextMenuManager=new D},beforeUnmount(){this.contextMenuManager.destroy()},async activated(){this.isLoading=true;await this.getRecentService().loadFirstPage();this.firstPageLoaded=true;this.isLoading=false;this.getPullWatchManager().subscribe()},deactivated(){this.getPullWatchManager().unsubscribe()},methods:{async onScroll(e){this.contextMenuManager.close();if(!r.Utils.dom.isOneScreenRemaining(e.target)||!this.getRecentService().hasMoreItemsToLoad){return}this.isLoadingNextPage=true;await this.getRecentService().loadNextPage();this.isLoadingNextPage=false},onClick(e){this.$emit("chatClick",e.dialogId)},onRightClick(e,t){t.preventDefault();this.contextMenuManager.openMenu(e,t.currentTarget)},getRecentService(){if(!this.service){this.service=new x}return this.service},getPullWatchManager(){if(!this.pullWatchManager){this.pullWatchManager=new X}return this.pullWatchManager},loc(e){return this.$Bitrix.Loc.getMessage(e)}},template:`\n\t\t<div class="bx-im-list-channel__container">\n\t\t\t<LoadingState v-if="isLoading && !firstPageLoaded" />\n\t\t\t<div v-else @scroll="onScroll" class="bx-im-list-channel__scroll-container">\n\t\t\t\t<EmptyState v-if="isEmptyCollection" />\n\t\t\t\t<div class="bx-im-list-channel__general_container">\n\t\t\t\t\t<ChannelItem\n\t\t\t\t\t\tv-for="item in preparedItems"\n\t\t\t\t\t\t:key="item.dialogId"\n\t\t\t\t\t\t:item="item"\n\t\t\t\t\t\t@click="onClick(item)"\n\t\t\t\t\t\t@click.right="onRightClick(item, $event)"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<LoadingState v-if="isLoadingNextPage" />\n\t\t\t</div>\n\t\t</div>\n\t`};e.ChannelList=R})(this.BX.Messenger.v2.Component.List=this.BX.Messenger.v2.Component.List||{},BX.Messenger.v2.Component.Elements,BX.Main,BX.Messenger.v2.Component.Elements,BX.Messenger.v2.Component.Elements,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Application,BX.Messenger.v2.Lib,BX,BX.Messenger.v2.Const,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib);
//# sourceMappingURL=channel-list.bundle.map.js