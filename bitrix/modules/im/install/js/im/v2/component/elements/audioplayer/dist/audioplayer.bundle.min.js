this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};this.BX.Messenger.v2.Component=this.BX.Messenger.v2.Component||{};(function(t,e,i,a,s,r,n,o){"use strict";const l="im:audioplayer:id";const u={name:"AudioPlayer",components:{MessageAvatar:o.MessageAvatar},props:{id:{type:Number,default:0},src:{type:String,default:""},file:{type:Object,required:true},authorId:{type:Number,required:true},messageId:{type:[String,Number],required:true},timelineType:{type:Number,required:true},withContextMenu:{type:Boolean,default:true},withAvatar:{type:Boolean,default:true},withPlaybackRateControl:{type:Boolean,default:false}},data(){return{preload:"none",loaded:false,loading:false,state:s.AudioPlaybackState.none,progress:0,progressInPixel:0,seek:0,timeCurrent:0,timeTotal:0,showContextButton:false,currentRate:s.AudioPlaybackRate["1"]}},computed:{State:()=>s.AudioPlaybackState,seekPosition(){if(!this.loaded&&!this.seek){return"display: none"}return`left: ${this.seek}px;`},isPlaying(){return this.state===s.AudioPlaybackState.play},labelTime(){if(!this.loaded&&!this.timeTotal){return"--:--"}let t=0;if(this.isPlaying){t=this.timeTotal-this.timeCurrent}else{t=this.timeTotal}return n.Utils.date.formatMediaDurationTime(t)},AvatarSize:()=>o.AvatarSize,fileSize(){return n.Utils.file.formatFileSize(this.file.size)},progressPosition(){if(!this.loaded||this.state===s.AudioPlaybackState.none){return{width:"100%"}}return{width:`${this.progressInPixel}px`}},activeTimelineStyles(){const t=44;const e=19;const i=this.timelineType*t+e;return{...this.progressPosition,"background-position-y":`-${i}px`}},timelineStyles(){const t=44;const e=this.timelineType*t;return{"background-position-y":`-${e}px`}},getAudioPlayerIds(){return this.$Bitrix.Data.get(l,[])},currentRateLabel(){return this.isPlaying?`${this.currentRate}x`:""},metaInfo(){return`${this.fileSize}, ${this.labelTime}`}},watch:{id(t){this.registerPlayer(t)},progress(t){if(t>70){this.preloadNext()}}},created(){this.localStorageInst=r.LocalStorageManager.getInstance();this.currentRate=this.getRateFromLS();this.preloadRequestSent=false;this.registeredId=0;this.registerPlayer(this.id);a.EventEmitter.subscribe(s.EventType.audioPlayer.play,this.onPlay);a.EventEmitter.subscribe(s.EventType.audioPlayer.stop,this.onStop);a.EventEmitter.subscribe(s.EventType.audioPlayer.pause,this.onPause);a.EventEmitter.subscribe(s.EventType.audioPlayer.preload,this.onPreload)},mounted(){this.getObserver().observe(this.$refs.body)},beforeUnmount(){this.unregisterPlayer();a.EventEmitter.unsubscribe(s.EventType.audioPlayer.play,this.onPlay);a.EventEmitter.unsubscribe(s.EventType.audioPlayer.stop,this.onStop);a.EventEmitter.unsubscribe(s.EventType.audioPlayer.pause,this.onPause);a.EventEmitter.unsubscribe(s.EventType.audioPlayer.preload,this.onPreload);this.getObserver().unobserve(this.$refs.body)},methods:{loadFile(t=false){if(this.loaded||this.loading&&!t){return}this.preload="auto";if(!t){return}this.loading=true;if(this.source()){void this.source().play()}},clickToButton(){if(!this.src){return}if(this.isPlaying){this.pause()}else{this.play()}},play(){this.updateRate(this.getRateFromLS());if(!this.loaded){this.loadFile(true);return}void this.source().play()},pause(){this.source().pause()},stop(){this.state=s.AudioPlaybackState.stop;this.source().pause()},setPosition(){if(!this.loaded){this.loadFile(true);return}const t=this.$refs.track.offsetWidth/100;this.setProgress(this.seek/t,this.seek);if(this.state!==s.AudioPlaybackState.play){this.state=s.AudioPlaybackState.pause}this.play();this.source().currentTime=this.timeTotal/100*this.progress},getRateFromLS(){return this.localStorageInst.get(s.LocalStorageKey.audioPlaybackRate)||s.AudioPlaybackRate["1"]},setRateInLS(t){this.localStorageInst.set(s.LocalStorageKey.audioPlaybackRate,t)},getNextPlaybackRate(t){const e=Object.values(s.AudioPlaybackRate).sort();const i=e.indexOf(t);const a=(i+1)%e.length;return e[a]},changeRate(){if([s.AudioPlaybackState.pause,s.AudioPlaybackState.none].includes(this.state)){return}const t=this.getRateFromLS();const e=this.getNextPlaybackRate(t);this.setRateInLS(e);this.updateRate(e)},updateRate(t){this.currentRate=t;this.source().playbackRate=t},seeking(t){if(!this.loaded){return}this.seek=t.offsetX>0?t.offsetX:0},setProgress(t,e=-1){this.progress=t;this.progressInPixel=e>0?e:Math.round(this.$refs.track.offsetWidth/100*t)},registerPlayer(t){if(t<=0){return}this.unregisterPlayer();const e=[...new Set([...this.getAudioPlayerIds,t])];this.$Bitrix.Data.set(l,e.sort(((t,e)=>t-e)));this.registeredId=t},unregisterPlayer(){if(!this.registeredId){return}this.$Bitrix.Data.get(l,this.getAudioPlayerIds.filter((t=>t!==this.registeredId)));this.registeredId=0},playNext(){if(!this.registeredId){return}const t=this.getAudioPlayerIds.filter((t=>t>this.registeredId)).slice(0,1)[0];if(t){a.EventEmitter.emit(s.EventType.audioPlayer.play,{id:t,start:true})}},preloadNext(){if(this.preloadRequestSent||!this.registeredId){return}this.preloadRequestSent=true;const t=this.getAudioPlayerIds.filter((t=>t>this.registeredId)).slice(0,1)[0];if(t){a.EventEmitter.emit(s.EventType.audioPlayer.preload,{id:t})}},onPlay(t){const e=t.getData();if(e.id!==this.id){return}if(e.start){this.stop()}this.play()},onStop(t){const e=t.getData();if(e.initiator===this.id){return}this.stop()},onPause(t){const e=t.getData();if(e.initiator===this.id){return}this.pause()},onPreload(t){const e=t.getData();if(e.id!==this.id){return}this.loadFile()},source(){return this.$refs.source},audioEventRouter(t,e){switch(t){case"durationchange":case"loadeddata":case"loadedmetadata":if(!this.source()){return}this.timeTotal=this.source().duration;break;case"abort":case"error":console.error("BxAudioPlayer: load failed",this.id,e);this.loading=false;this.state=s.AudioPlaybackState.none;this.timeTotal=0;this.preload="none";break;case"canplaythrough":this.loading=false;this.loaded=true;break;case"timeupdate":if(!this.source()){return}this.timeCurrent=this.source().currentTime;this.setProgress(Math.round(100/this.timeTotal*this.timeCurrent));if(this.isPlaying&&this.timeCurrent>=this.timeTotal){this.playNext()}break;case"pause":if(this.state!==s.AudioPlaybackState.stop){this.state=s.AudioPlaybackState.pause}break;case"play":this.state=s.AudioPlaybackState.play;if(this.state===s.AudioPlaybackState.stop){this.progress=0;this.timeCurrent=0}if(this.id>0){a.EventEmitter.emit(s.EventType.audioPlayer.pause,{initiator:this.id})}break}},getObserver(){if(this.observer){return this.observer}this.observer=new IntersectionObserver((t=>{t.forEach((t=>{if(t.isIntersecting&&this.preload==="none"){this.preload="metadata";this.observer.unobserve(t.target)}}))}),{threshold:[0,1]});return this.observer}},template:`\n\t\t<div \n\t\t\tclass="bx-im-audio-player__container bx-im-audio-player__scope" \n\t\t\tref="body"\n\t\t\t@mouseover="showContextButton = true"\n\t\t\t@mouseleave="showContextButton = false"\n\t\t>\n\t\t\t<div class="bx-im-audio-player__control-container">\n\t\t\t\t<button\n\t\t\t\t\tclass="bx-im-audio-player__control-button"\n\t\t\t\t\t:class="{\n\t\t\t\t\t\t'bx-im-audio-player__control-loader': loading,\n\t\t\t\t\t\t'bx-im-audio-player__control-play': !loading && !this.isPlaying,\n\t\t\t\t\t\t'bx-im-audio-player__control-pause': !loading && this.isPlaying,\n\t\t\t\t\t}"\n\t\t\t\t\t@click="clickToButton"\n\t\t\t\t></button>\n\t\t\t\t<div v-if="withAvatar" class="bx-im-audio-player__author-avatar-container">\n\t\t\t\t\t<MessageAvatar\n\t\t\t\t\t\t:messageId="messageId"\n\t\t\t\t\t\t:authorId="authorId"\n\t\t\t\t\t\t:size="AvatarSize.XS" \n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="bx-im-audio-player__timeline-container">\n\t\t\t\t<div class="bx-im-audio-player__track-container" @click="setPosition" ref="track">\n\t\t\t\t\t<div class="bx-im-audio-player__track-mask" :style="timelineStyles"></div>\n\t\t\t\t\t<div class="bx-im-audio-player__track-mask --active" :style="activeTimelineStyles"></div>\n\t\t\t\t\t<div class="bx-im-audio-player__track-seek" :style="seekPosition"></div>\n\t\t\t\t\t<div class="bx-im-audio-player__track-event" @mousemove="seeking"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class="bx-im-audio-player__timer-container --ellipsis">\n\t\t\t\t\t{{metaInfo}}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tv-if="!withPlaybackRateControl"\n\t\t\t\tclass="bx-im-audio-player__rate-button-container"\n\t\t\t>\n\t\t\t\t<button\n\t\t\t\t\t:class="{'--active': isPlaying}"\n\t\t\t\t\t@click="changeRate"\n\t\t\t\t>\n\t\t\t\t\t<span :class="{'bx-im-audio-player__rate-icon': !isPlaying}">\n\t\t\t\t\t\t{{currentRateLabel}}\n\t\t\t\t\t</span>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t\t<button\n\t\t\t\tv-if="showContextButton && withContextMenu"\n\t\t\t\tclass="bx-im-messenger__context-menu-icon bx-im-audio-player__context-menu-button"\n\t\t\t\t@click="$emit('contextMenuClick', $event)"\n\t\t\t></button>\n\t\t\t<audio \n\t\t\t\tv-if="src" \n\t\t\t\t:src="src" \n\t\t\t\tclass="bx-im-audio-player__audio-source" \n\t\t\t\tref="source" \n\t\t\t\t:preload="preload"\n\t\t\t\t@abort="audioEventRouter('abort', $event)"\n\t\t\t\t@error="audioEventRouter('error', $event)"\n\t\t\t\t@suspend="audioEventRouter('suspend', $event)"\n\t\t\t\t@canplay="audioEventRouter('canplay', $event)"\n\t\t\t\t@canplaythrough="audioEventRouter('canplaythrough', $event)"\n\t\t\t\t@durationchange="audioEventRouter('durationchange', $event)"\n\t\t\t\t@loadeddata="audioEventRouter('loadeddata', $event)"\n\t\t\t\t@loadedmetadata="audioEventRouter('loadedmetadata', $event)"\n\t\t\t\t@timeupdate="audioEventRouter('timeupdate', $event)"\n\t\t\t\t@play="audioEventRouter('play', $event)"\n\t\t\t\t@playing="audioEventRouter('playing', $event)"\n\t\t\t\t@pause="audioEventRouter('pause', $event)"\n\t\t\t></audio>\n\t\t</div>\n\t`};t.AudioPlayer=u})(this.BX.Messenger.v2.Component.Elements=this.BX.Messenger.v2.Component.Elements||{},BX,BX,BX.Event,BX.Messenger.v2.Const,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Component.Elements);
//# sourceMappingURL=audioplayer.bundle.map.js