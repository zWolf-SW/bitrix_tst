this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,t,i,a,r,n,s,o,l,c,d,u,p,g,k,b){"use strict";function v(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,a)}return i}function f(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?v(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):v(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var m=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"id","");babelHelpers.defineProperty(this,"title","");babelHelpers.defineProperty(this,"background","");babelHelpers.defineProperty(this,"preview","");babelHelpers.defineProperty(this,"isVideo",false);babelHelpers.defineProperty(this,"isSupported",true);babelHelpers.defineProperty(this,"isCustom",false);babelHelpers.defineProperty(this,"canRemove",false);babelHelpers.defineProperty(this,"isLoading",false);babelHelpers.defineProperty(this,"uploadState",null);Object.assign(this,t)}babelHelpers.createClass(e,[{key:"setUploadProgress",value:function e(t){this.uploadState.progress=t}},{key:"setUploadError",value:function e(){this.uploadState.status=d.FileStatus.error;this.uploadState.progress=0}},{key:"onUploadComplete",value:function e(t){this.id=t.id;if(this.isVideo){this.background=t.links.download}this.isLoading=false;this.canRemove=true}}],[{key:"createDefaultFromRest",value:function t(i){return new e(f(f({},i),{},{isVideo:i.id.includes(":video"),isCustom:false,canRemove:false,isSupported:true}))}},{key:"createCustomFromRest",value:function t(i){var a=u.Loc.getMessage("BX_IM_CALL_BG_CUSTOM");if(!i.isSupported){a=u.Loc.getMessage("BX_IM_CALL_BG_UNSUPPORTED")}return new e(f(f({},i),{},{title:a,isCustom:true,canRemove:true}))}},{key:"createCustomFromUploaderEvent",value:function t(i){var a=i.id,r=i.filePreview,n=i.file;return new e({id:a,background:r,preview:r,title:u.Loc.getMessage("BX_IM_CALL_BG_CUSTOM"),isVideo:n.type.startsWith("video"),isCustom:true,canRemove:false,isSupported:true,isLoading:true,uploadState:{progress:0,status:d.FileStatus.upload,size:n.size}})}}]);return e}();var h={props:{element:{type:Object,required:true},isSelected:{type:Boolean,required:true}},emits:["click","remove","cancel"],data:function e(){return{}},computed:{background:function e(){return this.element},containerClasses:function e(){var t=[];if(this.isSelected){t.push("--selected")}if(!this.background.isSupported){t.push("--unsupported")}if(this.background.isLoading){t.push("--loading")}return t},imageStyle:function e(){var t="";if(this.background.preview){t="url('".concat(this.background.preview,"')")}return{backgroundImage:t}}},watch:{"background.uploadState.status":function e(){this.getProgressBarManager().update()},"background.uploadState.progress":function e(){this.getProgressBarManager().update()}},mounted:function e(){this.initProgressBar()},beforeUnmount:function e(){this.removeProgressBar()},methods:{initProgressBar:function e(){var t=this;if(!this.background.uploadState||this.background.uploadState.progress===100){return}this.progressBarManager=new r.ProgressBarManager({container:this.$refs["container"],uploadState:this.background.uploadState});this.progressBarManager.subscribe(r.ProgressBarManager.event.cancel,(function(){t.$emit("cancel",t.background)}));this.progressBarManager.subscribe(r.ProgressBarManager.event.destroy,(function(){if(t.progressBar){t.progressBar=null}}));this.progressBarManager.start()},removeProgressBar:function e(){if(!this.progressBarManager){return}this.progressBarManager.destroy()},getProgressBarManager:function e(){return this.progressBarManager},loc:function e(t){return this.$Bitrix.Loc.getMessage(t)}},template:'\n\t\t<div @click="$emit(\'click\')" :class="containerClasses" class="bx-im-call-background__item" ref="container">\n\t\t\t<div :style="imageStyle" class="bx-im-call-background__item_image"></div>\n\t\t\t<div v-if="background.isSupported && background.isVideo" class="bx-im-call-background__item_video"></div>\n\t\t\t<div v-if="!background.isLoading" class="bx-im-call-background__item_title_container">\n\t\t\t\t<span class="bx-im-call-background__item_title">{{background.title}}</span>\n\t\t\t\t<div\n\t\t\t\t\tv-if="background.canRemove"\n\t\t\t\t\t:title="loc(\'BX_IM_CALL_BG_REMOVE\')"\n\t\t\t\t\t@click.stop="$emit(\'remove\')"\n\t\t\t\t\tclass="bx-im-call-background__item_remove"\n\t\t\t\t></div>\n\t\t\t</div>\n\t\t</div>\n\t'};var B=function(){function e(t){babelHelpers.classCallCheck(this,e);var i=e.type.none;var a=e.type.none;var r=u.Loc.getMessage("BX_IM_CALL_BG_ACTION_NONE");if(t===e.type.upload){i=t;a=t;r=u.Loc.getMessage("BX_IM_CALL_BG_ACTION_UPLOAD")}else if(t===e.type.gaussianBlur){i=t;a=t;r=u.Loc.getMessage("BX_IM_CALL_BG_ACTION_BLUR")}else if(t===e.type.blur){i=t;a=t;r=u.Loc.getMessage("BX_IM_CALL_BG_ACTION_BLUR_MAX")}this.id=i;this.background=a;this.title=r}babelHelpers.createClass(e,[{key:"isEmpty",value:function t(){return this.id===e.type.none}},{key:"isBlur",value:function t(){return this.id===e.type.gaussianBlur||this.id===e.type.blur}},{key:"isUpload",value:function t(){return this.id===e.type.upload}}]);return e}();babelHelpers.defineProperty(B,"type",{none:"none",upload:"upload",blur:"blur",gaussianBlur:"gaussianBlur"});var _={props:{element:{type:Object,required:true},isSelected:{type:Boolean,required:true}},data:function e(){return{}},computed:{action:function e(){return this.element},containerClasses:function e(){var t=["--".concat(this.action.id)];if(this.isSelected){t.push("--selected")}return t}},template:'\n\t\t<div :class="containerClasses" class="bx-im-call-background__item --action">\n\t\t\t<div class="bx-im-call-background__action_icon"></div>\n\t\t\t<div class="bx-im-call-background__action_title">\n\t\t\t\t{{ action.title }}\n\t\t\t</div>\n\t\t</div>\n\t'};var y=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"id","");babelHelpers.defineProperty(this,"active",true);babelHelpers.defineProperty(this,"mask","");babelHelpers.defineProperty(this,"background","");babelHelpers.defineProperty(this,"preview","");babelHelpers.defineProperty(this,"title","");babelHelpers.defineProperty(this,"isLoading",false);Object.assign(this,t)}babelHelpers.createClass(e,[{key:"isEmpty",value:function e(){return this.id===""}}],[{key:"createEmpty",value:function t(){return new e({active:true,id:"",mask:"",preview:"",background:"",title:u.Loc.getMessage("BX_IM_CALL_BG_NO_MASK_TITLE")})}},{key:"createFromRest",value:function t(i){var a=i.active,r=i.id,n=i.mask,s=i.background,o=i.preview,l=i.title;return new e({active:a,id:r,mask:n,preview:o,background:s,title:l})}}]);return e}();var C={props:{element:{type:Object,required:true},isSelected:{type:Boolean,required:true}},data:function e(){return{}},computed:{mask:function e(){return this.element},containerClasses:function e(){var t=["--".concat(this.mask.id)];if(this.isSelected){t.push("--selected")}if(!this.mask.active){t.push("--inactive")}return t},imageStyle:function e(){var t="";if(this.mask.preview){t="url('".concat(this.mask.preview,"')")}return{backgroundImage:t}}},methods:{loc:function e(t){return this.$Bitrix.Loc.getMessage(t)}},template:'\n\t\t<div :class="containerClasses" class="bx-im-call-background__item --mask">\n\t\t\t<div v-if="!mask.active" class="bx-im-call-background__mask_fade"></div>\n\t\t\t<div class="bx-im-call-background__mask_background"></div>\n\t\t\t<div :style="imageStyle" class="bx-im-call-background__item_image"></div>\n\t\t\t<div v-if="mask.isLoading" class="bx-im-call-background__mask_loading-container">\n\t\t\t\t<div class="bx-im-call-background__mask_loading-icon"></div>\n\t\t\t\t<div class="bx-im-call-background__mask_loading-text">{{ loc(\'BX_IM_CALL_BG_MASK_LOADING\') }}</div>\n\t\t\t</div>\n\t\t\t<div v-else-if="!mask.active" class="bx-im-call-background__mask_soon-container">\n\t\t\t\t<div class="bx-im-call-background__mask_soon-text">{{ loc(\'BX_IM_CALL_BG_MASK_COMING_SOON\') }}</div>\n\t\t\t</div>\n\t\t\t<div v-else class="bx-im-call-background__mask_title">{{ mask.title }}</div>\n\t\t</div>\n\t'};var M={name:"CallBackgroundLoader",data:function e(){return{}},template:'\n\t\t<div class="bx-im-call-background__loader">\n\t\t\t<svg class="bx-desktop-loader-circular" viewBox="25 25 50 50">\n\t\t\t\t<circle class="bx-desktop-loader-path" cx="50" cy="50" r="20" fill="none" stroke-miterlimit="10"/>\n\t\t\t</svg>\n\t\t</div>\n\t'};function L(e,t){S(e,t);t.add(e)}function S(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function w(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var I=new WeakSet;var H=new WeakSet;var P=new WeakSet;var T=function(){function e(t){babelHelpers.classCallCheck(this,e);L(this,P);L(this,H);L(this,I);babelHelpers.defineProperty(this,"limits",{});var i=t.limits,a=t.infoHelperUrlTemplate;w(this,I,A).call(this,i);w(this,H,D).call(this,a)}babelHelpers.createClass(e,[{key:"isLimitedAction",value:function t(i){if(i.isEmpty()||i.isUpload()){return false}return i.isBlur()&&w(this,P,x).call(this,e.limitCode.blur)}},{key:"isLimitedBackground",value:function t(){return w(this,P,x).call(this,e.limitCode.image)}},{key:"showLimitSlider",value:function e(t){window.BX.UI.InfoHelper.show(this.limits[t].articleCode)}}],[{key:"isMaskFeatureAvailable",value:function e(){if(!s.Utils.platform.isBitrixDesktop()){return true}return o.DesktopApi.isFeatureEnabled(o.DesktopFeature.mask.id)}},{key:"isMaskFeatureSupportedByDesktopVersion",value:function e(){if(!s.Utils.platform.isBitrixDesktop()){return true}return o.DesktopApi.isFeatureSupported(o.DesktopFeature.mask.id)}},{key:"showHelpArticle",value:function e(t){l.openHelpdeskArticle(t)}}]);return e}();function A(e){var t=this;e.forEach((function(e){t.limits[e.id]=e}))}function D(e){if(window.BX.UI.InfoHelper.isInited()){return}window.BX.UI.InfoHelper.init({frameUrlTemplate:e})}function x(e){var t,i;var a=!!((t=this.limits[e])!==null&&t!==void 0&&t.active);var r=!!((i=this.limits[e])!==null&&i!==void 0&&i.articleCode);return a&&r}babelHelpers.defineProperty(T,"limitCode",{blur:"call_blur_background",image:"call_background"});var E={mask:"mask",background:"background"};var O=12398124;var U={props:{selectedTab:{type:String,required:true}},emits:["tabChange"],data:function e(){return{}},computed:{tabs:function e(){var e=[];if(T.isMaskFeatureAvailable()){e.push({id:E.mask,loc:"BX_IM_CALL_BG_TAB_MASK",isNew:false})}e.push({id:E.background,loc:"BX_IM_CALL_BG_TAB_BG",isNew:false});return e}},methods:{loc:function e(t){return this.$Bitrix.Loc.getMessage(t)}},template:'\n\t\t<div class="bx-im-call-background__tab-panel">\n\t\t\t<div\n\t\t\t\tv-for="tab in tabs"\n\t\t\t\t:key="tab.id"\n\t\t\t\t@click="$emit(\'tabChange\', tab.id)"\n\t\t\t\t:class="{\'--active\': selectedTab === tab.id, \'--new\': tab.isNew}"\n\t\t\t\tclass="bx-im-call-background__tab"\n\t\t\t>\n\t\t\t\t<div v-if="tab.isNew" class="bx-im-call-background__tab_new">{{ loc(\'BX_IM_CALL_BG_TAB_NEW\') }}</div>\n\t\t\t\t<div class="bx-im-call-background__tab_text">{{ loc(tab.loc) }}</div>\n\t\t\t</div>\n\t\t</div>\n\t'};function X(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,a)}return i}function R(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?X(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):X(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var F=1280;var j=720;var G={data:function e(){return{noVideo:false}},computed:{videoClasses:function e(){return{"--flipped":BX.Call.Hardware.enableMirroring}}},created:function e(){var t=this;this.initHardware().then((function(){t.getDefaultDevices()}))["catch"]((function(e){console.error("VideoPreview: error initing hardware",e)}))},beforeUnmount:function e(){this.videoStream.getTracks().forEach((function(e){return e.stop()}));this.videoStream=null},methods:{getDefaultDevices:function e(){var t=this;var i={audio:false,video:true};i.video={};i.video.width={ideal:F};i.video.height={ideal:j};if(BX.Call.Hardware.defaultCamera){this.selectedCamera=BX.Call.Hardware.defaultCamera;i.video=R(R({},i.video),{deviceId:{exact:this.selectedCamera}})}else if(Object.keys(BX.Call.Hardware.cameraList).length===0){console.error("VideoPreview: no camera");return}navigator.mediaDevices.getUserMedia(i).then((function(e){t.videoStream=e;if(e.getVideoTracks().length===0){t.noVideo=true;console.error("VideoPreview: no video tracks");return}if(!t.selectedCamera){t.selectedCamera=e.getVideoTracks()[0].getSettings().deviceId}t.playLocalVideo()}))},playLocalVideo:function e(){g.Logger.warn("VideoPreview: playing local video");this.$refs["video"].volume=0;this.$refs["video"].srcObject=this.videoStream;this.$refs["video"].play()},initHardware:function e(){return BX.Call.Hardware.init()},loc:function e(t){return this.$Bitrix.Loc.getMessage(t)}},template:'\n\t\t<div class="bx-im-call-background__video">\n\t\t\t<div v-if="noVideo" class="bx-im-call-background__no-cam_container">\n\t\t\t\t<div class="bx-im-call-background__no-cam_icon"></div>\n\t\t\t\t<div class="bx-im-call-background__no-cam_title">{{ loc(\'BX_IM_CALL_BG_NO_CAM\') }}</div>\n\t\t\t</div>\n\t\t\t<video v-else :class="videoClasses" ref="video" muted autoplay playsinline></video>\n\t\t</div>\n\t'};var N=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"getElementsList",value:function e(){var t;var i=(t={},babelHelpers.defineProperty(t,d.RestMethod.imCallBackgroundGet,[d.RestMethod.imCallBackgroundGet]),babelHelpers.defineProperty(t,d.RestMethod.imCallMaskGet,[d.RestMethod.imCallMaskGet]),t);return new Promise((function(e,t){c.rest.callBatch(i,(function(i){g.Logger.warn("BackgroundService: getElementsList result",i);var a=i[d.RestMethod.imCallBackgroundGet];var r=i[d.RestMethod.imCallMaskGet];if(a.error()){console.error("BackgroundService: error getting background list",a.error());return t(a.error())}if(r.error()){console.error("BackgroundService: error getting mask list",r.error());return t(r.error())}return e({backgroundResult:a.data(),maskResult:r.data()})}))}))}},{key:"commitBackground",value:function e(t){c.rest.callMethod(d.RestMethod.imCallBackgroundCommit,{fileId:t})["catch"]((function(e){console.error("BackgroundService: commitBackground error",e.error())}))}},{key:"deleteFile",value:function e(t){c.rest.callMethod(d.RestMethod.imCallBackgroundDelete,{fileId:t})["catch"]((function(e){console.error("BackgroundService: deleteFile error",e.error())}))}}]);return e}();function V(e,t){z(e,t);t.add(e)}function z(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function W(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var $=100*1024*1024;var q=100;var K=1024*1024;var J="custom";var Q="BX.Messenger.v2.CallBackground.UploadManager";var Y=new WeakSet;var Z=new WeakSet;var ee=new WeakSet;var te=new WeakSet;var ie=new WeakSet;var ae=new WeakSet;var re=new WeakSet;var ne=new WeakSet;var se=new WeakSet;var oe=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));V(babelHelpers.assertThisInitialized(i),se);V(babelHelpers.assertThisInitialized(i),ne);V(babelHelpers.assertThisInitialized(i),re);V(babelHelpers.assertThisInitialized(i),ae);V(babelHelpers.assertThisInitialized(i),ie);V(babelHelpers.assertThisInitialized(i),te);V(babelHelpers.assertThisInitialized(i),ee);V(babelHelpers.assertThisInitialized(i),Z);V(babelHelpers.assertThisInitialized(i),Y);i.setEventNamespace(Q);var a=e.inputNode;i.uploader=new k.Uploader({inputNode:a,generatePreview:true,fileMaxSize:$});W(babelHelpers.assertThisInitialized(i),Y,le).call(babelHelpers.assertThisInitialized(i));return i}babelHelpers.createClass(t,[{key:"setDiskFolderId",value:function e(t){this.diskFolderId=t}},{key:"cancelUpload",value:function e(t){this.uploader.deleteTask(t)}}]);return t}(p.EventEmitter);function le(){this.uploader.subscribe("onFileMaxSizeExceeded",W(this,Z,ce).bind(this));this.uploader.subscribe("onSelectFile",W(this,ee,de).bind(this));this.uploader.subscribe("onStartUpload",W(this,te,ue).bind(this));this.uploader.subscribe("onProgress",W(this,ie,pe).bind(this));this.uploader.subscribe("onComplete",W(this,ae,ge).bind(this));this.uploader.subscribe("onUploadFileError",W(this,re,ke).bind(this));this.uploader.subscribe("onCreateFileError",W(this,re,ke).bind(this))}function ce(e){g.Logger.warn("UploadManager: onFileMaxSizeExceeded",e);var t=e.getData();var i=t.file;b.Notifier.call.onBackgroundFileSizeError({fileName:i.name,fileSizeLimit:q})}function de(e){g.Logger.warn("UploadManager: onSelectFile",e);var t=e.getData(),i=t.file,a=t.previewData;if(!W(this,se,ve).call(this,i.type)||!a){b.Notifier.call.onBackgroundUnsupportedError(i.name);return}W(this,ne,be).call(this,i,a)}function ue(e){g.Logger.warn("UploadManager: onStartUpload",e);var t=e.getData(),i=t.previewData,a=t.id,r=t.file;var n=URL.createObjectURL(i);this.emit(oe.event.uploadStart,{id:a,filePreview:n,file:r})}function pe(e){g.Logger.warn("UploadManager: onProgress",e);var t=e.getData(),i=t.id,a=t.progress;this.emit(oe.event.uploadProgress,{id:i,progress:a})}function ge(e){g.Logger.warn("UploadManager: onComplete",e);var t=e.getData(),i=t.id,a=t.result;this.emit(oe.event.uploadComplete,{id:i,fileResult:a.data.file})}function ke(e){g.Logger.warn("UploadManager: onUploadError",e);var t=e.getData();this.emit(oe.event.uploadError,{id:t.id})}function be(e,t){this.uploader.addTask({taskId:"".concat(J,":").concat(Date.now()),chunkSize:K,fileData:e,fileName:e.name,diskFolderId:this.diskFolderId,generateUniqueName:true,previewBlob:t})}function ve(e){return oe.allowedFileTypes.includes(e)}babelHelpers.defineProperty(oe,"allowedFileTypes",["image/png","image/jpg","image/jpeg","video/avi","video/mp4","video/quicktime"]);babelHelpers.defineProperty(oe,"event",{uploadStart:"uploadStart",uploadProgress:"uploadProgress",uploadComplete:"uploadComplete",uploadError:"uploadError"});var fe={name:"CallBackground",components:{BackgroundComponent:h,ActionComponent:_,MaskComponent:C,Loader:M,TabPanel:U,VideoPreview:G},props:{tab:{type:String,default:E.background}},data:function e(){return{selectedTab:"",selectedBackgroundId:"",selectedMaskId:"",loadingItems:true,actions:[],defaultBackgrounds:[],customBackgrounds:[],masks:[],listIsScrolled:false}},computed:{TabId:function e(){return E},backgrounds:function e(){return[].concat(babelHelpers.toConsumableArray(this.customBackgrounds),babelHelpers.toConsumableArray(this.defaultBackgrounds))},containerClasses:function e(){var t=[];if(this.isDesktop){t.push("--desktop")}return t},uploadTypes:function e(){return oe.allowedFileTypes.join(", ")},descriptionText:function e(){var t={"#HIGHLIGHT_START#":'<span class="bx-im-call-background__description_highlight">',"#HIGHLIGHT_END#":"</span>","#BR#":"</br></br>"};if(this.selectedTab===E.mask){return this.loc("BX_IM_CALL_BG_DESCRIPTION_MASK_2",t)}return this.loc("BX_IM_CALL_BG_DESCRIPTION_BG",t)},isDesktop:function e(){return s.Utils.platform.isBitrixDesktop()}},created:function e(){var t=this;this.initSelectedTab();this.getBackgroundService().getElementsList().then((function(e){var i=e.backgroundResult,a=e.maskResult;t.initLimitManager(i);t.initBackgroundList(i);t.uploadManager.setDiskFolderId(i.upload.folderId);var r=!!i.upload.folderId;t.initActions(r);t.initMasks(a);t.initMaskLoadEventHandler();t.initPreviouslySelectedItem();t.loadingItems=false;t.hideLoader()}))["catch"]((function(){t.loadingItems=false}))},mounted:function e(){this.initUploader()},methods:{initSelectedTab:function e(){if(this.tab===E.mask&&!T.isMaskFeatureAvailable()){this.selectedTab=E.background;return}if(this.tab===E.mask&&!T.isMaskFeatureSupportedByDesktopVersion()){this.selectedTab=E.background;T.showHelpArticle(O);return}this.selectedTab=this.tab},initPreviouslySelectedItem:function e(){this.initPreviouslySelectedMask();this.initPreviouslySelectedBackground()},initPreviouslySelectedMask:function e(){if(this.isDesktop){var t=o.DesktopApi.getCallMask(),i=t.id;var a=this.masks.find((function(e){return e.id===i}));if(!a){a=y.createEmpty()}this.previouslySelectedMask=a;g.Logger.warn("CallBackground: previously selected mask",this.previouslySelectedMask)}else{this.previouslySelectedMask=y.createEmpty()}this.selectedMaskId=this.previouslySelectedMask.id},initPreviouslySelectedBackground:function e(){if(this.isDesktop){var t=o.DesktopApi.getBackgroundImage(),i=t.id;var a=[].concat(babelHelpers.toConsumableArray(this.actions),babelHelpers.toConsumableArray(this.backgrounds));var r=a.find((function(e){return e.id===i}));if(!r){r=new B(B.type.none)}this.previouslySelectedBackground=r;g.Logger.warn("CallBackground: previously selected background",this.previouslySelectedBackground)}else{this.previouslySelectedBackground=new B(B.type.none)}this.selectedBackgroundId=this.previouslySelectedBackground.id},initActions:function e(t){this.actions=[new B(B.type.none)].concat(babelHelpers.toConsumableArray(t?[new B(B.type.upload)]:[]),[new B(B.type.gaussianBlur),new B(B.type.blur)])},initBackgroundList:function e(t){var i=this;this.defaultBackgrounds=[];t.backgrounds["default"].forEach((function(e){i.defaultBackgrounds.push(m.createDefaultFromRest(e))}));this.customBackgrounds=[];t.backgrounds.custom.forEach((function(e){i.customBackgrounds.push(m.createCustomFromRest(e))}))},initLimitManager:function e(t){var i=t.limits,a=t.infoHelperParams;this.limitManager=new T({limits:i,infoHelperUrlTemplate:a.frameUrlTemplate})},initUploader:function e(){var t=this;this.uploadManager=new oe({inputNode:this.$refs["uploadInput"]});this.uploadManager.subscribe(oe.event.uploadStart,(function(e){var i=m.createCustomFromUploaderEvent(e.getData());t.customBackgrounds.unshift(i)}));this.uploadManager.subscribe(oe.event.uploadProgress,(function(e){var i=e.getData(),a=i.id,r=i.progress;var n=t.findCustomBackgroundById(a);if(!n){return}n.setUploadProgress(r)}));this.uploadManager.subscribe(oe.event.uploadComplete,(function(e){var i=e.getData(),a=i.id,r=i.fileResult;var n=t.findCustomBackgroundById(a);if(!n){return}n.onUploadComplete(r);t.onBackgroundClick(n);t.getBackgroundService().commitBackground(n.id)}));this.uploadManager.subscribe(oe.event.uploadError,(function(e){var i=e.getData(),a=i.id;var r=t.findCustomBackgroundById(a);if(!r){return}r.setUploadError()}))},initMasks:function e(t){var i=this;var a=t.masks;this.masks.push(y.createEmpty());a.forEach((function(e){i.masks.push(y.createFromRest(e))}))},initMaskLoadEventHandler:function e(){if(!this.isDesktop){return}this.maskLoadTimeouts={};o.DesktopApi.setCallMaskLoadHandlers(this.onMaskLoad.bind(this))},onActionClick:function e(t){if(this.getLimitManager().isLimitedAction(t)){this.getLimitManager().showLimitSlider(T.limitCode.blur);return}if(t.isUpload()){this.$refs["uploadInput"].click();return}this.selectedBackgroundId=t.id;if(t.isEmpty()){this.removeCallBackground();return}this.selectedMaskId="";this.setCallBlur(t)},onBackgroundClick:function e(t){if(this.getLimitManager().isLimitedBackground()){this.getLimitManager().showLimitSlider(T.limitCode.image);return}if(!t.isSupported||t.isLoading){return}this.selectedBackgroundId=t.id;this.selectedMaskId="";this.setCallBackground(t)},onBackgroundRemove:function e(t){if(t.id===this.selectedBackgroundId){this.selectedBackgroundId=B.type.none;this.removeCallBackground()}if(t.isLoading){this.uploadManager.cancelUpload(t.id)}else{this.getBackgroundService().deleteFile(t.id)}this.customBackgrounds=this.customBackgrounds.filter((function(e){return e.id!==t.id}))},onMaskClick:function e(t){if(!t.active){return}if(t.isEmpty()){this.selectedMaskId=t.id;this.removeCallMask()}this.setCallMask(t)},onSaveButtonClick:function e(){window.close()},onCancelButtonClick:function e(){var t=this;var i=this.previouslySelectedBackground.id!==this.selectedBackgroundId;var a=this.previouslySelectedMask.id!==this.selectedMaskId;if(!i&&!a){window.close();return}var r=Promise.resolve();if(i){r=this.setCallBackground(this.previouslySelectedBackground)}r.then((function(){if(a&&!t.previouslySelectedMask.isEmpty()){t.setCallMask(t.previouslySelectedMask);t.isWaitingForMaskToCancel=true}else if(t.previouslySelectedMask.isEmpty()){t.removeCallMask();window.close()}else{window.close()}}))},onListScroll:function e(t){if(t.target.scrollTop===0){this.listIsScrolled=false;return}this.listIsScrolled=true},onTabChange:function e(t){if(t===E.mask&&!T.isMaskFeatureSupportedByDesktopVersion()){T.showHelpArticle(O);return}this.selectedTab=t},onMaskLoad:function e(t){g.Logger.warn("CallBackground: onMaskLoad",t);if(this.isWaitingForMaskToCancel){window.close();return}var i=this.masks.filter((function(e){return!e.isEmpty()}));var a=i.find((function(e){return t.includes(e.mask)}));g.Logger.warn("CallBackground: loaded mask",a);if(!a){return}clearTimeout(this.maskLoadTimeouts[a.id]);a.isLoading=false;if(this.lastRequestedMaskId===a.id){this.selectedMaskId=a.id}},onSetCallBackgroundHandle:function e(t,i){var a=this;return o.DesktopApi.setCallBackground(t,i).then((function(e){if(e==="none"&&a.selectedBackgroundId!=="none"){g.Logger.warn("CallBackground: background settings limit exceeded");a.selectedBackgroundId=B.type.none}}))},setCallBackground:function e(t){g.Logger.warn("CallBackground: trying set background",t);if(!this.isDesktop){return}return this.onSetCallBackgroundHandle(t.id,t.background)},setCallBlur:function e(t){g.Logger.warn("CallBackground: trying set blur",t);if(!this.isDesktop){return}return this.onSetCallBackgroundHandle(t.id,t.background)},removeCallBackground:function e(){if(!this.isDesktop){return}return this.onSetCallBackgroundHandle(B.type.none,B.type.none)},setCallMask:function e(t){g.Logger.warn("CallBackground: set mask",t);if(!this.isDesktop){return}if(t.isEmpty()){g.Logger.warn("CallBackground: empty mask - removing it");o.DesktopApi.setCallMask();return}this.lastRequestedMaskId=t.id;var i=500;this.maskLoadTimeouts[t.id]=setTimeout((function(){t.isLoading=true}),i);o.DesktopApi.setCallMask(t.id,t.mask,t.background)},removeCallMask:function e(){if(!this.isDesktop){return}o.DesktopApi.setCallMask()},hideLoader:function e(){if(!this.isDesktop){return}o.DesktopApi.hideLoader()},findCustomBackgroundById:function e(t){return this.customBackgrounds.find((function(e){return e.id===t}))},getBackgroundService:function e(){if(!this.backgroundService){this.backgroundService=new N}return this.backgroundService},getLimitManager:function e(){return this.limitManager},loc:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};return this.$Bitrix.Loc.getMessage(t,i)}},template:'\n\t\t<div :class="{\'--desktop\': isDesktop}" class="bx-im-call-background__scope bx-im-call-background__container">\n\t\t\t<div v-if="loadingItems" class="bx-im-call-background__loader_container">\n\t\t\t\t<Loader />\n\t\t\t</div>\n\t\t\t<div v-else class="bx-im-call-background__content">\n\t\t\t\t<div class="bx-im-call-background__left">\n\t\t\t\t\t<VideoPreview />\n\t\t\t\t\t<div v-html="descriptionText" class="bx-im-call-background__description"></div>\n\t\t\t\t</div>\n\t\t\t\t<div :class="{\'--scrolled\': listIsScrolled}" class="bx-im-call-background__right">\n\t\t\t\t\t<TabPanel :selectedTab="selectedTab" @tabChange="onTabChange" />\n\t\t\t\t\t<div v-if="selectedTab === TabId.background" @scroll="onListScroll" class="bx-im-call-background__list">\n\t\t\t\t\t\t<ActionComponent\n\t\t\t\t\t\t\tv-for="action in actions"\n\t\t\t\t\t\t\t:element="action"\n\t\t\t\t\t\t\t:key="action.id"\n\t\t\t\t\t\t\t:isSelected="selectedBackgroundId === action.id"\n\t\t\t\t\t\t\t@click="onActionClick(action)"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<BackgroundComponent\n\t\t\t\t\t\t\tv-for="background in backgrounds"\n\t\t\t\t\t\t\t:element="background"\n\t\t\t\t\t\t\t:key="background.id"\n\t\t\t\t\t\t\t:isSelected="selectedBackgroundId === background.id"\n\t\t\t\t\t\t\t@click="onBackgroundClick(background)"\n\t\t\t\t\t\t\t@cancel="onBackgroundRemove(background)"\n\t\t\t\t\t\t\t@remove="onBackgroundRemove(background)"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div v-else-if="selectedTab === TabId.mask" @scroll="onListScroll" class="bx-im-call-background__list">\n\t\t\t\t\t\t<MaskComponent\n\t\t\t\t\t\t\tv-for="mask in masks"\n\t\t\t\t\t\t\t:element="mask"\n\t\t\t\t\t\t\t:key="mask.id"\n\t\t\t\t\t\t\t:isSelected="selectedMaskId === mask.id"\n\t\t\t\t\t\t\t@click="onMaskClick(mask)"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\t\n\t\t\t</div>\n\t\t\t<div class="bx-im-call-background__button-panel">\n\t\t\t\t<button @click="onSaveButtonClick" :class="{\'ui-btn-wait ui-btn-disabled\': loadingItems}" class="ui-btn ui-btn-success">\n\t\t\t\t\t{{ loc(\'BX_IM_CALL_BG_SAVE\') }}\n\t\t\t\t</button>\n\t\t\t\t<button @click="onCancelButtonClick" class="ui-btn ui-btn-link">\n\t\t\t\t\t{{ loc(\'BX_IM_CALL_BG_CANCEL\') }}\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</div>\n\t\t<div class="bx-im-call-background__upload-input">\n\t\t\t<input type="file" :accept="uploadTypes" ref="uploadInput"/>\n\t\t</div>\n\t'};e.CallBackground=fe})(this.BX.Messenger.v2.Component=this.BX.Messenger.v2.Component||{},BX.Vue3,BX.UI,BX,BX.Messenger.v2.Lib,BX.UI,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX,BX.Messenger.v2.Const,BX,BX.Event,BX.Messenger.v2.Lib,BX.Messenger.Lib,BX.Messenger.v2.Lib);
//# sourceMappingURL=call-background.bundle.map.js