{"version":3,"file":"call-background.bundle.js","sources":["../src/classes/items/background.js","../src/components/background.js","../src/classes/items/action.js","../src/components/action.js","../src/classes/items/mask.js","../src/components/mask.js","../src/components/loader.js","../src/classes/limit-manager.js","../src/const.js","../src/components/tab-panel.js","../src/components/video-preview.js","../src/classes/background-service.js","../src/classes/upload-manager.js","../src/call-background.js"],"sourcesContent":["import {Loc} from 'main.core';\n\nimport {FileStatus} from 'im.v2.const';\n\nimport type {BackgroundRestResult} from '../../types/rest';\n\nexport type UploadState = {\n\tprogress: number,\n\tstatus: string,\n\tsize: number\n};\n\nexport class Background\n{\n\tid: string = '';\n\ttitle: string = '';\n\tbackground: string = '';\n\tpreview: string = '';\n\tisVideo: boolean = false;\n\tisSupported: boolean = true;\n\tisCustom: boolean = false;\n\tcanRemove: boolean = false;\n\n\tisLoading: boolean = false;\n\tuploadState: UploadState = null;\n\n\tconstructor(params)\n\t{\n\t\tObject.assign(this, params);\n\t}\n\n\tstatic createDefaultFromRest(restItem: BackgroundRestResult): Background\n\t{\n\t\treturn new Background({\n\t\t\t...restItem,\n\t\t\tisVideo: restItem.id.includes(':video'),\n\t\t\tisCustom: false,\n\t\t\tcanRemove: false,\n\t\t\tisSupported: true\n\t\t});\n\t}\n\n\tstatic createCustomFromRest(restItem: BackgroundRestResult): Background\n\t{\n\t\tlet title = Loc.getMessage('BX_IM_CALL_BG_CUSTOM');\n\t\tif (!restItem.isSupported)\n\t\t{\n\t\t\ttitle = Loc.getMessage('BX_IM_CALL_BG_UNSUPPORTED');\n\t\t}\n\n\t\treturn new Background({\n\t\t\t...restItem,\n\t\t\ttitle,\n\t\t\tisCustom: true,\n\t\t\tcanRemove: true\n\t\t});\n\t}\n\n\tstatic createCustomFromUploaderEvent(uploaderData: {id: string, filePreview: string, file: File}): Background\n\t{\n\t\tconst {id, filePreview, file} = uploaderData;\n\n\t\treturn new Background({\n\t\t\tid: id,\n\t\t\tbackground: filePreview,\n\t\t\tpreview: filePreview,\n\t\t\ttitle: Loc.getMessage('BX_IM_CALL_BG_CUSTOM'),\n\t\t\tisVideo: file.type.startsWith('video'),\n\t\t\tisCustom: true,\n\t\t\tcanRemove: false,\n\t\t\tisSupported: true,\n\t\t\tisLoading: true,\n\t\t\tuploadState: {\n\t\t\t\tprogress: 0,\n\t\t\t\tstatus: FileStatus.upload,\n\t\t\t\tsize: file.size,\n\t\t\t}\n\t\t});\n\t}\n\n\tsetUploadProgress(progress: number)\n\t{\n\t\tthis.uploadState.progress = progress;\n\t}\n\n\tsetUploadError()\n\t{\n\t\tthis.uploadState.status = FileStatus.error;\n\t\tthis.uploadState.progress = 0;\n\t}\n\n\tonUploadComplete(fileResult)\n\t{\n\t\tthis.id = fileResult.id;\n\n\t\tif (this.isVideo)\n\t\t{\n\t\t\tthis.background = fileResult.links.download;\n\t\t}\n\n\t\tthis.isLoading = false;\n\t\tthis.canRemove = true;\n\t}\n}","import {ProgressBarManager} from 'im.v2.lib.progressbar';\n\nimport {Background} from '../classes/items/background';\n\nimport '../css/background-item.css';\n\n// @vue/component\nexport const BackgroundComponent = {\n\tprops:\n\t{\n\t\telement: {\n\t\t\ttype: Object,\n\t\t\trequired: true\n\t\t},\n\t\tisSelected: {\n\t\t\ttype: Boolean,\n\t\t\trequired: true\n\t\t}\n\t},\n\temits: ['click', 'remove', 'cancel'],\n\tdata()\n\t{\n\t\treturn {};\n\t},\n\tcomputed:\n\t{\n\t\tbackground(): Background\n\t\t{\n\t\t\treturn this.element;\n\t\t},\n\t\tcontainerClasses(): string[]\n\t\t{\n\t\t\tconst classes = [];\n\n\t\t\tif (this.isSelected)\n\t\t\t{\n\t\t\t\tclasses.push('--selected');\n\t\t\t}\n\n\t\t\tif (!this.background.isSupported)\n\t\t\t{\n\t\t\t\tclasses.push('--unsupported');\n\t\t\t}\n\n\t\t\tif (this.background.isLoading)\n\t\t\t{\n\t\t\t\tclasses.push('--loading');\n\t\t\t}\n\n\t\t\treturn classes;\n\t\t},\n\t\timageStyle(): {backgroundImage: string}\n\t\t{\n\t\t\tlet backgroundImage = '';\n\t\t\tif (this.background.preview)\n\t\t\t{\n\t\t\t\tbackgroundImage = `url('${this.background.preview}')`;\n\t\t\t}\n\n\t\t\treturn {backgroundImage};\n\t\t}\n\t},\n\twatch:\n\t{\n\t\t'background.uploadState.status'()\n\t\t{\n\t\t\tthis.getProgressBarManager().update();\n\t\t},\n\t\t'background.uploadState.progress'()\n\t\t{\n\t\t\tthis.getProgressBarManager().update();\n\t\t}\n\t},\n\tmounted()\n\t{\n\t\tthis.initProgressBar();\n\t},\n\tbeforeUnmount()\n\t{\n\t\tthis.removeProgressBar();\n\t},\n\tmethods:\n\t{\n\t\tinitProgressBar()\n\t\t{\n\t\t\tif (!this.background.uploadState || this.background.uploadState.progress === 100)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.progressBarManager = new ProgressBarManager({\n\t\t\t\tcontainer: this.$refs['container'],\n\t\t\t\tuploadState: this.background.uploadState\n\t\t\t});\n\n\t\t\tthis.progressBarManager.subscribe(ProgressBarManager.event.cancel, () => {\n\t\t\t\tthis.$emit('cancel', this.background);\n\t\t\t});\n\t\t\tthis.progressBarManager.subscribe(ProgressBarManager.event.destroy, () => {\n\t\t\t\tif (this.progressBar)\n\t\t\t\t{\n\t\t\t\t\tthis.progressBar = null;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis.progressBarManager.start();\n\t\t},\n\t\tremoveProgressBar()\n\t\t{\n\t\t\tif (!this.progressBarManager)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.progressBarManager.destroy();\n\t\t},\n\t\tgetProgressBarManager(): ProgressBarManager\n\t\t{\n\t\t\treturn this.progressBarManager;\n\t\t},\n\t\tloc(phraseCode: string): string\n\t\t{\n\t\t\treturn this.$Bitrix.Loc.getMessage(phraseCode);\n\t\t}\n\t},\n\ttemplate:\n\t`\n\t\t<div @click=\"$emit('click')\" :class=\"containerClasses\" class=\"bx-im-call-background__item\" ref=\"container\">\n\t\t\t<div :style=\"imageStyle\" class=\"bx-im-call-background__item_image\"></div>\n\t\t\t<div v-if=\"background.isSupported && background.isVideo\" class=\"bx-im-call-background__item_video\"></div>\n\t\t\t<div v-if=\"!background.isLoading\" class=\"bx-im-call-background__item_title_container\">\n\t\t\t\t<span class=\"bx-im-call-background__item_title\">{{background.title}}</span>\n\t\t\t\t<div\n\t\t\t\t\tv-if=\"background.canRemove\"\n\t\t\t\t\t:title=\"loc('BX_IM_CALL_BG_REMOVE')\"\n\t\t\t\t\t@click.stop=\"$emit('remove')\"\n\t\t\t\t\tclass=\"bx-im-call-background__item_remove\"\n\t\t\t\t></div>\n\t\t\t</div>\n\t\t</div>\n\t`\n};","import {Loc} from 'main.core';\n\nexport class Action\n{\n\tstatic type = {\n\t\tnone: 'none',\n\t\tupload: 'upload',\n\t\tblur: 'blur',\n\t\tgaussianBlur: 'gaussianBlur'\n\t};\n\n\tid: string;\n\ttitle: string;\n\tbackground: string;\n\n\tconstructor(type: String)\n\t{\n\t\tlet id = Action.type.none;\n\t\tlet background = Action.type.none;\n\t\tlet title = Loc.getMessage('BX_IM_CALL_BG_ACTION_NONE');\n\n\t\tif (type === Action.type.upload)\n\t\t{\n\t\t\tid = type;\n\t\t\tbackground = type;\n\t\t\ttitle = Loc.getMessage('BX_IM_CALL_BG_ACTION_UPLOAD');\n\t\t}\n\t\telse if (type === Action.type.gaussianBlur)\n\t\t{\n\t\t\tid = type;\n\t\t\tbackground = type;\n\t\t\ttitle = Loc.getMessage('BX_IM_CALL_BG_ACTION_BLUR');\n\t\t}\n\t\telse if (type === Action.type.blur)\n\t\t{\n\t\t\tid = type;\n\t\t\tbackground = type;\n\t\t\ttitle = Loc.getMessage('BX_IM_CALL_BG_ACTION_BLUR_MAX');\n\t\t}\n\n\t\tthis.id = id;\n\t\tthis.background = background;\n\t\tthis.title = title;\n\t}\n\n\tisEmpty(): boolean\n\t{\n\t\treturn this.id === Action.type.none;\n\t}\n\n\tisBlur(): boolean\n\t{\n\t\treturn this.id === Action.type.gaussianBlur || this.id === Action.type.blur;\n\t}\n\n\tisUpload(): boolean\n\t{\n\t\treturn this.id === Action.type.upload;\n\t}\n}","import {Action} from '../classes/items/action';\n\n// @vue/component\nexport const ActionComponent = {\n\tprops:\n\t{\n\t\telement: {\n\t\t\ttype: Object,\n\t\t\trequired: true\n\t\t},\n\t\tisSelected: {\n\t\t\ttype: Boolean,\n\t\t\trequired: true\n\t\t}\n\t},\n\tdata()\n\t{\n\t\treturn {};\n\t},\n\tcomputed:\n\t{\n\t\taction(): Action\n\t\t{\n\t\t\treturn this.element;\n\t\t},\n\t\tcontainerClasses(): string[]\n\t\t{\n\t\t\tconst classes = [`--${this.action.id}`];\n\t\t\tif (this.isSelected)\n\t\t\t{\n\t\t\t\tclasses.push('--selected');\n\t\t\t}\n\n\t\t\treturn classes;\n\t\t}\n\t},\n\ttemplate:\n\t`\n\t\t<div :class=\"containerClasses\" class=\"bx-im-call-background__item --action\">\n\t\t\t<div class=\"bx-im-call-background__action_icon\"></div>\n\t\t\t<div class=\"bx-im-call-background__action_title\">\n\t\t\t\t{{ action.title }}\n\t\t\t</div>\n\t\t</div>\n\t`\n};","import {Loc} from 'main.core';\n\nimport type {MaskRestResult} from '../../types/rest';\n\nexport class Mask\n{\n\tid: string = '';\n\tactive: boolean = true;\n\tmask: string = '';\n\tbackground: string = '';\n\tpreview: string = '';\n\ttitle: string = '';\n\n\tisLoading: boolean = false;\n\n\tconstructor(params)\n\t{\n\t\tObject.assign(this, params);\n\t}\n\n\tisEmpty()\n\t{\n\t\treturn this.id === '';\n\t}\n\n\tstatic createEmpty()\n\t{\n\t\treturn new Mask({\n\t\t\tactive: true,\n\t\t\tid: '',\n\t\t\tmask: '',\n\t\t\tpreview: '',\n\t\t\tbackground: '',\n\t\t\ttitle: Loc.getMessage('BX_IM_CALL_BG_NO_MASK_TITLE')\n\t\t});\n\t}\n\n\tstatic createFromRest(rawMask: MaskRestResult)\n\t{\n\t\tconst {active, id, mask, background, preview, title} = rawMask;\n\n\t\treturn new Mask({\n\t\t\tactive,\n\t\t\tid,\n\t\t\tmask,\n\t\t\tpreview,\n\t\t\tbackground,\n\t\t\ttitle\n\t\t});\n\t}\n}","import '../css/mask.css';\n\nimport {Mask} from '../classes/items/mask';\n\n// @vue/component\nexport const MaskComponent = {\n\tprops:\n\t{\n\t\telement: {\n\t\t\ttype: Object,\n\t\t\trequired: true\n\t\t},\n\t\tisSelected: {\n\t\t\ttype: Boolean,\n\t\t\trequired: true\n\t\t}\n\t},\n\tdata()\n\t{\n\t\treturn {};\n\t},\n\tcomputed:\n\t{\n\t\tmask(): Mask\n\t\t{\n\t\t\treturn this.element;\n\t\t},\n\t\tcontainerClasses(): string[]\n\t\t{\n\t\t\tconst classes = [`--${this.mask.id}`];\n\t\t\tif (this.isSelected)\n\t\t\t{\n\t\t\t\tclasses.push('--selected');\n\t\t\t}\n\n\t\t\tif (!this.mask.active)\n\t\t\t{\n\t\t\t\tclasses.push('--inactive');\n\t\t\t}\n\n\t\t\treturn classes;\n\t\t},\n\t\timageStyle(): {backgroundImage: string}\n\t\t{\n\t\t\tlet backgroundImage = '';\n\t\t\tif (this.mask.preview)\n\t\t\t{\n\t\t\t\tbackgroundImage = `url('${this.mask.preview}')`;\n\t\t\t}\n\n\t\t\treturn {backgroundImage};\n\t\t}\n\t},\n\tmethods:\n\t{\n\t\tloc(phraseCode: string): string\n\t\t{\n\t\t\treturn this.$Bitrix.Loc.getMessage(phraseCode);\n\t\t}\n\t},\n\ttemplate: `\n\t\t<div :class=\"containerClasses\" class=\"bx-im-call-background__item --mask\">\n\t\t\t<div v-if=\"!mask.active\" class=\"bx-im-call-background__mask_fade\"></div>\n\t\t\t<div class=\"bx-im-call-background__mask_background\"></div>\n\t\t\t<div :style=\"imageStyle\" class=\"bx-im-call-background__item_image\"></div>\n\t\t\t<div v-if=\"mask.isLoading\" class=\"bx-im-call-background__mask_loading-container\">\n\t\t\t\t<div class=\"bx-im-call-background__mask_loading-icon\"></div>\n\t\t\t\t<div class=\"bx-im-call-background__mask_loading-text\">{{ loc('BX_IM_CALL_BG_MASK_LOADING') }}</div>\n\t\t\t</div>\n\t\t\t<div v-else-if=\"!mask.active\" class=\"bx-im-call-background__mask_soon-container\">\n\t\t\t\t<div class=\"bx-im-call-background__mask_soon-text\">{{ loc('BX_IM_CALL_BG_MASK_COMING_SOON') }}</div>\n\t\t\t</div>\n\t\t\t<div v-else class=\"bx-im-call-background__mask_title\">{{ mask.title }}</div>\n\t\t</div>\n\t`\n};","// @vue/component\nexport const Loader = {\n\tname: 'CallBackgroundLoader',\n\tdata()\n\t{\n\t\treturn {};\n\t},\n\ttemplate:\n\t`\n\t\t<div class=\"bx-im-call-background__loader\">\n\t\t\t<svg class=\"bx-desktop-loader-circular\" viewBox=\"25 25 50 50\">\n\t\t\t\t<circle class=\"bx-desktop-loader-path\" cx=\"50\" cy=\"50\" r=\"20\" fill=\"none\" stroke-miterlimit=\"10\"/>\n\t\t\t</svg>\n\t\t</div>\n\t`\n};","import 'ui.info-helper';\n\nimport { Utils } from 'im.v2.lib.utils';\nimport { DesktopApi, DesktopFeature } from 'im.v2.lib.desktop-api';\nimport { openHelpdeskArticle } from 'im.v2.lib.helpdesk';\n\nimport { Action } from './items/action';\n\nimport type { LimitRestResult } from '../types/rest';\n\nexport class LimitManager\n{\n\tstatic limitCode = {\n\t\tblur: 'call_blur_background',\n\t\timage: 'call_background',\n\t};\n\n\tlimits: {[limitId: string]: LimitRestResult} = {};\n\n\tconstructor(params: {limits: LimitRestResult[], infoHelperUrlTemplate: string})\n\t{\n\t\tconst { limits, infoHelperUrlTemplate } = params;\n\t\tthis.#initLimits(limits);\n\t\tthis.#initInfoHelper(infoHelperUrlTemplate);\n\t}\n\n\tisLimitedAction(action: Action): boolean\n\t{\n\t\tif (action.isEmpty() || action.isUpload())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\treturn action.isBlur() && this.#limitIsActive(LimitManager.limitCode.blur);\n\t}\n\n\tisLimitedBackground(): boolean\n\t{\n\t\treturn this.#limitIsActive(LimitManager.limitCode.image);\n\t}\n\n\tshowLimitSlider(limitCode: string)\n\t{\n\t\twindow.BX.UI.InfoHelper.show(this.limits[limitCode].articleCode);\n\t}\n\n\t// region Mask feature\n\tstatic isMaskFeatureAvailable(): boolean\n\t{\n\t\tif (!Utils.platform.isBitrixDesktop())\n\t\t{\n\t\t\treturn true;\n\t\t}\n\n\t\treturn DesktopApi.isFeatureEnabled(DesktopFeature.mask.id);\n\t}\n\n\tstatic isMaskFeatureSupportedByDesktopVersion(): boolean\n\t{\n\t\tif (!Utils.platform.isBitrixDesktop())\n\t\t{\n\t\t\treturn true;\n\t\t}\n\n\t\treturn DesktopApi.isFeatureSupported(DesktopFeature.mask.id);\n\t}\n\t// endregion Mask feature\n\n\tstatic showHelpArticle(articleCode: string)\n\t{\n\t\topenHelpdeskArticle(articleCode);\n\t}\n\n\t#initLimits(limits: LimitRestResult[])\n\t{\n\t\tlimits.forEach((limit: LimitRestResult) => {\n\t\t\tthis.limits[limit.id] = limit;\n\t\t});\n\t}\n\n\t#initInfoHelper(infoHelperUrlTemplate: string)\n\t{\n\t\tif (window.BX.UI.InfoHelper.isInited())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\twindow.BX.UI.InfoHelper.init({\n\t\t\tframeUrlTemplate: infoHelperUrlTemplate\n\t\t});\n\t}\n\n\t#limitIsActive(limitCode: string): boolean\n\t{\n\t\tconst limitIsActive = !!this.limits[limitCode]?.active;\n\t\tconst articleIsActive = !!this.limits[limitCode]?.articleCode;\n\n\t\treturn limitIsActive && articleIsActive;\n\t}\n}\n","export const TabId = {\n\tmask: 'mask',\n\tbackground: 'background'\n};\n\nexport const MASK_HELP_ARTICLE_CODE = 12398124;","import {LimitManager} from '../classes/limit-manager';\nimport {TabId} from '../const';\n\nimport '../css/tab-panel.css';\n\nimport type {Tab} from '../types/tab';\n\n// @vue/component\nexport const TabPanel = {\n\tprops:\n\t{\n\t\tselectedTab: {\n\t\t\ttype: String,\n\t\t\trequired: true\n\t\t}\n\t},\n\temits: ['tabChange'],\n\tdata()\n\t{\n\t\treturn {};\n\t},\n\tcomputed:\n\t{\n\t\ttabs(): Tab[]\n\t\t{\n\t\t\tconst tabs = [];\n\t\t\tif (LimitManager.isMaskFeatureAvailable())\n\t\t\t{\n\t\t\t\ttabs.push({\n\t\t\t\t\tid: TabId.mask,\n\t\t\t\t\tloc: 'BX_IM_CALL_BG_TAB_MASK',\n\t\t\t\t\tisNew: false\n\t\t\t\t});\n\t\t\t}\n\n\t\t\ttabs.push({\n\t\t\t\tid: TabId.background,\n\t\t\t\tloc: 'BX_IM_CALL_BG_TAB_BG',\n\t\t\t\tisNew: false\n\t\t\t});\n\n\t\t\treturn tabs;\n\t\t}\n\t},\n\tmethods:\n\t{\n\t\tloc(phraseCode: string): string\n\t\t{\n\t\t\treturn this.$Bitrix.Loc.getMessage(phraseCode);\n\t\t}\n\t},\n\ttemplate:\n\t`\n\t\t<div class=\"bx-im-call-background__tab-panel\">\n\t\t\t<div\n\t\t\t\tv-for=\"tab in tabs\"\n\t\t\t\t:key=\"tab.id\"\n\t\t\t\t@click=\"$emit('tabChange', tab.id)\"\n\t\t\t\t:class=\"{'--active': selectedTab === tab.id, '--new': tab.isNew}\"\n\t\t\t\tclass=\"bx-im-call-background__tab\"\n\t\t\t>\n\t\t\t\t<div v-if=\"tab.isNew\" class=\"bx-im-call-background__tab_new\">{{ loc('BX_IM_CALL_BG_TAB_NEW') }}</div>\n\t\t\t\t<div class=\"bx-im-call-background__tab_text\">{{ loc(tab.loc) }}</div>\n\t\t\t</div>\n\t\t</div>\n\t`\n};","import {Logger} from 'im.v2.lib.logger';\n\nconst VIDEO_CONSTRAINT_WIDTH = 1280;\nconst VIDEO_CONSTRAINT_HEIGHT = 720;\n\n// @vue/component\nexport const VideoPreview = {\n\tdata()\n\t{\n\t\treturn {\n\t\t\tnoVideo: false\n\t\t};\n\t},\n\tcomputed:\n\t{\n\t\tvideoClasses()\n\t\t{\n\t\t\treturn {'--flipped': BX.Call.Hardware.enableMirroring};\n\t\t}\n\t},\n\tcreated()\n\t{\n\t\tthis.initHardware().then(() => {\n\t\t\tthis.getDefaultDevices();\n\t\t}).catch(error => {\n\t\t\tconsole.error('VideoPreview: error initing hardware', error);\n\t\t});\n\t},\n\tbeforeUnmount()\n\t{\n\t\tthis.videoStream.getTracks().forEach(tr => tr.stop());\n\t\tthis.videoStream = null;\n\t},\n\tmethods:\n\t{\n\t\tgetDefaultDevices()\n\t\t{\n\t\t\tconst constraints = {audio: false, video: true};\n\t\t\tconstraints.video = {};\n\t\t\tconstraints.video.width = {ideal: VIDEO_CONSTRAINT_WIDTH};\n\t\t\tconstraints.video.height = {ideal: VIDEO_CONSTRAINT_HEIGHT};\n\n\t\t\tif (BX.Call.Hardware.defaultCamera)\n\t\t\t{\n\t\t\t\tthis.selectedCamera = BX.Call.Hardware.defaultCamera;\n\t\t\t\tconstraints.video = {...constraints.video, ...{deviceId: {exact: this.selectedCamera}}};\n\t\t\t}\n\t\t\telse if (Object.keys(BX.Call.Hardware.cameraList).length === 0)\n\t\t\t{\n\t\t\t\tconsole.error('VideoPreview: no camera');\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tnavigator.mediaDevices.getUserMedia(constraints).then((stream: MediaStream) => {\n\t\t\t\tthis.videoStream = stream;\n\t\t\t\tif (stream.getVideoTracks().length === 0)\n\t\t\t\t{\n\t\t\t\t\tthis.noVideo = true;\n\t\t\t\t\tconsole.error('VideoPreview: no video tracks');\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (!this.selectedCamera)\n\t\t\t\t{\n\t\t\t\t\tthis.selectedCamera = stream.getVideoTracks()[0].getSettings().deviceId;\n\t\t\t\t}\n\t\t\t\tthis.playLocalVideo();\n\t\t\t});\n\t\t},\n\t\tplayLocalVideo()\n\t\t{\n\t\t\tLogger.warn('VideoPreview: playing local video');\n\t\t\tthis.$refs['video'].volume = 0;\n\t\t\tthis.$refs['video'].srcObject = this.videoStream;\n\t\t\tthis.$refs['video'].play();\n\t\t},\n\t\tinitHardware(): Promise\n\t\t{\n\t\t\treturn BX.Call.Hardware.init();\n\t\t},\n\t\tloc(phraseCode: string): string\n\t\t{\n\t\t\treturn this.$Bitrix.Loc.getMessage(phraseCode);\n\t\t}\n\t},\n\ttemplate: `\n\t\t<div class=\"bx-im-call-background__video\">\n\t\t\t<div v-if=\"noVideo\" class=\"bx-im-call-background__no-cam_container\">\n\t\t\t\t<div class=\"bx-im-call-background__no-cam_icon\"></div>\n\t\t\t\t<div class=\"bx-im-call-background__no-cam_title\">{{ loc('BX_IM_CALL_BG_NO_CAM') }}</div>\n\t\t\t</div>\n\t\t\t<video v-else :class=\"videoClasses\" ref=\"video\" muted autoplay playsinline></video>\n\t\t</div>\n\t`\n};","import { rest as RestClient } from 'rest.client';\n\nimport { Logger } from 'im.v2.lib.logger';\nimport { RestMethod } from 'im.v2.const';\n\nimport type { BackgroundListRestResult } from '../types/rest';\n\ntype ElementsListRestResult = {\n\t[RestMethod.imCallBackgroundGet]: RestResult,\n\t[RestMethod.imCallMaskGet]: RestResult\n};\n\nexport class BackgroundService\n{\n\tgetElementsList(): Promise<BackgroundListRestResult>\n\t{\n\t\tconst query = {\n\t\t\t[RestMethod.imCallBackgroundGet]: [RestMethod.imCallBackgroundGet],\n\t\t\t[RestMethod.imCallMaskGet]: [RestMethod.imCallMaskGet],\n\t\t};\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tRestClient.callBatch(query, (response: ElementsListRestResult) => {\n\t\t\t\tLogger.warn('BackgroundService: getElementsList result', response);\n\t\t\t\tconst backgroundResult: RestResult = response[RestMethod.imCallBackgroundGet];\n\t\t\t\tconst maskResult: RestResult = response[RestMethod.imCallMaskGet];\n\t\t\t\tif (backgroundResult.error())\n\t\t\t\t{\n\t\t\t\t\tconsole.error('BackgroundService: error getting background list', backgroundResult.error());\n\n\t\t\t\t\treturn reject(backgroundResult.error());\n\t\t\t\t}\n\n\t\t\t\tif (maskResult.error())\n\t\t\t\t{\n\t\t\t\t\tconsole.error('BackgroundService: error getting mask list', maskResult.error());\n\n\t\t\t\t\treturn reject(maskResult.error());\n\t\t\t\t}\n\n\t\t\t\treturn resolve({\n\t\t\t\t\tbackgroundResult: backgroundResult.data(),\n\t\t\t\t\tmaskResult: maskResult.data(),\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t}\n\n\tcommitBackground(fileId: string): void\n\t{\n\t\tRestClient.callMethod(RestMethod.imCallBackgroundCommit, { fileId })\n\t\t\t.catch((result: RestResult) => {\n\t\t\t\tconsole.error('BackgroundService: commitBackground error', result.error());\n\t\t\t});\n\t}\n\n\tdeleteFile(fileId: string): void\n\t{\n\t\tRestClient.callMethod(RestMethod.imCallBackgroundDelete, { fileId })\n\t\t\t.catch((result: RestResult) => {\n\t\t\t\tconsole.error('BackgroundService: deleteFile error', result.error());\n\t\t\t});\n\t}\n}\n","import { Loc } from 'main.core';\nimport { EventEmitter, BaseEvent } from 'main.core.events';\n\nimport { Logger } from 'im.v2.lib.logger';\nimport { Uploader } from 'im.lib.uploader';\nimport { Notifier } from 'im.v2.lib.notifier';\n\nconst FILE_MAX_SIZE = 100 * 1024 * 1024;\nconst FILE_MAX_SIZE_PHRASE_NUMBER = 100;\nconst UPLOAD_CHUNK_SIZE = 1024 * 1024;\nconst NOTIFICATION_HIDE_DELAY = 5000;\nconst CUSTOM_BG_TASK_PREFIX = 'custom';\nconst EVENT_NAMESPACE = 'BX.Messenger.v2.CallBackground.UploadManager';\n\nexport class UploadManager extends EventEmitter\n{\n\tstatic allowedFileTypes = [\n\t\t'image/png',\n\t\t'image/jpg',\n\t\t'image/jpeg',\n\t\t'video/avi',\n\t\t'video/mp4',\n\t\t'video/quicktime',\n\t];\n\n\tstatic event = {\n\t\tuploadStart: 'uploadStart',\n\t\tuploadProgress: 'uploadProgress',\n\t\tuploadComplete: 'uploadComplete',\n\t\tuploadError: 'uploadError',\n\t};\n\n\tuploader: Uploader;\n\tdiskFolderId: number;\n\n\tconstructor(params: {inputNode: HTMLElement})\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace(EVENT_NAMESPACE);\n\n\t\tconst { inputNode } = params;\n\t\tthis.uploader = new Uploader({\n\t\t\tinputNode,\n\t\t\tgeneratePreview: true,\n\t\t\tfileMaxSize: FILE_MAX_SIZE,\n\t\t});\n\n\t\tthis.#bindEvents();\n\t}\n\n\tsetDiskFolderId(diskFolderId: number)\n\t{\n\t\tthis.diskFolderId = diskFolderId;\n\t}\n\n\tcancelUpload(fileId: string)\n\t{\n\t\tthis.uploader.deleteTask(fileId);\n\t}\n\n\t// region events\n\t#bindEvents()\n\t{\n\t\tthis.uploader.subscribe('onFileMaxSizeExceeded', this.#onFileMaxSizeExceeded.bind(this));\n\t\tthis.uploader.subscribe('onSelectFile', this.#onSelectFile.bind(this));\n\t\tthis.uploader.subscribe('onStartUpload', this.#onStartUpload.bind(this));\n\t\tthis.uploader.subscribe('onProgress', this.#onProgress.bind(this));\n\t\tthis.uploader.subscribe('onComplete', this.#onComplete.bind(this));\n\t\tthis.uploader.subscribe('onUploadFileError', this.#onUploadError.bind(this));\n\t\tthis.uploader.subscribe('onCreateFileError', this.#onUploadError.bind(this));\n\t}\n\n\t#onFileMaxSizeExceeded(event: BaseEvent)\n\t{\n\t\tLogger.warn('UploadManager: onFileMaxSizeExceeded', event);\n\t\tconst eventData = event.getData();\n\t\tconst { file } = eventData;\n\n\t\tNotifier.call.onBackgroundFileSizeError({\n\t\t\tfileName: file.name,\n\t\t\tfileSizeLimit: FILE_MAX_SIZE_PHRASE_NUMBER,\n\t\t});\n\t}\n\n\t#onSelectFile(event: BaseEvent)\n\t{\n\t\tLogger.warn('UploadManager: onSelectFile', event);\n\t\tconst { file, previewData } = event.getData();\n\n\t\tif (!this.#isAllowedType(file.type) || !previewData)\n\t\t{\n\t\t\tNotifier.call.onBackgroundUnsupportedError(file.name);\n\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#addUploadTask(file, previewData);\n\t}\n\n\t#onStartUpload(event: BaseEvent)\n\t{\n\t\tLogger.warn('UploadManager: onStartUpload', event);\n\t\tconst { previewData, id, file } = event.getData();\n\n\t\tconst filePreview = URL.createObjectURL(previewData);\n\t\tthis.emit(UploadManager.event.uploadStart, {\n\t\t\tid,\n\t\t\tfilePreview,\n\t\t\tfile,\n\t\t});\n\t}\n\n\t#onProgress(event: BaseEvent)\n\t{\n\t\tLogger.warn('UploadManager: onProgress', event);\n\t\tconst { id, progress } = event.getData();\n\t\tthis.emit(UploadManager.event.uploadProgress, {\n\t\t\tid,\n\t\t\tprogress,\n\t\t});\n\t}\n\n\t#onComplete(event: BaseEvent)\n\t{\n\t\tLogger.warn('UploadManager: onComplete', event);\n\t\tconst { id, result } = event.getData();\n\t\tthis.emit(UploadManager.event.uploadComplete, {\n\t\t\tid,\n\t\t\tfileResult: result.data.file,\n\t\t});\n\t}\n\n\t#onUploadError(event: BaseEvent)\n\t{\n\t\tLogger.warn('UploadManager: onUploadError', event);\n\t\tconst eventData = event.getData();\n\t\tthis.emit(UploadManager.event.uploadError, { id: eventData.id });\n\t}\n\t// endregion events\n\n\t#addUploadTask(file: File, previewData)\n\t{\n\t\tthis.uploader.addTask({\n\t\t\ttaskId: `${CUSTOM_BG_TASK_PREFIX}:${Date.now()}`,\n\t\t\tchunkSize: UPLOAD_CHUNK_SIZE,\n\t\t\tfileData: file,\n\t\t\tfileName: file.name,\n\t\t\tdiskFolderId: this.diskFolderId,\n\t\t\tgenerateUniqueName: true,\n\t\t\tpreviewBlob: previewData,\n\t\t});\n\t}\n\n\t#isAllowedType(fileType: string): boolean\n\t{\n\t\treturn UploadManager.allowedFileTypes.includes(fileType);\n\t}\n}\n","import 'ui.vue3';\nimport 'ui.buttons';\nimport 'ui.fonts.opensans';\n\nimport {BaseEvent} from 'main.core.events';\nimport { DesktopApi } from 'im.v2.lib.desktop-api';\n\nimport {Utils} from 'im.v2.lib.utils';\nimport {Logger} from 'im.v2.lib.logger';\n\nimport {BackgroundComponent} from './components/background';\nimport {ActionComponent} from './components/action';\nimport {MaskComponent} from './components/mask';\nimport {Loader} from './components/loader';\nimport {TabPanel} from './components/tab-panel';\nimport {VideoPreview} from './components/video-preview';\n\nimport {Action} from './classes/items/action';\nimport {Background} from './classes/items/background';\nimport {Mask} from './classes/items/mask';\nimport {BackgroundService} from './classes/background-service';\nimport {UploadManager} from './classes/upload-manager';\nimport {LimitManager} from './classes/limit-manager';\nimport {TabId, MASK_HELP_ARTICLE_CODE} from './const';\n\nimport './css/call-background.css';\nimport './css/call-background-dark.css';\n\nimport type {ElementListRestResult, BackgroundListRestResult, BackgroundRestResult, MaskListRestResult, MaskRestResult} from './types/rest';\n\n// @vue/component\nexport const CallBackground = {\n\tname: 'CallBackground',\n\tcomponents: {BackgroundComponent, ActionComponent, MaskComponent, Loader, TabPanel, VideoPreview},\n\tprops: {\n\t\ttab: {\n\t\t\ttype: String,\n\t\t\tdefault: TabId.background,\n\t\t}\n\t},\n\tdata()\n\t{\n\t\treturn {\n\t\t\tselectedTab: '',\n\t\t\tselectedBackgroundId: '',\n\t\t\tselectedMaskId: '',\n\t\t\tloadingItems: true,\n\t\t\tactions: [],\n\t\t\tdefaultBackgrounds: [],\n\t\t\tcustomBackgrounds: [],\n\t\t\tmasks: [],\n\t\t\tlistIsScrolled: false\n\t\t};\n\t},\n\tcomputed:\n\t{\n\t\tTabId: () => TabId,\n\t\tbackgrounds(): Background[]\n\t\t{\n\t\t\treturn [...this.customBackgrounds, ...this.defaultBackgrounds];\n\t\t},\n\t\tcontainerClasses(): string[]\n\t\t{\n\t\t\tconst classes = [];\n\n\t\t\tif (this.isDesktop)\n\t\t\t{\n\t\t\t\tclasses.push('--desktop');\n\t\t\t}\n\n\t\t\treturn classes;\n\t\t},\n\t\tuploadTypes(): string\n\t\t{\n\t\t\treturn UploadManager.allowedFileTypes.join(', ');\n\t\t},\n\t\tdescriptionText(): string\n\t\t{\n\t\t\tconst replaces = {\n\t\t\t\t'#HIGHLIGHT_START#': '<span class=\"bx-im-call-background__description_highlight\">',\n\t\t\t\t'#HIGHLIGHT_END#': '</span>',\n\t\t\t\t'#BR#': '</br></br>'\n\t\t\t};\n\t\t\tif (this.selectedTab === TabId.mask)\n\t\t\t{\n\t\t\t\treturn this.loc('BX_IM_CALL_BG_DESCRIPTION_MASK_2', replaces);\n\t\t\t}\n\n\t\t\treturn this.loc('BX_IM_CALL_BG_DESCRIPTION_BG', replaces);\n\t\t},\n\t\tisDesktop()\n\t\t{\n\t\t\treturn Utils.platform.isBitrixDesktop();\n\t\t}\n\t},\n\tcreated()\n\t{\n\t\tthis.initSelectedTab();\n\n\t\tthis.getBackgroundService().getElementsList().then((result: ElementListRestResult) => {\n\t\t\tconst {backgroundResult, maskResult} = result;\n\n\t\t\tthis.initLimitManager(backgroundResult);\n\t\t\tthis.initBackgroundList(backgroundResult);\n\n\t\t\tthis.uploadManager.setDiskFolderId(backgroundResult.upload.folderId);\n\t\t\tconst uploadActionIsAvailable = !!backgroundResult.upload.folderId;\n\t\t\tthis.initActions(uploadActionIsAvailable);\n\n\t\t\tthis.initMasks(maskResult);\n\t\t\tthis.initMaskLoadEventHandler();\n\n\t\t\tthis.initPreviouslySelectedItem();\n\t\t\tthis.loadingItems = false;\n\n\t\t\tthis.hideLoader();\n\t\t}).catch(() => {\n\t\t\tthis.loadingItems = false;\n\t\t});\n\t},\n\tmounted()\n\t{\n\t\tthis.initUploader();\n\t},\n\tmethods:\n\t{\n\t\t// region init\n\t\tinitSelectedTab()\n\t\t{\n\t\t\tif (this.tab === TabId.mask && !LimitManager.isMaskFeatureAvailable())\n\t\t\t{\n\t\t\t\tthis.selectedTab = TabId.background;\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (this.tab === TabId.mask && !LimitManager.isMaskFeatureSupportedByDesktopVersion())\n\t\t\t{\n\t\t\t\tthis.selectedTab = TabId.background;\n\t\t\t\tLimitManager.showHelpArticle(MASK_HELP_ARTICLE_CODE);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.selectedTab = this.tab;\n\t\t},\n\t\tinitPreviouslySelectedItem()\n\t\t{\n\t\t\tthis.initPreviouslySelectedMask();\n\t\t\tthis.initPreviouslySelectedBackground();\n\t\t},\n\t\tinitPreviouslySelectedMask()\n\t\t{\n\t\t\tif (this.isDesktop)\n\t\t\t{\n\t\t\t\tconst {id: maskId} = DesktopApi.getCallMask();\n\t\t\t\tlet foundMask = this.masks.find(mask => mask.id === maskId);\n\t\t\t\tif (!foundMask)\n\t\t\t\t{\n\t\t\t\t\tfoundMask = Mask.createEmpty();\n\t\t\t\t}\n\t\t\t\tthis.previouslySelectedMask = foundMask;\n\t\t\t\tLogger.warn('CallBackground: previously selected mask', this.previouslySelectedMask);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.previouslySelectedMask = Mask.createEmpty();\n\t\t\t}\n\n\t\t\tthis.selectedMaskId = this.previouslySelectedMask.id;\n\t\t},\n\t\tinitPreviouslySelectedBackground()\n\t\t{\n\t\t\tif (this.isDesktop)\n\t\t\t{\n\t\t\t\tconst {id: backgroundId} = DesktopApi.getBackgroundImage();\n\t\t\t\tconst itemsToSearch = [...this.actions, ...this.backgrounds];\n\t\t\t\tlet foundBackground = itemsToSearch.find(item => item.id === backgroundId);\n\t\t\t\tif (!foundBackground)\n\t\t\t\t{\n\t\t\t\t\tfoundBackground = new Action(Action.type.none);\n\t\t\t\t}\n\t\t\t\tthis.previouslySelectedBackground = foundBackground;\n\t\t\t\tLogger.warn('CallBackground: previously selected background', this.previouslySelectedBackground);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.previouslySelectedBackground = new Action(Action.type.none);\n\t\t\t}\n\n\t\t\tthis.selectedBackgroundId = this.previouslySelectedBackground.id;\n\t\t},\n\t\tinitActions(uploadActionIsAvailable: boolean)\n\t\t{\n\t\t\tthis.actions = [\n\t\t\t\tnew Action(Action.type.none),\n\t\t\t\t...uploadActionIsAvailable ? [new Action(Action.type.upload)]: [],\n\t\t\t\tnew Action(Action.type.gaussianBlur),\n\t\t\t\tnew Action(Action.type.blur),\n\t\t\t];\n\t\t},\n\t\tinitBackgroundList(restResult: BackgroundListRestResult)\n\t\t{\n\t\t\tthis.defaultBackgrounds = [];\n\t\t\trestResult.backgrounds.default.forEach((background: BackgroundRestResult) => {\n\t\t\t\tthis.defaultBackgrounds.push(Background.createDefaultFromRest(background));\n\t\t\t});\n\n\t\t\tthis.customBackgrounds = [];\n\t\t\trestResult.backgrounds.custom.forEach((background: BackgroundRestResult) => {\n\t\t\t\tthis.customBackgrounds.push(Background.createCustomFromRest(background));\n\t\t\t});\n\t\t},\n\t\tinitLimitManager(result: BackgroundListRestResult)\n\t\t{\n\t\t\tconst {limits, infoHelperParams} = result;\n\t\t\tthis.limitManager = new LimitManager({\n\t\t\t\tlimits,\n\t\t\t\tinfoHelperUrlTemplate: infoHelperParams.frameUrlTemplate\n\t\t\t});\n\t\t},\n\t\tinitUploader()\n\t\t{\n\t\t\tthis.uploadManager = new UploadManager({\n\t\t\t\tinputNode: this.$refs['uploadInput']\n\t\t\t});\n\n\t\t\tthis.uploadManager.subscribe(UploadManager.event.uploadStart, (event: BaseEvent) => {\n\t\t\t\tconst backgroundsInstance = Background.createCustomFromUploaderEvent(event.getData());\n\t\t\t\tthis.customBackgrounds.unshift(backgroundsInstance);\n\t\t\t});\n\t\t\tthis.uploadManager.subscribe(UploadManager.event.uploadProgress, (event: BaseEvent) => {\n\t\t\t\tconst {id, progress} = event.getData();\n\t\t\t\tconst background = this.findCustomBackgroundById(id);\n\t\t\t\tif (!background)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tbackground.setUploadProgress(progress);\n\t\t\t});\n\t\t\tthis.uploadManager.subscribe(UploadManager.event.uploadComplete, (event: BaseEvent) => {\n\t\t\t\tconst {id, fileResult} = event.getData();\n\t\t\t\tconst background = this.findCustomBackgroundById(id);\n\t\t\t\tif (!background)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tbackground.onUploadComplete(fileResult);\n\n\t\t\t\tthis.onBackgroundClick(background);\n\n\t\t\t\tthis.getBackgroundService().commitBackground(background.id);\n\t\t\t});\n\t\t\tthis.uploadManager.subscribe(UploadManager.event.uploadError, (event: BaseEvent) => {\n\t\t\t\tconst {id} = event.getData();\n\t\t\t\tconst background = this.findCustomBackgroundById(id);\n\t\t\t\tif (!background)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tbackground.setUploadError();\n\t\t\t});\n\t\t},\n\t\tinitMasks(result: MaskListRestResult)\n\t\t{\n\t\t\tconst {masks} = result;\n\t\t\tthis.masks.push(Mask.createEmpty());\n\t\t\tmasks.forEach((mask: MaskRestResult) => {\n\t\t\t\tthis.masks.push(Mask.createFromRest(mask));\n\t\t\t});\n\t\t},\n\t\tinitMaskLoadEventHandler()\n\t\t{\n\t\t\tif (!this.isDesktop)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.maskLoadTimeouts = {};\n\t\t\tDesktopApi.setCallMaskLoadHandlers(this.onMaskLoad.bind(this));\n\t\t},\n\t\t// endregion init\n\t\t// region component events\n\t\tonActionClick(action: Action)\n\t\t{\n\t\t\tif (this.getLimitManager().isLimitedAction(action))\n\t\t\t{\n\t\t\t\tthis.getLimitManager().showLimitSlider(LimitManager.limitCode.blur);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (action.isUpload())\n\t\t\t{\n\t\t\t\tthis.$refs['uploadInput'].click();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.selectedBackgroundId = action.id;\n\n\t\t\tif (action.isEmpty())\n\t\t\t{\n\t\t\t\tthis.removeCallBackground();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.selectedMaskId = '';\n\t\t\tthis.setCallBlur(action);\n\t\t},\n\t\tonBackgroundClick(background: Background)\n\t\t{\n\t\t\tif (this.getLimitManager().isLimitedBackground())\n\t\t\t{\n\t\t\t\tthis.getLimitManager().showLimitSlider(LimitManager.limitCode.image);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!background.isSupported || background.isLoading)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.selectedBackgroundId = background.id;\n\t\t\tthis.selectedMaskId = '';\n\t\t\tthis.setCallBackground(background);\n\t\t},\n\t\tonBackgroundRemove(background: Background)\n\t\t{\n\t\t\tif (background.id === this.selectedBackgroundId)\n\t\t\t{\n\t\t\t\tthis.selectedBackgroundId = Action.type.none;\n\t\t\t\tthis.removeCallBackground();\n\t\t\t}\n\n\t\t\tif (background.isLoading)\n\t\t\t{\n\t\t\t\tthis.uploadManager.cancelUpload(background.id);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.getBackgroundService().deleteFile(background.id);\n\t\t\t}\n\n\t\t\tthis.customBackgrounds = this.customBackgrounds.filter(element => element.id !== background.id);\n\t\t},\n\t\tonMaskClick(mask: Mask)\n\t\t{\n\t\t\tif (!mask.active)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (mask.isEmpty())\n\t\t\t{\n\t\t\t\tthis.selectedMaskId = mask.id;\n\t\t\t\tthis.removeCallMask();\n\t\t\t}\n\n\t\t\tthis.setCallMask(mask);\n\t\t},\n\t\tonSaveButtonClick()\n\t\t{\n\t\t\twindow.close();\n\t\t},\n\t\tonCancelButtonClick()\n\t\t{\n\t\t\tconst backgroundWasChanged = this.previouslySelectedBackground.id !== this.selectedBackgroundId;\n\t\t\tconst maskWasChanged = this.previouslySelectedMask.id !== this.selectedMaskId;\n\t\t\tif (!backgroundWasChanged && !maskWasChanged)\n\t\t\t{\n\t\t\t\twindow.close();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tlet backgroundPromise = Promise.resolve();\n\t\t\tif (backgroundWasChanged)\n\t\t\t{\n\t\t\t\tbackgroundPromise = this.setCallBackground(this.previouslySelectedBackground);\n\t\t\t}\n\n\t\t\tbackgroundPromise.then(() => {\n\t\t\t\tif (maskWasChanged && !this.previouslySelectedMask.isEmpty())\n\t\t\t\t{\n\t\t\t\t\tthis.setCallMask(this.previouslySelectedMask);\n\t\t\t\t\tthis.isWaitingForMaskToCancel = true;\n\t\t\t\t}\n\t\t\t\telse if (this.previouslySelectedMask.isEmpty())\n\t\t\t\t{\n\t\t\t\t\tthis.removeCallMask();\n\t\t\t\t\twindow.close();\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\twindow.close();\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\tonListScroll(event: Event)\n\t\t{\n\t\t\tif (event.target.scrollTop === 0)\n\t\t\t{\n\t\t\t\tthis.listIsScrolled = false;\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.listIsScrolled = true;\n\t\t},\n\t\tonTabChange(newTabId: string)\n\t\t{\n\t\t\tif (newTabId === TabId.mask && !LimitManager.isMaskFeatureSupportedByDesktopVersion())\n\t\t\t{\n\t\t\t\tLimitManager.showHelpArticle(MASK_HELP_ARTICLE_CODE);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.selectedTab = newTabId;\n\t\t},\n\t\tonMaskLoad(url: string)\n\t\t{\n\t\t\tLogger.warn('CallBackground: onMaskLoad', url);\n\t\t\tif (this.isWaitingForMaskToCancel)\n\t\t\t{\n\t\t\t\twindow.close();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst masksWithoutEmpty = this.masks.filter((mask: Mask) => !mask.isEmpty());\n\t\t\tconst loadedMask = masksWithoutEmpty.find((mask: Mask) => url.includes(mask.mask));\n\t\t\tLogger.warn('CallBackground: loaded mask', loadedMask);\n\t\t\tif (!loadedMask)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tclearTimeout(this.maskLoadTimeouts[loadedMask.id]);\n\t\t\tloadedMask.isLoading = false;\n\t\t\tif (this.lastRequestedMaskId === loadedMask.id)\n\t\t\t{\n\t\t\t\tthis.selectedMaskId = loadedMask.id;\n\t\t\t}\n\t\t},\n\t\t// endregion component events\n\t\t// region desktop interactions\n\t\tonSetCallBackgroundHandle(id, source)\n\t\t{\n\t\t\treturn DesktopApi.setCallBackground(id, source)\n\t\t\t\t.then((id) =>\n\t\t\t\t\t{\n\t\t\t\t\t\tif (id === 'none' && this.selectedBackgroundId !== 'none')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tLogger.warn('CallBackground: background settings limit exceeded');\n\t\t\t\t\t\t\tthis.selectedBackgroundId = Action.type.none;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t},\n\t\tsetCallBackground(backgroundInstance: Background): Promise\n\t\t{\n\t\t\tLogger.warn('CallBackground: trying set background', backgroundInstance);\n\t\t\tif (!this.isDesktop)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\treturn this.onSetCallBackgroundHandle(backgroundInstance.id, backgroundInstance.background);\n\t\t},\n\t\tsetCallBlur(action: Action): Promise\n\t\t{\n\t\t\tLogger.warn('CallBackground: trying set blur', action);\n\t\t\tif (!this.isDesktop)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\treturn this.onSetCallBackgroundHandle(action.id, action.background);\n\t\t},\n\t\tremoveCallBackground(): Promise\n\t\t{\n\t\t\tif (!this.isDesktop)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\treturn this.onSetCallBackgroundHandle(Action.type.none, Action.type.none);\n\t\t},\n\t\tsetCallMask(mask: Mask)\n\t\t{\n\t\t\tLogger.warn('CallBackground: set mask', mask);\n\t\t\tif (!this.isDesktop)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (mask.isEmpty())\n\t\t\t{\n\t\t\t\tLogger.warn('CallBackground: empty mask - removing it');\n\t\t\t\tDesktopApi.setCallMask();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.lastRequestedMaskId = mask.id;\n\n\t\t\tconst MASK_LOAD_STATUS_DELAY = 500;\n\t\t\tthis.maskLoadTimeouts[mask.id] = setTimeout(() => {\n\t\t\t\tmask.isLoading = true;\n\t\t\t}, MASK_LOAD_STATUS_DELAY);\n\t\t\tDesktopApi.setCallMask(mask.id, mask.mask, mask.background);\n\t\t},\n\t\tremoveCallMask()\n\t\t{\n\t\t\tif (!this.isDesktop)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tDesktopApi.setCallMask();\n\t\t},\n\t\thideLoader()\n\t\t{\n\t\t\tif (!this.isDesktop)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tDesktopApi.hideLoader();\n\t\t},\n\t\t// endregion desktop interactions\n\t\tfindCustomBackgroundById(id: string): ?Background\n\t\t{\n\t\t\treturn this.customBackgrounds.find(element => element.id === id);\n\t\t},\n\t\tgetBackgroundService(): BackgroundService\n\t\t{\n\t\t\tif (!this.backgroundService)\n\t\t\t{\n\t\t\t\tthis.backgroundService = new BackgroundService();\n\t\t\t}\n\n\t\t\treturn this.backgroundService;\n\t\t},\n\t\tgetLimitManager(): LimitManager\n\t\t{\n\t\t\treturn this.limitManager;\n\t\t},\n\t\tloc(phraseCode: string, replacements: {[p: string]: string} = {}): string\n\t\t{\n\t\t\treturn this.$Bitrix.Loc.getMessage(phraseCode, replacements);\n\t\t}\n\t},\n\ttemplate:\n\t`\n\t\t<div :class=\"{'--desktop': isDesktop}\" class=\"bx-im-call-background__scope bx-im-call-background__container\">\n\t\t\t<div v-if=\"loadingItems\" class=\"bx-im-call-background__loader_container\">\n\t\t\t\t<Loader />\n\t\t\t</div>\n\t\t\t<div v-else class=\"bx-im-call-background__content\">\n\t\t\t\t<div class=\"bx-im-call-background__left\">\n\t\t\t\t\t<VideoPreview />\n\t\t\t\t\t<div v-html=\"descriptionText\" class=\"bx-im-call-background__description\"></div>\n\t\t\t\t</div>\n\t\t\t\t<div :class=\"{'--scrolled': listIsScrolled}\" class=\"bx-im-call-background__right\">\n\t\t\t\t\t<TabPanel :selectedTab=\"selectedTab\" @tabChange=\"onTabChange\" />\n\t\t\t\t\t<div v-if=\"selectedTab === TabId.background\" @scroll=\"onListScroll\" class=\"bx-im-call-background__list\">\n\t\t\t\t\t\t<ActionComponent\n\t\t\t\t\t\t\tv-for=\"action in actions\"\n\t\t\t\t\t\t\t:element=\"action\"\n\t\t\t\t\t\t\t:key=\"action.id\"\n\t\t\t\t\t\t\t:isSelected=\"selectedBackgroundId === action.id\"\n\t\t\t\t\t\t\t@click=\"onActionClick(action)\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<BackgroundComponent\n\t\t\t\t\t\t\tv-for=\"background in backgrounds\"\n\t\t\t\t\t\t\t:element=\"background\"\n\t\t\t\t\t\t\t:key=\"background.id\"\n\t\t\t\t\t\t\t:isSelected=\"selectedBackgroundId === background.id\"\n\t\t\t\t\t\t\t@click=\"onBackgroundClick(background)\"\n\t\t\t\t\t\t\t@cancel=\"onBackgroundRemove(background)\"\n\t\t\t\t\t\t\t@remove=\"onBackgroundRemove(background)\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div v-else-if=\"selectedTab === TabId.mask\" @scroll=\"onListScroll\" class=\"bx-im-call-background__list\">\n\t\t\t\t\t\t<MaskComponent\n\t\t\t\t\t\t\tv-for=\"mask in masks\"\n\t\t\t\t\t\t\t:element=\"mask\"\n\t\t\t\t\t\t\t:key=\"mask.id\"\n\t\t\t\t\t\t\t:isSelected=\"selectedMaskId === mask.id\"\n\t\t\t\t\t\t\t@click=\"onMaskClick(mask)\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\t\n\t\t\t</div>\n\t\t\t<div class=\"bx-im-call-background__button-panel\">\n\t\t\t\t<button @click=\"onSaveButtonClick\" :class=\"{'ui-btn-wait ui-btn-disabled': loadingItems}\" class=\"ui-btn ui-btn-success\">\n\t\t\t\t\t{{ loc('BX_IM_CALL_BG_SAVE') }}\n\t\t\t\t</button>\n\t\t\t\t<button @click=\"onCancelButtonClick\" class=\"ui-btn ui-btn-link\">\n\t\t\t\t\t{{ loc('BX_IM_CALL_BG_CANCEL') }}\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</div>\n\t\t<div class=\"bx-im-call-background__upload-input\">\n\t\t\t<input type=\"file\" :accept=\"uploadTypes\" ref=\"uploadInput\"/>\n\t\t</div>\n\t`\n};\n"],"names":["Background","params","Object","assign","progress","uploadState","status","FileStatus","error","fileResult","id","isVideo","background","links","download","isLoading","canRemove","restItem","includes","isCustom","isSupported","title","Loc","getMessage","uploaderData","filePreview","file","preview","type","startsWith","upload","size","BackgroundComponent","props","element","required","isSelected","Boolean","emits","data","computed","containerClasses","classes","push","imageStyle","backgroundImage","watch","getProgressBarManager","update","mounted","initProgressBar","beforeUnmount","removeProgressBar","methods","progressBarManager","ProgressBarManager","container","$refs","subscribe","event","cancel","$emit","destroy","progressBar","start","loc","phraseCode","$Bitrix","template","Action","none","gaussianBlur","blur","ActionComponent","action","Mask","active","mask","rawMask","MaskComponent","Loader","name","LimitManager","limits","infoHelperUrlTemplate","isEmpty","isUpload","isBlur","limitCode","image","window","BX","UI","InfoHelper","show","articleCode","Utils","platform","isBitrixDesktop","DesktopApi","isFeatureEnabled","DesktopFeature","isFeatureSupported","openHelpdeskArticle","forEach","limit","isInited","init","frameUrlTemplate","limitIsActive","articleIsActive","TabId","MASK_HELP_ARTICLE_CODE","TabPanel","selectedTab","String","tabs","isMaskFeatureAvailable","isNew","VIDEO_CONSTRAINT_WIDTH","VIDEO_CONSTRAINT_HEIGHT","VideoPreview","noVideo","videoClasses","Call","Hardware","enableMirroring","created","initHardware","then","getDefaultDevices","console","videoStream","getTracks","tr","stop","constraints","audio","video","width","ideal","height","defaultCamera","selectedCamera","deviceId","exact","keys","cameraList","length","navigator","mediaDevices","getUserMedia","stream","getVideoTracks","getSettings","playLocalVideo","Logger","warn","volume","srcObject","play","BackgroundService","query","RestMethod","imCallBackgroundGet","imCallMaskGet","Promise","resolve","reject","RestClient","callBatch","response","backgroundResult","maskResult","fileId","callMethod","imCallBackgroundCommit","result","imCallBackgroundDelete","FILE_MAX_SIZE","FILE_MAX_SIZE_PHRASE_NUMBER","UPLOAD_CHUNK_SIZE","CUSTOM_BG_TASK_PREFIX","EVENT_NAMESPACE","UploadManager","_classPrivateMethodInitSpec","setEventNamespace","inputNode","uploader","Uploader","generatePreview","fileMaxSize","_classPrivateMethodGet","diskFolderId","deleteTask","EventEmitter","bind","eventData","getData","Notifier","call","onBackgroundFileSizeError","fileName","fileSizeLimit","previewData","onBackgroundUnsupportedError","URL","createObjectURL","emit","uploadStart","uploadProgress","uploadComplete","uploadError","addTask","taskId","Date","now","chunkSize","fileData","generateUniqueName","previewBlob","fileType","allowedFileTypes","CallBackground","components","tab","selectedBackgroundId","selectedMaskId","loadingItems","actions","defaultBackgrounds","customBackgrounds","masks","listIsScrolled","backgrounds","isDesktop","uploadTypes","join","descriptionText","replaces","initSelectedTab","getBackgroundService","getElementsList","initLimitManager","initBackgroundList","uploadManager","setDiskFolderId","folderId","uploadActionIsAvailable","initActions","initMasks","initMaskLoadEventHandler","initPreviouslySelectedItem","hideLoader","initUploader","isMaskFeatureSupportedByDesktopVersion","showHelpArticle","initPreviouslySelectedMask","initPreviouslySelectedBackground","getCallMask","maskId","foundMask","find","createEmpty","previouslySelectedMask","getBackgroundImage","backgroundId","itemsToSearch","foundBackground","item","previouslySelectedBackground","restResult","createDefaultFromRest","custom","createCustomFromRest","infoHelperParams","limitManager","backgroundsInstance","createCustomFromUploaderEvent","unshift","findCustomBackgroundById","setUploadProgress","onUploadComplete","onBackgroundClick","commitBackground","setUploadError","createFromRest","maskLoadTimeouts","setCallMaskLoadHandlers","onMaskLoad","onActionClick","getLimitManager","isLimitedAction","showLimitSlider","click","removeCallBackground","setCallBlur","isLimitedBackground","setCallBackground","onBackgroundRemove","cancelUpload","deleteFile","filter","onMaskClick","removeCallMask","setCallMask","onSaveButtonClick","close","onCancelButtonClick","backgroundWasChanged","maskWasChanged","backgroundPromise","isWaitingForMaskToCancel","onListScroll","target","scrollTop","onTabChange","newTabId","url","masksWithoutEmpty","loadedMask","clearTimeout","lastRequestedMaskId","onSetCallBackgroundHandle","source","backgroundInstance","MASK_LOAD_STATUS_DELAY","setTimeout","backgroundService","replacements"],"mappings":"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"}